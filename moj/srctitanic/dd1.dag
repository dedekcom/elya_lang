// engine.setdebugstate(1);

new int igmdebug = 0;

/**************************************************************/
new int igmwinlocal = 0;		// special folder windows
new int igmmac = 0;
new int igmipad = 0;
new int ibigfish = 0;
new int igamehouse = 0;

new string sgmdeveloper = "PlayWay";
new string sgmproject = "TitanicKeysToThePast";

if( igmdebug && (igmipad||igmmac) )	{
	engine.addmethod("getsavepath", func { "saves/"; } );
}


/**************************************************************/

public string getwinpath(string spath)	{
	//("searching: " + spath)->print;
	string s = engine.getspecialpath("appdata");
	if( s!=null )	{
		s + "/" + sgmdeveloper + "/" + sgmproject + "/" + spath;
	} else spath;
}

public getsavepath	{
	if( igmipad || igmmac )	{
		engine.getsavepath;
	} else {
		(igmwinlocal ?  .getwinpath("saves/") :  "saves/");	
	}
}

/**************************************************************/

public buildsavedir	{
	if( igmwinlocal && !igmipad && !igmmac )	{
		string s = engine.getspecialpath("appdata");
		if( s!=null )	{
			s += "/" + sgmdeveloper;
			int odp = engine.mkdir(s);
			odp = 0;
			if( odp==0 || odp==1 )	{
				s +=  "/" + sgmproject;
				odp = engine.mkdir(s);
				odp = 0;
				if( odp==0 || odp==1 )	{
					s+= "/saves";
					_ = engine.mkdir(s);
				}
			}
		}
	}
}
.buildsavedir;

/******** konstrukcje  ********************/
new string	A = "!!!";
new real		PI = 3.14159265358979323846;
new int		BYTE0 = "0"->getbyte(0);
new int		BYTE9 = "9"->getbyte(0);
new int		BYTEa = "a"->getbyte(0);
new int		BYTEz = "z"->getbyte(0);
new int		BYTEA = "A"->getbyte(0);
new int		BYTEZ = "Z"->getbyte(0);
new int		BYTE_ = "_"->getbyte(0);
new int		BYTESPACE = " "->getbyte(0);

// engine.setdebugstate(2);

public varget(string svar)				{	[svar];				}
public varset(string svar, def val)			{	<svar> = val;			}
public varnew(string styp, string svar)	{	new <styp> <svar>;	}
public varnewif(string styp, string svar)	{	if( !.hasvar(svar) )	.varnew(styp,svar);}
public vardelif(string svar)				{	if( .hasvar(svar) )	.vardel(svar);		}
public vardel(string svar)				{	delete <svar>;		}
public reader(string sname)	{
	.varnewif("def", sname);
	.addmethod( sname, func { [.methodname]; } );
}
public writer(string sname)	{
	.varnewif("def", sname);
	.addmethod( sname+"=", func { (def val) <.methodname->strsube(1)> = val; } );
}
public var(string sname)	{
	.reader(sname);
	.writer(sname);
}
public var2(string sname, def val)	{
	.var(sname);
	<sname> = val;
}
public withlist(string sfun)	{
	@s = _;
	while( A != s )	{
		.<sfun>(s);
		@s = _;
	}
}
public withlist2(string sfun)	{
	@s = _;
	while( A != s )	{
		@s1 = _;
		.<sfun>(s1,s);
		@s = _;
	}
}
public vars	{	.withlist("var");}
public vars2	{	.withlist2("var2");}

/*****************************************************/
public builder_func(string sfun)	{
	<.getbuildername>.<.getbuildername+sfun>;
}
/*****************************************************/
public bool in	{
	bool b = false;
	@x = .get;
	@y = _;
	while( A != y )	{
		if( !b )	b = x==y;
		@y=_;
	}
	b;
}
public with(string sfun)	{
	string sob = _;
	while( sob!=A )	{
		<sob>.<sfun>();
		sob=_;
	}
}
public copycall(string sfun, string sob)	{
	string s = "__call" + sfun;
	new string <s>;
	<s> = sob;
	.addmethod( sfun, func {
		string sf = .methodname;
		< [ "__call" + sf ] >.<sf>();
		});
}
public copycalls(string sobj)	{
	string s = _;
	while( s!=A )	{
		.copycall( s, sobj ); 
		s=_;
	}
}
/***********************************/
public mresize()	{	< .gettype + "_pack">::resizemethods( this );	}
/******** petle ********************/
public times(string sfun)		{	this.for_plus(0, this.get()-1, sfun );		}
public upto(int ito, string sfun)	{	this.for_plus( this.get(), ito, sfun );	}
public downto(int ito, string sfun)	{	this.for_minus( this.get(), ito, sfun );	}
public for_plus(int ifrom, int ito, string sfun)	{
	if( ito-ifrom<=0 )	return;
	for( ; ifrom<=ito; ifrom++)	this.<sfun>(ifrom);
}
public for_minus(int ifrom, int ito, string sfun)	{
	if( ifrom-ito<=0 )	return;
	for( ; ifrom>=ito; ifrom--)	this.<sfun>(ifrom);
}
public double_for(int w, int h, string sfun)	{
	int j;
	for( int i=0; i<w; i++)	{
		for( j=0; j<h; j++)	{
			this.<sfun>(i,j);
		}
	}
}
/****************************************/

// klasa do np. dynamicznego tworzenia obiektow z prefixem+id
class classobjcounter	{
	init(string sprefix)	{
		new string _sprefix=sprefix;
		new int _iile=0;
		.var2("limit",0);
	}
	string get()	{
		if( limit>0 ) _iile=_iile%limit+1;
		else _iile++;
		return _sprefix + (_iile-1);
	}
	int size()	{_iile;}
	int getid(int id)	{	_sprefix + (_iile-1-id);	}
}

/*class classvsigobj	{
	init()	{
		new bool bplaying=false;
	}
	virtual play()	{	bplaying=true;	}
	virtual stop(bool bstop)	{ 
		bplaying=false;
		if( bstop )	{	this.onfinish();	}
	}
	virtual bool isplaying()	{	bplaying;	}
}*/

/***************************************************************************/

class classsignals	{
	init()	{}
	/********** std obj **********************/
	stdfinish(string sob) { <sob>.addmethod("onfinish",func { this.<this.getname()+"_FINISH">();}); }
	stdstart(string sob) { <sob>.addmethod("onstart",func { this.<this.getname()+"_START">(); }); }
	stdsigs(string sob)	{
		this.stdstart(sob);
		this.stdfinish(sob);
	}
	/********** anima **********************/
	buildanima(string san)	{
		this.stdsigs(san);
		<san>.addmethod("onendframe", func { this.<this.getname()+"_ENDFRAME">(); } );
	}
	/********** snd **********************/
	buildsnd(string ssnd)	{	this.stdsigs(ssnd);		}
	/********** timer **********************/
	buildtimer(string stimer)	{
		this.stdsigs(stimer);
		<stimer>.addmethod("ontick", func { this.<this.getname()+"_TICK">(); });
	}
	/********** button *******************/
	buildbut(string sbut)	{
		<sbut>.addmethod("onclick", func { this.<this.getname()+"_CLICK">(); });
		<sbut>.addmethod("onrel", func { this.<this.getname()+"_REL">(); });
		<sbut>.addmethod("onmoveon", func { this.<this.getname()+"_MOVEON">(); });
		<sbut>.addmethod("onmoveoff", func { this.<this.getname()+"_MOVEOFF">(); });
	}
}

/******************************************************************/

class classlocker	{
	init()	{
		new bool _block = true;
	}
	public lock()	{	_block=true;	}
	public unlock()	{	_block=false;	}
	public setlock(bool b)	{	_block=b;	}
	public bool getlock()	{	return _block;	}
	public bool unlocked	{	_block==false;	}
	public setaslocker(string sob)	{
		<sob>.addmethod("buildlocker", func { new bool _block=true; });
		<sob>.buildlocker;
		<sob>.addmethod("lock", "lock");
		<sob>.addmethod("unlock", "unlock");
		<sob>.addmethod("setlock", "setlock");
		<sob>.addmethod("getlock", "getlock");
		<sob>.addmethod("unlocked", "unlocked");
	}
}

/***************************************************************************/

module classdbreader	{
	init()	{
		new db dbl;
	}
	readdb( string sfunc )	{
		int id = 0;
		int ile = dbl.getrowsno();
		while( id < ile )	{
			this.<sfunc>( id );
			id++;
		}
	}
	readrow( string srow, string sfunc )	{
		int ipos = dbl.findbyrow( srow );
		if( ipos >= 0 )	{
			this.<sfunc>( ipos );
		}
	}
}

/***************************************************************************/


/***************************************************************************/
class collection	{
	init(string styp)	{	new string stype=styp;	}
	public string type()	{	return stype;		}
}

class array : collection {
	init(string styp, int idimens, int isiz)	{
		collection::init(styp);
		new int idim = idimens;
		new int isize = isiz;
		new vector vec;
		vec.type(styp);
		if( idimens<=0 || isiz<=0 )	return;
		//vec.resize( isiz.pow(isiz,idimens), 0 );
		vec.resize( isiz.pow(idimens), 0 );
	}
	int getid()	{
		int pos=0;
		int dim=idim-1;
		while(dim>0)	{
			pos+=_;
			pos*=isize;
			dim--;
		}
		return pos+_;
	}
	public def get()	{	return vec.get( this.getid() );	}
	public set(def svar)	{	vec.set( this.getid(), svar);	}
	public int getsize()	{	return isize;			}
	public int getdim()	{	return idim;			}
}

class stack : collection	{
	init(string styp)	{
		collection::init(styp);
		new vector vec;
		vec.type(styp);
		new <styp> var;
	}
	public push(string svar){	vec.add(svar);		}
	public def top()	{	return vec.last();	}
	public def pop()	{
		var = this.top();
		vec.removeat( vec.size()-1 );
		return var;
	}
	public free	{	vec.free;	}
}

class map : collection	{
	init(string styp)	{
		collection::init(styp);
		new int isize=0;
	}
	set(string svar, def val)	{
		if( !this.hasvar("v"+svar) )	this.add(svar);
		<"v"+svar>.set(val);
	}
	add(string svar)	{	new <stype> <"v"+svar>;		}
	def get(string svar)	{	return ["v"+svar];		}
	remove(string svar)	{	delete <"v"+svar>;		}
	bool contains(string svar){	return this.hasvar("v"+svar);	}
}
class map2 : collection	{
	init(string styp)	{
		collection::init(styp);
		new vector vn;
		vn.type("string");
		new vector vec;
		vec.type(styp);
	}
	add(string svar, def val)	{	vn.add(svar);	vec.add(val);	}
	set(string svar, def val)	{	vec.set( vn.find(svar), val );	}
	bool contains(string svar)	{	return vn.contains(svar);	}
	def get(string svar)		{	return vec.get( vn.find(svar) );}
	remove(string svar)	{
		int id = vn.find(svar);
		if( id>=0 )	{
			vec.removeat( id );
			vn.removeat(id);
		}
	}
	free()	{	vn.free();	vec.free();	}
	print	{	vec.print;	vn.print;	}
}


/***************************************************************************/
class classgamemusic : classdbreader	{
	init()	{
		classdbreader::init();
		new string smuspath = "";
		new string sbgrpath = "";
		new snd _sndbgr;
		_sndbgr.addmethod("onfinish", "_stdsndloop");
	}
	reset()	{
		gameapi.stopmusic();
		this.stopbgr();
	}
	_stdsndloop()	{	this.play(); }
	load(string sfile)	{	dbl.loadscript( sfile );	}
	musicpath(string s)	{	smuspath = s;	}
	sndbgrpath(string s)	{	sbgrpath=s;	}
	_play(int ipos)	{
		int i[3], string s[2];
		i0 = 1;
		i1 = dbl.getcolsno( ipos );
		while( i0 < i1 )	{
			s0 = dbl.get( ipos, i0 );	i0++;
			if( s0 == "music" )	{
				s1 = smuspath + dbl.get( ipos, i0 );
				i0++;
				if( i0 < i1 )	{
					if( dbl.get( ipos, i0 )=="vol" )	{
						i0++;
						gameapi.setmusicvol( dbl.get( ipos, i0 ) );
						i0++;
					}
				} else {
					gameapi.setmusicvol( 100 );
				}
				gameapi.playmusic( s1 );
			} else if (s0 == "bgr")	{
				_sndbgr.load( sbgrpath + dbl.get( ipos, i0 ) );
				i0++;
				if( i0 < i1 )	{
					if( dbl.get( ipos, i0 )=="vol" )	{
						i0++;
						_sndbgr.setvol( dbl.get( ipos, i0 ) );
						i0++;
					}
				} else {
					_sndbgr.setvol( 100 );
				}
				this.playbgr();
			} else {	i0++;	}
		}
	}
	play()	{
		this.reset();
		this.readrow( gameapi.getgamename(), "_play" );
	}
	playbgr()		{	_sndbgr.play();	}
	stopbgr()	{	_sndbgr.stop(false);	}
}

class Music	{
	init	{
		new vector vmus;
		vmus.type("string");
		new int ilastid;
		.var2("musicvolume", 100);
		//onmusicfin      {       mus.play;       }
	}
	playdb(string s, int row, int icol)	{
		vmus.free;
		while (icol < <s>.getcolsno(row) )	{
			vmus.add( <s>.get(row, icol) );
			icol++;
		}
		ilastid = 0;
		.play;
	}
	playvec(string s, int id)	{
		vmus.free;
		while( id< <s>.size )	{
			vmus.add( <s>.get(id) );
			id++;
		}
		ilastid = 0;
		.play;
	}
	playstr(string s)	{
		vmus.vecbuildfromstring(s, " ");
		ilastid = 0;
		.play;
	}
	play	{
		if( ilastid >= vmus.size ) return;
		
		string s = MUSICPATH + vmus.get(ilastid);
		if( !engine.fileexist(s) )	{
			s = SFXPATH + vmus.get(ilastid);
		}
		
		ilastid++;
		
		bool bloop=false;
		int fin=0;
		int fout = 0;
		int vol = musicvolume;
		for( int i=ilastid; i<vmus.size; i++)	{
			@s1 = vmus.get(i);
			match(s1)	{
				"-l" => bloop = true;
				"-v" => { i++;
					vol = vmus.get(i);
					vol = (vol*musicvolume)/100;
					}
				"-fin" => { i++; fin = vmus.get(i); }
				"-fout" => { i++; fout = vmus.get(i); }
				"-p" => ;
				? => { ilastid=i; i = vmus.size; }
			}
		}
		gameapi.setmusicvol(vol);
		if( bloop ) {
			gameapi.playmusic(s);
			ilastid = vmus.size;
			return;
		}
		gameapi.loadmusic(s);
		if (fin) gameapi.fadeinmusic(fin);
		else gameapi.startmusic;
		if (fout) gameapi.fadeoutmusic(fout);
	}
	fadeout(int ms)	{
		if( gameapi.ismusicplaying ) {
			gameapi.fadeoutmusic(ms);
			ilastid=vmus.size;
		}
	}
	isplaying	{	gameapi.ismusicplaying;	}
	stop	{
		gameapi.endmusic(false);
	}
}
/**************************************************************/
	// zmienne globalna - stany gry
new int igmstate;
new string sgmstate;
new int igmeasy;
new int igmdemo;
new int igmbegin;
new int igmsoundson = false;

new db dbconf;
dbconf.loadscript("scripts/mainloader/config.beh");
dbconf.addmethod("confmode", func { (string s)
	if( Trudnosc==0 ) s+="_easy:";
	else if (Trudnosc==1) s+="_normal:";
	else s+="_expert:";
	.dbget(s);
	} );

new string sgmfontfile = "configs/fonts/normal.ttf";
new string sgmfontmono = "configs/fonts/mono.ttf";
new string sgmfontmonobold = "configs/fonts/monobold.ttf";
new string sgmfontbold = "configs/fonts/monobold.ttf";
new string sgmfontitalic = "configs/fonts/timesit.ttf";

new string SFXPATH = "sounds/sfx/";
new string BGRPATH = "sounds/bgr/";
new string MUSICPATH = "sounds/music/";
//new string LANG = "eng";	// pl, eng, cze, slo

new string LANG;
if( igmipad )	{
	match( engine.getcurlang )	{
		"it" => "ita";
		"de" => "ger";
		"es" => "esp";
		"fr" => "fra";
		? => "eng";
	}
	LANG = _;
} else {
	LANG = dbconf.dbget("lang:");
}


new string SNDPATH = "sounds/";
new string LANGDIR = "lang/" + LANG + "/";
if( LANG=="pl" ) LANG="";
if( LANG.length > 0 ) SNDPATH += LANG + "/";

// new int iResX = 1024;
// new int iResY = 768;
|new int iResX, new int iResY| = engine.getscreenres;

/**************************************************************/
	// standardowa klasa do tworzenia zmiennych
class newvars		{
	init()	{
		new string _sclpath = "";
		new string _sclwavpath = "";
	}
	string _checkfont(string sfont, int isize, string sfnt)	{
		if( sfont==null )	sfont=sgmfontfile;
		if( sfont.contains(".ttf") )	{
			new font <sfnt>;
			<sfnt>.load( sfont, isize );
			sfont = sfnt;
		}
		sfont;
	}
	string checkfont(string sfont, int isize)	{
		._checkfont(sfont, isize, "_fnt");
	}
	bool begingame()	{
		igmbegin = !igmbegin;
		!igmbegin;
	}
	newarray(string styp, string sbase, int size)	{
		if( size<= 0 )	return;
		size--;
		while(size>=0)	{
			new <styp> <sbase+size>;
			size--;
		}
	}
	setgraphpath(string spath)	{	_sclpath = spath;	}
	setwavpath(string spath)	{ _sclwavpath = spath; }
	string getgraphpath()	{	return _sclpath; }
	string getsndpath()	{	return _sclwavpath; }
	getpath(string sfile)	{
		if( sfile.getb(0,1)=="$" ) sfile.strsubb(1);
		else .getgraphpath + sfile;
	}
	newanima(string sname, string sfile, int z)	{
		new anima <sname>;
		<sname>.load( .getpath(sfile) );
		<sname>.setz(z);
	}
	newstdanima(string sname, string sfile, int z)	{
		this.newanima(sname, sfile, z);
		this.stdanaction(sname);
	}
	copyanimaactz(string ssrc, string sdest, string saction, int z)	{
		this.copyanimaact(ssrc, sdest, saction);
		<sdest>.setz(z);
	}
	copyanimaact(string ssrc, string sdest, string saction)	{
		this.copyanima(ssrc, sdest);
		<sdest>.setframe( saction, 0 );
	}
	copyanima(string ssrc, string sdest)	{
		new anima <sdest>;
		<sdest>.copy( ssrc );
	}
	copyanimas(string san, string sname, int istart, int ilosc)	{
		if (ilosc<0)	return;
		for(int i=0; i<ilosc; i++)	this.copyanima( san, sname + (istart + i)  );
	}
	newanimas(string sname, string sfile, int z, int ilosc)	{
		if(ilosc<0) return; 
		this.newanima(sname+"0", sfile, z);		// pierwsza load z zerem
		this.copyanimas(sname+"0", sname, 1, ilosc-1);		// pozostale kopiowane z niej
	}
	int newanframesgr(string san, string sname, int iaction, string sgr)	{	// tworzy animacje z klatek
		int ile = <san>.nofframes( iaction );
		this.copyanimas( san, sname, 0, ile );
		for(int i=0; i<ile; i++)	{
			<sname+i>.setframe(iaction, i);
			if( sgr!=null )	{	<sgr>.add( sname+i );	}
		}
		return ile;		// zwraca ilosc stworzonych animacji
	}
	int newanframes(string san, string sname, int iaction)	{	// tworzy animacje z klatek
		return this.newanframesgr(san,sname,iaction,null);
	}
	newcanvas(string sname, int w, int h, int r, int g, int b, int a, int z)	{
		new img <sname>;
		<sname>.create(w,h,r,g,b,a);
		<sname>.setz(z);
	}
	newimg(string sname, string sfile, int z)	{
		new img <sname>;
		<sname>.load( .getpath( sfile ) );
		<sname>.setz(z);
	}
	copyimg(string ssrc, string sdest)	{
		new img <sdest>;
		<sdest>.copy(ssrc);
	}
	playmusic(string sfile)	{gameapi.playmusic( MUSICPATH + sfile );	}
	newsndfree(string sname, string sfile)	{
		new snd <sname>;
		<sname>.setstartstopflag(false, true);
		<sname>.load( this.getsndpath() + sfile);
	}
	snewsnd(string sname, string sfile)	{
		this.newsnd(sname,sfile);
		<sname>.addmethod("onfinish","__std_finish");
	}
	_newsnd(string sname, string sfile)	{
		new snd <sname>;
		if( !sfile.contains(".") ) {
			sfile += ".wav";
		}
		if( !engine.fileexist(sfile) )	{
			sfile = sfile.strsubes("wav") + "ogg";
		}
		<sname>.load( sfile );
		if( igmsubtitle )	{
			subtitle.register(sname, sfile);
		}
	}
	newsfx(string sname, string sfile)	{	._newsnd(sname, SFXPATH + sfile);	}
	newbgr(string sname, string sfile)	{	._newsnd(sname, BGRPATH + sfile);	}
	newbgrloop(string s, string s2)	{	.newbgr(s,s2); .sndplayloop(s);	}
	newsnd(string sname, string sfile)	{	._newsnd(sname, .getsndpath+sfile);	}
	newsndloop(string sname, string sfile)	{
		this.newsnd(sname,sfile);
		this.looponfinish1( sname );
	}
	looponfinish1( string sob )	{<sob>.addmethod("onfinish","_stdsndloop");	}
	sndplayloop(string sob)	{
		this.looponfinish1( sob );
		<sob>.play();
	}
	newsnds(string sbase, int inamestart, string sfilebase, int ifilefrom, int ifileto)	{
		string s;
		int ile = ifileto-ifilefrom+1;
		for(int i=0; i<ile; i++)	{
			s = sbase + (inamestart + i);
			new snd <s>;
			<s>.load( this.getsndpath() + sfilebase + (ifilefrom+i) + ".wav" );
		}
	}
	newtimer(string sname, int idelay, int iticks)	{
		new timer <sname>;
		<sname>.settick(iticks);
		<sname>.delay(idelay);
	}
	newtimercycle(string sname, int icycle, int iticks)	{
		new timer <sname>;
		<sname>.settick(iticks);
		<sname>.setcycle(icycle);
	}
	stdanaction(string san)	{
		string s = <san>.actionname();
		if( s.contains("L")  )	this.looponfinish(san);
		else if( s.contains("H")  )	this.hideonfinish(san);
		if( s.contains("P")  )	<san>.play(-1);
	}
	int newanactionsgr(string san, string sname, string sgr)	{
		int ile = <san>.nofactions();
		this.copyanimas( san, sname, 0, ile );
		string s;
		for(int i=0; i<ile; i++)	{
			s = sname+i;
			<s>.setframe(i,0);
			this.stdanaction(s);
			if( sgr!=null )	{<sgr>.add( s );}
		}
		return ile;
	}
	int newanactions(string san, string sname)	{return this.newanactionsgr(san,sname,null);	}
	int newanfrbyactgr(string san, string sname, string sgr)	{
		int ile = <san>.nofactions();
		for( int i=0; i<ile; i++)	_ = this.newanframesgr(san, sname+i+"_", i, sgr);
		return ile;
	}
	int newanfrbyact(string san, string sname)	{return this.newanfrbyactgr(san,sname,null);	}
	int loadanfrbyact(string san, string sfile, int z)	{
		string s = "_"+san;
		this.newanima(s,sfile,z);
		int ile = this.newanfrbyact(s, san);
		<s>.hide();
		return ile;
	}
	int loadanactions(string san, string sfile, int z)	{
		string s = "_"+san;
		this.newanima(s, sfile, z);
		int ile = this.newanactions(s, san);
		<s>.hide();
		return ile;
	}
	int loadanframes(string san, string sfile, int iaction, int z)	{
		string s = "_"+san;
		this.newanima(s, sfile, z);
		int ile = this.newanframes(s, san, iaction);
		<s>.hide();
		return ile;
	}
	newbutimg(string sbut, string sstd, string smov, string sclick, string smouse)	{
		new button <sbut>;
		<sbut>.set(sstd, smov, sclick);
		<sbut>.setmouse(smouse);
	}
	newbutan(string sbut, string sanstd, string sanmov, string sanclick, string smouse)	{
		new button <sbut>;
		<sbut>.setan(sanstd, sanmov, sanclick);
		<sbut>.setmouse(smouse);
	}
	/*****************************************************/
	newdb(string sdb, string sfile)	{
		new db <sdb>;
		<sdb>.load( .getpath(sfile) );
	}
	newdbscript(string sdb, string sfile)	{
		new db <sdb>;
		//<sdb>.loadscript( this.getgraphpath() + sfile );
		<sdb>.loadscritp( .getpath(sfile) );
	}
	vargmset(string svar, def val)	{
		string sg = gameapi.getgamename();
		if( !<sg>.hasvar(svar) )	<sg>.varnew( val.gettype(), svar );
		<svar> = val;
	}
}

/**************************************************************/
new img imglobcurs;		// globalny kursor aktywnosci
bsms.load("configs/kursorstd.png","configs/kursoract.png" );
	// modul obslugi standardowych kursorow myszy
module bsms {
	init()	{
		new img imgstd;
		new img imgact;
		new int msid = 0;		// 0- brak kursora 1-std lapka 2- active lapka 3- wlasny (wczytany w jakiejs grze)
	}
	load(string spath1, string spath2)	{
		imgstd.load(spath1);
		imgact.load(spath2);
		imglobcurs.copy("imgact");
		imglobcurs.hide();
		imgstd.hide();
		imgact.hide();
		this.reset();
		engine.stdbutcursor("imgstd");
	}
	setinitial()	{	mouse.stdcursor();	msid = 0;	}
	setstd()	{
		if( msid!=1 )	{
			mouse.setcursor("imgstd");
			engine.stdbutcursor("imgstd");
			msid = 1;
		}
	}
	setact()	{
		if( msid!=2 )	{
			mouse.setcursor("imgact");
			msid = 2;
		}
	}
	setown()	{	msid=3;	}
	bool isinitial()	{	msid==0;	}
	bool isstd()	{	msid==1;	}
	bool isact()	{	msid==2;	}
	bool isown()	{	msid==3;	}
}

/***************************************************************************/

module clsurf	{
	init()	{}
	bool isin(int x, int y, int x1, int y1, int x2, int y2)	{	x >= x1 && x<=x2 && y>=y1 && y<=y2;	}
	bool isin2(int x, int y, int x1, int y1, int w, int h)	{	x >= x1 && x < x1+w && y>=y1 && y<y1+h;	}
	bool inscreen(int x, int y, int dx, int dy)	{	this.isin( x, y, 0-dx, 0-dy, 800+dx, 600+dy );	}
	bool insurf(int x, int y, string simg) { .isin(x,y,<simg>.getpx, <simg>.getpy, <simg>.getex-1, <simg>.getey-1);}
	bool issurfin(int x1, int y1, int x2, int y2, int x3, int y3, int x4, int y4)	{
		this.isin(x1,y1, x3,y3,x4,y4) || this.isin(x2,y1, x3,y3,x4,y4) ||
				this.isin(x1,y2, x3,y3,x4,y4) || this.isin(x2,y2, x3,y3,x4,y4);
	}
	bool commonsurface(int x1, int y1, int x2, int y2, int x3, int y3, int x4, int y4)	{
		this.issurfin(x1,y1,x2,y2, x3,y3,x4,y4) || 
				this.issurfin(x3,y3,x4,y4, x1,y1,x2,y2);
	}
	bool commonimgs(string simg1, string simg2)	{
		this.commonsurface(<simg1>.getpx(), <simg1>.getpy(), <simg1>.getex()-1, <simg1>.getey()-1,
				<simg2>.getpx(), <simg2>.getpy(), <simg2>.getex()-1, <simg2>.getey()-1 );
	}
	bool surfwithinsurf(int x1, int y1, int x2, int y2, int x3, int y3, int x4, int y4)	{
		this.isin(x1,y1, x3,y3,x4,y4) && this.isin(x2,y1, x3,y3,x4,y4) &&
				this.isin(x1,y2, x3,y3,x4,y4) && this.isin(x2,y2, x3,y3,x4,y4);
	}
	bool imgwithinimg(string simg1, string simg2)	{
		this.surfwithinsurf(<simg1>.getpx(), <simg1>.getpy(), <simg1>.getex()-1, <simg1>.getey()-1,
				<simg2>.getpx(), <simg2>.getpy(), <simg2>.getex()-1, <simg2>.getey()-1 );
	}
}

/* modul do obliczen odleglosci */

module cllen	{
	init()	{
		new int il1;
		new int ilx;
		new int ily;
	}
	int ilenx()	{ return ilx; }
	int ileny()	{ return ily; }
	int ilen4(int x1, int x2)	{	return (x1-x2)->abs();	}
	int ilen3(string simg1, string simg2)	{
		return this.ilen( <simg1>.getcx(), <simg1>.getcy(), <simg2>.getcx(), <simg2>.getcy() );
	}
	int ilen5(string simg1, string simg2)	{
		return this.ilen( <simg1>.getpx(), <simg1>.getpy(), <simg2>.getpx(), <simg2>.getpy() );
	}
	int ilen2(string simg1, int x, int y)	{return this.ilen( <simg1>.getcx(), <simg1>.getcy(), x,  y );	}
	int ilen(int x1, int y1, int x2, int y2)	{
		ilx = x1-x2;
		ily = y1-y2;
		return il1.length( ilx, ily );
	}
	int iclenx(string simg1, int x)	{	return <simg1>.getcx() - x;	}
	int iclenx2(string simg1, string simg2)	{	return <simg1>.getcx() - <simg2>.getcx();	}
	int icleny(string simg1, int y)	{	return <simg1>.getcy() - y;	}
	int icleny2(string simg1, string simg2)	{	return <simg1>.getcy() - <simg2>.getcy();	}
	int isbetween2(string simg1, string simg2, int x1, int y1, int x2, int y2)	{
		return this.isbetween(simg1, <simg2>.getcx(), <simg2>.getcy(), x1, y1, x2, y2);
	}
	int isbetween(string simg1, int xx, int yy, int x1, int y1, int x2, int y2)	{
		il1 = this.ilen( simg1, xx, yy );
		return ilx>=x1 && ilx<=x2 && ily>=y1 && ily<=y2;
	}
	int ilodlen(string s1, string s2)	{	.ilen(<s1>.lodx,<s1>.lody, <s2>.lodx, <s2>.lody);	}
	int iposlen(string simg1, string simg2)	{
		.ilen( <simg1>.getpos, <simg2>.getpos );
	}
}

/****************************************************/
class classansearcher	{
	init()	{}
	def _findnotr(string san, int x, int y, int dx, int dy)	{
		int ex = <san>.getex() , int ey = <san>.getey();
		while( x!=ex && y!=ey )	{
			if( <san>.isin(x,y,false,true) ) return x,y;
			x+=dx;	y+=dy;
		}
		return -1,-1;
	}
	def firstnotrx1y(string san)	{	return ._findnotr(san,<san>.getpx(), <san>.getpy(), 1, 0);	}
	def firstnotrexy1(string san)	{	return ._findnotr(san,<san>.getex()-1, <san>.getpy(), 0, 1);	}
	def firstnotrxy1(string san)	{	return ._findnotr(san,<san>.getpx(), <san>.getpy(), 0, 1);	}
	def firstnotrx1ey(string san)	{	return ._findnotr(san,<san>.getpx(), <san>.getey()-1, 1, 0);	}
}

class signal_pack	{
	init()	{}
	addsignals(string san)	{
		<san>.addmethod("operator<", func { (string sfun) this.addmethod("onfinish", sfun ); } );
	}
}
/***************************************************************************/
class ImagePos	{
	init	{}
	getex	{	.getpx + .getw;	}
	getey	{	.getpy + .geth;	}
	getcx	{	.getpx + .getw/2;	}
	getcy	{	.getpy + .geth/2;	}
	setpos(int x, int y)	{	.move(x-.getpx, y-.getpy);	}
}
class ImageVisible	{
	init	{
		new bool _isvisible=1;
	}
	isvisible	{	_isvisible;	}
	show		{	_isvisible=1;	}
	hide		{	_isvisible=0;	}
}
class Image	{
	init	{}
	public resizemethods(string sob)	{
		<sob>.vars2(A, "getz",0, "getpx",0, "getpy",0, "getw",0, "geth",0, "isvisible", 0);
		<sob>.addmethod("show", func { isvisible=1; }	);
		<sob>.addmethod("hide", func { isvisible=0; }	);
		<sob>.addmethod("setz", func { (int z) getz=z; } );
		<sob>.addmethod("setpos", func { (int x, int y) getpx=x; getpy=y; } );
		<sob>.addmethod("move", func { (int x, int y) getpx+=x; getpy+=y; } );
		<sob>.addmethod("getex", func { getpx+getw; } );
		<sob>.addmethod("getey", func { getpy+geth; } );
		<sob>.addmethod("getcx", func { getpx+getw/2; } );
		<sob>.addmethod("getcy", func { getpy+geth/2; } );
		<sob>.addmethod("isin", func { (int x, int y, int bv, int ba)
			if( !ba ) {
				if( !bv || (bv&&isvisible) )	{
					x>=getpx && x<.getex && y>=getpy && y<.getey;
				} else 0;
			} else 0;
			} );
	}
}
	// rozszerzenia dla animcaji
class anima_pack : signal_pack	{
	init()	{}
	public resizemethods(string san)	{
		<san>.addmethod("_clanbuildpomvars", func { new int _ixp; new int _iyp; } );
		<san>._clanbuildpomvars();
		<san>.addmethod("setbpos", func {(int x, int y) .setpos( x-.lodx, y-.lody ); });
		<san>.addmethod("saverelpos", func {(int x,int y)_ixp=x-.getpx;_iyp=y-.getpy;} );
		<san>.addmethod("setrelpos", func{(int x, int y) .setbpos( x - _ixp, y - _iyp );});
		<san>.addmethod("mssaverelpos", func {.saverelpos( mouse.getpos );} );
		<san>.addmethod("mssetrelpos", func {.setrelpos( mouse.getpos );});
		<san>.addmethod("rplay", func {(string sact)if( !.isplaying(sact) ) .play(sact);});
		<san>.addmethod("setcpos", func {(int x, int y).setbpos( x-.getw/2, y-.geth/2 );});
		<san>.addmethod("operator=", func { (string s) .copy(s); } );
		<san>.addmethod("operator==", func { (string s)
			.actionnr==<s>.actionnr && .framenr==<s>.framenr; } );
		this.addsignals(san);
	}
}

class timer_pack : signal_pack	{
	init()	{}
	resizemethods(string sob)	{
		this.addsignals(sob);
	}
}
/***************************************************************************/
class vector_pack	{
	init()	{}
	each(string sfun)	{	for( int i=0; i<.size; i++) this.<sfun>(.get(i));	}
	resizemethods(string svec)	{
		<svec>.addmethod("each", "each");
		<svec>.addmethod("operator-", func { (def x) this.remove(x); this; } );
		<svec>.addmethod("operator+", func { (def x) this.add(x); this; } );
	}
}

/***************************************************************************/

public new_object(string styp, string sob)	{
	new <styp> <sob>;
	<styp+"_pack">::resizemethods(sob);
}
public new_anima(string s)	{	.new_object("anima",s);	}
public new_vector(string s)	{	.new_object("vector",s);	}

/***************************************************************************/

class classanfilter	{
	init()	{}
	buildanfilter()	{
		new filter ft;
		ft.link( this.getname() );
		ft.setpivottype(1);
	}
	public build(string san)	{
		<san>.addmethod("buildanfilter","buildanfilter");
		<san>.buildanfilter();
		<san>.addmethod("setopacity",	func {	(int iop) ft.setopacity(iop); }		);
		<san>.addmethod("setzoom",		func {	(real r) ft.setzoom(r); }			);
		<san>.addmethod("setangle",		func {	(real r) ft.setangle(r); }			);
		<san>.addmethod("getangle",		func {	return ft.getangle; }			);
		<san>.addmethod("rotate",		func {	(real r)	ft.rotate(r); }			);
		<san>.addmethod("setpivottype",	func {	(int ityp) ft.setpivottype(ityp); }	);
		<san>.addmethod("unlink",		func {	ft.unlink(); }					);
		<san>.addmethod("link",			func {	ft.link(this); }					);
		<san>.addmethod("blend",		func {	(string s) ft.blend(s); }			);
		<san>.addmethod("mask",		func {	(string s) ft.mask(s); }			);
	}
}

/***************************************************************************/

class classancounter	{
	init()	{
		new int iile;
		new int id;
		new string _san;
		new vector _vs;
		new int _pos;
	}
	set(string sname, int ile)	{
		_san = sname;
		iile = ile;
		id = 0;
		_pos = sname.length();
		_vs.resize( ile, false );
	}
	string get()	{
		string s = _san+id;
		id = (id+1)%iile;
		return s;
	}
	string getf()	{
		for(int i=0; i<iile; i++)	{
			if( !_vs.get(i) )	{
				_vs.set(i, true);
				return _san+i;
			}
		}
		return null;	// brak wolnych
	}
	retf(string s)	{	_vs.set( s.strsubbs( _san ), false );	}
	isfree(int pos)	{	return _vs.get(pos);	}
	int getile()	{	return iile;	}
	bool allfree	{	_vs.vecsum==0; }
}

/**************************************************************/
	// operacje na obrazach, dzwiekach, timerach i animacjach
class gmobjvec {
	init()	{
		new vector lsim;
		lsim.type("string");
	}
	operator=(string sgr)	{
		if( engine.varexist(sgr) )	{
			match(<sgr>.gettype())	{
				"vector" => this.copy(sgr);
				"gmobjvec" => this.copy(sgr);
				"gmimgvec" => this.copy(sgr);
				? => {	this.free(); this.add(sgr); }
			}
		} else {
			this.free();
			this.add(sgr);
		}
	}
	save(string s)	{	lsim.save(s);	}
	load(string s)	{	lsim.load(s);	}
	operator+(string sob)	{	this.add(sob);		return this;	}
	operator-(string sob)	{	this.remove(sob);	return this;	}
	removegr(string sgr)	{	for( int i=0; i < <sgr>.size; i++)	.remove( <sgr>.get(i) );	}
	addtogr(string sgr)	{	for( int i=0; i<this.size(); i++)	<sgr>.add(this.get(i));	}
	addgr(string sgr)	{	for( int i=0; i< <sgr>.size(); i++)	this.add( <sgr>.get(i) );	}
	addgroups	{	.withlist("addgr");	}
	copy(string sgr)	{
		this.free();
		this.addgr(sgr);
	}
	free()	{ lsim.free();	}
	int size()	{ return lsim.size(); }
	bool empty()	{	return this.size()==0;	}
	hash()	{ lsim.hash(); }
	string first()	{ return lsim.get(0); }
	string last()	{ return lsim.get( lsim.size()-1 ); }
	print()	{
		engine.print("");
		engine.print("------ type("+.gettype+") " + this + " ------");
		lsim.print();
		engine.print("------ end ------");
		engine.print("");
	}
	string get(int i)	{ return lsim.get(i); }
	set(int pos, string sval)	{	lsim.set(pos,sval);	}
	add(string simg)	{	lsim.add(simg);	}
	additer(string s, int ifrom, int iile)	{
		while( iile>0 )	{
			.add(s+ifrom);
			ifrom++;
			iile--;
		}
	}
	buildarray(string styp, string sname, int ilosc)	{
		<gameapi.getgamename>.newarray(styp,sname,ilosc);
		.additer(sname,0,ilosc);
	}
	deleteall	{	for( int i=0; i<.size; i++)	delete <.get(i)>;	}
	deleteallgm	{
		@s = gameapi.getgamename;
		for( int i=0; i<.size; i++)	<s>.vardel(.get(i));
	}
	deleteallgmobj	{
		@s = gameapi.getgamename;
		for( int i=0; i<.size; i++)	<s>.deletegmobj(.get(i));
	}
	lockall	{	.eval("lock");	.print;	}
	unlockall	{	.eval("unlock");	}
	addbegin(string simg)	{	lsim.addbegin(simg);	}
	swap(int i, int j)	{	lsim.swap(i,j);	}
	addonce(string simg)	{	if( !lsim.contains(simg) )	lsim.add(simg);	}
	sepadd(string separator)	{
		string s = _;
		while( s!=separator )	{
			this.addbegin(s);
			s = _;
		}
	}
	addlist	{	.sepadd(A);	}
	removelist	{ .withlist("remove");	}
	insertat(string sob, int pos)	{
		@ile = .size;
		if( pos<=0 )	.addbegin(sob);
		else if (pos>=ile)	.add(sob);
		else {
			.add(null);
			for( @i=ile; i>pos; i--)	.set( i, .get(i-1) );
			.set(pos, sob );
		}
	}
	remove(string simg)	{	lsim.remove(simg);	}
	removeat(int pos)		{	lsim.removeat(pos);	}
	removefirst			{	lsim.removeat(0);	}
	removelast			{	lsim.removeat(.size-1);	}
	removealloccurs(string simg)	{	while(this.contains(simg))	this.remove(simg);	}
	removeif(string sfun)	{
		for( int i=0; i<.size; i++)
			if( <.get(i)>.<sfun>() )  .removeat(i);
	}
	int find(string simg)	{ return lsim.find(simg); }
	int contains(string simg)	{ return lsim.contains(simg); }
	addgroup(string sob, int ile)	{	this.addgroup2( sob, 0, ile-1 );	}
	addgroup2(string sob, int ifrom, int ito)	{
		while( ifrom <= ito )	{
			this.add( sob+ifrom );
			ifrom++;
		}
	}
	string rand()	{
		int ile = .size;
		ile>0 ? .get(ile.rand) : null;
	}
	string randdiff(string s)	{
		int ile = .size;
		if( ile>0 )	{
			int id = ile.rand;
			int i = id;
			while( .get(id)==s )	{
				id = (id+1)%ile;
				if( id==i )	return null;
			}
			return .get(id);
		}
		null;
	}
	buildfullvars	{	.each( func { (@id) .buildfullname; } );	}
	buildvars		{	.each( func { (@id) .addtogamevars(this); } );	}
	/******************* metody na obiektach grupy *****************************/
	movefrom(string simg, int x, int y)	{
		int i = this.find(simg);
		if( i>=0 )	{
			while( i<lsim.size() )	{
				<lsim.get(i)>.move(x,y);
				i++;
			}
		}
	}
	move(int x, int y)	{	this.eval2("move",x,y);	}
	setpos(int x, int y)	{	this.eval2("setpos",x,y);	}
	show()	{	this.eval("show");	}
	hide()	{	this.eval("hide");	}
	stop(int fin)	{	this.eval1("stop",fin);	}
	play()	{	this.eval("play");	}
	setdelay(int d)	{	this.eval1("setdelay",d);	}
	isplaying	{
		for( int i=0; i<.size; i++)	if( <.get(i)>.isplaying(-1) ) return true;
		false;
	}
	graddmethod(string sdest, string ssrc)	{	this.eval2("addmethod",sdest,ssrc);	}
	string getimg(int x, int y, int bignorehidden, int bignorealpha)	{
		for( int i=lsim.size()-1; i>=0; i--)	{
			if( <lsim.get(i)>.isin( x,y,bignorehidden,bignorealpha ) )	return lsim.get(i);
		}
		return null;
	}
	int isin(int x, int y, bool bignorehidden, bool bignorealpha)	{
		for( int i=lsim.size()-1; i>=0; i--)	{
			if( <lsim.get(i)>.isin( x,y,bignorehidden,bignorealpha ) )	return i+1;
		}
		return false;
	}
	setframe(def ac, int ifr)	{	this.eval2("setframe",ac,ifr);	}
	setz(int z)	{	this.eval1("setz",z);	}
	/**************/
	eval(string sfunc)	{
		for(int i=0; i<lsim.size(); i++)	{<lsim.get(i)>.<sfunc>();	}
	}
	eval1(string sfunc, def darg)	{
		for(int i=0; i<lsim.size(); i++)	{<lsim.get(i)>.<sfunc>(darg);}
	}
	eval2(string sfunc, def darg1, def darg2)	{
		for(int i=0; i<lsim.size(); i++)	{<lsim.get(i)>.<sfunc>(darg1, darg2);}
	}
	eval3(string sfunc, def darg1, def darg2, def darg3)	{
		for(int i=0; i<lsim.size(); i++)	{<lsim.get(i)>.<sfunc>(darg1, darg2, darg3);}
	}
	int _find(string sfun, def id)	{
		for( int i=0; i<this.size; i++) if ( <this.get(i)>.<sfun>()==id ) return i;
		-1;
	}
	int _find1(string sfun, @id)	{
		for( int i=0; i<.size; i++) if ( <this.get(i)>.<sfun>(id) ) return i;
		-1;
	}
	each(string sfun)	{	for( int i=0; i<.size; i++) <.get(i)>.<sfun>(i);	}
	each1(string sfun, @d1)	{	for( int i=0; i<.size; i++) <.get(i)>.<sfun>(i, d1);	}
	each2(string sfun, @d1, @d2)	{	for( int i=0; i<.size; i++) <.get(i)>.<sfun>(i, d1, d2);	}
	bool ineach(string sfun)	{
		for( int i=0; i<.size; i++) if( !<.get(i)>.<sfun>(i) )	return false;
		true;
	}
	int find_closest(string sob, string sfun)	{
		if( .empty ) return;
		int id = 0, real il;
		real ilen = <.get(0)>.<sfun>(sob);
		for( int i=1; i<.size; i++)	{
			il = <.get(i)>.<sfun>(sob);
			if( il < ilen )	{
				id = i;
				il = ilen;
			}
		}
		id;
	}
	/**************/
	sortimgsfun(string sfun)	{	lsim.vecsort(sfun);	}
	sortimgs()	{	// sortowanie od najmniejszych
		lsim.vecsort("_scmpimg1");
	}
	bool _scmpimg1(string s0, string s1)	{
		return ( <s0>.getz() < <s1>.getz() || ( <s0>.getz()==<s1>.getz() && <s0>.getidobj() < <s1>.getidobj() ) );
	}
}

class gmimgvec : gmobjvec	{
	init()	{
		gmobjvec::init();
		new int _ix = 0;
		new int _iy = 0;
		new int _iz = 0;
		new int _ifound = -1;
		new string sanload = null;
	}
	_setpos(int x, int y)	{	|_ix, _iy| = x,y;	}
	int lodx()	{0;}
	int lody()	{0;}
	int getposx()	{	return _ix;	}
	int getposy()	{	return _iy;	}
	int getpos()	{	return _ix, _iy;	}
	int getpx() {	return _ix;	}
	int getpy() {	return _iy;	}
	int getw()	{	return this.getex()-this.getpx();	}
	int geth()	{	return this.getey()-this.getpy();	}
	int getcx() {	return this.getpx()+this.getw()/2;	}
	int getcy() {	return this.getpy()+this.geth()/2;	}
	int getz()	{	return _iz;	}
	int getex()	{
		int ile = this.size();
		if( ile<=0 )	{	return _ix;	}
		int x = <this.get(0)>.getex();
		int x2;
		for( int i=1; i<ile; i++)	{
			x2 = <this.get(i)>.getex();
			if( x2>x )	{	x=x2;	}
		}
		return x;
	}
	int getey()	{
		int ile = this.size();
		if( ile<=0 )	{	return _iy;	}
		int y = <this.get(0)>.getey();
		int y2;
		for( int i=1; i<ile; i++)	{
			y2 = <this.get(i)>.getey();
			if( y2>y )	{	y=y2;	}
		}
		return y;
	}
	int _getpx()	{
		int ile = this.size();
		if( ile<=0 )	{	return _ix;	}
		int x = <this.get(0)>.getpx();
		int x2;
		for( int i=1; i<ile; i++)	{
			x2 = <this.get(i)>.getpx();
			if( x2<x )	{	x=x2;	}
		}
		return x;
	}
	int _getpy()	{
		int ile = this.size();
		if( ile<=0 )	{	return _iy;	}
		int y = <this.get(0)>.getpy();
		int y2;
		for( int i=1; i<ile; i++)	{
			y2 = <this.get(i)>.getpy();
			if( y2<y )	{	y=y2;	}
		}
		return y;
	}
	int _getw	{	.getex-._getpx;	}
	int _geth	{	.getey-._getpy;	}
	/*minx	{	.find_closest(null, func {(@s) .getpx; } );	}
	miny	{	.find_closest(null, func {(@s) .getpy; } );	}
	countborders	{
		_ix = .minx;
		_iy = .miny;
	}*/
	setz(int z)	{
		_iz = z;
		this.eval1("setz",z);
	}
	move(int x, int y)	{
		_ix +=x;
		_iy +=y;
		this.eval2("move",x,y);
	}
	setpos(int x, int y)	{
		_ix = x;
		_iy = y;
		this.eval2("setpos",x,y);
	}
	setpos2(int x, int y)	{
		_ix = x;
		_iy = y;
		if( !.empty )	{
			x -= <.get(0)>.getpx;
			y -= <.get(0)>.getpy;
			.move(-x,-y);
		}
	}
	changeframe(int ifr) {
		string s;
		for( int i=0; i<.size; i++)	{
			s = .get(i);
			<s>.setframe( <s>.actionnr(-1), ifr );
		}
	}
	nplay(int n)	{	.eval1("play",n);	}
	txtreset	{	for( int i=0; i<.size; i++) <.get(i)>.txtset("");	}
	anputgr()	{	this.eval("anputgr");	}
	anputy(int ypos)	{	this.eval1("anputy", ipos);	}
	int isin(int x, int y, bool bignorehidden, bool bignorealpha)	{
		for( int i=lsim.size()-1; i>=0; i--)	{
			if( <lsim.get(i)>.isin( x,y,bignorehidden,bignorealpha ) )	{
				_ifound=i;
				return i+1;
			}
		}
		_ifound = -1;
		return false;
	}
	int isinfunc(int x, int y, string sfunc)	{
		for( int i=lsim.size()-1; i>=0; i--)	{
			if( <lsim.get(i)>.<sfunc>( x,y ) )	{
				_ifound=i;
				return i+1;
			}
		}
		_ifound = -1;
		return false;
	}
	int isincut(int x, int y, bool bignorehidden, bool bignorealpha)	{
		for( int i=lsim.size()-1; i>=0; i--)	{
			if( <lsim.get(i)>.withincut(x,y) && <lsim.get(i)>.isin( x,y,bignorehidden,bignorealpha ) )	{
				_ifound=i;
				return i+1;
			}
		}
		_ifound = -1;
		return false;
	}
	int findif(string sfunc)	{	._find( sfunc,true);	}
	int getfound()	{	return _ifound;	}
	string getsfound()	{	return this.get(_ifound);	}
	int findfr(int id)	{	._find("framenr", id);	}
	int findsfr(string s)	{	._find("framename", s);	}
	int findac(int id)	{	._find("anactnr", id);	}
	int findsac(string sac)	{	._find("actionname", sac);	}
	int nearest_to(string sob)	{
		//.find_closest(sob, func {(string s) 0->length( .getpx-<s>.getpx, .getpy-<s>.getpy ); } );
		.find_closest(sob, func {(string s) cllen.ilen5(this,s); } );
	}
	string getsac(string sac)	{	.get( .findsac(sac) );	}
	string getsacfr(string sac, int fr)	{	for(int i=0; i<.size; i++) if( <.get(i)>.actionname==sac && <.get(i)>.framenr==fr ) return .get(i); null; }
	/*def find_min(string s)	{
		if( .empty ) return;
		int x = <s>.getpx;
		int y = <s>.getpy;
		int id = 0, int il;
		int ilen = id.length( <.get(0)>.getpx-x, <.get(0)>.getpy-y );
		for( int i=1; i<.size; i++)	{
			il = id.length( <.get(i)>.getpx-x, <.get(i)>.getpy-y );
			if( il < ilen )	{
				id = i;
				il = ilen;
			}
		}
	}*/
	blitto(string simg)	{	for( int i=0; i<.size; i++)	<simg>.blit(.get(i));	}
	sortz(int z)	{	for( int i=0; i<.size; i++) <.get(i)>.setz(z+i);	}
	/****************************/
	ancopies(string san, int ile)	{
		for( int i=0; i<ile; i++)	{
			<GAME>.copyanima(san, san+"_"+i);
			.add(san+"_"+i);
		}
	}
	loadallan(string sname, string sfile, int z)	{
		string s = gameapi.getgamename();
		<s>.newanima(sname,sfile,z);
		_ = <s>.newanfrbyactgr(sname, sname, this);
		<sname>.hide();
	}
	addsrcanima(string san)	{	.var2("srcanima", san);	}
	operator*(string s)	{
		string sg = gameapi.getgamename;
		string san;
		if ( s.contains(".pyz") ) {
			if( s.getb(0,1)=="$" )	{
				new vector _vtmp; _vtmp.type("string");
				_vtmp.vecbuildfromstring(s, "/");
				san = "an" + _vtmp.last->strsubes(".pyz");
				delete _vtmp;
			} else {
				san = "an" + s.strsubes(".pyz");
			}
			<sg>.newanima(san,s,0);
		} else san = s;
		sanload = san;
		_ = <sg>.newanactionsgr(san, san, this);
		<san>.hide();
		.addsrcanima(san);
	}
	operator<(string s)	{
		string sg = gameapi.getgamename;
		string san;
		if ( s.contains(".pyz") ) {
			san = "an" + s.strsubes(".pyz");
			<sg>.newanima(san,s,0);
		} else san = s;
		sanload = san;
		_ = <sg>.newanfrbyactgr(san, san, this);
		<san>.hide();
		.addsrcanima(san);
	}
	deleteloaded	{
		.deleteallgm;
		if( sanload!=null ) <gameapi.getgamename>.vardel(sanload);
	}
	deleteinit	{
		@s = gameapi.getgamename;
		for( int i=0; i<.size; i++)	{
			@s2 = .get(i);
			if( <s2>.gettype=="gmimgvec" )	{
				<s2>.deleteinit;
			}
			<s>.vardel(s2);
		}
		if( sanload!=null ) <gameapi.getgamename>.vardel(sanload);
	}
}

class gmadvvec : gmimgvec	{
	init	{	gmimgvec::init;	}
	int butisin(int x, int y, bool bignorehidden, bool bignorealpha)	{
		for( int i=lsim.size()-1; i>=0; i--)	{
			if( <lsim.get(i)>.butisin( x,y,bignorehidden,bignorealpha ) )	{
				_ifound=i;
				return i+1;
			}
		}
		_ifound = -1;
		return false;
	}
}

class gmmaskvec : gmadvvec	{
	init()	{	gmadvvec::init;	}
	int butisin(int x, int y, bool bigvis, bool bigalpha)	{	gmimgvec::butisin(x,y,false,bigalpha);	}
}




new int igmsubtitle = 0;
class Subtitle	{
	init(string sdbfile, string spath, string sfont, int ifont, int borx, int bory)	{
		real rwidth = 0.5;
		int col[3];	// kolor fonta
		col0 = 255;
		col1 = 255;
		col2 = 255;
	
		new int iborx = borx;
		new int ibory = bory;
		
		new font fnt;
		fnt.load(sfont, ifont);
		new int ifontsize = ifont;
		
		new db dbl;
		dbl.load("lang/"+sdbfile);
		string s;
		string s2;
		new vector v1;	v1.type("string");
		int cols = (iResX-2*borx)/(rwidth*ifont+1);
		int k, int j;
		int linie = 0;
		for( int i=0; i<dbl.getrowsno; i++)	{
			dbl.set( i, 0, spath + dbl.get(i,0)+".wav" );
			s = dbl.get(i,1);
			v1.vecbuildfromstring(s, " ");
			s2 = "";
			k = 1;
			for( j=0; j<v1.size; j++)	{
				if( s2.length + v1.get(j)->length + 1 <= cols )	s2 += " " + v1.get(j);
				else {
					if( k==1 )	dbl.set(i, k, s2);
					else dbl.add(i, s2);
					s2 = v1.get(j);
					k++;
				}
			}
			if( k==1 )	dbl.set(i, k, s2);
			else dbl.add(i, s2);
			if( k>linie ) linie = k;
		}
		
		new gmimgvec grtxt;
		for( int i=0; i<linie; i++)	{
			s = "txt"+i;
			s2 = "txts"+i;
			classgame::newtext(s2,"","fnt",.black);
			classgame::newtext(s,"","fnt",col0, col1, col2);
			grtxt.add(s);
			grtxt.add(s2);
		}
		
		new db dbsnd;
		new timer timtxt;
		timtxt.settick(1);
		timtxt.setcycle(1);
		timtxt.addmethod("onfinish", func {
			if( !.cisplaying )	.hidesubs;
			else .play;
			} );
		.setz(12000);
	}
	reset	{
		.stop;
		dbsnd.free;
	}
	hidesubs	{
		grtxt.hide;
	}
	setz(int z)	{
		grtxt.setz(z);
	}
	stop	{
		.hidesubs;
		timtxt.stop(false);
	}
	register(string ssnd, string sfile)	{
		@id = dbl.findbyrow(sfile);
		if( id>=0 )	{
			@r = dbsnd.findbyrow(ssnd);
			if( r>=0 )	dbsnd.set(r, 1, id);
			else {
				@r = dbsnd.addrow-1;
				dbsnd.add(r, ssnd);
				dbsnd.add(r, id);
			}
		}
		//("register "+ssnd+" "+sfile+" "+id)->print;
	}
	play(string s)	{
		.stop;
		@id = dbsnd.findbyrow(s);
		if( id>=0 )	{
			id = dbsnd.get(id, 1);
			@ile = dbl.getcolsno(id)-1;
			string s[2], int i2;
			grtxt.setpos(0,0);
			int dy = 2;
			for( int i=0; i<ile; i++)	{
				i2 = 2*i;
				s0 = grtxt.get(i2);
				<s0>.txtset(dbl.get(id, i+1));
				s1 = grtxt.get(i2+1);
				<s1>.txtset(<s0>.get);
				<s0>.setpos( (iResX-<s0>.getw)/2, i*ifontsize + dy );
				<s0>.show;
				<s1>.setpos(<s0>.getpx+1, <s0>.getpy+1);
				<s1>.show;
			}
			grtxt.move( 0, iResY - ile*(ifontsize+dy)-ibory );
			timtxt.play;
		}
	}
}

if( igmsubtitle )	{
	new Subtitle subtitle("eng_egipt.db", "sounds/", sgmfontbold, 24, 50, 15);
}

class classsound {
	init()	{
		new string _csplay = null;
		if( igmsubtitle )	{
			subtitle.reset;
		}
	}
	creset()	{ _csplay = null; }
	string cgetactsnd()	{ return _csplay; }
	crselfplay(string ssnd)	{
		if( !this.cisplaying() )	this.cbplay(ssnd);
		else if ( this.cgetactsnd()!=ssnd )	this.cbplay(ssnd);
	}
	cbselfplay(string ssnd)	{
		if( !.cisplaying || .cgetactsnd!=ssnd )	.cbplay(ssnd);
	}
	cbplay(string ssnd)	{
		if(this.cisplaying())	<_csplay>.stop(true);
		_csplay = ssnd;
		if( ssnd!=null )
			.csubplay(ssnd);
		//	<ssnd>.play();
	}
	cbsplay(string ssnd)	{
		_csplay = ssnd;
		if( ssnd!=null)	.csubplay(ssnd);
	}
	cbplayfin(string ssnd, string sfun)	{
		<ssnd>.addmethod("onfinish", sfun);
		.cbplay(ssnd);
	}
	cbplay2(string ssnd)	{
		if(this.cisplaying())	<_csplay>.stop(false);
		_csplay = ssnd;
		if( ssnd!=null )
			.csubplay(ssnd);
		//	<ssnd>.play();
	}
	crplay(string ssnd)	{
		if(_csplay!=null && <_csplay>.isplaying() )	return;
		_csplay = ssnd;
		if( ssnd!=null )
			.csubplay(ssnd);
		//	<ssnd>.play();
	}
	cbplayif(string ssnd)	{
		if(.cisplaying)
			.cbplay(ssnd);
	}
	crbgplay(string ssnd)	{
		if( ssnd != null && !<ssnd>.isplaying() )
			.csubplay(ssnd);
			//<ssnd>.play();
	}
	crandplay(string ssnd, int irand, string styp)	{
		if( irand.rand()==0 )	this.<"c"+styp+"play">( ssnd );
	}
	cplayf(string styp, string ssnd, string sfun)	{
		this.<"c"+styp+"play">(ssnd);
		if( <ssnd>.isplaying() && sfun!=null)	<ssnd>.addmethod("onfinish",sfun);
	}
	//cactsndstop(bool bfin)	{	if(_csplay!=null)	<_csplay>.stop(bfin);	}
	cactsndstop(bool bfin)	{
		if(.cisplaying)	<_csplay>.stop(bfin);
	}
	cstopsnds(bool b)	{
		if( _csplay.in && .cisplaying )
			.cactsndstop(b);
	}
	bool cisplaying()	{	_csplay!=null ? <_csplay>.isplaying() : false;	}
	csubplay(string s)	{
		if( igmsubtitle )	{
			subtitle.play(s);
		}
		<s>.play;
	}
}

/***************************************************************************/
class classsndbank	{
	init()	{
		new int itype;
		new int ilicz = 0;
		new int iile;
		new string splay=null;
		new string ssnd = "snd";
	}
	/********************************/
	loadsingle(string sfile, int ile)	{
		if( ile<=0)	{	iile=0;	return;	}
		iile=ile;
		itype=0;
		for( int i=0; i<ile; i++)	newvars::newsnd( ssnd+i, sfile );
	}
	/********************************/
	load(string sfilebase, int ifilefrom, int ifileto, int ityp, int itypstart)	{
		iile = ifileto-ifilefrom+1;
		if(iile<=0)	{
			iile = 0;
			return;
		}
		newvars::newsnds( ssnd, 0, sfilebase, ifilefrom, ifileto);
		itype = ityp;			// 0 - po kolei, 1 - random
		if(itypstart==1)	{	// 0 - od pierwszego, 1 - randomowy
			ilicz = iile.rand( );
		}
	}
	addmethod(string ssig, string sfunc)	{
		for( int i=0; i<iile; i++)	<ssnd+i>.addmethod( ssig, sfunc );
	}
	stop(int ifin)	{	if(splay!=null)	<splay>.stop(ifin);	}
	int isplaying()	{	splay!=null ? <splay>.isplaying() : false;	}
	randplay( int irand )	{	if( irand.rand()==0 )	this.play();	}
	playid(int id)	{
		ilicz=id%iile;
		this.play();
	}
	play()	{
		this.stop(false);
		this.bgplay();
	}
	reset()	{	ilicz=0;	}
	/************************************************/
	rbgplay()	{	if( !this.isplaying() )	this.bgplay();	}
	rplay()	{	if( !this.isplaying() )	this.play();	}
	bgplay()	{
		splay = ssnd + ilicz;
		<splay>.play();
		if( itype==0)	ilicz = (ilicz+1)%iile;
		else if (itype==1)	ilicz = iile.rand();
	}
	setvol(int vol)	{	for( int i=0; i<iile; i++)	<ssnd+i>.setvol( vol );	}
}

class SoundSource	{
	init	{	}
	setvol(string ssnd, int srcvol, int outvol, real rad, real length)	{
		if( length.abs>=rad ) <ssnd>.setvol(outvol);
		else <ssnd>.setvol((1.0-length.abs/rad)*srcvol + outvol);
	}
}

/**************************************************************/
	// standardowe czynnosci przy grach, popakowane w metody
class classgame : newvars , classsound {
	init()	{
		newvars::init();
		classsound::init();
		new int _iconstid;
		new gmobjvec _grsfxs;
	}
	/**************************************************************/
	bkg=(@sfile)	{
		if( sfile.contains(".pyz") ) .newanima("anbkg", sfile, 0);
		else .newimg("imgbkg",sfile,0);
	}
	bgr=(@sfile)	{
		//this.csndplayloop("sndbgr",sfile);
		.csndbgr(sfile);
	}
	path=(@s)	{	.setgraphpath("scripts/"+s+"/");	}
	cycle=(@stimer, @sfun)	{	.cnewtimercyclefin(stimer,1,1,sfun);	}
	timer=(@stimer, @itime, @sfun) { .cnewtimerfin(stimer,itime,1,sfun);	}
	def _getflags(string s)	{
		@bloop = false;
		if( s.contains("L") )	{
			s.strremove("L");
			bloop=true;
		}
		@bplay = false;
		if( s.contains("P") )	{
			s.strremove("P");
			bplay=true;
		}
		@bhide = false;
		if( s.contains("H") )	{
			s.strremove("H");
			bhide=true;
		}
		return s,bloop,bplay,bhide;
	}
	img=(@sfile)	{
		_ = ._build_img(sfile);
	}
	getlangfile(string s)	{
		@s2 = s.strsube(4) + "_" + LANG + s.gete(0,4);
		engine.fileexist( .getpath(s2) ) ? s2 : s;
	}
	_build_img(@sfile)	{
		|sfile,@bloop,@bplay,@bhide| = ._getflags(sfile);
		bool bgroup = false;
		if(sfile.contains("G"))	{
			sfile.strremove("G");
			bgroup = true;
		}
		@iz = 0;
		if( sfile.contains(" ") )	{
			iz = sfile.strgetfrom(" ");
			sfile = sfile.strgetto(" ");
		}
		string sname;
		if( sfile.contains("/") ) {
			new vector _v_sfile;
			_v_sfile.type("string");
			_v_sfile.vecbuildfromstring(sfile,"/");
			sname = _v_sfile.last->strsube(4);
			delete _v_sfile;
		} else sname = sfile.strsube(4);
		string s;
		if( sfile.contains(".pyz") ) {
			if( bgroup )	{
				s = "gr"+sname;
				.newgrimg(s, .getlangfile(sfile)->strsubes(".pyz"), iz);
			} else {
				s = "an" + sname;
				.newanima(s, .getlangfile(sfile), iz);
			}
		} else {
			s = "img" + sname;
			.newimg(s, .getlangfile(sfile), iz);
		}
		if( bloop ) <s>.anloopfin;
		if( bplay ) <s>.play(-1);
		if( bhide ) <s>.hide;
		s;
	}
	imgsgr=	{
		string sgr = _;
		string simg;
		new gmimgvec <sgr>;
		@s = _;
		while( A != s )	{
			<sgr>.add(._build_img(s));
			@s = _;
		}
	}
	imgs=	{	.withlist("img=");	}
	clone(string sob)	{
		<gameapi.getgamename> (this, .gettype, sob) { (@sthis, @styp, @sob)
			new <styp> <sob>;
			<sob>.copy(sthis);
		};
	}
	clones=	{	.withlist("clone");	}
	list=(@sname)	{
		@s=_;
		new gmobjvec <sname>;
		while(A!=s)	{
			<sname>.addbegin(s);
			s = _;
		}
	}
	list2={
		@s = .newconst("gmobjvec");
		.list=(s);
		s;
	}
	debug=(@b)	{	engine.setdebugstate(b);	}
	sfx=(string s)	{
		bool bloop2 = s.contains("N");
		if( bloop2 )	{
			s.strremove("N");
		}
		|s,@bloop,@bplay,_| = ._getflags(s);
		@ivol = 100;
		if( s.contains(" ") )	{
			ivol = s.strgetfrom(" ");
			s = s.strgetto(" ");
		}
		string sf = "fx"+s;
		//.newsnd(sf, "sfx/"+s+".wav");
		.newsfx( sf, s+".wav");
		<sf>.setvol( ivol );
		if( bloop ) <sf>.addmethod("onfinish","_stdsndloop");
		if( bplay ) <sf>.play;
		else if( bloop2 ) <sf>.playloop;
		_grsfxs.add(sf);
	}
	sfxs=	{	.withlist("sfx=");	}
	snd=(string sname, string sfile, string sfun)	{
		.newsndfree(sname, sfile + ".wav");
		<sname>.addmethod("onfinish", sfun);
	}
	tickstart	{
		if( !.hasvar("__timspeed") )	new TicksCounter __timspeed;
		__timspeed.start;
	}
	tickstop	{	__timspeed.print("ticker: ");	}
	/**************************************************************/
	csndplayloop(string ssnd, string sfile)	{
		this.newsndloop(ssnd,sfile);
		<ssnd>.play();
	}
	csndbgr(string sfile)	{
		//this.csndplayloop("sndbgr",sfile);
		.newbgr("sndbgr", sfile );
		.sndplayloop("sndbgr");
	}
	cloadcursor(string sfile)	{
		if( sfile.contains(".") )	{
			.newimg("imgkursor", sfile,0);
			sfile = "imgkursor";
		}
		<sfile>.hide();
		mouse.setcursor(sfile);
		engine.stdbutcursor(sfile);
		bsms.setown();
	}
	/****************************************************************/
	newimgarray(string sname, string styp, string sn, int ile)	{
		new gmimgvec <sname>;
		<sname>.buildarray(styp,sn,ile);
	}
	newfont(string sfnt, string sfile, int isize)	{
		new font <sfnt>;
		<sfnt>.load( sfile, isize );
	}
	monofont(string sfnt, int isize)	{	.newfont(sfnt, sgmfontmono, isize);	}
	newfontbold(string sfnt, int isize)	{	.newfont(sfnt, sgmfontbold, isize);	}
	string snewfont(string sfontfile, int isize)	{
		string s = .newconst("font");
		<s>.load( sfontfile, isize );
		return s;
	}
	string stdfont(int isize)	{	.snewfont( sgmfontfile, isize	);	}
	string stdmono(int isize)	{	.snewfont( sgmfontmono, isize);	}
	string stdbold(int isize)	{	.snewfont( sgmfontbold, isize);	}
	int getconstid	{	_iconstid++;	_iconstid-1;	}
	string newconst(string styp)	{
		string s = "const"+styp+.getconstid;
		new <styp> <s>;
		return s;
	}
	string consttext(string stext, int x, int y, int isize, int r, int g, int b)	{
		string s = this.newconst("text");
		string sf = .stdfont(isize);
		<s>.setfont(sf);
		<s>.set(stext);
		<s>.createtxt(r,g,b);
		<s>.setpos(x,y);
		return s;
	}
	newtext(string stxt, string stext, string sfont, int r, int g, int b)	{
		new text <stxt>;
		<stxt>.set(stext);
		<stxt>.setfont(sfont);
		<stxt>.createtxt(r,g,b);
	}
	newtextposz(string stxt, string stext, string sfont, int r, int g, int b, int x, int y, int z)	{
		.newtext(stxt,stext,sfont,r,g,b);
		<stxt>.anposz(x,y,z);
	}
	newgrimg(string sgr, string sfile, int z)	{
		new gmimgvec <sgr>;
		sgr .* (sfile+".pyz");
		<sgr>.setz(z);
	}
	/****************************************************************/
	cfinmethod(string sobj, string sfuncfin)	{	<sobj>.addmethod("onfinish", sfuncfin);	}
	cnewsndfin(string sname, string sfile, string sfunc)	{
		this.newsnd(sname,sfile);
		this.cfinmethod(sname,sfunc);
	}
	cnewsndsfin(string sbase, int inamestart, string sfilebase, int ifilefrom, int ifileto, string sfunc)	{
		this.newsnds(sbase, inamestart, sfilebase, ifilefrom, ifileto);
		this.caddobjsfunfin(sbase, inamestart, inamestart+( ifileto-ifilefrom), sfunc);
	}
	cnewsndfinbplay(string sname, string sfile, string sfunc)	{
		this.cnewsndfin(sname,sfile,sfunc);
		this.cbplay(sname);
	}
	cnewtimerfin(string sname, int idelay, int iticks, string sfunc)	{
		this.newtimer(sname,idelay,iticks);
		this.cfinmethod(sname,sfunc);
	}
	cnewtimercyclefin(string sname, int icycle, int iticks, string sfunc)	{
		this.newtimercycle(sname,icycle,iticks);
		this.cfinmethod(sname,sfunc);
	}
	/****************************************************************/
	caddobjsfun(string ssnd, int ifrom, int ito, string ssig, string sfunc)	{
		while( ifrom <= ito )	{
			<ssnd+ifrom>.addmethod( ssig, sfunc+ifrom );
			ifrom++;
		}
	}
	caddobjsfunfin(string ssnd, int ifrom, int ito, string sfunc)	{
		this.caddobjsfun( ssnd, ifrom, ito, "onfinish", sfunc );
	}
	/****************************************************************/
	newancounter(string scounter, string sname, string sfile, int z, int ile)	{
		this.newanimas( sname, sfile, z, ile);
		new classancounter <scounter>;
		<scounter>.set( sname, ile );
	}
	newancounterh(string scounter, string sname, string sfile, int z, int ile)	{
		this.newancounter( scounter, sname, sfile, z , ile );
		for( int i=0; i<ile; i++)	<sname+i>.hide();
	}
	newancounterf(string scounter, string sname, string sfile, int z, int ile, string sfun)	{
		this.newancounter( scounter, sname, sfile, z , ile );
		for( int i=0; i<ile; i++)	<sname+i>.addmethod("onfinish", sfun);
	}
	newancounterhf(string scounter, string sname, string sfile, int z, int ile, string sfun)	{
		this.newancounter( scounter, sname, sfile, z , ile );
		for( int i=0; i<ile; i++)	{
			<sname+i>.addmethod("onfinish", sfun);
			<sname+i>.hide();
		}
	}
	cnewanimafin(string sname, string sfile, int z, string sfunc)	{
		this.newanima(sname, sfile, z);
		<sname>.addmethod("onfinish", sfunc );
	}
	ccopyanimafin(string sname, string snew, string sfunc)	{
		this.copyanima(sname, snew);
		<snew>.addmethod("onfinish", sfunc );
	}
	/****************************************************************/
	cloadwavs(string sdb, string sfile)	{
		this.newdb( sdb, sfile );
		int id = 0;
		int ile = <sdb>.getrowsno();
		int i[6], string s[5];
		while( id < ile )	{
			i1 = <sdb>.getcolsno(id);
			i2 = 0;
			s1 = <sdb>.get( id, i2 );	i2++;
			if( s1.getb(0,1)!="#" )	{
				s3 = <sdb>.get( id, i2 );	i2++;
				if( s1=="wav" || s1=="sfx" )	{
					s2 = <sdb>.get( id, i2 );	i2++;
					if( s1=="sfx")	{
						this.newsfx( s3, s2 );
					} else { this.newsnd( s3, s2 ); }
					if( i2 < i1 )	{
						s1 = <sdb>.get( id, i2 );	i2++;
						s2 = <sdb>.get( id, i2 );	i2++;
						if( s1=="method" )	{
							<s3>.addmethod("onfinish", s2 );
						} else if (s1.gete(0,4)=="play")	{
							this.<"c"+s1.gete(4,10)+"playonfin">(s3, s2);
						} else if ( s1=="vol" )	{
							<s3>.setvol( s2 );
						}
					}
				} else if (s1=="group")	{
					s2 = <sdb>.get( id, i2 );	i2++;
					i3 = <sdb>.get( id, i2 );	i2++;
					i4 = <sdb>.get( id, i2 );	i2++;
					if( i2 < i1 )	{		// jest method
						s1 = <sdb>.get( id, i2 );	i2++;
						if( s1=="method" )	{
							s4 = <sdb>.get( id, i2 );	i2++;
							this.cnewsndsfin( s3, i3, s2, i3, i4, s4 );
						}
					} else {
						this.newsnds( s3, i3, s2, i3, i4 );
					}
				} else if (s1=="bank")	{
					s2 = <sdb>.get( id, i2 );	i2++;
					i0 = <sdb>.get( id, i2 );	i2++;
					i3 = <sdb>.get( id, i2 );	i2++;
					i4 = <sdb>.get( id, i2 );	i2++;
					i5 = <sdb>.get( id, i2 );	i2++;
					new classsndbank <s3>;
					<s3>.load( s2, i0, i3, i4, i5);
					if( i2<i1)	{
						s1 = <sdb>.get( id, i2 );	i2++;
						if( s1=="method")	{
							s4 = <sdb>.get( id, i2 );	i2++;
							<s3>.addmethod( "onfinish", s4 );
						} else if (s1=="vol")	{
							<s3>.setvol( <sdb>.get( id, i2 ) );
						}
					}
				} else if ( s1=="method" )	{
					s2 = <sdb>.get( id, i2 );	i2++;
					i3 = <sdb>.get( id, i2 );	i2++;
					i4 = <sdb>.get( id, i2 );	i2++;
					while( i3<=i4)	{
						<s2+i3>.addmethod("onfinish", s3);
						i3++;
					}
				} else if ( s1=="singlebank")	{
					s2 = <sdb>.get( id, i2 );	i2++;
					i3 = <sdb>.get( id, i2 );	i2++;
					new classsndbank <s3>;
					<s3>.loadsingle( s2, i3 );
				} else if ( s1=="bgr" )	{
					this.csndbgr( s3 );
					if( i2 < i1 )	{
						if( <sdb>.get( id, i2 )=="vol" )	{
							i2++;
							sndbgr.setvol( <sdb>.get( id, i2 ) );
							i2++;
						}
					}
				} else if ( s1=="music" )	{
					this.playmusic( s3 );
					if( i2 < i1 )	{
						if( <sdb>.get( id, i2 )=="vol" )	{
							i2++;
							sndbgr.setvol( <sdb>.get( id, i2 ) );
							i2++;
						}
					}
				}
			}
			id++;
		}
	}
	/****************************************************************/
	crestart()	{	gameapi.play( gameapi.getgamename() );	}
	/****************************************************************/
	cgetscreenshoot(string sfile)	{
		new img _imgsavebkg;
		_imgsavebkg.create(iResX,iResY,.white,255);
		_imgsavebkg.setz(2000);
		_imgsavebkg.blitscreen;
		new filter _ftbg;
		_ftbg.link("_imgsavebkg");
		_ftbg.setsmooth(1);
		real rzoom = 0.3;
		_ftbg.setzoom(rzoom);
		_imgsavebkg.setpos(0,0);
		
		new img _im_1;
		_im_1.create(rzoom*iResX, rzoom*iResY, .white,255);
		_im_1.setpos(_imgsavebkg.getpx, _imgsavebkg.getpy);
		_im_1.blit("_imgsavebkg");
		
		_im_1.save(sfile);
		
		delete _im_1;
		_ftbg.unlink;
		delete _ftbg;
		delete _imgsavebkg;
	}
}


/***************************************************************************/

class clfindfunc	{
	init()	{}
	int _stdfindfunc(string sobj, int ifirst, int ilast, string sname, string sfunc)	{	
		while(ifirst<=ilast)	{
			if( <sobj + ifirst>.<sfunc>() ==sname )	return ifirst;
			ifirst++;
		}
		-1;
	}
	int _stdfindfunc2(string sobj, int iile, string sname, string sfunc)	{	
		._stdfindfunc(sobj, 0, iile-1, sname, sfunc);
	}
	/****************************************************************/
	cfindandeval2(string sobj, int iile, string sname, string sfunc, string seval)	{	
		.cfindandeval(sobj, 0, iile-1, sname, sfunc, seval);
	}
	cfindandeval(string sobj, int ifirst, int ilast, string sname, string sfunc, string seval)	{	
		int pos = ._stdfindfunc(sobj, ifirst, ilast, sname, sfunc);
		if(pos>=0)	<sobj+pos>.<seval>();
	}
}



/*****************************************************************/
class classbutton 	{
	init()	{
		new string san = "anbut";
		new string sbut = "but";
		new int iilebut = 0;
		new string sfxmon = null;
	}
	_cbuildbutname(string sname)	{	new string _sbutname=sname; }
	string cgetbutname()	{ return _sbutname; }
	build(string sfile, int z, string smouse)	{this.build2(sfile,z,smouse,null);	}
	build2(string sfile, int z, string smouse, string sgrp)	{	// wczytuje animacje i buduje z niej przyciski
		string smain = "_" + san;
		new anima <smain>;
		<smain>.load( sfile );
		<smain>.setz(z);
		int ile = <smain>.nofactions();
		int j;	int k;
		int iliczans = 0;
		string sn1, string sn2, string sn3;
		string spom;
		for(int i=0; i<ile; i++)	{
			sn1 = null;	sn2 = null;	sn3 = null;
			j = <smain>.nofframes(i);
			for(k=1; k<=j; k++)	{
				spom = san + iliczans;
				if(k==1)	{	sn1=spom; } 
				else if (k==2)	{ sn2 = spom; }
				else if (k==3)	{ sn3 = spom; }
				newvars::copyanima( smain, spom );
				<spom>.setframe( i, k-1 );
				iliczans++;
			}
			if( sgrp!=null && <sgrp>.contains( <smain>.nameofaction(i)) ) {
				<sn1>.setz(z-1);
			} else this.addbut(sn1, sn2, sn3, smouse);
		}
		<smain>.hide();
	}
	/***************************** \/ \/ \/ \/ \/ wewnetrzne \/ \/ \/ \/ \/ *************************************************/
	_buildfuncclick( string sname )	{	new string _sfunclick = sname; }
	_stdbutclick()	{	this.<_sfunclick>( this.getbutname() );		}
	_buildfuncrel( string sname )	{	new string _sfuncrel = sname; }
	_stdbutrel()	{	this.<_sfuncrel>( this.getbutname() );	}
	_buildfuncmovon( string sname )	{	new string _sfunmovon = sname; }
	_stdbutmovon()	{
		if( sfxmon!=null )	<sfxmon>.play();
		this.<_sfunmovon>( this.getbutname() );
	}
	_buildfuncmovoff( string sname )	{	new string _sfunmovoff = sname; }
	_stdbutmovoff()	{	this.<_sfunmovoff>( this.getbutname() );	}
	butsigfun(string sb, string sfunc, string ssig, string sfun1, string sfun2)	{
		if( sfunc==null )	return;
		<sb>.addmethod(sfun1, sfun1);
		<sb>.<sfun1>( sfunc );
		<sb>.addmethod(ssig, sfun2);
	}
	sigfunc(string sfunc, string ssig, string sfun1, string sfun2)	{
		for(int i=0; i<iilebut; i++)	this.butsigfun(sbut + i, sfunc, ssig, sfun1, sfun2);
	}
	print()	{for(int i=0; i<iilebut; i++)	engine.print( <sbut+i>.getbutname() );}
	setrect()	{
		string s;
		for( int i=0; i<iilebut; i++)	{
			s = <sbut+i>.getimg;
			<sbut+i>.setrect( <s>.getpx, <s>.getpy, <s>.getex, <s>.getey );
		}
	}
	setflags(bool bvis, bool balph)	{	for(int i=0; i<iilebut; i++)	<sbut+i>.setflags(bvis,balph);	}
	/***************************** /\ /\ /\ /\ /\ wewnetrzne /\ /\ /\ /\ /\ ************************************************/
	sfxonmovon(string ssnd)	{	sfxmon=ssnd;	}
	clickfunc(string sfunc)	{this.sigfunc(sfunc,"onclick", "_buildfuncclick", "_stdbutclick");	}
	relfunc(string sfunc)	{this.sigfunc(sfunc,"onrel", "_buildfuncrel", "_stdbutrel");	}
	movonfunc(string sfunc)	{this.sigfunc(sfunc,"onmoveon", "_buildfuncmovon", "_stdbutmovon");	}
	movofffunc( string sfunc)	{this.sigfunc( sfunc,"onmoveoff", "_buildfuncmovoff", "_stdbutmovoff");}
	/*****************************************************************/
	int ilebuts()	{	return iilebut;	}
	/*****************************************************************/
	int ifind(string sname)	{return clfindfunc::_stdfindfunc2(sbut, iilebut, sname, "getbutname");	}
	string sfind(string sname)	{
		int pos = clfindfunc::_stdfindfunc2(sbut, iilebut, sname, "getbutname");
		return pos>=0 ? sbut+pos : null;
	}
	/*****************************************************************/
	_cbutfun(string sname, string sfunc)	{
		clfindfunc::cfindandeval2(sbut, this.ilebuts(), sname, "getbutname", sfunc );
	}
	_callbutfunc(string sfunc)	{	for(int i=0; i<iilebut; i++)	<sbut+i>.<sfunc>();	}
	_cibutfunc(string sfunc, int ile)	{
		if( ile > iilebut )	ile = iilebut;
		for(int i=0; i<ile; i++)	<sbut+i>.<sfunc>();
	}
	ienable( int ile )	{	this._cibutfunc("enable", ile);	}
	benableall()	{	this.resumeall();	this.enableall();	}
	pauseall()	{	this._callbutfunc("pause");	}
	resumeall()	{	this._callbutfunc("resume");	}
	enableall()	{	this._callbutfunc("enable");	}
	disableall()	{	this._callbutfunc("disable");	}
	disabled	{	<sbut+0>.disabled;	}
	
	benable(string sname)	{	this.resume(sname);	this.enable(sname);	}
	disable(string sname)	{	this._cbutfun( sname, "disable");	}
	enable(string sname)	{	this._cbutfun( sname, "enable");	}
	pause(string sname)	{	this._cbutfun( sname, "pause");	}
	resume(string sname)	{	this._cbutfun( sname, "resume");	}
	
	resetall()	{	for(int i=0; i<iilebut; i++)	<sbut+i>.setcursorpos(0, 0);	}
	setcursorpos(int x, int y)	{	for(int i=0; i<iilebut; i++)	<sbut+i>.setcursorpos(x, y);	}
	/*****************************************************************/
	string getimg(string sname)	{
		string s= this.sfind(sname);
		return s!=null ? <s>.getimg() : null;	
	}
	callimgfun(string sname, string sfun)	{	<.getimg(sname)>.<sfun>;	}
	/*****************************************************************/
	newmouse(string sname, string snewmouse)	{
		string s = this.sfind(sname);
		if(s!=null)	<s>.setmouse( snewmouse );
	}
	addbut(string san1, string san2, string san3, string smouse)	{
		string spom = sbut + iilebut;
		newvars::newbutan( spom, san1, san2, san3, smouse);
		<spom>.addmethod("getbutname","cgetbutname");
		<spom>._cbuildbutname( <san1>.actionname() );	// nazwa buttonu to nazwa akcji
		iilebut++;
	}
	/*****************************************************************/
	_addfunc(string s, string sfclick, string sfrel, string sfmvon, string sfmvoff)	{
		if( s== null)	return;
		this.butsigfun( s, sfclick, "onclick", "_buildfuncclick", "_stdbutclick");
		this.butsigfun( s, sfrel, "onrel", "_buildfuncrel", "_stdbutrel");
		this.butsigfun( s, sfmvon, "onmoveon", "_buildfuncmovon", "_stdbutmovon");
		this.butsigfun( s, sfmvoff, "onmoveoff", "_buildfuncmovoff", "_stdbutmovoff");
	}
	addfuncto(string sname, string sfclick, string sfrel, string sfmvon, string sfmvoff)	{
		this._addfunc( this.sfind(sname), sfclick, sfrel, sfmvon, sfmvoff);
	}
	addfunctolast(string sfclick, string sfrel, string sfmvon, string sfmvoff)	{
		this._addfunc( sbut + (iilebut-1) , sfclick, sfrel, sfmvon, sfmvoff);
	}
	/*****************************************************************/
	_transmet(string sob, string sfunc, string smet, string s)	{
		new string <"_sob" + s> = sob;
		new string <"_sf" + s> = sfunc;
		this.<smet>( "_trf"+s );
	}
	transclickfunc(string sob, string sfunc)	{this._transmet( sob, sfunc, "clickfunc", "cl" );	}
	transrelfunc(string sob, string sfunc)	{this._transmet( sob, sfunc, "relfunc", "rl" );	}
	transmovonfunc(string sob, string sfunc){this._transmet( sob, sfunc, "movonfunc", "mn" );	}
	transmovofffunc(string sob, string sfunc){this._transmet( sob, sfunc, "movofffunc", "mf" );	}
	_trfcl(string s)	{	<_sobcl>.<_sfcl>(s);		}
	_trfrl(string s)	{	<_sobrl>.<_sfrl>(s);		}
	_trfmn(string s)	{
		if( sfxmon!=null )	<sfxmon>.play();
		<_sobmn>.<_sfmn>(s);
	}
	_trfmf(string s)	{	<_sobmf>.<_sfmf>(s);		}
}

class classsimplebutton {
	init()	{
		new string simgob=null;
		new gmimgvec grbut;
	}
	public stdbuild(string sfile, string smouse, int z)	{this.build(this.getgraphpath()+sfile, smouse, 0, 0, z, 0);	}
	public getimgfunc(string sfunc)	{	simgob==null ? 0 : <simgob>.<sfunc>();	}
	public setbutpos(int x, int y)	{	grbut.setpos(x,y);	}
	public build(string sfile, string smouse, int x, int y, int z, int iact)	{
		new button but1;
		but1 (this.getname()) {(string s) new string sbut = s; };
		but1.addmethod("onclick", func { this.<sbut+"_CLICK">(); });
		but1.addmethod("onrel", func { this.<sbut+"_REL">(); } );
		but1.addmethod("onmoveon", func { this.<sbut+"_MOVEON">(); });
		but1.addmethod("onmoveoff", func { this.<sbut+"_MOVEOFF">(); });
		
		if( sfile.contains(".pyz") )	{
			new anima anbut0;
			anbut0.load( sfile );
			anbut0.setpos(x,y);
			anbut0.setz(z);
			anbut0.setframe(iact,0);
			simgob="anbut0";
			grbut.add(simgob);
			string s0="anbut0";
			string s1=null;
			string s2=null;
			int ile = anbut0.nofframes(iact);
			if( ile>1 )	{
				new anima anbut1;
				anbut1.copy("anbut0");
				anbut1.setframe(iact,1);
				s1 = "anbut1";
				grbut.add(s1);
			}
			if (ile>2)	{
				new anima anbut2;
				anbut2.copy("anbut0");
				anbut2.setframe(iact,2);
				s1 = "anbut2";
				grbut.add(s1);
			}
			but1.setan(s0,s1,s2);
		} else {
			new img imgbut;
			simgob="imgbut";
			grbut.add(simgob);
			imgbut.load(sfile);
			imgbut.setpos(x,y);
			imgbut.setz(z);
			but1.set("imgbut",null,null);
		}
		but1.setmouse(smouse);
	}
}

/*****************************************************************/

class classmask : classbutton	{
	init()	{
		classbutton::init();
	}
	buildmask(string sfile, string smouse)	{
		this.build(sfile, 0, smouse);
		int ile = this.ilebuts();
		for(int i=0; i<ile; i++)	{
			<sbut+i>.setflags(false, false);
			<sbut+i>.hide();
		}
	}
	buildmaskfunc(string sfile, string smouse, string sfunc)	{
		this.buildmask(sfile, smouse);
		this.clickfunc(sfunc);
	}
	addmask(string sanim, string sname, string smouse, int bhide)	{		// dodanie np. ludka jako maski
		string spom = sbut + iilebut;
		newvars::newbutan( spom, sanim, null, null, smouse);
		<spom>.addmethod("getbutname","cgetbutname");
		sname==null ? <spom>._cbuildbutname(<sanim>.actionname()) : <spom>._cbuildbutname(sname);
		if(bhide)	{
			<spom>.setflags(false, false);
			<spom>.hide();
		}
		iilebut++;
	}
	addadvmask(string sanim, string sname, string smouse, string sfuncclick)	{
		this.addmask( sanim, sname, smouse, false );
		this.addfunctolast( sfuncclick, null, null, null);	
	}
}

/*****************************************************/
public callfun(string sob, string sfun)	{if( sfun!=null ) sob==null ? this.<sfun>() : <sob>.<sfun>();}
public _stdanloop()	{	this.play(-1); }
public _stdanhide()	{	this.hide();	}
public _stdsndloop()	{	this.play(); }
public __std_finish()	{	this.<this+"_FINISH">();	}
public looponfinish(string san)	{	<san>.addmethod("onfinish", "_stdanloop");	}
public hideonfinish(string san)	{	<san>.addmethod("onfinish", "_stdanhide");	}
/*****************************************************/
public string strsube(int ile)	{	return this.getb( 0, this.length()-ile );	}
public string strsubb(int ile)	{	return this.getb( ile, this.length() - ile );	}
public string strsubbs(string s)	{	return this.strsubb( s.length() );	}
public string strsubes(string s)	{	return this.strsube( s.length() );	 }
public string strgetto(string schar)	{
	@id = .find(schar);
	id<0 ? .get : .getb(0, id);
}
public bool streq(string s)	{	.get == s.getb(0, .length);	}
public string strgetfromto(int ipos, string schar)	{	return this.getb(ipos, this.find(schar));	}
public string strgetfrom(string schar)	{	return .getb(.find(schar)+schar.length, .length );	}
public strremove(string s)	{	.set( .strgetto(s) + .strgetfrom(s) ); }
public bool strisbetween(int b1, int b2)	{
	int ib;
	for(int i=0; i<.length; i++)	{
		ib = .getbyte(i);
		if( ib<b1 || ib>b2 )	return false;
	}
	true;
}
public bool strisint		{	.strisbetween(BYTE0, BYTE9);	}
public bool strisbin	{	.strisbetween(BYTE0, BYTE0+1);	}
public bool strisalpha	{	.strisbetween(BYTEa, BYTEz);	}
public streach(string sfun)	{
	string s;
	for( int i=0; i<.length; i++) {
		s = .getb(i,1);
		<s>.<sfun>(i);
	}
}
public string strdotpos(int pos)	{	.strgetto(".") + "." + .strgetfrom(".")->getb(0,pos);}
/*****************************************************/
public swap(string s1, string s2)	{
	[s1];
	<s1> = [s2];
	<s2> = _;
}
public bool stats(int ile)	{	(ile <= 0) ? false : ( 100->rand <= ile );}
public def between(def i1, def i, def i2)	{	( i < i1 ) ? i1 : (i>i2) ? i2 : i;}
public def max(def val1, def val2)	{	val1>val2 ? val1 : val2;	}
public def min(def val1, def val2)		{	val1<val2 ? val1 : val2;	}
/*************** do wykorzystania na obiektach!! ***********************************/
public imgborders(int w, int r, int g, int b, int a)	{	.imgborderss(w,r,g,b,a,"1111"); }
public imgborderss(int w, int r, int g, int b, int a, string sbor)	{
	new img _img_bor;
	_img_bor.create(.getw, w, r,g,b,a);
	_img_bor.setpos(.getpx, .getpy );
	if(sbor.getb(3,1)=="1")
		.blit("_img_bor");
	_img_bor.move(0, .geth-w);
	if(sbor.getb(1,1)=="1")
		.blit("_img_bor");
	_img_bor.create(w,.geth,r,g,b,a);
	_img_bor.setpos(.getpx, .getpy);
	if(sbor.getb(0,1)=="1")
		.blit("_img_bor");
	_img_bor.move(.getw-w, 0);
	if(sbor.getb(2,1)=="1")
		.blit("_img_bor");
	delete _img_bor;
}
public imgroundborder(int w, int r, int g, int b, int a)	{
	.imgborders(w,r,g,b,a);
	.imgerasecorners;
}
public imgerasecorners	{
	@x = .getpx;
	@y = .getpy;
	.putrgba(x,y,.transparent);
	.putrgba(.getex-1,y,.transparent);
	.putrgba(.getex-1,.getey-1,.transparent);
	.putrgba(x,.getey-1,.transparent);
}
public real imgdrawline(string sbrush, int xstart, int ystart, int xstop, int ystop, real istep, real rdy)	{
	.imgfuncline("blit",sbrush,xstart,ystart,xstop,ystop,istep,rdy);
}
public real imgeraseline(string sbrush, int xstart, int ystart, int xstop, int ystop, real istep, real rdy)	{
	.imgfuncline("erase",sbrush,xstart,ystart,xstop,ystop,istep,rdy);
}
public imgputoncenter(string simg)	{	.setpos( <simg>.getcx-.getw/2, <simg>.getcy-.geth/2);	}
public real imgfuncline(string sfun, string sbrush, int xstart, int ystart, int xstop, int ystop, real istep, real rdy)	{
	@dx = xstop-xstart;
	@dy = ystop-ystart;
	real r;
	if( dx==0 )	{
		if( dy<0 )	{
			r = rdy+ystart;
			while( r>=ystop )	{
				<sbrush>.setpos(xstart, r);
				.<sfun>(sbrush);
				r-=istep;
			}
			ystop-r;
		} else if (dy>0)	{
			r = rdy+ystart;
			while( r<=ystop )	{
				<sbrush>.setpos(xstart, r);
				.<sfun>(sbrush);
				r+=istep;
			}
			r-ystop;
		} else rdy;
	} else {
		r = rdy.length(dx, dy);
		real rd;
		while( rdy<=r )	{
			rd = 1.0 - (r-rdy)/r;
			<sbrush>.setpos( (rd*dx)+xstart, (rd*dy)+ystart );
			.<sfun>(sbrush);
			rdy+=istep;
		}
		rdy-r;
	}
}
public anresizemets()	{	anima_pack::resizemethods(this.getname());	}
//public def anfirstnontr	{	classansearcher::firstnotrx1y(this);	}
public def anfirstnontr	{	classansearcher::_findnotr(this,.getpx, .getpy, 1, 0);	}
public anloopfin()	{	this.addmethod("onfinish", "_stdanloop");	}
public anloopplay(int iact)	{	this.anloopfin();	this.play(iact);	}
public anloopsplay(string sact)	{	this.anloopfin();	this.play(sact);	}
public anhidefin()	{	this.addmethod("onfinish","_stdanhide");	}
public anputgr()	{	this.setz( this.getey() );	}
public anputy(int ypos)	{	this.move(0, ypos - this.geth() - this.getpy());	}
public anputx(int xpos)	{	this.move(0, xpos - this.geth() - this.getpy());	}
public ansetposgr(int x, int y)	{	this.setpos(x,y);	this.anputgr();	}
public anplayz(int id, int z)	{	this.setz(z);	this.play(id);	}
public anplaygr(int id)	{	this.play(id);	this.anputgr();	}
public anplayzpos(int id, int z, int x, int y)	{	this.setpos(x,y);	this.anplayz(id,z);	}
public anplaypos(int x, int y)	{	this.setpos(x,y);	this.play(-1);	}
public anplayposgr(int x, int y)	{	this.ansetposgr(x,y);	this.play(-1);	}
public anplaypos2(int x, int y, string sact)	{	this.setpos(x,y);	this.play(sact);	}
public anplaypos3(int x, int y, int iact)	{	this.setpos(x,y);	this.play(iact);	}
public anhide()	{	this.stop(false);	this.hide();	}
public andownpos(int x, int y)	{	this.setpos( x, y-this.geth() );	}
public ansetbpos(int x, int y)	{	this.setpos( x-this.lodx(), y-this.lody() );	}
public ansetcpos(int x, int y)	{	.ansetbpos( x - .getw/2, y - .geth/2 );	}
public ancenterscreen {       .ansetcpos( iResX/2, iResY/2 ); }
public ansetframe(int id)	{	this.setframe( this.actionnr(-1), id );	}
public ansetsframe(def d, string s)	{
	.setframe(d,0);
	int id = 0;
	while( id < .nofframes(-1) && .framename!=s )	{
		id++;
		.setframe(-1,id);
	}
}
public int anonscreen()	{	return clsurf.inscreen(this.getcx(), this.getcy(), this.getw()/2, this.geth()/2);	}
public objplayfin(string sfun)	{	this.addmethod("onfinish", sfun);	this.play();	}
public objloop()	{	this.addmethod("onfinish","_stdsndloop");	}
public objplayloop()	{	this.objloop;	this.play();	}
public anplayfin(def act, string sfun)	{	this.addmethod("onfinish", sfun);	this.play(act);	}
public anytoz()	{	this.setz(this.getposy());	}
public anposz(int x, int y, int z)	{	.setpos(x,y);	.setz(z);	}
public string annextaction(string sact)	{return this.nameofaction( (this.actionnr(sact)+1)%this.nofactions() );}
public ansetnextact	{	.setframe( (.actionnr(-1)+1)%.nofactions, 0 ); }
public ansetnextfr		{	.setframe( -1, (.framenr+1)%.nofframes(-1)); }
public anhasaction(string sac)	{	.actionnr(sac) != .nofactions;}
public anaddfilter()	{	classanfilter::build(this.getname());	}
public anaddfx	{	AnimaFx::build( this );	}
public anputc(int x1, int y1, int x2, int y2)	{
	.ansetbpos(x1,y1);
	.move( (x2-x1-.getw)/2, (y2-y1-.geth)/2 );
}
public aninlod(int itoler)	{	itoler.length( .getpx - .lodx, .getpy - .lody ) <= itoler; }
public angetcpos	{	return .getcx, .getcy;	}
public anactnr	{	.actionnr(-1);	}
public angetcrgba	{	.getrgba(.getcx, .getcy);	}
public anisin(int x, int y, bool bv, bool ba)	{
	for( int i=0; i<.nofactions; i++)	{
		.setframe(i, 0);
		if( .isin(x,y,bv,ba) ) return i;
	}
	-1;
}
public anreload(string sfile)	{
	int id = .actionnr(-1);
	int fr = .framenr;
	bool bplay = .isplaying(-1)!=false;
	|int x, int y| = .getpos;
	int z = .getz;
	.load( .getpath(sfile) );
	.setpos(x, y);
	.setz(z);
	if( id < .nofactions ) {
		if( bplay ) .play(id);
		.setframe(id ,fr );
	} else .setframe(0 ,0);
}
public anclipob(string sob)	{	.clip(<sob>.getpx, <sob>.getpy, <sob>.getex, <sob>.getey);	}
public ancopyan(string san)	{
	.setframe( <san>.actionnr(-1), <san>.framenr );
	<san>.isvisible ? .show : .hide;
	.setpos( <san>.getpos );
}
public anconstmove(int delay, int x, int y)	{
	.vars2(A, "mvx", x, "mvy", y);
	.setdelay(delay);
	.anplayfin(-1, func { .play(-1); .move(mvx, mvy); });
}
/***************** text ****************/
public txtset(string s)	{	.set(s);	.create;	}
public txtsetcol(string s, int r, int g, int b)	{	.set(s);	.createtxt(r,g,b);	}
public txtshadow(int w, string sfont)	{
	if( !.hasvar("txts") )	{
		new text txts;
		txts.setfont(sfont);
	}
	txts.set(.get);
	txts.setpos(.getpx+w, .getpy+w);
	txts.setz(.getz-1);
	txts.show;
	txts.createtxt(0,0,0);
}
public txthides	{	.hide; if(.hasvar("txts")) txts.hide; }
public txtisin(int x, int y)	{
	x>=.getpx && x<.getpx+.getw && y>=.getpy && y<=.getpy+.geth;
}
public txtcenter(string sob)	{	.setpos( <sob>.getcx - .getw/2, <sob>.getcy - .geth/2 );}
public txtright(string sob)	{	.setpos( <sob>.getex - .getw, <sob>.getcy - .geth/2 );}
public txtcenterscreen		{	.setpos( (iResX-.getw)/2, (iResY-.geth)/2 );	}
/***************** vector ****************/
public vecinc(int pos)	{	this.set( pos, this.get(pos)+1 );	}
public vecdec(int pos)	{	this.set( pos, this.get(pos)-1 );		}
public vecnewint(int ile)	{
	this.free();
	if( ile>0 )	for( int i=0; i<ile; i++)	{	this.add(i);	}
}
public veccopy(string svec)	{
	this.free();
	for( int i=0; i< <svec>.size(); i++ )	this.add( <svec>.get(i) );
}
public int vecnextid(def val)	{
	int id = .find(val);
	if( id>=0 )	id = (id+1)%.size;
	id;
}
public int vecprevid(def val)	{
	int id = .find(val);
	if( id>0 )	id--;
	else if (id==0)	id = .size-1;
	id;
}
public def vecget(int id)	{
	( id>=0 && id<.size) ? .get(id) : null;
}
public def vecnext(def val)	{	.vecget( .vecnextid(val) );	}
public def vecprev(def val)	{	.vecget( .vecprevid(val) );	}
public def veclast()	{
	int ile = this.size();
	ile>0 ? this.get(ile-1) : null;
}
public def vecpop()	{
	@x = .last;
	.removeat( .size - 1 );
	x;
}
public veclimes(int ile)	{	while( .size > ile )	_ = .vecpop;	}
public def vecpopfront()	{
	def x = this.get(0);
	this.removeat( 0 );
	return x;
}
public vecreplace(def d1, def d2)	{
	@id = .find(d1);
	if( id>=0 )	.set(id,d2);
}
public insertsort(int ile, string sgetfun, string scomparefun, string sswapfun)	{
	if( ile<=1 )	{	return;	}
	def s[2], int id, int i, int j;
	for( i=0; i<ile; i++)	{
		s0 = this.<sgetfun>(i);
		id = i;
		for( j=i+1; j<ile; j++)	{
			s1 = this.<sgetfun>(j);
			if( this.<scomparefun>(s1,s0) )	{
				s0 = s1;
				id = j;
			}
		}
		this.<sswapfun>(i,id);
	}
}
public obbuildfromstring(string s, string separator, string sfunadd)	{
	int pos = s.find(separator);
	while( pos>-1 )	{
		this.<sfunadd>( s.getb(0,pos) );
		s = s.strsubb(pos+1);
		pos = s.find(separator);
	}
	if( s.length()>0 )	{	this.<sfunadd>(s);	}
}
public obbuildfromstring2(string s, string separator, string sfunadd)	{
	int pos = s.find(separator);
	while( pos>-1 )	{
		if( pos>0 )	this.<sfunadd>( s.getb(0,pos) );
		s = s.strsubb(pos+1);
		pos = s.find(separator);
	}
	if( s.length()>0 )	{	this.<sfunadd>(s);	}
}
public vecsort(string scomparefun)	{ .insertsort( .size, "get", scomparefun,"swap" ); }
public string vecbuildfromstring(string s, string separator)	{
	this.free();
	this.obbuildfromstring(s,separator,"add");
}
public string vecbuildfromstring2(string s, string separator)	{
	this.free();
	this.obbuildfromstring2(s,separator,"add");
}
public vecremoveto(int ito)		{	for( int i=0; i<ito; i++ ) this.removeat(0);		}
public vecremovefrom(int ifrom)	{	while( ifrom<this.size() ) this.removeat(ifrom);	}
public vecfindfrom(int ifrom, def d)	{
	while (ifrom<.size)	{
		if( .get(ifrom)==d ) return ifrom;
		else ifrom++;
	}
	return -1;
}
public vecposfromto(int i1, int i2)	{
	if( i1==i2 || .size==0 )	return;
	def x = .get(i1);
	if( i1>i2 )	for( int i=i1; i>i2; i--)	{	.set(i, .get(i-1));		}
	else if (i1<i2)	for( int i=i1; i<i2; i++)	{	.set(i, .get(i+1));	}
	.set(i2,x);
}
public vecposfirst( def x )	{
	int id = .find(x);
	if( id>=0 )	.vecposfromto(id, 0);
	else	.addbegin(x);
}
public vecposlast( def x )	{
	int id = .find(x);
	if( id>=0 )	.vecposfromto(id, .size-1);
	else	.addbegin(x);
}
public vecset(def x, def d2)	{
	int id = .find(x);
	if( id>=0 )	.set(id,d2);
}
public bool veceq(string svec)	{
	int id = .size;
	if( id != <svec>.size  )	return false;
	for( int i=0; i< id; i++)	if( .get(i)!=<svec>.get(i) ) return false;
	true;
}
public vecbuild	{	.withlist("addbegin");}
public bool veceq2	{
	new vector ___v;
	___v.type(.getvectype);
	___v.vecbuild;
	bool b = .veceq("___v");
	delete ___v;
	b;
}
public veccopydbrow(string sdb, int irow)	{	.free;	 .vecadddbrow(sdb,irow);	}
public vecadddbrow(string sdb, int irow)	{	for( int i=0; i< <sdb>.getcolsno(irow); i++)	.add( <sdb>.get(irow,i) );	}
public def vecchecknext(int id)	{
	id++;
	id < .size ? .get(id) : null;
}
public def vecsum	{
	if( .size )	{
		def sum = .get(0);
		for( int i=1; i<.size; i++)	{
			sum+=.get(i);
		}
		sum;
	} else 0;
}
public vecclosest(def val)	{
	int ile = .size;
	if( ile <= 0 ) return -1;
	int id = 0;
	def ipom = (val - .get(0))->abs;
	for( int i=1; i<ile; i++)	{
		def ipom2 = (val - .get(i))->abs;
		if( ipom2<ipom )	{
			id = i;
			ipom = ipom2;
		}
	}
	id;
}
/************** db ************************/
public dbbuild(int icol)	{
	if( icol<=0 )	return;
	icol--;
	.free;
	string s = _, int id;
	for( int i = 0; s!=A; )	{
		if( i==0 )	id = this.addbeginrow() - 1;
		this.addbegin(0,s);
		s = _;
		i = (i<icol)? i+1 : 0;
	}
}
public dbbuild2	{
	.free;
	string s = _;
	while( s!=A )	{
		if( s==null )	_ = .addbeginrow;
		else .addbegin(0,s);
		s = _;
	}
}
public dbaddvec(string svec)	{
	@id = .addrow-1;
	for( int i=0; i< <svec>.size; i++)	.add(id, <svec>.get(i));
}
public dbcopy(string sdb)	{	.dbcopyfromto(sdb, 0, <sdb>.getrowsno);}
public dbcopyrow(string sdb, int irow)	{	.dbcopyfromto(sdb,irow,irow+1);	}
public dbcopyfromto(string sdb, int i1, int i2)	{
	.free;
	.dbaddrowfromto(sdb,i1,i2);
}
public dbaddrowfromto(string sdb, int i1, int i2)	{
	int i, int j, int row;
	for( i =i1; i< i2; i++)	{
		row = .addrow-1;
		for( j=0; j< <sdb>.getcolsno(i); j++)	{
			.add( row, <sdb>.get(i,j) );
		}
	}
}
public dbadddbrowtorow(int myrow, string sdb, int row)	{
	for( int i=0; i< <sdb>.getcolsno(row); i++)	{
		.add( myrow, <sdb>.get(row,i) );
	}
}
public dbremovecol(int col)	{	for(int i=0; i<.getrowsno; i++) if( .getcolsno(i)>col ) .removeat(i,col);	}
public dbcopyfromtos(string sdb, string sfrom, string sto)	{
	.dbcopyfromto(sdb, <sdb>.findbyrow(sfrom)+1, <sdb>.findbyrow(sto));
}
public dbremovelast()	{
	.removerow( .getrowsno-1 );
}
public dbcuttosize(int isize)	{
	if( isize>0 ) while( .getrowsno > isize )	.dbremovelast;
	else	.free;
}
public dbaddlast(string svar)	{	this.add( this.getrowsno()-1, svar );	}
public dbaddstringrow(string s, string separator)	{
	_ = this.addrow();
	this.obbuildfromstring(s,separator,"dbaddlast");
}
public dbgetstringrow(int row)	{
	string s="";
	int ile = .getcolsno(row);
	for( int i = 0; i<ile; i++) s+= .get(row,i);
	s;
}
public dbaddrow	{
	@id = .addrow - 1;
	@s = _;
	while(A!=s)	{
		.addbegin(id, s);
		@s = _;
	}
}
public dbaddrowfrom(string sdb, int irow, int icol)	{
	if( <sdb>.rowinrange(irow) && icol>=0)	{
		int id = this.addrow()-1;
		int ile = <sdb>.getcolsno(irow);
		while( icol < ile )	{
			this.add( id, <sdb>.get( irow, icol ) );
			icol++;
		}
	}
}
public string dbchecknext(int irow, int icol)	{
	icol++;
	icol < this.getcolsno(irow) ? this.get(irow,icol) : null;
}
public string dbgets(string s, int icol)	{return this.get( this.findbyrow(s), icol );}
public string dbget(string s)	{ @id=.findbyrow(s); id>=0 ? .get( id, 1 ) : null; }
public int dbinsertless(int i1)	{
	int id = this.addrow()-1;
	this.add(id,i1);
	this.dbsort("cmpless");
	while( id>=0 )	{
		if( i1==this.get(id,0) )	return id;
		id--;
	}
	return -1;
}
public bool dbdelvar(int irow, string svar)	{return this.dbdelvarn(irow,svar,1);}
public bool dbdelvarn(int irow, string svar, int n)	{
	int id = this.dbfindinrow(irow,svar);
	if( id>=0 )	{
		this.removen(irow,id,n);
		return true;
	}
	return false;
}
public int dbfindinrow(int irow, string svar)	{
	if( this.rowinrange(irow) )	{
		for( int i=0; i<this.getcolsno(irow); i++)	if( this.get(irow,i)==svar )	return i;
	}
	return -1;
}
public int dbfindbycol(int icol, string svar)	{
	for( int i=0; i<this.getrowsno(); i++)	{if( this.get(i,icol)==svar ) return i;}
	return -1;
}
public bool dbrowcontains(int irow, string svar)	{	return this.dbfindinrow(irow,svar)!=-1;	}
public string dbfirst(int id)		{	return this.get(id,0);	}	
public bool cmpless(int i1, int i2)	{	return i1<i2;	}
public bool cmpabove(int i1, int i2)	{	i1>i2;	}
public bool dbfirstless(int i1, int i2)	{	.get(i1,0) < .get(i2,0);	}
public dbsort(string scomparefun)	{	.insertsort( .getrowsno, "dbfirst",scomparefun, "swap" ); }
public dbsetall(string svar)	{	for( @i=0; i<.getrowsno; i++)	for(@j=0; j<.getcolsno(i); j++)	.set(i,j,svar);	}
public dbeach_row(string sfun)	{	for( @i=0; i<.getrowsno; i++) .<sfun>(i);	}
public dbeq(string sdb)	{
	if( .getrowsno != <sdb>.getrowsno ) return false;
	int ile, int j;
	for( int i=0; i<.getrowsno; i++)	{
		ile = .getcolsno(i);
		if( ile!=<sdb>.getcolsno(i) ) return false;
		for( j=0; j<ile; j++)	{
			if( .get(i,j)!=<sdb>.get(i,j) ) return false;
		}
	}
	true;
}
/************** int ************************/
public int randdiff(int zakres, int odjakiej)	{
	if( zakres<=1 )		return -1;
	for( int i1 = zakres.rand; i1==odjakiej; i1= zakres.rand )	{}
	return i1;
}
public int bin_to_i	{
	string s = .get;
	int idwa = 1;
	int iout = 0;
	for( int i=s.length-1; i>=0; i--)	{
		if( s.getb(i,1)=="1") iout+=idwa;
		idwa*=2;
	}
	iout;
}

/***************************************************************************/
class classgamepause	{
	init()	{
		new button butpause;
		butpause.setrect( 0, 0, 800, 600 );
		butpause.addmethod("onclick", "resume");
		butpause.disable();
	}
	resume()	{
		butpause.disable();
		gameapi.resume();
	}
	pause()	{
		gameapi.pause();
		butpause.enable();
		butpause.resume();
	}
}

class TicksCounter	{
	init()	{
		new int istart;
	}
	start()	{	istart = engine.getticks();	}
	stop()	{	istart = engine.getticks() - istart;	}
	get()		{	return istart;	}
	int stopget()	{	this.stop();	return this.get();	}
	print(string s)	{	engine.print(s+" delay: "+this.stopget()+" ms");	}
	put()	{	.print("");	}
}

class ObjController	{
	init()	{
		new string _sme = this.getname();
		<GAME>.addgmobj(_sme);
	}
	removefromgame	{	<GAME>.removegmobj(_sme); }
}
class LObjController : ObjController, classlocker	{
	init()	{
		ObjController::init;
		classlocker::init;
	}
}

class gmbankvec : gmobjvec	{
	init	{
		gmobjvec::init;
		.var2("iid", -1);
	}
	startrand	{	if(.size>0) iid=.size->rand;	}
	play()	{
		this.stop(false);
		int ile = this.size();
		if( ile==0 ) return;
		iid = (iid+1)%ile;
		<this.get(iid)>.play();
	}
	onfinish()	{}
	stop(bool bfin)	{
		if( this.isplaying() )	{
			<this.getplay()>.stop(bfin);
			if( bfin ) this.onfinish();
		}
	}
	isplaying	{	( iid>=0 )	? <.getplay>.isplaying : false;	}
	getplay()	{	return this.get(iid);	}
}

class GameController : classlocker {
	init(string ssndbase)	{
		classlocker::init();
		new gmobjvec __grobj;
		
		new db _dbsnd;
		_dbsnd.setseparator("|");
		new string _sndbase = ssndbase;
		new string GAME = this;
		
		new timer __dblclick;
		__dblclick.delay(250);
		__dblclick.settick(1);
		
		new int _itimersnddelay = 10000;
	}
	public game_exit()	{
		//this.stdexportsnd();
	}
	/*************************************************/
	public setsndbase(string sb)	{	_sndbase=sb;	}
	public say(string styp, string stxt)	{	this.sayf(styp,stxt,null);	}
	public sayf(string styp, string stxt, string sfun)	{
		string s = this.getsndtxt(stxt);
		<s>.setstartstopflag(false,true);
		this.cplayf(styp, s, sfun);
	}
	public string getsndtxt(string stxt)	{
		string ssnd = "snd" + _sndbase + _dbsnd.getrowsno();
		this.addsnd( ssnd, stxt );
		return ssnd;
	}
	_sndtimerstart()	{
		return;
		int id = _dbsnd.dbfindbycol(1,this.getname());
		if( id>=0 )	engine.print( _dbsnd.get( id,2) );
		else 		engine.print( this.getname() + " not in _dbsnd");
		engine.print("");
	}
	public addsndf(string ssnd, string stxt, string sfun)	{
		this.addsnd(ssnd,stxt);
		if( sfun!=null )	{
			if( ssnd.getb(0,1)==":" ) ssnd = ssnd.strsubb(1);
			<ssnd>.addmethod("onfinish", sfun );
		}
	}
	public asf(string ssnd, string stxt)	{	this.addsndff( "snd" + ssnd, stxt, "end" + ssnd);	}
	public addsndff(string ssnd, string stxt, string sfun)	{
		this.addsndf(ssnd,stxt,sfun);
		//<ssnd>.setstartstopflag(false,true);
	}
	gmconsnd(string ssnd, string swav)	{
		new snd <ssnd>;
		<ssnd>.setstartstopflag(false,true);
		<ssnd>.load( .getsndpath+swav );
		if( igmsubtitle )	{
			subtitle.register(ssnd, .getsndpath+swav);
		}
	}
	public addsnd(string ssnd, string stxt)	{
		int id = _dbsnd.addrow()-1;
		string swav;
		if( ssnd.getb(0,1)==":" )	{
			ssnd = ssnd.strsubb(1);
			swav = _sndbase + "_" + ssnd + id + ".wav";
		} else swav = _sndbase + id + ".wav";
		string sg = gameapi.getgamename();
		if( igmsoundson && engine.fileexist( this.getsndpath() + swav ) )	{
			<sg>.gmconsnd( ssnd, swav );
		} else {
			<sg>.newtimer( ssnd, stxt.length()*_itimersnddelay, 1);
			<ssnd>.addmethod("onstart", "_sndtimerstart");
			<ssnd>.addmethod("setstartstopflag", func { (bool b1, bool b2) ; });
		}
		_dbsnd.add(id, swav);
		_dbsnd.add(id, ssnd);
		_dbsnd.add(id, stxt);
	}
	public addbank(string sbank, string sfunc)	{
		new gmbankvec <sbank>;
		string s = _;
		string s2;
		while( s!=A )	{
			s2 = this.getsndtxt(s);
			<sbank>.addbegin( s2 );
			if( sfunc!=null ) <s2>.addmethod("onfinish", sfunc );
			s = _;
		}
	}
	public exportbank(string sbase)	{
		new db <"__db"+sbase> (sbase)	{ (@sbase)
			.dbbuild(1);
			.setseparator("|");
			.dbeach_row( func { (@id)
				@s = this->strsubbs("__db");
				.addbegin(id, "snd"+s+id);
				.addbegin(id, s+id+".wav");
				} );
			if( igmdebug )
				.save("exports/"+sbase+".dlg");
		};
		delete <"__db"+sbase>;
	}
	public importbank(string sbank, string sbase, string sfun)	{
		new gmbankvec <sbank>;
		.importgroupto(sbase, sfun, null, sbank);
	}
	public exportsnd(string sfile)	{	if( igmdebug) _dbsnd.save(sfile);	}
	public stdexportsnd()	{	this.exportsnd( "exports/" + _sndbase + ".dlg" );	}
	public sounds=()	{	.buildsnds;	}
	public sounds_from(string sbase)	{
		new db __tmpdb;
		@stmpbase = _sndbase;
		.setsndbase(sbase);
		__tmpdb.load("exports/"+sbase+".dlg");
		_dbsnd.free;
		@s = _;
		int id, string sf;
		while( A!=s )	{
			@s1 = _;
			id = __tmpdb.dbfindbycol(1, s1);
			if( id>=0 )	{
				sf = .getsndpath + __tmpdb.get(id,0);
				if( engine.fileexist( sf ) )	{
					<GAME>.gmconsnd( s1, __tmpdb.get(id,0) );
					<s1>.addmethod("onfinish", s );
				} else	.addsndf( s1, __tmpdb.get(id,1), s );
			}
			@s = _;
		}
		_dbsnd.free;
		delete __tmpdb;
		.setsndbase(stmpbase);
	}
	public buildsnds()	{
		_dbsnd.free;
		new db __dbsnd;
		__dbsnd.dbbuild(3);
		.buildfromdb("__dbsnd");
		delete __dbsnd; 
	}
	public buildfromdb(string sdb)	{
		for( int i=0; i< <sdb>.getrowsno; i++)	{
			.addsndf( <sdb>.get(i,0), <sdb>.get(i,1), <sdb>.get(i,2) );
		}
		.stdexportsnd;
	}
	public importsnd(string sbase, string sfun)	{	this.importgroup(sbase, sfun, null );	}
	public importgroup(string sbase, string sfun, string sgr)	{	.importgroupto(sbase,sfun,sgr,null);	}
	public importgroupto(string sbase, string sfun, string sgr, string sgrto)	{
		new db __tmpdb;
		@stmpbase = _sndbase;
		.setsndbase(sbase);
		__tmpdb.load("exports/"+sbase+".dlg");
		_dbsnd.free();
		string s;
		for( int i=0; i<__tmpdb.getrowsno(); i++)	{
			s = __tmpdb.get(i,1);
			if( sgr==null || <sgr>.contains(s) )	{
				.addsndf( s, __tmpdb.get(i,2), sfun );
				if( sgrto!=null ) <sgrto>.add(s);
			}
		}
		_dbsnd.free();
		__tmpdb.free();
		delete __tmpdb;
		.setsndbase(stmpbase);
	}
	public freesnd()	{	_dbsnd.free();	}
	/*************************************************/
	public addgmobj(string s)		{	__grobj.add(s);		}
	public removegmobj(string s)	{	__grobj.remove(s);	}
	public isgmobj(string s)	{	__grobj.contains(s);	}
	public deletegmobj(string s)	{
		if( .hasvar(s) )	{
			.removegmobj(s);
			delete <s>;
		}
	}
	public lockall()		{
		__grobj.eval("lock");
		this.lock();	
	}
	public unlockall()		{
		__grobj.eval("unlock");
		this.unlock();
	}
	public gmunlockall	{	<GAME>.unlockall;	}
	public gmlockall	{	<GAME>.lockall;	}
	public lock=(bool b)	{	b ? .gmlockall : .gmunlockall; }
	mousemove()	{
		__grobj.eval("onmousemove");
		this.mouse_move();
	}
	mouselclick()	{
		__grobj.eval("onmouselclick");
		this.mouse_lclick();
		if( __dblclick.isplaying )	.mouse_dblclick;
		else __dblclick.play;
	}
	mouserclick()	{
		__grobj.eval("onmouserclick");
		this.mouse_rclick();
	}
	mouselrel()	{
		__grobj.eval("onmouselrel");
		this.mouse_lrel();
	}
	mouserrel()	{
		__grobj.eval("onmouserrel");
		this.mouse_rrel();
	}
	keydown()	{
		__grobj.eval("onkeydown");
		this.key_down();
	}
}

/* classadv : klasa do przygodowek	*/

class classadv : classgame {
	init()	{
		classgame::init();
	}
	/**************************************************************************/
	newclpathf(string spt, string san, string sfile, int x, int y, real rstep, int ityp)	{
		new classpathf <spt>;
		<spt>.build(san, this.getgraphpath() + sfile, x, y, rstep, ityp);
	}
	newclpathfcopy(string spt, string san, string sptf, real rstep)	{
		new classpathf <spt>;
		<spt>.buildfrom( san, sptf, rstep );
	}
	newpathf(string spathf, string sfile, int x, int y)	{
		new path <spathf>;
		<spathf>.build( this.getgraphpath() +sfile, x, y, 2.0, 1 );
	}
	/**************************************************************************/
	newclbut(string sbut, string sfile, int z, string smouse)	{
		new classbutton <sbut>;
		<sbut>.build( this.getgraphpath() + sfile, z, smouse );
	}
	newclmask(string sm, string sfile, string smouse)	{
		new classmask <sm>;
		<sm>.buildmask( this.getgraphpath() + sfile, smouse );
	}
	newclmaskfunc(string sm, string sfile, string smouse, string sfunc)	{
		new classmask <sm>;
		<sm>.buildmaskfunc( this.getgraphpath() + sfile, smouse, sfunc );
	}
}

class classquest	{
	init()	{
		new vector vqst;
		vqst.type("string");
	}
	int isdone(string sqst)	{	return vqst.contains(sqst);	}
	int notdone( string sqst )	{	return !vqst.contains(sqst);	}
	done(string sqst)	{	if( !vqst.contains(sqst) )	vqst.add(sqst);		}
	reset()	{	vqst.free();	}
	save(string sfile)	{	vqst.save( sfile );	}
	load(string sfile)	{	vqst.load( sfile );	}
}

new classquest clqs;

/***************************************************************************/

public winsave(string sval)	{
	new db _db_win;
	_db_win.load("output.db");
	@id = _db_win.addrow-1;
	_db_win.add(id, sval);
	_db_win.save("output.db");
	delete _db_win;
}

/***************************************************************************/

public saveexist(string sfile)	{	engine.fileexist( .getsavepath + sfile );	}

public vecsave(string sfile)	{	.save(.getsavepath + sfile);	}

public vecload(string sfile)	{	.load( .getsavepath + sfile );	}

class classfullsave	{
	init(string sfile)	{
		new db dbsav;
		dbsav.setseparator("|");
		new string sstdfile;
		.setfile(sfile);
		.var2("saveonset",0);
	}
	public save(string sfile)	{	dbsav.save( .getsavepath + sfile );	}
	
	_load(string sfile)	{
		if( engine.fileexist(sfile) )	{
			dbsav.free;
			dbsav.load(sfile);
		}
	}
	public load(string sfile)	{	._load( .getsavepath + sfile );	}
	public print()	{	dbsav.print();	}
	public setfile(string sf)	{	sstdfile = sf;	}
	public stdload()	{	this.load(sstdfile);	}
	public stdsave()	{	this.save(sstdfile); }
	public free()	{	dbsav.free();	}
	public set(string sname, string svar)	{
		int id = dbsav.findbyrow(sname);
		if( id>=0 )	{
			dbsav.set(id,1,svar);
		} else {
			id = dbsav.addrow()-1;
			dbsav.add( id, sname );
			dbsav.add( id, svar );
		}
		if( saveonset )
			this.stdsave();
	}
	public bset(string sname)	{	this.set(sname,true);	}
	public string get(string sname)	{
		int id = dbsav.findbyrow(sname);
		return id>=0?dbsav.get(id,1):null;
	}
	public bool is(string sname, string svar)	{
		int i = dbsav.findbyrow(sname);
  		return i>=0?dbsav.get(i,1)==svar:false;
	}
	//public bool bis(string sname)	{	return this.is(sname,true);	}
	public bool bis(string sname)	{
		int i = dbsav.findbyrow(sname);
		return i>=0?dbsav.get(i,1)!=false:false;
	}
	bool has(string sname)	{ dbsav.findbyrow(sname) >= 0; }
	public bool bgo(string sname)	{
		if( !.bis(sname) )	{
			.bset(sname);
			true;
		} else false;
	}
	public remove(string sname)	{
		int i = dbsav.findbyrow(sname);
		if( i>=0 ) {
			dbsav.removerow(i);
			if( saveonset )
				this.stdsave();
		}
	}
}



class StringChecker	{
	init()	{}
	/*bool isdigit(string s)	{	s.to_i == s;	}
	int getint(string s)	{	return s.to_i();	}
	real getreal(string s)	{	return s.to_r();	}	
	bool isreal(string s)	{	return this.isdigit(s)&&s.contains(".");	}
	bool isstring(string s) {	return s.getb(0,1)=="\"";	}
	string getstring(string s)	{	return s.strsubb(1);	}*/
	bool isdigit(string s)	{	return s.to_i()!=0||s.getb(0,1)=="0";	}
	int getint(string s)	{	return s.to_i();	}
	real getreal(string s)	{	return s.to_r();	}	
	bool isreal(string s)	{	return this.isdigit(s)&&s.contains(".");	}
	bool isstring(string s) {	return s.getb(0,1)=="\"";	}
	string getstring(string s)	{	return s.strsubb(1);	}
}

class Script	{
	init(string sfile)	{
		new db __dbcode;
		new string __sdb;
		new int __irow;
		new int __icol;
		new string __sreads;
		
		new vector __vec;
		__vec.type("string");
		
		new string __sarg;
		new int __iarg;
		new real __rarg;
		
		new StringChecker __csc;
		new map2 __mp("int");		// odnosniki do funkcji
		for( int i=0; i<10; i++)	new string <"ARG"+i>;
		
		this.load(sfile);
	}
	public ARG=(int id, string s)	{ <"ARG"+id> = s; }
	public ARG(int id)	{ ["ARG"+id]; }
	public load(string sfile)	{
		if( sfile==null )	return;
		if( sfile.contains(".") )	{		// znaczy sie plik jest
			__sdb = "__dbcode";
			__dbcode.loadbeh(sfile);
		} else {
			__sdb = sfile;		// odwolanie przez inna baze
		}
		__mp.free();
		for( int i=0; i < <__sdb>.getrowsno(); i++)	{
			if( <__sdb>.get(i,0)=="func" )
				__mp.add( <__sdb>.get(i,1), i );
		}
		this.call("init");
	}
	public def get(string svar)	{	return [svar];	}
	bool isvar(string s)	{	return s.contains("$");	}
	string getvar(string s)	{
		s = s.strsubb(1);
		if( !engine.varexist(s) )
			new def <s>;
		return s;
	}
	bool isfunc(string s)	{	return s.contains(".")&&!__csc.isreal(s);	}
	getfunc(string sfun)	{
		__vec.free();
		__vec.add( sfun.strgetto(".") );
		__vec.add( sfun.strgetfrom(".") );
	}
	string _get()	{
		__icol++;
		return <__sdb>.get(__irow,__icol-1);
	}
	bool isnext()	{
		if( __icol < <__sdb>.getcolsno(__irow) )	{
			__sreads=<__sdb>.get(__irow,__icol);
			return true;
		}
		return false;
	}
	perror(bool expr, string sout)	{
		if( expr )
			engine.print("error: " + sout);
	}
	interpcall(string scal)	{
		this.getfunc(scal);
		string sob = __vec.get(0);
		if( sob.getb(0,1)=="*" ) sob=[sob.strsubb(1)];
		string sfun = __vec.get(1);
		if( sfun.getb(0,1)=="*" ) sob=[sfun.strsubb(1)];
		__vec.free();
		__icol++;	// omin '('
		string s = this._get();
		while( s!=")" )	{
			this.getexpr(s);	// odloz na stos argumenty
			s = this._get();
		}
		if( sob=="this" ) sob=null;
		this.callfun(sob,sfun);
	}
	string getvname(string s)	{
		if( this.isvar(s) )	{
			s=this.getvar(s);
		} else if(__csc.isreal(s))	{
			__rarg = s.to_r();
			s = "__rarg";
		} else if( __csc.isdigit(s) ) {
			__iarg = s;
			s = "__iarg";
		} else if( __csc.isstring(s) ) {
			__sarg = __csc.getstring(s);
			s = "__sarg";
		}
		return s;
	}
	bool isscriptfun(string s)	{	return s.contains("->");	}
	string getscriptfun(string s)	{	return s.strsubb(2);	}
	getexpr(string sexpr)	{
		if( __csc.isstring(sexpr) )	{
			<this.getvname(sexpr)>.get();
		} else if( this.isfunc(sexpr) )	{
			this.interpcall(sexpr);
		} else if(this.isscriptfun(sexpr))	{
			int r = __irow;
			int c = __icol;
			this.call( this.getscriptfun(sexpr) );
			__irow = r;
			__icol = c;
		} else {
			<this.getvname(sexpr)>.get();
		}
	}
	bool cmp()	{
		bool bodp=false;
		def d0 = this.getexpr(this._get());
		string s2 = this._get();		// typ porownania
		def d1 = this.getexpr( this._get() );
		match(s2)	{
			"==" =>	{	bodp = d0 == d1;	}
			"!=" =>	{	bodp = d0 != d1;	}
			"<" =>	{	bodp = d0 < d1;	}
			">" =>	{	bodp = d0 > d1;	}
			"<=" =>	{	bodp = d0 <= d1;	}
			">=" =>	{	bodp = d0 >= d1;	}
			? => ;
		}
		s2 = this._get();
		if( s2=="||" )	return bodp || this.cmp();
		else if (s2=="&&")	return bodp && this.cmp();
		else return bodp;
	}
	public containsfun(string sfun)	{	__mp.contains(sfun);	}
	public call(string sfun)	{
		if( !__mp.contains(sfun) )	return;
		
		__irow = __mp.get( sfun );
		__irow++;
		__icol=0;
		
		bool bgo = true;
		bool bif = false, bool bifexp, bool bwhile=false;
		bool belif=false;
		int iwhilerow;
		string s[3], int i[3];
		while( bgo )	{
			__icol=0;
			s0 = this._get();
			match(s0)	{
				"new"=>{	s0 = this._get();
					s1 = this._get();
					s1 = s1.strsubb(1);	// pozbadz sie $
					if( this.isnext() )	{
						if( __sreads=="[" )	{
							__icol++;
							i0 = this._get();
							for(i1=0; i1<i0; i1++)	{
								new <s0> <s1+i1>;
							}
						} else {		// powinien byc "(" dla konstruktora
							__icol++;
							while( this.isnext() && __sreads!=")" )	this.getexpr( this._get() );
							new <s0> <s1>;
						}
					} else {
						new <s0> <s1>;
					}
					__irow++;
				}"delete" =>	{	delete <this.getvar(this._get())>;	__irow++;	}
				(s0=="if" || belif || bwhile)?s0:"" => {
	// 				belif ? this.perror(!bif,"else without if") : this.perror(bif,"if within if");
					__icol++;		// '('
					bifexp = this.cmp();
					if(s0=="if") bif=true;
					belif=false;
					bwhile = false;
					__irow++;
					if( !bifexp )	{
						i1=1;
						while(i1)	{
							s0 = <__sdb>.get(__irow,0);
							if( s0=="else"||s0=="elif"||s0=="fi"||s0=="done") i1=0;
							else	__irow++;
						}
					}
				}"else" => { 	this.perror(!bif,"else without if");
					__irow++;
					if( bifexp )	{
						while(<__sdb>.get(__irow,0)!="fi")
							__irow++;
					}
				} "fi" =>	{	this.perror(!bif,"fi without if");
					bif=false;
					bifexp = false;
					belif=false;
					__irow++;
				} "elif"=>	{
					if( bifexp )	{
						__irow++;
						while(<__sdb>.get(__irow,0)!="fi")
							__irow++;
					} else {
						belif = true;
					}
				} "end" =>	bgo=false;
				"while" =>	{
					iwhilerow = __irow;
					bwhile = true;
				}"done" =>	{
					if( bifexp )	{
						__irow = iwhilerow;
					} else {
						__irow++;
					}
				}"print" =>	{
					s0 = "";
					while( this.isnext() )
						s0 += this.getexpr( this._get() ); 
					engine.print( s0 );
					__irow++;
				}"return" => 	{
					if( this.isnext() )	{
						this.getexpr( __sreads );
					}
					return;
				} ? => { 
					if (s0.contains("$"))	{
						s0 = this.getvar( s0 );
						__icol++;		// olej <<
						<s0> = this.getexpr(this._get());
						while( this.isnext() )	{
							__icol++;		// omin znak dzialania
							def d2 = this.getexpr( this._get() );
							match(__sreads)	{
								"+"	=>	<s0> += d2;
								"-"	=> 	<s0> -= d2;
								"*"	=>	<s0> *= d2;
								"/"	=>	<s0> /= d2;
								"%"	=>	<s0> %= d2;
								?	=>	;
							}
						}
					} else
						this.getexpr( s0 );
					__irow++; 
				}
			}
			if( __irow >= <__sdb>.getrowsno() )	{
				this.perror(1,"function "+sfun+" not finished!");
				bgo=false;
			}
		}
	}
}

public transparent	{	return 0,0,0,0;	}
public red			{	return 255,0,0;	}
public green		{	return 0,255,0;	}
public blue			{	return 0,0,255;	}
public white		{	return 255,255,255; }
public black		{	return 0,0,0;		}
public grey(int c)	{	return c,c,c;		}
public yellow		{	return 255,255,0;	}

class Color	{
	init	{
		.vars(A,"r","g","b","a");
	}
	operator=(string scol)	{	this.set( <scol>.get() );	}
	img=(@simg)	{
		|r,g,b,a| = <simg>.getrgba( classansearcher::firstnotrx1y(simg) );
	}
	get			{	return r,g,b,a;	}
	set(int r2, int g2, int b2, int a2)	{	|r,g,b,a| = r2,g2,b2,a2;	}
	rgb=(int r2, int g2, int b2)	{	|r,g,b|=r2,g2,b2;	}
	rgb	{	return r,g,b;	}
	print	{	engine.print("Color::" + this + " (r,g,b,a) = ("+r+","+g+","+b+","+a+")");	}
}

/***************************************************************************/

class classasker : newvars	{
	init()	{
		newvars::init();
		new string sfuncyes = null;
		new string sfuncno = null;
		new string ssndask;
		new string ssndyes;
		new string ssndno;
		new classsound clsnd;
	}
	reset()	{
		sfuncyes=null;	sfuncno=null;
		buts.resetall();
	}
	setfuncs(string syes, string sno)	{
		sfuncyes = syes;
		sfuncno = sno;
	}
	fxonmovon(string ssnd)	{	buts.sfxonmovon(ssnd);	}
	setmouse(string smouse)	{
		buts.newmouse("yes", smouse);
		buts.newmouse("no", smouse);
	}
	load(string sfile, int z)	{
		new classbutton buts;
		buts.build(sfile, z, null);
		buts.transclickfunc( engine.actclassname(), "butclick");
		buts.transmovonfunc( engine.actclassname() , "butmovon");
		buts.disableall();
	}
	ask( string sask, string syes, string sno, string sf1, string sf2 )	{
		this.setfuncs(sf1,sf2);
		this.ask2( sask, syes, sno );
	}
	ask2( string sask, string syes, string sno )	{
		ssndask=sask;
		ssndyes = syes;
		ssndno = sno;
		gameapi.pause();
		buts.benableall();
		buts.pause("bkg");
		clsnd.creset();
		clsnd.cbplay( sask );
		.<this+"_ask">;
	}
	/**********************************************/
	butmovon(string sc)	{
		/*if( ssndask!=null )	{
			if( <ssndask>.isplaying()==true )	{
				return;
			}
		}*/
		if( sc=="yes" )	{
			<ssndask>.stop(false);
			clsnd.cbplay( ssndyes );
		} else if (sc=="no")	{
			<ssndask>.stop(false);
			clsnd.cbplay( ssndno );
		}
	}
	butclick(string sc)	{
		if( sc=="bkg" )	return;
		gameapi.resume();
		buts.disableall();
		clsnd.cactsndstop(false);
		if( sc=="yes" && sfuncyes!=null)	{
			this.<sfuncyes>();
			.<this+"_yes">;
		} else if( sc=="no" && sfuncno!=null)	{
			this.<sfuncno>();
			.<this+"_no">;
		}
	}
	disabled	{	buts.disabled;	}
	setcursorpos(int x, int y)	{	buts.setcursorpos(x,y);	}
}

/***************************************************************************/
class classplacepointer	{
	init()	{
		new anima anpointer;
		anpointer.addmethod("onfinish", func { this.play(-1); } );
		new int _iz = 1000;
	}
	public load(string sfile)	{
		anpointer.load(sfile);
		this.setz(_iz);
		anpointer.hide();
	}
	public setz(int iz)	{
		_iz = iz;
		anpointer.setz(iz);
	}
	public stop()	{	anpointer.stop(false);	}
	public stoph()	{	anpointer.stop(false);	anpointer.hide();	}
	public show(int x, int y, string sdir)	{
		anpointer.setpos(x,y);
		anpointer.play(sdir);
	}
	move(@x, @y)	{	anpointer.move(x,y);	}
	public showob(string sob, string sdir)	{	this.show(<sob>.getcx(), <sob>.getcy(), sdir);	}
	public showpob(string sob, string sdir)	{	this.show(<sob>.getpx(), <sob>.getpy(), sdir);	}
}

class SimpleCounter	{
	init(int ilength)	{
		.var2("length", ilength );
		new int iid = 0;
	}
	int next()	{	iid = (iid+1)%length;		iid;	}
	set(int i)	{	iid=i;	}
	reset()	{	iid=0;	}
	get()	{	iid;	}
}

/******************************************/

module clstrdigit	{
	init()	{}
	public string getdigit(int idigit, int ilepozycji)	{
		string s = idigit;
		while( s.length() < ilepozycji )	s = "0" + s;
		return s;
	}
	public string gettime(int itime, string smod)	{
		return this.getstime( this.geth(itime), this.getm(itime), this.gets(itime), 
			smod.contains("h"), smod.contains("m"), smod.contains("s") );
	}
	public string getstime(int ih, int im, int is, bool bh, bool bm, bool bs)	{
		string s = "";
		if( bh ) s+= ih;
		if( bm ) s+= (bh?":":"") + this.getdigit(im,2);
		if( bs ) s+= ((bh||bm)?":":"") + this.getdigit(is,2);
		return s;
	}
	public int geth(int itime)	{	return itime/3600;	}
	public int getm(int itime)	{	return (itime/60)%60;	}
	public int gets(int itime)	{	return itime%60;	}
	public string getns(int itime, int n)	{	return this.getdigit( this.gets(itime),n );	}
	public string getnm(int itime, int n)	{	return this.getdigit( this.getm(itime),n );	}
	string getbinary(int ival)	{
		string s = "";
		while(ival>0)	{
			s = "" + (ival%2) + s;
			ival/=2;
		}
		return s;
	}
	string bintohex(string sval)	{
		string s;
		match(sval.length%4)	{
			3=>"0"; 2=> "00"; 1=> "000";
			? => "";
		}
		s = _;
		sval = s + sval;
		s = "";
		for( int i=0; i<sval.length; i+=4)	{
			match(sval.getb(i,4))	{
				"0000" => "0";	"0001" => "1";	"0010" => "2";	"0011" => "3";
				"0100" => "4";	"0101" => "5";	"0110" => "6";	"0111" => "7";
				"1000" => "8";	"1001" => "9";	"1010" => "A";	"1011" => "B";
				"1100" => "C";	"1101" => "D";	"1110" => "E";	"1111" => "F";
				? => ;
			}
			s += _;
		}
		s;
	}
}

public string getbinary			{	clstrdigit::getbinary(.get);		}
public string getdigit(int ile)		{	clstrdigit::getdigit(.get,ile);		}
public string getbindigit(int ile)	{	clstrdigit::getdigit( .getbinary,ile);	}

class Text	{
	init(string sfont, int ifontsize, int ifr, int ifg, int ifb, int x, int y, int z)	{
		if( sfont==null )	sfont = sgmfontfile;
		if( sfont.contains(".ttf") )	{
			new font _fnt;
			_fnt.load( sfont, ifontsize );
			sfont = "_fnt";
		}
		new int iR = ifr;
		new int iG = ifg;
		new int iB = ifb;
		new int iFontSize = ifontsize;
		new text txt;
		txt.setfont(sfont);
		txt.setz(z);
		txt.setpos(x,y);
		txt.show;
		
		new text txtbg;
		txtbg.hide();
	}
	public hide()	{	txt.hide;	}
	public show()	{	txt.show;	}
	public setpos(int x, int y)	{	txt.setpos(x,y);	}
	public set(string s)	{
		txt.set( s );
		txt.createtxt( iR, iG, iB );
	}
	public string get()	{	return txt.get;	}
	public setbg(int ir, int ig, int ib, int ia)	{
		txtbg.setbkg(txt.getpx()-iFontSize/2, txt.getpy()-iFontSize/2,
			txt.getw()+iFontSize, iFontSize*2, ir, ig, ib, ia );
		txtbg.setborders(1,255,255,255,128);
		txtbg.show();
	}
	operator=(string val)	{	this.set(val);	}
	move(int x, int y)	{	txt.move(x,y);	}
}

class Cypher : Text	{
	init(string sfont, int ifontsize, int ifr, int ifg, int ifb, int x, int y, int z)	{
		Text::init(sfont, ifontsize, ifr, ifg, ifb, x, y, z );
		this.set(0);
	}
	add(int dt)	{	this.set( dt + this.get );	}
	iget()		{	this.get->to_i;		}
	operator+(int val)	{	this.add(val);	}
	operator++()	{	this.add(1);	}
	operator--()	{	this.add(-1);	}
	operator-(int val)	{	this.add(-val);	}
	operator=(int val)	{	this.set(val);	}
	operator==(int val)	{	.get==val;	}
	operator!=(int val)	{	.get!=val;	}
	operator>(int val)	{	.get>val;	}
	operator<(int val)	{	.get<val;	}
}

class SecCounter	{
	init(string sdigits, int starttime, int dt)	{
		new string sdigit = sdigits;
		.vars2(A, "istarttime", starttime, "idtime", dt, "itime", 0);
		this.reset();
		this.cnewtimerfin("timcyk",1000,1, func { .play; <.getbuildername>.tick; } );
	}
	public play()	{	timcyk.play();	}
	public stop()	{	timcyk.stop(false);}
	public isplaying	{	timcyk.isplaying;	}
	public string sgettime()	{	return clstrdigit.gettime(itime, sdigit);	}
	public int gettime()	{	return itime;	}
	public tick	{	.update(idtime);	}
	public reset()	{
		//this.update(-itime);
		itime = istarttime;
	}
	public update(int isec)	{
		itime+=isec;
	}
}

class TextTimeCounter : Text, SecCounter	{
	init(string sfont, int ifontsize, int ifr, int ifg, int ifb, int x, int y, int z, string sdigits, int starttime, int dt)	{
		Text::init(sfont, ifontsize, ifr, ifg, ifb, x, y, z);
		SecCounter::init(sdigits, starttime, dt);
		.reset;
		.update(0);
	}
	public update(int isec)	{
		SecCounter::update(isec);
		this.set( this.sgettime() );
		if( itime<=0 && idtime<0 )	{
			.<this + "_finish">;
		}
	}
}

class gfxObject	{
	init(string sob)	{	new string sgfxobj = sob; }
	setpos		{	<sgfxobj>.setpos;	}
	move		{	<sgfxobj>.move;	}
	getpos		{	<sgfxobj>.getpos;	}
	getposx		{	<sgfxobj>.getposx;	}
	getposy		{	<sgfxobj>.getposy;	}
	getpx		{	<sgfxobj>.getpx;	}
	getpy		{	<sgfxobj>.getpy;	}
	getw			{	<sgfxobj>.getw;	}
	geth			{	<sgfxobj>.geth;	}
	getcx		{	<sgfxobj>.getcx;	}
	getcy		{	<sgfxobj>.getcy;	}
	getex		{	<sgfxobj>.getex;	}
	getey		{	<sgfxobj>.getey;	}
	lodx			{	<sgfxobj>.lodx;	}
	lody			{	<sgfxobj>.lody;	}
	setz			{	<sgfxobj>.setz;		}
	getz			{	<sgfxobj>.getz;	}
	show		{	<sgfxobj>.show;	}
	hide			{	<sgfxobj>.hide;	}
	isvisible		{	<sgfxobj>.isvisible;	}
	bool isin		{	<sgfxobj>.isin;		}
}

class gfxSquare : Color, gfxObject	{
	init(int x1, int y1, int w1, int h1)	{
		Color::init;
		.vars(A, "w", "h");
		w=w1; h=h1;
		new img imggfx;
		imggfx.setpos(x1,y1);
		gfxObject::init("imggfx");
	}
	build	{	imggfx.create(w,h,r,g,b,a);	}
	shadow(int dx, int dy, int alpha)	{
		|@x,@y| = imggfx.getpos;
		imggfx.setpos(0,0);
		new img _img1;
		new img _img2;
		if( imggfx.getw>0 )	{
			_img1.create(w,h,.transparent);
			_img1.blit("imggfx");
		} else _img1.create(w,h,.get);
		_img2.create(w,h,.black,alpha);
		if( dx<0 )	{
			_img1.move(-dx, 0);
			x+=dx;
		} else	_img2.move( dx, 0 );
		if( dy<0 )	{
			_img1.move(0,-dy);
			y+=dy;
		} else	_img2.move( 0, dy );
		w += dx.abs;
		h += dy.abs;
		imggfx.create(w, h, .transparent);
		imggfx.blit("_img2");
		imggfx.blit("_img1");
		delete _img1;
		delete _img2;
		imggfx.move(x,y);
	}
	blackborder(int width, int a2)	{	.border(width,width, .black,a2);	}
	border(int width, int height, int r2, int g2, int b2, int a2)	{
		|@x,@y| = imggfx.getpos;
		imggfx.setpos(0,0);
		new img _img;
		if( imggfx.getw>0 )	{
			_img.create(w,h,.transparent);
			_img.blit("imggfx");
		} else _img.create(w,h,.get);
		_img.move(width,height);
		w += 2*width;
		h += 2*width;
		imggfx.create(w,h,r2,g2,b2,a2);
		imggfx.blit("_img");
		delete _img;
		imggfx.move(x,y);
	}
}

class Rect	{
	init(int _x, int _y, int _w, int _h)	{
		.vars(A, "x", "y", "w", "h");
		.set(_x, _y, _w, _h);
	}
	x2	{	x+w;	}
	y2	{	y+h;	}
	set(int _x, int _y, int _w, int _h)	{ x=_x; y=_y; w=_w; h=_h; }
	fit(string simg)	{
		if( <simg>.gettype=="gmimgvec") {
			@dx = x-<simg>._getpx;
			if( dx>0 ) <simg>.move(dx,0);
			@dy = y-<simg>._getpy;
			if( dy>0 ) <simg>.move(0,dy);
		} else {
			@dx = x-<simg>.getpx;
			if( dx>0 ) <simg>.move(dx,0);
			@dy = y-<simg>.getpy;
			if( dy>0 ) <simg>.move(0,dy);
		}
		dx = .x2-<simg>.getex;
		if( dx<0 ) <simg>.move(dx,0);
		dy = .y2-<simg>.getey;
		if( dy<0 ) <simg>.move(0,dy);
	}
	fitrand(string simg)	{	<simg>.ansetbpos( x+(w-<simg>.getw)->rand, y+(h-<simg>.geth)->rand);	}
	fitgrouprand(string sgr)	{	for( int i=0; i< <sgr>.size; i++) .fitrand( <sgr>.get(i) );	}
	fitgroup(string sgr)	{	for( int i=0; i< <sgr>.size; i++) .fit( <sgr>.get(i) );	}
}
/***************************************************************************/

class classfadeinout		{
	init()	{
		new timer timf;
		new string _sob;
		new int _istep;
		new int _ival;
		new int _ib1;
		new int _ib2;
		new string _sfun;
		new string _sfunfin;
		new string _sobfin;
		timf.addmethod("onfinish", "_ctimffin");
	}
	/***************\/\/\/\/\/ wewnetrzne \/\/\/\/\/\/************************************/
	_cfinito(int v)	{
		<_sob>.<_sfun>( v );
		if( _sfunfin!=null)	{
			if( _sobfin==null )
				this.<_sfunfin>();
			else <_sobfin>.<_sfunfin>;
		}
	}
	_ctimffin()	{
		_ival+=_istep;
		if( _ival >= _ib2 )	{
			this._cfinito( _ib2 );
		} else if( _ival<=_ib1 )	{
			this._cfinito( _ib1 );
		} else {
			<_sob>.<_sfun>( _ival );
			this.play();
		}
	}
	_play( int icycle, int istep, string sob, string sfun, int ib1, int ib2, string sob2, string sfun2 )	{
		_sobfin = sob2;
		_sfunfin = sfun2;
		_ib1 = ib1;
		_ib2 = ib2;
		int i = istep.abs();
		if( icycle <= 0 || i==ib1 || i>ib2 )	return;
		_sfun = sfun;
		timf.setcycle( icycle );
		_sob = sob;
		if( istep>0 )	_ival = _ib1;
		else if( istep<0 )	_ival=_ib2;
		else return;
		<sob>.<sfun>( _ival );
		_istep = istep;
		timf.play();
	}
	/******************* /\/\/\/\/\/\/\ wewnetrzne /\/\/\/\ ****************************/
	imgtransparency(int icycle, int istep, string simg, string sfun)	{
		this._play( icycle, istep, simg, "transparency", 0, 255, null, sfun );
	}
	setopacity(int icycle, int istep, string simg, string sfun)	{
		this._play( icycle, istep, simg, "setopacity", 0, 255, null, sfun );
	}
	sndvolume(int icycle, int istep, string ssnd, string sfun)	{
		this._play( icycle, istep, ssnd, "setvol", 0, 100, null, sfun );
	}
	/***************************************************/
	isplaying	{	timf.isplaying;	}
}

class CutScene : gfxObject	{
	init(int x1, int y1, int x2, int y2)	{
		new int X1;	new int Y1;
		new int X2;	new int Y2;
		new img _gsq;
		.build(x1, y1, x2, y2);
		gfxObject::init("_gsq");
		new string _sfunc1;
		new string _sob1;
		new string _sfunc2;
		new string _sob2;
		new int _idelay = 10;
		new classfadeinout _clfio;
	}
	build(int x1, int y1, int x2, int y2)	{
		|X1, Y1, X2, Y2| = x1, y1, x2, y2;
		_gsq.create(X2-X1,Y2-Y1,.black,255);
		_gsq.setpos(X1,Y1);
		_gsq.hide;
		_gsq.transparency(0);
	}
	delay(int n)	{	_idelay=n;	}
	transparency(int n)	{	_gsq.transparency(n);	}
	playfin(string sfunc1, string sfunc2)	{	.playobfin(null,sfunc1, null, sfunc2);	}
	playobfin(string sob1, string sfunc1, string sob2, string sfunc2)	{
		_sob1 = (sob1==null) ? gameapi.getgamename : sob1;
		_sfunc1 = sfunc1;
		_sob2 = (sob2==null) ? gameapi.getgamename : sob2;
		_sfunc2 = sfunc2;
		_gsq.show;
		_gsq.transparency(0);
		_clfio._play( 1, _idelay, this, "transparency", 0, 255, this, func {
			.callfun(_sob1, _sfunc1);
			_gsq.show;
			_clfio._play( 1, -_idelay, this, "transparency", 0, 255, this, "_callfun2" );
			} );
	}
	close(string sfunc1)	{	.obclose(gameapi.getgamename, sfunc1);	}
	obclose(string sob, string sfunc1)	{
		_sob1 = sob;
		_sfunc1 = sfunc1;
		_gsq.transparency(0);
		_gsq.show;
		_clfio._play( 1, _idelay, this, "transparency", 0, 255, this, func {
			_gsq.hide;
			.callfun(_sob1, _sfunc1);
			} );
	}
	enter(string sfunc2)	{	.obenter(gameapi.getgamename, sfunc2);	}
	obenter(string sob, string sfunc2)	{
		_sob2 = sob;
		_sfunc2 = sfunc2;
		_gsq.transparency(255);
		_gsq.show;
		_clfio._play( 1, -_idelay, this, "transparency", 0, 255, this, "_callfun2" );
	}
	_callfun2	{
		_gsq.hide;
		.callfun(_sob2, _sfunc2);
	}
	isplaying	{	_clfio.isplaying;	}
	show	{
		_gsq.transparency(255);
		_gsq.show;
	}
}


public string allchars	{	"a0 t_!@#$%^&*()_+-=[]\\|}{;':\",./<>?`~"; }

class TextTyper : classlocker, gfxObject {
	init(string sfont, int isize, int ir, int ig, int ib, string schars, int ilimit)	{
		classlocker::init();
		sfont = .checkfont(sfont, isize);
		new int iR = ir;
		new int iG = ig;
		new int iB = ib;
		new string sChars = schars;
		new int iLimit = ilimit;		// 0 - unlimited
		
		.vars2(A,"Sdir","left", "W", 0, "iFontSize", isize, "X", 0, "Y", 0);
		
		new text txt1;
		txt1.setfont(sfont);
		txt1.set("");
		new text txt2;
		txt2.setfont(sfont);
		txt2.set("_");
		txt2.createtxt(iR,iG,iB);
		txt2.hide();
		
		new text txtpass;
		txtpass.setfont(sfont);
		txtpass.hide;
		new bool bpass = false;
		
		new string _sob=null;
		new string _sfun=null;
		
		this.cnewtimerfin("timcyk",300,1,"fintimcyk");
		
		gfxObject::init("txt1");
	}
	setaspasswd	{
		bpass = true;
		txt1.hide;
		txtpass.setz( txt1.getz );
		txtpass.show;
		.copytopass;
	}
	copytopass	{
		@id = txt1.get->length;
		string s = "";
		for( int i=0; i<id; i++)	s += "*";
		txtpass.txtset(s);
		txtpass.setpos( txt1.getpx, txt1.getpy );
	}
	setastext	{
		bpass = false;
		txt1.show;
		txtpass.hide;
	}
	public isin(int x, int y, bool bv, bool ba)	{	txt1.isin(x,y,bv,ba);	}
	getcol	{	return iR,iG,iB;	}
	fintimcyk()	{
		if( this.getlock() )	return;
		this.updatecyk();
		this.play();
	}
	updatecyk()	{
		if( txt2.isvisible() )	{
			txt2.hide();
		} else {
			txt2.setpos( txt1.getex(), txt1.getpy() );
			txt2.show();
		}
	}
	public enable()	{
		this.unlock();
		this.updatecyk();
		timcyk.play();
	}
	public disable()	{
		txt2.hide();
		timcyk.stop(false);
		this.lock();
	}
	public onenter(string sob, string sfun)	{	_sob=sob;	_sfun=sfun;	}
	public setpos(int x, int y)	{
		X = x;
		Y = y;
		//txt1.setpos(x,y);
		.updatetxt(.get);
	}
	public move(int x, int y)	{	.setpos(X+x, Y+y); }
	public setz(int z)	{	txt1.setz(z);txt2.setz(z);	}
	public get()	{
		string s = txt1.get();
		( s.length()>0 ) ? s : "";
	}
	getpx	{	txt1.getpx;	}
	getpy	{	txt1.getpy;	}
	getcx	{	txt1.getcx;	}
	getcy	{	txt1.getcy;	}
	geth	{	txt1.geth;	}
	getey	{	txt1.getpy + iFontSize;	}
	clip(int x1, int y1, int x2, int y2)	{
		txt1.clip(x1,y1,x2,y2);
		txt2.clip(x1,y1,x2,y2);
	}
	public length	{	txt1.get->length;	}
	public set(string s)	{	txt1.set(s);	}
	public txtset(string s)	{	txt1.txtsetcol(s,.getcol);	}
	public limit=(int il)	{	iLimit=il;	}
	public onkeydown()	{
		if( this.getlock() )	return;
		.<this+"_ontype">;
		if( keyboard.iskeydown("enter") )	{
			this.disable();
			this.callfun(_sob,_sfun);
			.<this+"_onenter">;
			return;
		}
		string s;
		if( sChars.contains("t") && keyboard.iskey("tab") )	s = " ";
		else s = keyboard.getkey();
		string s2 = txt1.get();
		if( ( (keyboard.isalpha && sChars.contains("a") ) || ( keyboard.isdigit && sChars.contains("0") )
			|| sChars.contains(s) ) && (iLimit<=0 || iLimit>s2.length)  )	{
			//txt1.set( s2+s );
			//txt1.createtxt(iR,iG,iB);
			.updatetxt(s2+s);
			this.updatecyk();
		} else if (keyboard.iskey("backspace") && s2.length()>0)	{
			//txt1.set( s2.strsube(1) );
			//txt1.createtxt(iR,iG,iB);
			.updatetxt( s2.strsube(1) );
			this.updatecyk();
		}
		.<this+"_ontyped">;
	}
	updatetxt(string s)	{
		txt1.set(s);
		txt1.createtxt(iR, iG, iB);
		if( Sdir == "center" )	txt1.setpos( X+(W-txt1.getw)/2, Y );
		else if (Sdir=="right")	txt1.setpos( X+W-txt1.getw, Y );
		else txt1.setpos(X, Y);
		if( bpass )	.copytopass;
		.<this+"_onwrite">;
	}
}

class ConTextTyper : TextTyper, ObjController	{
	init()	{
		TextTyper::init();
		ObjController::init();
	}
}

new string sTextBoxTyperSys = null;
class TextBoxTyper : LObjController, ImagePos	{
	init(string sfont, int ish, int isw, int ir, int ig, int ib, string schars, int x, int y, int w, int h, int dy)	{
		LObjController::init;
		ImagePos::init;
		new @Font = .checkfont(sfont, ish);
		.vars2(A,"Cols", w/isw, "Rows", h/(ish+dy), "X", x, "Y", y, "Row", 0, "enablemove", true, "W", w,
			"insystem", false, "H", h, "isvisible", 1, "clipx1", x, "clipy1", y, "clipx2", 0, "clipy2", 0, "clipped", false );
		new @Size = ish;
		new @Dy = dy;
		new @Z = 0;
		string s;
		new gmimgvec grtt;
		new gmimgvec gren;
		for( int i=0; i<Rows; i++)	{
			s = "tt"+i;
			new TextTyper <s>(Font,ish,ir,ig,ib,schars,Cols);
			<s>.W = (w);
			<s>.Sdir = ("left");
			<s>.setpos( x, y+i*(ish+dy) );
			grtt.add(s);
		}
	}
	settyper(int id, string sfont, int ish, int isw, int ir, int ig, int ib, string schars, string sdir)	{
		int x;
		int y;
		string s;
		string stext = "";
		if( id<0 ) {
			x = <grtt.last>.X;
			y  = <grtt.last>.getey+Dy;
			id = grtt.size;
			grtt.add("tt"+id);
		} else {
			s = grtt.get(id);
			x = <s>.X;
			y = <s>.getpy;
			stext = <s>.get;
			grtt.movefrom( s, 0, ish - <s>.iFontSize );
			delete <s>;
		}
		s = "tt" + id;
		new TextTyper <s>(sfont,ish,ir,ig,ib,schars,W/isw);
		<s>.W = (W);
		<s>.Sdir = (sdir);
		<s>.updatetxt(stext);
		<s>.setz(Z);
		<s>.setpos( x, y );
	}
	move(int x, int y)	{	grtt.move(x,y); gren.move(x,y); X+=x; Y+=y;	}
	size	{	grtt.size;	}
	setz(int z)	{	Z = z; grtt.setz(z);	gren.setz(z); }
	getz	{	Z;	}
	show	{	isvisible=1; grtt.show;	}
	hide		{	isvisible=0;	grtt.hide;		}
	clip(int x1, int y1, int x2, int y2)	{
		clipped = true;
		clipx1=x1;	clipy1=y1;	clipx2=x2;	clipy2=y2;
		for( int i=0; i<grtt.size; i++) <grtt.get(i)>.clip(x1,y1,x2,y2);
	}
	getw	{	W;	}
	geth	{	H;	}
	enumerate(int dx)	{
		string s[2];
		for( int i=0; i<grtt.size; i++)	{
			s0 = "txte"+i;
			new text <s0>;
			gren.add(s0);
			<s0>.setz(Z);
			<s0>.setfont(Font);
			<s0>.txtsetcol(""+(i+1)+".", tt0.getcol);
			<s0>.setpos(X-<s0>.getw-dx,Y+i*(Size+Dy));
		}
	}
	cut(int id)	{	Rows=id;	}
	enable	{	.unlock;	.activateact;	}
	disable	{	.lock; grtt.eval("disable");	}
	actual	{	"tt"+Row;	}
	activate(int id)	{
		.unlock;
		if( id>=0 && id<Rows )	{
			if( insystem )	{
				if( <GAME>.isgmobj(sTextBoxTyperSys) && sTextBoxTyperSys!=this )	<sTextBoxTyperSys>.deactivate;
				sTextBoxTyperSys = this;
			}
			.deactivate;
			Row = id;
			<"tt"+ Row>.enable;
			.<this+"_activate">;
		}
	}
	activateact	{	.activate(Row);	}
	deactivate	{	<"tt"+Row>.disable;	}
	onkeydown	{
		if(.getlock)	return;
		.<this+"_boxontype">;
		if( keyboard.iskeydown("enter") )		{
			@s = .getid(Rows-1);
			s.clear;
			if( s.length==0 && enablemove )	{
				for( @i=Rows-1; i>Row+1; i--)	.setid( .getid(i-1), i);
				if( Row+1<Rows) .setid("", Row+1);
			}
			.activate(Row+1);
		} else if (keyboard.iskey("up") && Row>0) .activate(Row-1);
		else if (keyboard.iskey("down") && Row<Rows-1) .activate(Row+1);
		else if (keyboard.iskey("pgdown"))	{
			if(Row<Rows-10) .activate(Row+10);
			else .activate(Rows-1);
		} else if (keyboard.iskey("pgup"))	{
			if(Row>9) .activate(Row-10);
			else .activate(0);
		} else if ((keyboard.iskey("backspace") || keyboard.iskey("delete")) && <.actual>.length==0 ) {
			if( enablemove )	{
				for( @i=Row; i<Rows-1; i++)	.setid( .getid(i+1), i);
				.setid("",Rows-1);
			}
			if( keyboard.iskey("backspace") )
				.activate(Row-1);
		} else grtt.eval("onkeydown");
	}
	onmouselclick	{
		if(.getlock)	return;
		|int x, int y| = mouse.getpos;
		//if(  )	{
		if( (clipped && clsurf.isin(x,y,clipx1,clipy1,clipx2,clipy2)) || (!clipped && clsurf.isin2(x,y,X,Y,W,H)) )	{
			.deactivate;
			//.activate( ((y-Y)*Rows)/H );
			for( int i=0; i<.size; i++)	{
				if( <"tt"+i>.getey > y ) {
					.activate(i);
					return;
				}
			}
		} else {
			.<this+"_OUTSIDE">;
		}
	}
	int isin(int x, int y, bool bv, bool ba)	{
		if( bv && !isvisible ) return 0;
		clsurf.isin2(x,y,X,Y,W,H);
	}
	string getid(int id)	{	<"tt"+id>.get;	}
	string getact		{	<"tt"+Row>.get;	}
	int idpx(int id)	{	<"tt"+id>.getpx;	}
	int idpy(int id)	{	<"tt"+id>.getpy;	}
	//int getpy	{	.idpy(0);	}
	//int getpx	{	.idpx(0);	}
	int getpx	{	X;	}
	int getpy	{	Y;	}
	string get	{	.getfrom(0);	}
	string getfrom(int id)	{	.getlinesfrom(id,"");	}
	string getlinesfrom(int id, string send)	{
		string s = "";
		for( int i=id; i<grtt.size; i++) s += <"tt"+i>.get + send;
		s;
	}
	string getlines	{	.getlinesfrom(0," ");	}
	int nonempty(int id)	{
		string s;
		for( ; id<grtt.size; id++)	{
			s = <"tt"+id>.get;
			s.clear;
			if( s.length > 0 ) return id;
		}
		-1;
	}
	clear	{	grtt.txtreset;	}
	setid(string s, int id)	{	if( grtt.size>=id )	<"tt"+id>.txtset(s);	}
	settext(int ile)	{
		while(ile>0)	{
			ile--;
			.setid(_,ile);
		}
	}
	copytodb(string sdb)	{
		<sdb>.free;
		for( int i=0;i<grtt.size; i++)	{
			<sdb>.add( <sdb>.addrow-1, <grtt.get(i)>.get);
		}
	}
	copyfromdb(string sdb)	{	.copyfromdbii(sdb, 0, <sdb>.getrowsno);	}
	copyfromdbss(string sdb, string s1, string s2)	{	.copyfromdbii(sdb, <sdb>.findbyrow(s1)+1, <sdb>.findbyrow(s2) );	}
	copyfromdbii(string sdb, int row1, int row2)	{
		if( row1==-1 || row2==-1 ) return;
		.clear;
		if( row2-row1 > .size ) row2 = row1+.size;
		for( int i=row1; i<row2; i++)	{
			if( <sdb>.getcolsno(i) )
				.setid( <sdb>.get(i,0), i-row1 );
		}
	}
	copyfromdbrow(string sdb, int row, int startcol)	{
		int size = <sdb>.getcolsno(row);
		if( size>.size ) size = .size;
		for( int i=startcol; i<size; i++)
			.setid( <sdb>.get(row,i), i-startcol );
	}
	save(string sfile)	{
		new db __tmpdb;
		.copytodb("__tmpdb");
		__tmpdb.setseparator("|");
		__tmpdb.save(sfile);
		delete __tmpdb;
	}
	load(string sfile)	{
		new db __tmpdb;
		__tmpdb.load(sfile);
		.copyfromdb("__tmpdb");
		delete __tmpdb;
	}
	/*H	{
		if( grtt.size )	<grtt.last>.getey-<grtt.first>.getpy;
		else 0;
	}*/
}

class GUITextBoxTyper : TextBoxTyper	{
	init(string sfont, int ish, int isw, int ir, int ig, int ib, string schars, int x, int y, int w, int h, int dy)	{
		TextBoxTyper::init(sfont,ish,isw,ir,ig,ib,schars,x,y,w,h,dy);
		.vars2(A,"rewinder", null, "rewinderbg", null);
	}
	setrewinder(string s)	{
		rewinder = s;
		rewinderbg = s + "bg";
	}
	activate(int id)	{
		TextBoxTyper::activate(id);
		.updaterewactual;
	}
	updaterewactual	{	.updaterewpos(Row);	}
	updaterewpos(int id)	{
		if( rewinder!=null )	{
			@s = "tt"+id;
			if( <s>.getpy < <rewinderbg>.getpy )		<rewinder>.rewind( 0, <rewinderbg>.getpy - <s>.getpy );
			else if (<s>.getey > <rewinderbg>.getey)		<rewinder>.rewind( 0, <rewinderbg>.getey - <s>.getey );
		}
	}
}

/****************************************************************/
class DelayTaker	{
	init()	{
		new bool bonrel = false;
		new bool bstart = false;
		new bool bclickrel = true;
		this.cnewtimerfin("timwez",300,1, func { bonrel=true; } );
	}
	public setclickrel(bool b)	{	bclickrel=b;	}
	public setdelay(int idelay)	{	timwez.delay(idelay);	}
	public take()	{
		if( bclickrel )	{
			timwez.play();
			bonrel=false;
		} else bonrel=true;
		bstart=true;
		
	}
	public ret()	{
		bonrel=false;
		bstart=false;
		timwez.stop(false);
	}
	public bool isonclick()	{
		this.stoptimer();
		( bstart && !bonrel );
	}
	public bool isonrel()	{
		this.stoptimer();
		( bstart && bonrel );
	}
	public bool istaken()	{	bstart;	}
	public stoptimer()	{	timwez.stop(false);	}
}


class ImgMover	{
	init()	{
		new string smoved=null;
		new int ilastx;
		new int ilasty;
		new int irelx;
		new int irely;
	}
	public mssetobj(string s)	{	this.setobj(s,mouse.getpos);	}
	public setobj(string s, int x, int y)	{	this.set(s,x,y,0,0);	}
	public setcobj(string s)	{	.setobj(s, <s>.getcx, <s>.getcy);	}
	public setpobj(string s)	{	.setobj(s, <s>.getpx, <s>.getpy);	}
	public set(string s, int x, int y, int dx, int dy)	{
		ilastx = <s>.getposx()-dx;
		ilasty = <s>.getposy()-dy;
		irelx = x-<s>.getpx();
		irely = y-<s>.getpy();
		smoved = s;
	}
	public msmove()	{	this.move(mouse.getpos);	}
	public msftmove()	{	this.ftmove(mouse.getpos);	}
	public move(int x, int y)	{
		if( smoved!=null )	<smoved>.setpos( x-<smoved>.lodx()-irelx, y-<smoved>.lody()-irely );
	}
	public ftmove( int x, int y)	{	if( smoved!=null )	<smoved>.setpos( x, y );	}
	public retobj()	{	this.ret(0,0);	}
	public ret(int dx, int dy)	{
		<smoved>.setpos(ilastx+dx, ilasty+dy);
		this.free();
	}
	public put(int x, int y)	{
		<smoved>.setpos(x,y);
		this.free();
	}
	public free()	{	smoved=null;	}
	public string getmover()	{	smoved;	}
	public string getfree	{	@s = smoved; .free; s; }
	public bool moving()	{	smoved!=null;	}
}

class ConImgMover : ImgMover, ObjController	{
	init()	{
		ImgMover::init();
		ObjController::init();
	}
	onmousemove()	{	this.msmove();	}
	onmouselclick	{	.<_sme+"_GET">;	}
	onmouselrel	{	if( smoved!=null ) .<_sme+"_PUT">;	}
}

class DelayMover : ImgMover, LObjController	{
	init()	{
		ImgMover::init();
		LObjController::init();
		new DelayTaker cldt; 
	}
	public setclickrel(bool b)	{	cldt.setclickrel(b);	}
	public reset	{	cldt.ret;	}
	_put()	{
		cldt.ret();
		this.<_sme+"_PUT">();
	}
	set(string s, int x, int y, int dx, int dy)	{
		ImgMover::set(s,x,y,dx,dy);
		cldt.take;
	}
	onmousemove()	{	this.msmove();	}
	onmouselclick()	{
		if( this.getlock() ) return;
		if( cldt.isonclick() )	this._put();
		else if (!cldt.istaken())
			this.<_sme+"_GET">();
	}
	onmouselrel()	{
		if( this.getlock() ) return;
		if( cldt.isonrel() )
			this._put();
	}
}

class Rewinder : classlocker	{
	init(int x1, int y1, int x2, int y2)	{
		classlocker::init();
		new string sarrowdir;
		new int ilenx;
		new int ileny;
		new string sgr;
		new string sorientation;
		new bool bvertical;
		new bool bfilteritem = false;
		
		// clip obiektow
		new int ibx1=0;
		new int ibx2=iResX;
		new int iby1=0;
		new int iby2=iResY;
		
		new int iodleg = 2;	// odleglosc pomiedzy przedmiotami
		
		new ImgMover clmv;
		
		this.cnewtimercyclefin("timtick", 1, 1, "timfin");
		
		// granice
		.vars2(A, "borx1", x1, "bory1", y1, "borx2", x2, "bory2", y2);
		
		new snd fxrew;
// 		fxrew.addmethod("onfinish", func { this.play(); } );
	}
	public movefilter()		{	bfilteritem=true;	}
	public movenormal()	{	bfilteritem=false;	}
	public setfxrew(string sfile)	{
		fxrew.load(this.getsndpath()+sfile);
	}
	public getitem(string s, int x, int y)	{
		/*clmv.set(s,x,y,<sgr>.getpx(),<sgr>.getpy());
		<s>.clip(0,0,800,600);
		<sgr>.movefrom(s, 0, -<s>.geth);
		<sgr>.remove(s);*/
		<s>.setz( <s>.getz+1 );
		clmv.set(s,x,y,<sgr>.getpx(),<sgr>.getpy());
		<s>.clip(0,0,iResX,iResY);
		if( sorientation=="up" || sorientation=="down")	{
			<sgr>.movefrom(s, -(<s>.getw+iodleg), 0 );
			<s>.move( <s>.getw,0 );
		} else {
			<sgr>.movefrom(s, 0, -(<s>.geth+iodleg));
			<s>.move(0, <s>.geth );
		}
		<sgr>.remove(s);
	}
	public bool pickup(int x, int y)	{
		if( <sgr>.isin(x,y,true,true) )	{
			this.getitem( <sgr>.getsfound(), x, y );
			return true;
		}
		return false;
	}
	public bool mspickup()	{	return this.pickup(mouse.getpos );	}
	public freeitem()	{	clmv.free();	}
	public moveitem()	{
		if( bfilteritem )		clmv.msftmove();
		else		clmv.msmove();
	}
	public retitem()	{
		string s = clmv.getmover();
		clmv.ret(<sgr>.getpx(),<sgr>.getpy());
		this.putitem(s);
	}
	public putitem(string s)	{
		if( sorientation=="up" || sorientation=="down")	{
			<s>.move( <sgr>.getex-<s>.getpx+iodleg, 0);
		} else {
// 			@dx = anupstd.getex - <s>.getw;
// 			<s>.setpos( dx - <s>.lodx, <sgr>.getey-<s>.lody);
			<s>.move( 0, <sgr>.getey-<s>.getpy+iodleg);
		}
		<sgr>.add(s);
		<s>.setz( <s>.getz-1 );
		<s>.clip(ibx1,iby1,ibx2,iby2);
	}
	public string getmoved()	{	return clmv.getmover();	}
	public int getbutw()	{	return anupstd.getw();	}
	public int getbuth()	{	return anupstd.geth();	}
	public movearrows(int x, int y)	{	grarrows.move(x,y);	}
	public build(string sfile, int z, string scursor, string sorient, int dt, string sgrelem)	{
		sgr = sgrelem;
// 		this.newanima("anupstd",sfile,z);
		new anima anupstd;
		anupstd.load(sfile);
		anupstd.setz(z);
		
		anupstd.setframe("up",0);
		this.copyanima("anupstd","anupact");
		anupact.setframe("up",1);
		this.copyanima("anupstd","andownact");
		andownact.setframe("down",1);
		this.copyanima("anupstd","andownstd");
		andownstd.setframe("down",0);
		this.newbutan("butup","anupstd","anupact",null,scursor);
		this.newbutan("butdown","andownstd","andownact",null,scursor);
		butup.addmethod("onmoveon","_rewbutmoveon");
		butdown.addmethod("onmoveon","_rewbutmoveon");
		butup.addmethod("onmoveoff","_rewstrzalkaoff");
		butdown.addmethod("onmoveoff","_rewstrzalkaoff");
		butup.addmethod("onclick","_rewbutclick");
		butdown.addmethod("onclick","_rewbutclick");
		butup.addmethod("onrel","_rewbutrel");
		butdown.addmethod("onrel","_rewbutrel");
		sorientation=sorient;
		new gmimgvec grarrows;
		_ = "grarrows" .+ "anupstd" .+ "anupact" .+ "andownact" .+ "andownstd";
		
		int dy, int dx, int ix, int iy;
		if( sorientation=="up" || sorientation=="down")	{
			bvertical = false;
			ilenx = dt;
			if( sorientation=="down")	{
				anupstd.setpos(borx1,bory2-anupstd.geth());
				anupact.setpos(borx1,bory2-anupact.geth());
				andownstd.setpos(borx2-andownstd.getw(),bory2-andownstd.geth());
				andownact.setpos(borx2-andownact.getw(),bory2-andownact.geth());
				dy = andownstd.getey();
			} else {
				anupstd.setpos(borx1,bory1);
				anupact.setpos(borx1,bory1);
				andownstd.setpos(borx2-andownstd.getw(),bory1);
				andownact.setpos(borx2-andownact.getw(),bory1);
				dy = bory1;
			}
			ibx1 = anupstd.getex()+iodleg;
			ibx2 = andownstd.getpx()-iodleg;
			dx = ibx1;
		} else {
			bvertical = true;
			ileny = dt;
			if( sorientation=="right")	{
				anupstd.setpos(borx2-anupstd.getw(),bory1);
				anupact.setpos(borx2-anupact.getw(),bory1);
				andownstd.setpos(borx2-andownstd.getw(),bory2-andownstd.geth());
				andownact.setpos(borx2-andownact.getw(),bory2-andownact.geth());
				dx = anupstd.getex();
			} else {
				anupstd.setpos(borx1,bory1);
				anupact.setpos(borx1,bory1);
				andownstd.setpos(borx1,bory2-andownstd.geth());
				andownact.setpos(borx1,bory2-andownact.geth());
				dx = borx1;
			}
			iby1 = anupstd.getey()+iodleg;
			iby2 = andownstd.getpy()-iodleg;
			dy = iby1;
		}
		butup._rewbuildbut(this.getname(),"up");
		butdown._rewbuildbut(this.getname(),"down");
		
		int ile = <sgrelem>.size();
		<sgrelem>._setpos(dx,dy);
		new int ilimx = dx;
		new int ilimy = dy;
		string s;
		for(int i=0; i<ile; i++)	{
			s = <sgr>.get(i);
			if( sorientation=="right")	{
				<s>.setpos( dx - <s>.getw() - <s>.lodx(), dy - <s>.lody() );
				dy += <s>.geth()+iodleg;
			} else if (sorientation=="left")	{
				<s>.setpos( dx - <s>.lodx(), dy - <s>.lody() );
				dy += <s>.geth()+iodleg;
			} else if (sorientation=="up")	{
				<s>.setpos( dx - <s>.lodx(), dy - <s>.lody() );
				dx += <s>.getw()+iodleg;
			} else if (sorientation=="down")	{
				<s>.setpos( dx - <s>.lodx(), dy - <s>.geth() - <s>.lody() );
				dx += <s>.getw()+iodleg;
			}
			<s>.clip(ibx1,iby1,ibx2,iby2);
		}
	}
	/*************************************/
	_rewbuildbut(string s, string s2)	{
		new string _sob = s;
		new string _sdir;
		if( s2=="up" )	{
			if(bvertical==false)	{	_sdir = "left";	}
			else {	_sdir = "up";	}
		} else if (s2=="down")	{
			if(bvertical==false)	{	_sdir = "right";	}
			else {	_sdir = "down";	}
		}
	}
	_rewbutmoveon()	{
		//this.mstrzalkaon(_sdir);
		this.<_sob+"_"+_sdir+"_MOVEON">();
	}
	_rewbutclick()	{
		this.mstrzalkaon(_sdir);
		this.<_sob+"_"+_sdir+"_CLICK">();
	}
	mstrzalkaon(string s)	{
		sarrowdir=s;
		timtick.play();
	}
	_rewbutrel	{
		sarrowdir=null;
		timtick.stop(false);
		fxrew.stop(false);
	}
	_rewstrzalkaoff()	{
		sarrowdir=null;
		timtick.stop(false);
		fxrew.stop(false);
		this.<_sob+"_"+_sdir+"_MOVEOFF">();
	}
	timfin()	{
		if( this.getlock() )	{	return;	}
		bool bok = false;
		if( sarrowdir!=null && !<sgr>.empty())	{
			if( sarrowdir=="up")	{
				if( <sgr>.getey() > andownstd.getpy() - ileny )	{
					<sgr>.move(0,-ileny);
					bok=true;
				}
			} else if (sarrowdir=="down") {
				if( <sgr>.getpy() < ilimy )	{
					<sgr>.move(0,ileny);
					bok=true;
				}
			} else if (sarrowdir=="left")	{
				if( <sgr>.getex() > andownstd.getpx() - ilenx )	{
					<sgr>.move(-ilenx,0);
					bok=true;
				}
			} else if (sarrowdir=="right") {
				if( <sgr>.getpx() < ilimx )	{
					<sgr>.move(ilenx,0);
					bok=true;
				}
			}
		}
		if( bok )	{
			if( !fxrew.isplaying() )	fxrew.play();
		} else {
			fxrew.stop(false);
		}
		this.play();
	}
}

class ConRewinder : Rewinder, ObjController {
	init()	{
		Rewinder::init();
		ObjController::init();
		new DelayTaker cldt; 
	}
	public getitem(string s, int x, int y)	{
		Rewinder::getitem(s,x,y);
		cldt.take();
	}
	_put()	{
		cldt.ret();
		this.<_sme + "_PUT">();
	}
	onmousemove()	{	this.moveitem();	}
	onmouselrel()	{
		if( this.getlock() )	return;
		if( cldt.isonrel() )	{	this._put();	}
	}
	onmouselclick()	{
		if( this.getlock() ) return;
		if( cldt.isonclick() )	{
			this._put();
		} else if ( !cldt.istaken() )	{
			this.<_sme+"_GET">();
		}
	}
}

class Button : LObjController	{
	init	{
		LObjController::init;
		.unlock;
		new gmimgvec grbuts;
		.vars2(A,"sobject", null, "sclicked",null);
	}
	sort	{ grbuts.sortimgs; }
	addgroups	{	grbuts.addgroups;	grbuts.sortimgs;	}
	addgroup(string s)	{	grbuts.addgr(s);	grbuts.sortimgs;	}
	addlist		{	grbuts.addlist;		grbuts.sortimgs;	}
	add(string sob)	{	grbuts.add(sob);	grbuts.sortimgs;	}
	addlocker(string sob)	{
		.add(sob);
		classlocker::setaslocker(sob);
	}
	removebutlist	{	.withlist("removebut"); }
	removebut(string sbut)	{
		grbuts.remove(sbut);
		if( sbut==sobject ) sobject=null;
		if( sbut==sclicked ) sclicked = null;
	}
	load(string sname, string sfile, string sfuninit) {
		<GAME>.varnew("gmimgvec", sname);
		sname .* sfile;
		<sname>.each( sfuninit );
		.addgroup(sname);
	}
	remove(string sname)	{
		if( <GAME>.hasvar(sname) )	{
			//for( int i=0; i < <sname>.size; i++ )	grbuts.remove( <sname>.get(i) );
			grbuts.removegr(sname);
		}
	}
	loadfrom(string sname, string spath, string sfile, string sfuninit) {
		@s = .getgraphpath;
		.setgraphpath(spath);
		.load(sname,sfile,sfuninit);
		.setgraphpath(s);
	}
	onmouselclick	{
		if( .getlock ) return;
		.<this + "_lclick">;
		if( sobject!=null)	{
			sclicked = sobject;
			if (<sobject>.hasaddedmet("butclick") )
				<sobject>.butclick;
		}
	}
	onmouselrel	{
		if( .getlock ) return;
		.<this + "_lrel">;
		if( sclicked!=null && <sclicked>.hasaddedmet("butlrel") )	{
			<sclicked>.butlrel;
		} else sclicked=null;
	}
	onmousemove	{
		if( .getlock ) return;
		if( sclicked!=null )	{
			if( <sclicked>.hasaddedmet("butmoving") )	<sclicked>.butmoving;
		}
		|int x, int y| = mouse.getpos;
		if(grbuts.isinfunc(x,y,"isbutin") )	{
			@s = grbuts.getsfound;
			if( s!=sobject )	{
				.lastoff;
				sobject = s;
				.<this + "_moveon">;
 				if( <s>.hasaddedmet("butmoveon") )
					<s>.butmoveon;
			}
		} else {
			.lastoff;
		}
	}
	lastoff	{
		if( sobject!=null )	{
			.<this + "_moveoff">;
			if( <sobject>.hasaddedmet("butmoveoff") )
				<sobject>.butmoveoff;
			sobject = null;
		}
	}
	/*
	virtual bool isbutin(int x, int y)	{ 0; }
	virtual butclick	{}
	virtual butmoveon {}
	virtual butmoveoff {}*/
}
public Button_isin			{	.addmethod("isbutin", func { (@x,@y) .isin(x,y,1,0); } );	}
public Button_isinvis			{	.addmethod("isbutin", func { (@x,@y) .isin(x,y,0,0); } );	}
public Button_isinalpha	{	.addmethod("isbutin", func { (@x,@y) .isin(x,y,1,1); } );	}
public Button_isinvisalpha	{	.addmethod("isbutin", func { (@x,@y) .isin(x,y,0,1); } );	}
public Button_moveon		{
	.addmethod("butmoveon", func {
		sndakskermovon.play;
		advmouse.setbut;
		if( .nofframes(-1)>1 ) .setframe(-1,1);
	} );
}
public Button_moveoff		{	.addmethod("butmoveoff", func { advmouse.setstd; .setframe(-1,0);} );	}
public Button_moveonms	{	.addmethod("butmoveon", func { advmouse.setbut; } );	}
public Button_moveoffms	{	.addmethod("butmoveoff", func { advmouse.setstd; } );	}
public Button_std			{ .Button_isin; .Button_moveon; .Button_moveoff;	}
public Button_stdalpha		{ .Button_isinalpha; .Button_moveon; .Button_moveoff;	}
public Button_stdms		{ .Button_isinalpha; .Button_moveonms; .Button_moveoffms;	}
public Button_stdmsisin		{ .Button_isin; .Button_moveonms; .Button_moveoffms;	}

class Buttons : LObjController	{
	init(string sfile)	{
		LObjController::init;
		.unlock;
		new gmimgvec grbuts;
		new int __id = 0;
		new string sanbut = "anbut";
		.newanima(sanbut, sfile, 10);
		_ = .newanactionsgr(sanbut, sanbut, "grbuts");
		anbut.hide;
		grbuts.setz(10);
		grbuts.removeif( func {
			if( .actionname=="bkg" ) { .setz( .getz-1); true; }
			else false; 
			});
		new string slastb = null;
		.vars2(A,"sobject", null, "bvisible", true, "balpha", true);
	}
	_release()	{
		<slastb>.setframe(-1,0);
		.copyobj;
		.<this + "_moveoff">();
		slastb = null;
		bsms.setstd;
	}
	getbut	{	grbuts.getsfound;	}
	onmousemove()	{
		if( .getlock ) return;
		grbuts.setframe(-1,0);
		def id =  grbuts.isin(mouse.getpos,bvisible,balpha);
		if( slastb!=null ) <slastb>.setframe(-1, 1);
		if( id ) {
			string s = grbuts.getsfound;
			if( s!=slastb )	{
				if( slastb!=null )	._release;
				slastb = s;
				<s>.setframe(-1,1);
				.copyobj;
				bsms.setact;
				.<this + "_moveon">();
			}
		} else if( slastb!=null )	{
			._release;
		}
		//slastb==null ? bsms.setstd : bsms.setact;
	}
	copyobj()	{	sobject = <slastb>.actionname;	}
	onmouselclick()	{
		if( .getlock ) return;
		if( slastb!=null )	{
			.copyobj;
			.<this + "_lclick">;
		}
	}
	onmouselrel	{
		if( .getlock ) return;
		if( slastb!=null )	{
			.copyobj;
			.<this + "_lrel">;
		}
	}
	disable	{
		.lock;
		grbuts.hide;
		if( slastb!=null )	{
			bsms.setstd;
			slastb=null;
		}
	}
	enable	{
		.unlock;
		grbuts.show;
	}
}

class TextDb : classlocker, ObjController, gfxObject {
	init(string sfont, int isize, string sdbfile, int r, int g, int b, int x, int y, int dy, int z, string sdir)	{
		classlocker::init;
		ObjController::init;
		new string sFont = sfont;
		new string sFontBold = null;
		new string sFontItalic = null;
		new string sFontBoldItalic = null;
		new bool bhtml = false;
		
		string s;
		int id, int i;
		if( sfont.contains("$") )	{
			bhtml = true;
			new vector vfont; vfont.type("string");
			vfont.vecbuildfromstring( sfont, "$" );
			
			for( i=0; i<vfont.size; i++)	{
				s = vfont.get(i);
				if( s.contains("_italic") && s.contains("_bold") )	{
					sFontBoldItalic = s;
				} else if ( s.contains("_italic") )	{
					sFontItalic = s;
				} else if ( s.contains("_bold") )	{
					sFontBold = s;
				} else sFont = s;
			}
			if( sFont.contains("$") )	{
				if( sFontItalic!=null ) sFont = sFontItalic;
				else if( sFontBold!=null ) sFont = sFontBold;
				else sFont = sFontBoldItalic;
			}
			sfont = sFont;
		} else sfont = .checkfont( sfont, isize );
		new int iFontSize = isize;
		
		.var2("Z",z);
		string skey = null;
		if( sdbfile.contains(":") )	{
			skey = sdbfile.strgetto(":") + ":";
		}
		if( sdbfile.contains(".db") )	{
			if( skey =="$path:" )	{
				new db dbtxt;
				dbtxt.load( sdbfile.strsubbs(skey) );
			} else .newdb( "dbtxt", sdbfile );
		} else {
			match(skey)	{
				"$lang:" => .lang_db("dbtxt", sdbfile.strsubbs(skey) );
				"$var:" => {
					new db dbtxt;
					dbtxt.dbcopy( sdbfile.strsubbs(skey) );
				}
				"$row:" => {
					new db dbtxt;
					s = sdbfile.strsubbs(skey)->strgetto(",");
					id = sdbfile.strgetfrom(",");
					for( i=0; i< <s>.getcolsno(id); i++)	{
						_ = dbtxt.addrow;
						dbtxt.add(i, <s>.get(id,i) );
					}
				}
				? => {
					new db dbtxt;
					dbtxt.dbaddlast( sdbfile );
				}
			}
		}
		int w = 0, int ile = dbtxt.getrowsno;
		
		if( sdir.getb(0,5)=="limit" )	{
			int lim = sdir.strsubbs("limit_");
			new vector vtmp; vtmp.type("string");
			new vector vtmp2; vtmp2.type("string");
			for( int i=0; i<dbtxt.getrowsno; i++)	{
				vtmp.vecbuildfromstring( dbtxt.get(i,0), " " );
				for( int j=0; j<vtmp.size; j++)
					vtmp2.add(vtmp.get(j));
			}
			dbtxt.free;
			string s = "";
			string s2;
			for( i=0; i<vtmp2.size; i++)	{
				s2 = vtmp2.get(i);
				if( (s+s2)->length < lim )	{
					s += s2 + " ";
				} else {
					j = dbtxt.addrow-1;
					dbtxt.add(j, s);
					s = s2 + " ";
				}
			}
			j = dbtxt.addrow-1;
			dbtxt.add(j, s);
			ile = dbtxt.getrowsno;
		}
		
		new gmimgvec grtxt;
		grtxt._setpos(x,y);
		for( i=0; i< ile; i++)	{
			s = "txt" + i;
			new text <s>;
			@s1 = dbtxt.get(i,0);
			if( bhtml )	{
				if( s1.contains("<b>") ) { sfont = sFontBold; s1.strremove("<b>"); }
				else if( s1.contains("<bi>") ) { sfont = sFontBoldItalic; s1.strremove("<bi>"); }
				else if( s1.contains("<i>") ) { sfont = sFontItalic; s1.strremove("<i>"); }
				else sfont = sFont;
			}
			<s>.setfont( sfont );
			
			<s>.set( s1 );
			<s>.setpos(x,y);
			y+=isize+dy;
			<s>.setz(z);
			<s>.createtxt(r,g,b);
			if( <s>.getw>w ) w = <s>.getw;
			grtxt.add(s);
		}
		.var2("Rows", ile);
		if( sdir == "right" || sdir =="center" )	{
			for( i=0; i<ile; i++)	{
				s = "txt" + i;
				if( sdir == "center" )	{
					<s>.move( (w-<s>.getw)/2, 0 );
				} else {
					<s>.move( w-<s>.getw, 0 );
				}
			}
		}
		.var2("W", w);
		gfxObject::init("grtxt");
	}
	stdshadow(int dt)	{	.setshadow(0,0,0,dt);	}
	setshadow(int r, int g, int b, int dt)	{
		string s[2];
		string sfont = ._checkfont(sFont, iFontSize, "_fntbrd");
		for( int i=0; i< dbtxt.getrowsno; i++)	{
			s0 = "txt" + i;
			s1 = "txts" + i;
			new text <s1>;
			<s1>.set( <s0>.get );
			<s1>.setfont( sfont );
			<s1>.setz( <s0>.getz-1 );
			<s1>.setpos( <s0>.getpx+dt, <s0>.getpy+dt );
			<s1>.createtxt(r,g,b);
			grtxt.add(s1);
		}
	}
	setz(int z)	{
		/*for( int i=0; i< dbtxt.getrowsno; i++)	{
			<"txt" + i>.setz(z);
			<"txts" + i>.setz(z-1);
		}*/
		Z = z;
		grtxt.setz(z);
	}
	getz	{ Z;	}
	isin(int x, int y, bool bv, bool ba)	{	grtxt.isin(x,y,bv,ba);	}
	view	{
		@s = _;
		string s2;
		while(A!=s)	{
			s2 = grtxt.get(s);
			<s2>.show;
			s2 = "txts" + s2.strsubbs("txt");
			if( engine.varexist(s2) ) <s2>.show;
			@s=_;
		}
	}
	blitto(string simg)	{
		string s;
		for( int i=0; i<grtxt.size; i++)	{
			s = grtxt.get(i);
			<s>.buildfullname;
			<simg>.blit(<s>.getfullname);
			<GAME>.vardel(<s>.getfullname);
		}
	}
	setcol(int r, int g, int b)	{
		for( int i=0; i<grtxt.size; i++) <grtxt.get(i)>.createtxt(r,g,b);
	}
	clip(int x1, int y1, int x2, int y2)	{
		for( int i=0; i<grtxt.size; i++) <grtxt.get(i)>.clip(x1,y1,x2,y2);
	}
	setpos(int x, int y)	{
		@dx = x-grtxt.getposx;
		@dy = y-grtxt.getposy;
		grtxt.move(dx, dy);
		//for( int i=0; i<grtxt.size; i++) <grtxt.get(i)>.setpos(x+,y1,x2,y2);
	}
}

class Lexer	{
	init	{}
	buildlex	{
		.vars(A,"id","found");
		new vector vconsts;
		vconsts.type("string");
		new vector vtmp1;
		vtmp1.type("string");
		new vector vtmp2;
		vtmp2.type("string");
		
		new int dot = "."->getbyte(0);
		new string _literal_char = "\"";
	}
	setliteralchar(string s)	{	_literal_char=s;	}
	getliteralchar	{	_literal_char;	}
	bool _isvar(int b1, int b2)	{
		int i = id;
		found = "";
		int ib;
		while(i<.length)	{
			ib = .getbyte(i);
			if( ib>=b1 && ib<=b2 )	{
				found += .getb(i,1);
				i++;
			} else {
				if( (ib>=BYTEa && ib<=BYTEz) || (ib>=BYTEA && ib<=BYTEZ) || ib==BYTE_ )	found="";
				i = .length;
			}
		}
		found.length;
	}
	bool isreal	{
		int i = id;
		found = "";
		int ib;
		bool kropka=true;
		while(i<.length)	{
			ib = .getbyte(i);
			if( (ib>=BYTE0 && ib<=BYTE9) || (ib==dot&&kropka) )	{
				if( ib==dot ) kropka=false;
				found += .getb(i,1);
				i++;
			} else i = .length;
		}
		if( kropka || found.getb(0,1)=="." || found.gete(0,1)=="." ) found="";
		found.length;
	}
	bool isident	{
		int i = id;
		found = "";
		int ib;
		while(i<.length)	{
			ib = .getbyte(i);
			if( (ib>=BYTEa && ib<=BYTEz) || (ib>=BYTEA && ib<=BYTEZ) || ib==BYTE_ ||
				(i>id && ib>=BYTE0 && ib<=BYTE9) )	{
				found += .getb(i,1);
				i++;
			} else i = .length;
		}
		found.length;
	}
	bool isliteral	{
		if( .check!=.getliteralchar )	return false;
		int i = id+1;
		found = "";
		string s;
		while(i<.length)	{
			s = .getb(i,1);
			if( s==.getliteralchar )	{
				//found += s;
				return true;
			} else {
				found += s;
				i++;
			}
		}
		false;
	}
	bool isconst	{
		string s0;
		bool b = .isident;
		for( int i=0; i< vconsts.size; i++)	{
			s0 = vconsts.get(i);
			if( b )	{
				if( s0 == found )	return true;
			} else {
				found = .getb(id, s0.length);
				if( s0 == found ) return true;
			}
		}
		false;
	}
	gettoken(string svec, bool bideal)	{
		<svec>.free;
		while( .notend )	{
			if (.check==" ")	id++;
			else if (.isconst)	{	<svec>.add("$const"); <svec>.add(.read);	}
			else if (.isreal )		{<svec>.add( "$real" );	.next; if( bideal ) <svec>.add( found );}
			else if (.isint )		{<svec>.add( "$int" );	.next; if( bideal ) <svec>.add( found );}
			else if (.isident )	{<svec>.add( "$alpha" );	.next; if( bideal ) <svec>.add( found );}
			else if (.isliteral )	{<svec>.add( "$literal" );	.next; id+=2; if( bideal ) <svec>.add( found );}
			else	{<svec>.add("$error"); id++; }
		}
	}
	int expectdb(string sdb, bool bideal)	{	// identyczne lub parse
		int j, string s;
		for( int i=0; i< <sdb>.getrowsno; i++)	{
			//vtmp2.veccopydbrow(sdb,i);
			vtmp2.free;
			for( j=0; j< <sdb>.getcolsno(i); j++)	{
				s = <sdb>.get(i,j);
				s.clear;
				if( s!="" ) vtmp2.add(s);
			}
			if( .expectvec("vtmp2", bideal) )	return i;
		}
		-1;
	}
	bool expectvec(string svecsrc, bool bideal)	{
		id = 0;
		.gettoken("vtmp1", bideal);
		/*vtmp1.print;
		<svecsrc>.print;*/
		vtmp1.veceq(svecsrc);
		/*bool b = vtmp1.veceq(svecsrc);
		if( !b ) {
			("wrong expect "+.get)->print;
			vtmp1.print;
			<svecsrc>.print;
		}
		b;*/
	}
	bool expects(string s, string ssep, bool bideal)	{
		vtmp2.vecbuildfromstring(s,ssep);
		.expectvec("vtmp2", bideal);
	}
	consts=	{	vconsts.withlist("addbegin");	}
	setas(string sob)	{
		<sob>.addmethod("buildlex", "buildlex");
		<sob>.buildlex;
		<sob>.addmethod("start",	func { (string s) .set(s);	id=0; } );
		<sob>.addmethod("notend",	func {	id<.length;	} );
		<sob>.addmethod("getnext",	func { if( id==.length ) return null;
					id++;	.getb(id-1,1);	} );
		<sob>.addmethod("next",	func { id+=found.length;	} );
		<sob>.addmethod("check",	func { if( id==.length ) return null; found=.getb(id,1); found; });
		<sob>.addmethod("ischar",	func { (string s) s.contains( .getb(id,1) ); } );
		<sob>.addmethod("isint",	func{	._isvar(BYTE0, BYTE9);	} );
		<sob>.addmethod("isreal", "isreal");
		<sob>.addmethod("isbinary",	func{	._isvar(BYTE0, BYTE0+1);	} );
		<sob>.addmethod("isident",	"isident" );
		<sob>.addmethod("isconst",	"isconst" );
		<sob>.addmethod("_isvar", "_isvar");
		<sob>.addmethod("read",	func { .next;	found;	} );
		<sob>.addmethod("isliteral", "isliteral");
		<sob>.addmethod("gettoken", "gettoken");
		<sob>.addmethod("expects", "expects");
		<sob>.addmethod("expectvec", "expectvec");
		<sob>.addmethod("expectdb", "expectdb");
		<sob>.addmethod("consts=", "consts=");
		<sob>.addmethod("setliteralchar", "setliteralchar");
		<sob>.addmethod("getliteralchar", "getliteralchar");
	}
}


class AnimaFx	{
	init {}
	build(string san)	{
		<san>.addmethod("_buildanfx", func {
			new db dbsnd;
			dbsnd.dbbuild(3);
			for( int i=0; i<dbsnd.getrowsno; i++) dbsnd.set(i,0, dbsnd.get(i,0)+"_"+dbsnd.get(i,1));
			} );
		<san>._buildanfx;
		<san>.addmethod("onsetframe", func {
			@id = dbsnd.findbyrow(.actionname+"_"+.framenr);
			if( id>=0 ) {
				<"fx"+dbsnd.get(id,2)>.play;
			}
			} );
	}
}

class Localize	{
	init	{}
	_lang_db(string sname, string sfile, string sfunload)	{
		new db <sname>;
		<sname>.<"load"+sfunload>( .lang_path(sfile) + ".db");
	}
	lang_db(string sname, string sfile)	{ ._lang_db(sname,sfile,"");	}
	lang_dbscript(string sname, string sfile)	{ ._lang_db(sname,sfile,"script");	}
	lang_dbbeh(string sname, string sfile)	{ ._lang_db(sname,sfile,"beh");	}
	lang_path(string sfile)	{ LANGDIR + gameapi.getgamename + "_" + sfile + LANG; }
}

class PyzCounter	{
	init(string sanima, int timestep)	{
		new int istart;
		new int istop;
		new int istep;
		new int idigits = 50;
		new int iactual;
		new string _sanima = sanima;
		.vars2(A, "idx",2, "itimestep", timestep);
		
		new gmimgvec grcnt;
		for( int i=0; i<idigits; i++ )	{
			string s = "pcc" + sanima + i;
			.copyanima(sanima, s);
			<s>.hide;
			grcnt.add(s);
		}
		.timer = ("timcnt", timestep, func {
			iactual += istep;
			.view(iactual);
			if( iactual==istop )	{
				<.getbuildername>.<.getbuildername+"_finish">;
			} else .play;
			} );
	}
	getcypher(int id)	{	"pcc" + _sanima + id;	}
	start(int start, int stop, int step)	{
		istart = start;
		istop = stop;
		istep = step;
		iactual = istart;
		.view(istart);
		timcnt.play;
	}
	showcypher(int i, int cypher)	{
		string s = .getcypher(i);
		<s>.setframe(0, cypher);
		<s>.show;
	}
	stop	{
		timcnt.stop(false);
	}
	view(int cnt)	{
		grcnt.hide;
		grcnt.setpos(0,0);
		if( cnt==0 )	{
			.showcypher(0,0);
		} else {
			for( int i=0; cnt > 0; i++ )	{
				.showcypher(i, cnt%10);
				cnt=cnt/10;
			}
			int w = 0;
			for( int j=i-1; j>=0; j-- )	{
				<.getcypher(j)>.move( w, 0 );
				w = w + <.getcypher(j+1)>.getw;
			}
		}
	}
}
/*************************************************************************/

class AnMover	{
	init(string san, real x, real y)	{
		new timer tmov;
		tmov.settick(1);
		tmov.setcycle(1);
		//new real rdx = x;
		//new real rdy = y;
		.vars2(A, "rdx", x, "rdy", y);
		new real rsx = 0;
		new real rsy = 0;
		new string sanima = san;
		tmov.addmethod("onfinish", func {
			.move;
			.builder_func("_finish");
			.play;
			} );
	}
	move	{
		rsx += rdx;
		rsy +=rdy;
		int x = rsx;
		int y = rsy;
		if( x || y ) {
			<sanima>.move(x,y);
			rsx-=x;
			rsy-=y;
		}
	}
	reset	{
		rsx=0;
		rsy=0;
	}
	play	{
		.reset;
		tmov.play;
	}
	stop	{	tmov.stop(false);	}
}

class SetAnMover	{
	init	{}
	setas(string sanima, real x, real y)	{
		<sanima>.addmethod("setanmover", "setanmover");
		<sanima>.setanmover(x,y);
		<sanima>.addmethod("sam_move", "sam_move");
	}
	setanmover(real x, real y)	{
		new real rdx = x;
		new real rdy = y;
		new real rsx = 0;
		new real rsy = 0;
		.var2("sam_speed", 1.0);
	}
	sam_move	{
		rsx += (rdx*sam_speed);
		rsy += (rdy*sam_speed);
		int x = rsx;
		int y = rsy;
		if( x || y ) {
			.move(x,y);
			rsx-=x;
			rsy-=y;
		}
	}
}

/*************************************************************************/
class classlives	{
	init()	{}
	set(int ile, int idamage, int x, int y, int h, int r1, int g1, int b1, int a1, int r2, int g2, int b2, int a2, int z, string sside)	{
		new int iside;
		
		if( sside=="left")iside=-1;
		else	iside=1;
		
		new int iilezyc = ile;
		new int ibum	= idamage;
		int idl = iilezyc*ibum;
		new int iposxsila = x;
		new int iendxsila = x+idl;
		new int iposysila = y;
		newvars::newcanvas( "imgsilapodkladka",idl, h, r1, g1, b1, a1, z-1 );
		newvars::newcanvas( "imgsila",idl, h, r2, g2, b2, a2, z );
		imgsila.setpos( iposxsila, iposysila );
		imgsila.clip(iposxsila, 0,  imgsila.getex(), 600);
		imgsilapodkladka.setpos( iposxsila, iposysila );
	}
	reset()	{
		imgsila.setpos( iposxsila, iposysila );
	}
	damage(int idam)	{
		imgsila.move( iside*idam*ibum, 0);
	}
	int destroyed()	{
		if( iside<0)	return imgsila.getex() < iposxsila;
		return imgsila.getpx() > iendxsila;
	}
	heal(int idam)	{
		imgsila.move( -iside*idam*ibum, 0 );
		if( iside > 0 )	{
			if( imgsila.getpx() < iposxsila )	{
				imgsila.setpos( iposxsila, iposysila );
			}
		} else {
			if( imgsila.getpx() > iposxsila )	{
				imgsila.setpos( iposxsila, iposysila );
			}
		}
	}
}


class imganima : gmimgvec	{
	init	{
		gmimgvec::init;
		new int idgran = 0;
		new timer timan;
		timan.settick(1);
		timan.addmethod("onfinish", func {
			idgran++;
			@s = .getbuildername;
			if( idgran == <s>.size )	{
				<s>.<s+"_finish">;
			} else {
				.setframe(idgran);
				<s>.<s+"_endframe">;
				.play;
			}
			} );
	}
	load(string simg, string sfiletype, int istart, int istop, int icycle)	{
		timan.setcycle(icycle);
		for( int i=istart; i<istop; i++)	{
			@s = simg + i;
			.newimg("an" + s, s + "." + sfiletype, 0);
			.add("an" + s);
		}
		.setframe(0);
	}
	play	{
		.setframe(0);
		timan.play;
	}
	setframe(int id)	{
		.hide;
		idgran = id;
		<.get(id)>.show;
	}
}


module advmouse	{
	init()	{
		new anima anmsc;
	}
	public load(string sname)	{
		anmsc.load(sname);
		anmsc.hide();
	}
	set(string saction)	{
		anmsc.show();
		anmsc.setframe( saction, 0 );
		mouse.setcursor("anmsc");
		anmsc.hide();
	}
	setstd()	{	this.set("normal");	}
	setactive()	{	this.set("active");	}
	setact()	{	this.set("active");	}
	setbut	{	this.set("active");	}
	setexit()	{	this.set("exit");	}
	setwait()	{	this.set("wait");	}
	get()		{	return anmsc.actionname();	}
}

game Tclassmenu	{
	init()	{
		new db _dbl;
		new gmobjvec gr1;
		gr1.add("bkg");
	}
	public tload(string spath, string sbuts, string sdbfile)	{
		this.setgraphpath(spath);
		if( sdbfile!=null )	{
			_dbl.loadscript(this.getgraphpath()+sdbfile);
			for(int i=0; i<_dbl.getrowsno();i++)	{
				this.newsnd("snd"+_dbl.get(i,0), _dbl.get(i,1)+".wav");
			}
		}
		new classbutton _clb;
		_clb.build2( this.getgraphpath() + sbuts, 10, "imglobcurs", "gr1" );
		_clb.clickfunc("_gmbutclick");
		_clb.movonfunc("_gmbutmove");
		if(engine.varexist("sndintro"))	this.cbplay("sndintro");
	}
	mouselclick()	{
		this.cactsndstop(true);
	}
	_gmbutmove(string s)	{
		sndakskermovon.play();
		if( engine.varexist("sndintro") && sndintro.isplaying() )	return;
		if( engine.varexist("snd"+s) )	this.crselfplay("snd"+s);
	}
	_gmbutclick(string s)	{
		this.<s+"_BUTCLICK">();
	}
}

class TMenu 	{
	init()	{}
	tinit(string sbuts)	{
		new Buttons but1(sbuts);
	}
	mousel_click()	{
		.cactsndstop(true);
	}
	but1_moveon	{
		string s = but1.sobject;
		sndakskermovon.play;
		if( !(engine.varexist("sndintro") && sndintro.isplaying) )
			if( engine.varexist("snd"+s) )	this.cbselfplay("snd"+s);
		.<s+"_MOVEON">;
	}
	but1_moveoff	{	.<but1.sobject + "_MOVEOFF">;	}
	but1_lclick()	{
		this.<but1.sobject+"_BUTCLICK">();
	}
}

/************ template game Painter **************/
class TPainter {
	init()	{}
	tinit(string sndbase, string spath, string sfilebg, string sfilebrush, string sfile, string sfarby, @dir, string ssavefile)	{
		if( sndbase!=null )
			GameController::init(sndbase);
		this.unlock();
		if( spath!=null )
			this.setgraphpath(spath);
		
		if( sfilebg!=null )
			this.newanima("anbkg",sfilebg,0);
		this.newanima("anbrush1", sfilebrush, 3000);
		this.copyanima("anbrush1","anbrush2");
		anbrush2.setframe(0,1);
		anbrush2.setz(anbrush1.getz-1);
		anima_pack::resizemethods("anbrush1");		// galka
		anima_pack::resizemethods("anbrush2");		// pedzel
		int x, int y;
		match( dir )	{
			"ru" => { x = anbrush2.getex;
				y = anbrush2.getpy; }
			"rd" => { x = anbrush2.getex;
				y = anbrush2.getey; }
			"ld" => { x = anbrush2.getpx;
				y = anbrush2.getey; }
			? => { x = anbrush2.getpx;
				y = anbrush2.getpy; }
		}
		anbrush1.saverelpos(x, y);	// lewy dolny rog - kursor myszy
		anbrush2.saverelpos(x, y);	// lewy dolny rog - kursor myszy
		mouse.hide();
		
		this.newanima("anfg", sfile, 100);
		anfg.setframe("foreground",0);
		
		new gmimgvec grdraw;
		_ = this.newanframesgr("anfg", "andraw", anfg.actionnr("draw"), "grdraw");
		grdraw.setz(10);
		
		new gmimgvec grpaleta;
		//_ = this.newanframesgr("anfg", "anpaleta", anfg.actionnr("paleta"), "grpaleta");
		"grpaleta" ..< sfarby;
		grpaleta.setz(20);
		
		new int _ibrx = anbrush2.getpx();
		new int _ibry = anbrush2.getpy();
		while( !anbrush2.isin(_ibrx, _ibry, false, true) )	{
			_ibrx++;
			if( _ibrx==anbrush2.getex() ) {
				_ibrx = anbrush2.getpx();
				_ibry++;
			}
		}
		_ibrx-=anbrush2.getpx();
		_ibry-=anbrush2.getpy();
		TPainter::tp_mouse_move;		// ustawienie pedzla w pozycji myszy
		
		if( ssavefile!=null )	{
			new string savefile = ssavefile;
			new db dbkolory;
			@s = ssavefile;
			//if( engine.fileexist(s) )	{
			if( .saveexist(s) )	{
				dbkolory.vecload(s);
				grdraw.each( func { (@id)
					.paint( dbkolory.get(id,0), dbkolory.get(id,1), dbkolory.get(id,2), 255, 0);
					} );
			} else {
				grdraw.each( func { (@id)
					.paint(.white,255,0);
					dbkolory.dbaddstringrow("255 255 255"," ");
					} );
				.tp_savekols;
			}
		}
	}
	game_exit()	{
		mouse.show();
		GameController::game_exit();
	}
	tp_exit	{
		mouse.show;
	}
	tp_mouse_move()	{
		anbrush1.mssetrelpos();
		anbrush2.mssetrelpos();
	}
	tp_mouse_lclick()	{
		if( !this.getlock() )	{
			|int x, int y| = mouse.getpos();
			if( grdraw.isin(x,y,true,true) )	{
				<grdraw.getsfound()>.paint(
					anbrush2.getrgba(anbrush2.getpx()+_ibrx,anbrush2.getpy()+_ibry), 0 );
				.onpaint;
			} else if ( grpaleta.isin(x,y,false,true) )	{
				|@c[4]| = <grpaleta.getsfound()>.getrgba(x,y);
				c3 = 255;
				anbrush2.paint( c0, c1, c2, c3, 0 );
				.onsetbrush;
			}
		}
	}
	tp_savekols	{
		if( !<GAME>.hasvar("dbkolory") ) return;
		grdraw.each( func { (@id)
			int c[4];
			//|c0, c1| = .anfirstnontr;
			int ex = .getex , int ey = .getey;
			int x = .getpx, int y=.getpy;
			while( x!=ex && y!=ey )	{
				if( .isin(x,y,false,true) ) { c0=x; c1=y; x=ex; }
				else x++;
			}
			|c0,c1,c2,_| = .getrgba(c0,c1);
			dbkolory.set(id,0,c0);
			dbkolory.set(id,1,c1);
			dbkolory.set(id,2,c2);
			} );
		dbkolory.vecsave( savefile );
	}
	tp_default_erase	{	.tp_erase(.white,255);	}
	tp_erase(int r, int g, int b, int a)	{
		for( int i=0; i< grdraw.size; i++)	{
			<grdraw.get(i)>.paint(r,g,b,a,0);
			dbkolory.set(i,0,255);
			dbkolory.set(i,1,255);
			dbkolory.set(i,2,255);
		}
		.tp_savekols;
	}
}

class TPainterCon : TPainter, GameController	{
	init	{}
}
new int iMemoTryb=1;	// 0 - player na czas, 1 - player vs computer, 2 - player vs player
new int iMemoW;
new int iMemoH;
new int iMemoAI = 0;	// poziom trudnosci

class TMemo 	{
	init()	{}
	public tinit(string sbkg, string stafle, string snakl, int dt)	{
		
		if( sbkg.gete(0,3)=="pyz") .newanima("anbkg", sbkg, 0);
		else .newimg("anbkg", sbkg, 0);
		
		.newanima("antaf", stafle, 20);
		.newanima("annak", snakl, 20);
		
		new int ipredkosc = 25;
		new gmimgvec grtaf;
		new gmimgvec grnak;
		new vector veci	{
			.vecnewint( antaf.nofframes(0) );
			.hash;
		};
		string s, int i[3], int j;
		i0 = 0;
		for( int i=0; i<iMemoW; i++)	{
			for( j=0; j<iMemoH; j++)	{
				new anima <"antaf"+i0>(i0) {
					(int i)
					.copy("antaf");
					.setframe(0, veci.get(i/2));
					.anaddfilter;
					.unlink;
					grtaf.add( this );
				};
				new anima <"annak"+i0> (i0) { (int i)
					.copy("annak");
					.anaddfilter;
					.unlink;
					grnak.add(this);
				};
				i0++;
			}
		}
		antaf.hide;
		annak.hide;
		grtaf.hash;
		i0=0;
		i1 = antaf.getw + dt;
		i2 = antaf.geth + dt;
		for( i=0; i<iMemoW; i++)	{
			for( j=0; j<iMemoH; j++)	{
				s = grtaf.get(i0);
				<s>.ansetbpos( i1*i, i2*j );
				<s>.ansetbpos( i1*i, i2*j );
				<s>.vars2(A, "col", i, "row", j);
				<s>.setz(10 + 2*i0-1);
				<grnak.get(i0)>.setz(10+2*i0);
				i0++;
			}
		}
		grtaf.eval("link");
		grnak.eval("link");
		i1 = (iResX-grtaf.getw())/2;
		i2 = (iResY-grtaf.geth())/2;
		grtaf.move( i1, i2 );
		grnak.move( i1, i2 );
		new int iplayer=1;
		new int icompplayer = 0;	// 1v2
		new classfadeinout clfio;
		new classfadeinout clfio2;
		new int imemostate=0;
		new string staf1;
		new string staf2;
		new string snak1;
		new string snak2;
		new int ileai = .between(1, .between(5, iMemoW*iMemoH*0.2, 10) + iMemoAI, 20);
		new string sset1;
		new string sset2;
		new vector vecai	{
			.mresize;
			.type("string");
		};
		new int iaistate = 0;
		.newtimer("timwait", 500, 1);
		timwait.mresize;
		.cnewtimerfin("timpoka", 500, 1, "endset22");
	}
	tm_start()	{
		imemostate = 1;
		if( iMemoTryb==1 )	{
			icompplayer=2;
		}
	}
	/******************************************************/
	aigo()	{
		imemostate=11;
		.tclicks( sset1 );
	}
	aigo2()	{
		.tclicks( sset2 );
	}
	int aifind1(string sob, int i,  int ile)	{
		if( sob==null )	return -1;
		int ifr = <sob>.framenr;
		string s;
		for (; i<ile; i++)	{
			s = .get(i);
			if( s!=null && s!=sob && ifr==<s>.framenr && .tstats(i))	return i;
		}
		-1;
	}
	bool tstats(int id)	{	.stats(100-id*10);	}
	startai(string sfun)	{
		if( iplayer==icompplayer )	{
			int ile = .min(vecai.size, ileai);
			if( sfun=="aigo" )	{
				imemostate = 11;
				int i[3];
				i2 = -1;
				for(i0=0; i0<ile; i0++)	{
					i2 = vecai.aifind1( vecai.get(i0), i0+1, ile );
					if( i2>=0 && .tstats(i0))	{
						i1 = i0;
						i0 = ile;
					} else
						i2=-1;
				}
				if( i2>=0 )	{		// znalazl pare
					sset1 = vecai.get(i1);
					sset2 = vecai.get(i2);
				} else {
					sset1 = grtaf.rand;
					sset2 = null;
				}
			} else {
				if( sset2 == null )	{
					int id = vecai.aifind1( sset1, 0, ile );
					if (id>=0 && .tstats(id))	sset2 = vecai.get(id);
					else 	sset2 = grtaf.randdiff( sset1 );
				}
			}
			"timwait" ..< sfun;
			timwait.play;
		}
	}
	/******************************************************/
	endset3()	{
		imemostate=1;
		if( iMemoTryb>0 )	{
			.tnextplayer;
			.startai("aigo");
		}
	}
	endset2	{	timpoka.play;	}
	endset22	{
		imemostate=3;
		<snak2>.hide;
		if( <staf1>.framenr == <staf2>.framenr )	{
			_ = "grnak" .- snak1 .- snak2;
			_ = "grtaf" .- staf1 .- staf2;
			vecai.set( vecai.find( staf1 ), null );
			vecai.set( vecai.find( staf2 ), null );
			if( grtaf.empty )	{
				imemostate = 5;
				clfio.setopacity(1, -ipredkosc, staf1, null );
				clfio2.setopacity(1, -ipredkosc, staf2, null );
				.tfinish;
			} else {
				clfio.setopacity(1, -ipredkosc, staf1, func {
						<staf1>.hide;	<staf2>.hide;
						if( iplayer!=icompplayer) imemostate=1;
						.startai("aigo");
					});
				clfio2.setopacity(1, -ipredkosc, staf2, null );
				.tpoint;
			}
		} else {
			<snak1>.show;
			<snak2>.show;
			clfio.setopacity(1, ipredkosc, snak1, "endset3");
			clfio2.setopacity(1, ipredkosc, snak2, null );
			.terror;
		}
	}
	tclicks(string sob)	{	.tclick(<sob>.getcx, <sob>.getcy);	}
	tclick(int x, int y)	{
		if( grnak.isin( x, y, true, true ) )	string s = grnak.getsfound;
		else return;
		.tchoose;
		//engine.setdebugstate(true);
		if( imemostate==1 || imemostate==11 ) {
			imemostate--;
			snak1 = s;
			staf1 = grtaf.getimg(<s>.getcx, <s>.getcy, true, true );
			vecai.vecset( staf1, null );
			vecai.addbegin( staf1 );
			vecai.veclimes(30);
			clfio.setopacity(1, -ipredkosc, s, func {
				<snak1>.hide;
				imemostate+=2;
				.startai("aigo2");
				});
		} else if (imemostate==2 || imemostate==12)	{
			imemostate-=2;
			snak2 = s;
			staf2 = grtaf.getimg(<s>.getcx, <s>.getcy, true, true );
			vecai.vecset(staf2,null);
			vecai.addbegin( staf2 );
			vecai.veclimes(30);
			clfio.setopacity(1, -ipredkosc, s, "endset2");
		}
	}
	tnextplayer	{	iplayer = iplayer==1 ? 2 : 1;	}
	tfitinsurf(int x, int y)	{
		grtaf.eval("unlink");
		grnak.eval("unlink");
		@w = x/iMemoW;
		@h = y/iMemoH;
		@dw = <grtaf.first>.getw;
		@dh = <grtaf.first>.geth;
		@dy = h - dh;
		@dx = w - dw;
		@i0 = 0;
		
		for( int i=0; i< iMemoW; i++)	{
			for( int j=0; j<iMemoH; j++)	{
				@s = grtaf.get(i0);
				<s>.ansetbpos(w*i, h*j);
				if( dx<0 && i%2 ) <s>.move(0, dy/2);
				<grnak.get(i0)>.ansetbpos( <s>.getpx, <s>.getpy );
				i0++;
			}
		}
		x = (iResX-grnak.getex)/2;
		y = (iResY-grnak.getey)/2;
		grnak.move( x, y );
		grtaf.move( x, y );
		grtaf.eval("link");
		grnak.eval("link");
	}
	/*********************/
	tm_mouselclick	{
		if( imemostate.in(A,1,2))	.tclick( mouse.getpos );
	}
	virtual tfinish	{}
	virtual tpoint		{}
	virtual terror		{}
	virtual tchoose	{}
}


class tcramka : gfxObject	{
	init	{
		new img imob;
		new filter ftob;
		new anima anglowka;
		anglowka.buildfullname;
		.vars2(A,"speaker", null);
		
		new int iopacity = 65;
		.cycle = ("timshow", func {
			if( bshow ) iop+=iopstep;
			else iop-=iopstep;
			zoom = iop.to_r/255.0;
			if( iop>=255 )	{
				ftob.setzoom(1);
				ftob.setopacity(255);
				//anskip.show;
				.showskip;
				<.getbuildername>.<.getbuildername + "_show">;
			} else {
				if( bshow || (!bshow && iop >= iopacity) )	{
					ftob.setzoom(zoom);
					//ftob.setopacity(iop);
					.play;
				} else {
					imob.hide;
					<.getbuildername>.<.getbuildername + "_hide">;
				}
			}
			} );
		timshow.vars2(A, "iop", iopacity, "zoom", 0.0, "iopstep", 25, "bshow", 1);
		timshow.addmethod("mreset", func {
			if( bshow )	{
				iop=iopacity;
				zoom = iop.to_r/255.0;
				ftob.setzoom(zoom);
				//ftob.setopacity(iop);
			} else {
				iop = 255;
				zoom = 1;
			}
			imob.show;
			} );
		
		//.reload(stxtbox);
		.hideskip;
		imob.hide;
		
		gfxObject::init("imob");
	}
	view(string stxtbox)	{	._reload(stxtbox, "okno");	}
	sayl(string stxtbox)	{	._reload(stxtbox, "sayl");	}
	sayr(string stxtbox)	{	._reload(stxtbox, "sayr");	}
	thinkl(string stxtbox)	{	._reload(stxtbox, "thinkl");	}
	thinkr(string stxtbox)	{	._reload(stxtbox, "thinkr");	}
	_reload(string stxtbox, string sokno)	{
		//anskip.hide;
		.hideskip;
		if( stxtbox==null ) return;
		timshow.stop(false);
		ftob.unlink;
		//.newanima("imob1", "$scripts/heroes/"+sokno+".pyz", <stxtbox>.getz-1 );
		.newanima("imob1", "$scripts/heroes/dymki2.pyz", <stxtbox>.getz-1 );
		
		imob1.setframe("pasek", 0);
		real h = imob1.geth;
		int ile = <stxtbox>.geth/h;
		if( ile<2 ) ile=2;
		
		imob1.setframe("dol",0);
		int h2 = imob1.geth;
		imob1.setframe("top",0);
		h2 += imob1.geth;
		
		delete imob;
		new img imob;
		
		bool bokno = sokno!="okno";
		int w = imob1.getw;
		int h3 = h2 + h*ile;
		int winx = 0;
		int winw = w;
		int winh = h3;
		if( bokno )	{
			.copyanima("imob1", "imobdymek");
			imobdymek.setframe(sokno,0);
			@dx = 10;
			if( sokno.gete(0,1)=="l" )	{
				imob1.move( imobdymek.getw + dx, 0 );
				winx = imob1.getpx;
				w = imob1.getex - imobdymek.getpx;
			} else {
				imobdymek.move( imob1.getw + dx, 0 );
				w = imobdymek.getex - imob1.getpx;
			}
			@h4 = imobdymek.getey - imob1.getpy;
			if( h4>h3) h3=h4;
			//imobdymek.move( 0 , imobdymek.geth/2 );
		}
		
		imob.create( w, h3, .transparent );
		
		if( bokno )
			imob.blit("imobdymek");
		int y = imob1.getey;
		imob.blit("imob1");
		@x = imob1.getpx;
		imob1.setframe("pasek",0);
		for( int i=0; i<ile; i++) {
			imob1.setpos(x, y);
			imob.blit("imob1");
			y+=imob1.geth;
		}
		imob1.setframe("dol",0);
		imob1.setpos(x,y);
		imob.blit("imob1");
		.setskippos;
		imob.blit("anskip");
		imob.setz( imob1.getz );
		anskip.setz( imob.getz + 1 );
		if( bokno )	{
			<stxtbox>.move( winx + winw/2 - <stxtbox>.getw/2, (winh - <stxtbox>.geth)/2 );
		} else {
			imob.setpos( <stxtbox>.getcx - imob.getw/2, <stxtbox>.getcy - imob.geth/2 );
		}
		
		if( bokno )	{
			delete imobdymek;
		}
		delete imob1;
		
		imob.buildfullname;
		<stxtbox>.blitto(imob.getfullname);
		<stxtbox>.hide;
		<gameapi.getgamename>.vardel(imob.getfullname);
		
		if( bokno )	{
			@s = speaker;
			@i = 0;
			while( StringChecker::isdigit(s.gete(i,1)) )	{
				i++;
			}
			s = s.strsube(i);
			@dir = sokno.gete(0,1);
			anglowka.setpos(0,0);
			anglowka.load( "scripts/heroes/" + s + dir + ".pyz" );
			anglowka.setz( .getz+1 );
			@dx = 90;
			if( dir == "l" )
				imob.setpos( anglowka.getcx + dx, anglowka.getpy );
			else imob.setpos( anglowka.getcx - imob.getw - dx, anglowka.getpy );
			anglowka.hide;
			
			dx = 10;
			@dy = iResY-anglowka.getey + dx;
			if( dir=="l" )	dx = -anglowka.getpx - dx;
			else dx = iResX - anglowka.getex + dx;
			anglowka.move( dx, dy );
			imob.move(dx, dy);
			
		} else {
			if( anglowka.nofactions>0 )
				anglowka.setpos(-1000,-1000);
		}
		
		if( imob.getpx<0 ) imob.move( -imob.getpx, 0 );
		if( imob.getpy<0 ) imob.move( 0, -imob.getpy );
		if( imob.getex>iResX) imob.move( iResX-imob.getex, 0);
		@iddol = iResY-80;
		if( (imob.getey+anskip.geth)> iddol) imob.move( 0, iddol-(imob.getey+anskip.geth));
		
		.setskippos;
		
		ftob.link("imob");
	}
	ashow	{
		//anskip.hide;
		.hideskip;
		timshow.bshow = (1);
		timshow.mreset;
		timshow.play;
		anglowka.show;
	}
	ahide	{
		.hideskip;
		anglowka.hide;
		timshow.bshow = (0);
		timshow.mreset;
		timshow.play;
	}
	setskippos	{	anskip.setpos( imob.getcx - anskip.getw/2, imob.getey );	}
	setpos(int x, int y)	{
		gfxObject::setpos(x,y);
		.setskippos;
	}
	move(int x, int y)	{
		gfxObject::move(x,y);
		.setskippos;
	}
	hideskip	{
		anskip.hide;
		but1.onmousemove;
		but1.removebut("anskip");
	}
	showskip	{
		but1.add("anskip");
		anskip.show;
		but1.onmousemove;
	}
	free	{
		<GAME>.vardel(anglowka.getfullname);
	}
}

class itemadder	{
	init	{
		new filter ftduch;
		ftduch.buildfullname;
		new int _iduchstep = 0;
		.cycle = ("_timduch", func {
			idstep++;
			if( idstep>=_iduchstep )	{
				<ftduch>.unlink;
				/*<sduch>.setframe(-1,1);
				<sduch>.setpos(0,0);*/
				.<sfunonplace>;
			} else {
				real rs = idstep.to_r/_iduchstep.to_r;
				real r = 1.0 - rs * (1.0 - <sduch>.ratio);
				//<sduch>.sam_speed = (r);
				//<sduch>.sam_move;
				<ftduch>.setzoom( r );
				<sduch>.move( rs*(<sduch>.xdest-<sduch>.getpx), rs*(<sduch>.ydest-<sduch>.getpy) );
				.play;
			}
			} );
		_timduch.vars2(A, "idstep", 0, "sduch", null, "idduch", 0, "ftduch", ftduch.getfullname,
			"sfunonplace", null);
	}
	free	{ <GAME>.vardel(ftduch.getfullname);	}
	showitem(string s, string sfun)	{
		if( !.hasvar("_fioduch") )
			new classfadeinout _fioduch;
		<s>.show;
		ftduch.unlink;
		ftduch.link(s);
		ftduch.setopacity(0);
		ftduch.setpivottype(0);
		_fioduch.setopacity(1, 25, ftduch.getfullname, sfun);
	}
	hideitem(string s, string sfun)	{
		ftduch.unlink;
		ftduch.link(s);
		_fioduch.setopacity(1, -25, ftduch.getfullname, sfun);
	}
	freeitem	{	ftduch.unlink;	}
	gotonextfr(string s, int istep, string sfunonplace)	{
		<s>.setframe(-1,1);
		real x1 = <s>.getpx;
		real y1 = <s>.getpy;
		real h1 = <s>.geth;
		<s>.setframe(-1,0);
		.gotodest(s, h1, x1, y1, istep, sfunonplace);
	}
	gotodestan(string s, string san, int istep, string sfunonplace)	{
		.gotodest(s, <san>.geth, <san>.getpx, <san>.getpy, istep, sfunonplace);
	}
	gotodest(string s, real desth, int destx, int desty, int istep, string sfunonplace)	{
		ftduch.unlink;
		ftduch.link(s);
		ftduch.setpivottype(0);
		_iduchstep = istep;
		<s>.vars2(A, "ratio", desth/<s>.geth->to_r, "xdest", destx, "ydest", desty );
		
		_timduch.idstep = (0);
		_timduch.sduch = (s);
		_timduch.sfunonplace=(sfunonplace);
		_timduch.play;
	}
}

class guitems : classfullsave	{
	init(string sfile)	{
		classfullsave::init(sfile);
		new gmimgvec grit;
	}
	last	{	.get("last_scene"); }
	builditems	{
		.hidepan2;
		for( int i=0; i< dbsav.getrowsno; i++)	{
			if( dbsav.get(i,0)->getb(0, "item_"->length) == "item_" &&
				dbsav.get(i,1)->to_i )
				.additem( dbsav.get(i,0)->strsubbs("item_") );
		}
	}
	additem(string s)	{
		grit.add(s);
		@san = "anitem"+s;
		.newanima(san, "$scripts/items/"+s+".pyz", <grpan2.first>.getz);
		<san>.addtogamevars(san);
		<san>.vars2(A,"sitem", s, "idgui", grit.size-1);
		<san>.addmethod("itemonpos", func {
			.setframe(0,0);
			string sangui = grpan2.last;
			<sangui>.setframe(-1,idgui);
			.setpos( <sangui>.getcx, <sangui>.getcy ); 
			});
		<san>.<"iteminit_"+s>;
		<san>.itemonpos;
		<san>.Button_stdalpha;
		<san>.addmethod("butclick", func {
			@smet = "itemclick_"+sitem;
			if( <GAME>.hasmet(smet) )	{
				.<smet>;
			} else {
			}
			} );
		but1.add(san);
		.showpan2;
	}
	iteminit_szyfr	{
		new itemadder itszyf;
	}
}

class MusicTit : Music	{
	init	{
		Music::init;
	}
	play	{
		Music::play;
		if( iGameMute )
			gameapi.pausemusic;
	}
}

class Match3 {
	m3init	{
		@sp = .getgraphpath;
		.path = ("match3");
		.imgsgr = (A, "m3bg.pyz 700", "m3e.pyzH 710", "m3bum.pyzH 720", "m3ramka.pyzH 715",
			"m3bg2.pyzG 705", "m3oknolewe.pyz 700", "m3oknoprawe.pyz 700",
			"m3grall");
		
		.copyanima("anm3ramka", "anm3ramka2");
		.copyanima("anm3ramka", "anm3ramka3"); anm3ramka3.setframe(1,0); anm3ramka3.setz(705);
		.copyanima("anm3ramka", "anm3ramka4"); anm3ramka4.setframe(1,0); anm3ramka4.setz(705);
		anm3ramka.var2("sram", "anm3ramka3");
		anm3ramka2.var2("sram", "anm3ramka4");
		
		new int m3rows = 10;
		new int m3cols = 10;
		new int im3w = anm3e.getw;
		new int im3h = anm3e.geth;
		new int im3level = dbconf.confmode("match3_level");
		
		new gmimgvec grm3;
		new gmimgvec grm3w;
		new gmimgvec grm3b;
		new gmimgvec grm3c;
		new vector vecm3;
		new int im3state = 20;
		
		.newsfx("m3fxmove", "szufladaopen.ogg");
		.newsfx("m3fxhit1", "hit1.ogg"); m3fxhit1.setvol(60);
		
// 		.debug = (1);
		
		int i[3];
		string s[2];
		for( int i=0; i<m3rows; i++)	{
			for( int j=0; j<m3cols; j++)	{
				vecm3.free;
				for( i0=0; i0<im3level; i0++)
					vecm3.add(i0);
				
				@s = .m3el(i,j);
				.copyanima("anm3e", s);
				<s>.vars2(A, "irow", i, "icol", j, "bbum", 0, "bonplace", 1);
				
				i0 = .m3get(i,j-2);
				if( i0==.m3get(i, j-1) )
					vecm3.remove(i0);
				i0 = .m3get(i-2,j);
				if( i0==.m3get(i-1, j) )
					vecm3.remove(i0);
				vecm3.hash;
				<s>.play( vecm3.first );
				<s>.setframe( -1, <s>.nofframes(-1)->rand );
				<s>.ansetbpos( .m3px(j), .m3py(i) );
				//<s>.clip( anm3bg.getpx, anm3bg.getpy, anm3bg.getex, anm3bg.getey );
				
				grm3.add(s);
				
				s0 = .m3elbum(i,j);
				.copyanima("anm3bum", s0);
				<s0>.addmethod("onstart", func { if( !iGameMute ) m3fxhit1.playif; } );
				<s0>.addmethod("onfinish", func {
					.hide;
					grm3b.remove(this);
					if( grm3b.empty )	{
						<GAME>.m3spadek;
					}
					} );
				<s0>.setpos( <s>.getcx, <s>.getcy );
				grm3w.add(s0);
			}
		}
		m3grall.add("grm3");
		
		.cycle = ("m3tim1", func {
			if( icykl==0 )	{
				rdx = (<sela>.getpx - <sel2>.getpx)->to_r/rspeed;
				rdy = (<sela>.getpy - <sel2>.getpy)->to_r/rspeed;
				restx = 0.0;
				resty = 0.0;
			}
			if( icykl == rspeed )	{
				@id = <sela>.actionnr(-1);
				<sela>.play( <sel2>.actionnr(-1) );
				<sel2>.play(id);
				<sela>.m3retpos;
				<sel2>.m3retpos;
				anm3ramka.hide;
				anm3ramka2.hide;
				anm3ramka3.hide;
				anm3ramka4.hide;
				if( bclick )	{
					/*if( <sela>.m3is3 || <sel2>.m3is3 )	{
						_ = .m3usun;
					} else {*/
					if( !.m3usun ) {
						.m3change(sela, 0);
						.m3change(sel2, 0);
					}
				} else {
					im3state = 0;
				}
			} else {
				restx += rdx;
				resty += rdy;
				int px = restx;
				int py = resty;
				if( px||py )	{
					<sela>.move(-px, -py );
					<sel2>.move(px, py );
					restx -= px;
					resty -= py;
				}
				icykl++;
				.play;
			}
			} );
		m3tim1.vars2(A, "rdx", 0.0, "rdy", 0.0, "rspeed", 10.0, "sela", null, "sel2", null, "icykl", 0, "restx", 0.0, "resty", 0.0,
			"bclick", 0);
		
		.cycle = ("m3tim2", func {
			grm3c.eval( func {
				if( !bonplace )	{
					.move(0, 5);
					if( .getpy >= .m3py(irow) )	{
						.m3retpos;
						bonplace=1;
					}
				}
				} );
			for( int i=0; i<grm3c.size; i++)	{
				if( !<grm3c.get(i)>.bonplace )	{
					.play;
					return;
				}
			}
			grm3c.free;
			if( !.m3usun ) {
				.m3initial;
			}
			} );
		
		.newfont("m3fnt", sgmfontmonobold, 23);
		
		@size = 28;
		@dx = 20;
		@dy = 23;
		new int im3time = dbconf.confmode("match3_time");
		new TextTimeCounter m3ttc("m3fnt",size, .m3pointcol,
			anm3oknolewe.getpx+dx+4, anm3oknolewe.getpy+dy,701, 
			"ms", im3time, -1);
		
		
		new int im3points = 0;
		new int im3pointlimit = dbconf.confmode("match3_points");
		.newtextposz("m3txtpoints", im3points, "m3fnt", .m3pointcol,
			anm3oknoprawe.getpx+dx, anm3oknoprawe.getpy+dy, 701);
		.m3points(0);
		
		m3grall.addlist(A, "m3txtpoints", "m3ttc");
		
		.path = (sp);
		
		m3grall.move( 0, -anm3bg.getey );
		.cycle = ("m3timkurt", func {
			m3grall.move(0, idir);
			if( idir>0 && anm3bg.getpy>=anm3bg.lody )	{
				@dy = anm3bg.lody-anm3bg.getpy;
				m3grall.move(0, dy);
				grm3.eval( func {
					.clip( anm3bg.getpx, anm3bg.getpy, anm3bg.getex, anm3bg.getey );
					} );
				im3state = 15;
				.m3play("start");
			} else if (idir<0 && anm3bg.getey < 0 )	{
				timendmatch3.play;
			} else .play;
			} );
		m3timkurt.var2("idir", 50);
		m3timkurt.addmethod("onstart", func {
			if( !iGameMute ) m3fxmove.play; 
			} );
		m3timkurt.play;
		
		
		new tcramka m3tcr;
		
		new db dbmatch3;
		dbmatch3.load( LANGDIR + "match3_"+LANG+".db");
		new db m3dbts;
		
		.newanima("anm3skip", "$scripts/common/skip.pyz", 720);
		new img im3skip; 
		if( LANG=="ger" )	{
			.newanima("anm3skip3", "$scripts/common/next3.pyz", 720);
			im3skip.clone("anm3skip3");
			delete anm3skip3;
		} else {
			im3skip.clone("anm3skip");
		}
		.txtonbutton( dbmatch3.dbget("txtskip"), "im3skip");
		im3skip.hide;
		new img im3again;
		if( LANG.in(A, "fra", "esp", "ger") )	{
			.newanima("anm3skip2", "$scripts/common/next2.pyz", 720);
			im3again.clone("anm3skip2");
			delete anm3skip2;
		} else {
			im3again.clone("anm3skip");
		}
		.txtonbutton( dbmatch3.dbget("txtagain"), "im3again");
		im3again.hide;
		delete anm3skip;
	}
	m3restart	{
		.m3points(-im3points);
		im3pointlimit = dbconf.confmode("match3_points");
		m3ttc.reset;
		m3ttc.update(0);
		m3ttc.play;
	}
	m3play(string s)	{	<GAME> (s) { (string s)
		/*sndm3start1|You must get
		sndm3start2|points.
		sndm3start3|Available time: 
		sndm3start4|Good luck!
		sndm3win|Congratulations! You won! Mission accomplished.
		sndm3fail1|Oups... It looks like the time has finished.
		sndm3fail2|You were very close - try again!
		sndm3fail3|You can try again!*/
		m3dbts.free;
		match(s)	{
			"start" => {
				m3dbts.dbbuild(A,
					dbmatch3.dbget("sndm3start1")+" "+im3pointlimit+" "+dbmatch3.dbget("sndm3start2"),
					dbmatch3.dbget("sndm3start3")+" "+ m3ttc.sgettime,
					dbmatch3.dbget("sndm3start4"),
					1 );
			}
			"ok" => {
				m3dbts.dbaddlast( dbmatch3.dbget("sndm3win") );
			}
			"nobut" => {
				m3dbts.dbbuild(A,
					dbmatch3.dbget("sndm3fail1"),
					dbmatch3.dbget("sndm3fail2"),
					1 );
			}
			"no" => {
				m3dbts.dbbuild(A, 
					dbmatch3.dbget("sndm3fail1"),
					dbmatch3.dbget("sndm3fail3"),
					1);
			}
			? => ;
		}
		new TextDb tdsnd(null, 16, "$var:m3dbts", .grey(20),
					0.2*iResX,iResY, 5,750, "center");
		m3tcr.view("tdsnd");
		.deletegmobj("tdsnd");
		m3tcr.ashow;
	}; }
	m3pointcol	{	return 220,220,220;	}
	m3ttc_finish	{
		.stop;
		if( im3state!=2 )	{
			im3state = 2;
			if( grm3b.empty && !m3tim2.isplaying )	{
				<GAME>.m3finish1;
			}
		}
	}
	m3is3	{
		@i1 = .actionnr(-1);
		@ia1 = .m3get(irow, icol-2);
		@ia2 = .m3get(irow, icol-1);
		@ia3 = .m3get(irow, icol+1);
		@ia4 = .m3get(irow, icol+2);
		@ib1 = .m3get(irow-2, icol);
		@ib2 = .m3get(irow-1, icol);
		@ib3 = .m3get(irow+1, icol);
		@ib4 = .m3get(irow+2, icol);
		((ia1==ia2 && ia1==i1 ) || (ia2==i1 && i1==ia3) || (i1==ia3 && ia3==ia4)) ||
		( (ib1==ib2 && ib1==i1 ) || (ib2==i1 && i1==ib3) || (i1==ib3 && ib3==ib4) );
	}
	m3points(int ip)	{
		im3points+=ip;
		m3txtpoints.txtset(""+im3points+"/"+im3pointlimit);
	}
	m3initial	{
		anm3ramka.hide;
		anm3ramka2.hide;
		anm3ramka3.hide;
		anm3ramka4.hide;
		if( im3points>=im3pointlimit && m3ttc.isplaying )	{
			m3ttc.stop;
			im3state=2;
		}
		if( im3state==2 )	{
			.m3finish1;
		} else if( im3state!=15 && im3state!=13 && im3state!=14) {
			im3state=0;
		}
	}
	m3finish1	{
		im3state = 13;
		if( im3points>=im3pointlimit )	{
			.m3play("ok");
		} else {
			if ( im3points.to_r/im3pointlimit.to_r >= 80.0 )
				.m3play("nobut");
			else .m3play("no");
			im3state = 1333;
		}
	}
	m3tcr_show	{
		if( im3state==1333 )	{
			//@x = anskip.getpx - anskip.getw/2;
			@x = anskip.getcx - ( im3again.getw + im3skip.getw ) /2;
			im3again.setpos( x, anskip.getpy );
			im3again.show;
			im3skip.setpos( im3again.getex+2, anskip.getpy );
			im3skip.show;
			m3tcr.hideskip;
			im3state = 13;
		}
	}
	m3finish	{
		m3timkurt.idir = (-m3timkurt.idir);
		if( m3timkurt.idir < 0 )	{
			grm3.eval( func {
				.clip( 0, 0, iResX, iResY );
				} );
		}
		anm3ramka.anhide;
		anm3ramka2.anhide;
		anm3ramka3.anhide;
		anm3ramka4.anhide;
		m3timkurt.play;
	}
	m3retpos	{
		.ansetbpos( .m3px(icol), .m3py(irow) );
	}
	m3get(int ir, int ic)	{
		if( ir<0 || ir>=m3rows || ic<0 || ic>=m3cols )	-1;
		else <"anm3"+ir+"_"+ic>.actionnr(-1);
	}
	m3px(int c)	{
		anm3bg.getpx + c * im3w;
	}
	m3py(int r)	{
		anm3bg.getpy + r * im3h;
	}
	m3edge	{	anm3bg.getpy; }
	m3exit	{
		delete im3again;
		delete im3skip;
	
		delete m3fxhit1;
		delete m3fxmove;
		
		m3tcr.free;
		.deletegmobj("m3tcr");
		delete m3dbts;
		delete dbmatch3;
		delete m3timkurt;
		delete im3time;
		delete im3points;
		delete im3pointlimit;
		delete m3txtpoints;
		.deletegmobj("m3ttc");
		delete m3fnt;
		grm3.deleteallgm;
		delete grm3;
		grm3w.deleteallgm;
		delete grm3w;
		delete vecm3;
		delete grm3b;
		delete grm3c;
		
		grm3bg2.deleteallgm;
		delete anm3bg2;
		delete grm3bg2;
		
		delete m3tim1;
		delete m3tim2;
		delete anm3e;
		delete anm3bg;
		delete anm3ramka4;
		delete anm3ramka3;
		delete anm3ramka2;
		delete anm3ramka;
		delete anm3bum;
		delete im3state;
		delete m3rows;
		delete m3cols;
		delete im3w;
		delete im3h;
		delete im3level;
		
		delete anm3oknolewe;
		delete anm3oknoprawe;
		
		delete m3grall;
	}
	m3_lclick	{
		if( im3state==0 && grm3.isin(mouse.getpos,1,0)  )	{
			.m3change( grm3.getsfound, 1 );
		} else if (im3state==13 )	{
			if( anskip.isin(mouse.getpos,1,1) )	{
				im3state=14;
				im3skip.hide;
				im3again.hide;
				m3tcr.ahide;
				.m3finish;
			} else if ( im3again.isin( mouse.getpos, 1, 1) )	{
				im3state=0;
				im3skip.hide;
				im3again.hide;
				m3tcr.ahide;
				.m3restart;
				m3ttc.play;
			} else if ( im3skip.isin( mouse.getpos, 1, 1) )	{
				im3state=14;
				im3skip.hide;
				im3again.hide;
				m3tcr.ahide;
				im3points = im3pointlimit+1;
				.m3finish;
			}
		} else if (im3state==15 )	{
			im3state=0;
			m3tcr.ahide;
			m3ttc.play;
		}
	}
	m3change(string s, bool bclick)	{
		if( anm3ramka.isvisible )	{
			@s2 = m3tim1.sela;
			if( s!=s2 )	{
				@p1 = (<s>.irow-<s2>.irow)->abs;
				@p2 = (<s>.icol-<s2>.icol)->abs;
				if(  (p1==0 && p2==1 ) || (p1==1 && p2==0 ) )	{
					anm3ramka2.m3set( s );
					if( im3state!=2 )	{
						im3state=1;
					} else {
					
					}
					m3tim1.bclick=(bclick);
					m3tim1.icykl = (0);
					m3tim1.play;
				} else {
					anm3ramka.m3set( s );
				}
			}
		} else {
			anm3ramka.m3set( s );
		}
	}
	m3set(string s)	{
		.setpos( <s>.getpx, <s>.getpy );
		.show;
		<sram>.show;
		<sram>.setpos( .getpx, .getpy );
		m3tim1.<"sel"+this->gete(0,1)+"="> (s);
	}
	m3usun	{
		int i[4];
		for( int i=0; i<m3rows; i++)	{
			for( int j=0; j<m3cols; j++)	{
				i2 = .m3get( i-2, j );
				i1 = .m3get( i-1, j );
				i0 = .m3get( i, j );
				if( i2==i1 && i1==i0 )	{
					.m3setbum(i-2,j);
					.m3setbum(i-1,j);
					.m3setbum(i,j);
				}
				i2 = .m3get( i, j-2 );
				i1 = .m3get( i, j-1 );
				if( i2==i1 && i1==i0 )	{
					.m3setbum(i,j-2);
					.m3setbum(i,j-1);
					.m3setbum(i,j);
				}
			}
		}
		for( i=0; i<m3rows; i++)	{
			for( j=0; j<m3cols; j++)	{
				@s = .m3el(i,j);
				if( <s>.bbum )	{
					<s>.stop(false);
					<s>.hide;
					s = .m3elbum(i, j);
					grm3b.add(s);
					<s>.play(0);
				}
			}
		}
		if( grm3b.size )	{
			.m3points(grm3b.size);
			1;
		} else 0;
	}
	m3el(int r, int c)	{	"anm3"+r+"_"+c;	}
	m3elbum(int i, int j)	{	"anm3w"+i+"_"+j;	}
	m3setbum(int r, int c)	{
		if( r <0 || c<0 ) return;
		<.m3el(r,c)>.bbum = (1);
	}
	m3spadek	{
		int i[5];
		string s, string s2;
		for( int j=0; j<m3cols; j++)	{
			i0 = 0;
			i1 = m3rows-1;
			i4 = 1;
			while(i1>=0)	{
				s = .m3el(i1,j);
				if( <s>.bbum )	{
					<s>.bbum = (0);
					i3 = i1;
					i2=0;
					while( i3>=1 && <.m3el(i3-1, j)>.bbum )	{
						i2++;
						i3--;
					}
					if( i3==0 )	{
						<s>.play( im3level->rand );
						<s>.setframe( -1, <s>.nofframes(-1)->rand );
						<s>.ansetbpos( <s>.getpx, .m3edge - i4 * im3h );
						i4++;
					} else {
						s2 = .m3el(i3-1, j);
						<s2>.bbum = (1);
						//<s>.stop(false);
						@ifr = <s2>.framenr;
						<s>.play( <s2>.actionnr(-1) );
						<s>.setframe( -1, ifr );
						<s>.ansetbpos( <s2>.getpx, <s2>.getpy );
					}
					<s>.bonplace=(0);
					grm3c.add(s);
				}
				i1--;
			}
		}
		if( grm3c.empty )	{
			.m3initial;
		} else {
			m3tim2.play;
		}
	}
}

/*game Tmp4 : StdGame, Match3	{
	init	{
		StdGame::init("tmp4");
		
		new img imbg;
		imbg.create( iResX, iResY, .black, 255 );
		
		.m3init;
	}
	mouse_lclick	{
		.m3_lclick;
	}
}*/


new string sAskerGame;
new string sNextGame = null;
new int iProfilId;
new int AdventureMode = 0;
new int iGameMute = 0;

class StdGame : classadv, GameController, Localize, Match3	{
	init(string s)	{
		igmstate = 0;
		sgmstate = "init";
		classadv::init;
		GameController::init(s);
		Localize::init;
		clbuts.setcursorpos(0, 0);
		claskexit.setcursorpos(0, 0);
		.path = (s);
		.setwavpath(SNDPATH);
		bsms.setstd;		// ustawia standardowo 
		clmusic.play;
		clbuts.reset;
		claskexit.reset;
		advmouse.setstd;
		
		new classfullsave clsmen("global.sav");
		clsmen.stdload;
		new MusicTit mus;
		.setgamevolume;
		
		if( AdventureMode )	{
			.loadsaver;
			
			if( AdventureMode==1 )	{
				AdventureMode = 2;
				
				clsave.free;
				
				if( igmdebug )	{
					new Script scrl("scripts/mainloader/init.dsc");
				}
			} else clsave.stdload;
			
			clsave.set("currentgame", this);
			clsave.stdsave;
		}
		
		new bool bmatch3mode = false;
		
		new Button but1;
		.cutscene;
		
		new db dblangcom;
		dblangcom.load( LANGDIR+"commontxt_"+LANG+".db");
		//.img = ("$scripts/common/skip.pyzH");
		.newanima("_anskip", "$scripts/common/skip.pyz", 0);
		new img anskip;
		anskip.clone("_anskip");
		delete _anskip;
		new int TextDialogSize = 16;
		//@sfont = .stdfont(TextDialogSize);
		.txtonbutton(dblangcom.dbget("next"), "anskip");
		anskip.hide;
		.sfx = ("skip");
		anskip {
			.Button_stdms;
			.addmethod("butclick", func {
				fxskip.play;
				.cactsndstop(true);
				} );
			//but1.add(this);
		};
		
		if( !this->in(A, "Intro", "MainMenu") )	{
			.img = ("$scripts/common/butmenu.pyz 1900");
			anbutmenu	{
				.Button_stdms;
				.addmethod("butclick", func {
					claskexit.askexittomenu;
					fxskip.play;
					} );
				but1.add(this);
			};
		}
		
		.img = ("$scripts/common/glosnik.pyz 800");
		anglosnik {
			iGameMute = clsmen.get("game_mute");
			.setframe(0, iGameMute);
			.Button_stdms;
			.addmethod("butclick", func {
				if( .framenr==0 )	{
					iGameMute = 1;
					_grsfxs.eval( func { .setvol(0); } );
					gameapi.pausemusic;
				} else {
					iGameMute = 0;
					_grsfxs.eval( func { .setvol(myvol); } );
					gameapi.resumemusic;
				}
				.game_mute;
				.setframe(0, iGameMute);
				clsmen.set("game_mute",iGameMute);
				clsmen.stdsave;
				} );
			but1.add(this);
		};
		
		new int iduchstate = 30;
		
		.newgrimg("grshowhintb", "$scripts/common/showhintb", 800);
		grshowhintb.var2("lastplayed", null);
		grshowhintb.hide;
		.newgrimg("grshowhintgold", "$scripts/common/hintgold", 800);
		grshowhintgold.var2("lastplayed", null);
		grshowhintgold.hide;
	}
	txtonbutton(string stxt, string simg)	{
		@sfont = "_fnbold";
		.newfont(sfont, "configs/fonts/timesbd.ttf", TextDialogSize);
		.newtext("_txtnext", stxt, sfont, .black);
		_txtnext.setpos( <simg>.getcx - _txtnext.getw/2, <simg>.getcy - _txtnext.geth/2 );
		<simg>.blit("_txtnext");
		delete _txtnext;
		delete <sfont>;
	}
	sfx=(string s)	{
		classgame::sfx=(s);
		s = _grsfxs.last;
		<s>.var2("myvol", <s>.getvol);
		if( iGameMute )
			<s>.setvol(0);
	}
	setgamevolume	{
		mus.musicvolume = (.loadmusicvolume);
		engine.setsndvol(.loadsndvolume);
	}
	stdmusicvol	{	50;	}
	loadmusicvolume	{
		int vol = .stdmusicvol;
		@s = clsmen.get("music_volume"+clsmen.get("currentprofile"));
		if( s!=null ) vol=s;
		vol;
	}
	stdsndvol	{	60;	}
	loadsndvolume	{
		int vol = .stdsndvol;
		@s = clsmen.get("sfx_volume"+clsmen.get("currentprofile"));
		if( s!=null ) vol=s;
		vol;
	}
	loadsaver	{
		new guitems clsave("profile_"+iProfilId+".sav");
	}
	/********************* adv **************************************/
	cutscene	{
		//if( igmipad ) return;
		new CutScene ccs(0, 0, iResX, iResY);
		ccs.setz(2000);
	}
	gotoadv(string spath, string sgame)	{
		sgmlastscene = gameapi.getgamename;
		sgmglobpath = spath;
		sgmgame = sgame;
		gameapi.play("gameadvdef");
	}
	gotoadv2(string spath, string sgame)	{
		sgmlastscene = gameapi.getgamename;
		sgmglobpath = spath;
		sgmgame = null;
		gameapi.play(sgame);
	}
	/********************* helpful **************************************/
	crect	{	new Rect rec(600,196,403,497);	}
	crect2	{	new Rect rec2(6,174,1012,530);	}
	cshowbut(string sbut, @dir)	{
		clbuts (sbut, dir) { (string sbut, @dir)
			clp.show( buts.callimgfun( sbut, "getcx"), buts.callimgfun( sbut, "getcy"), dir ); 
		};
	}
	napisshow(int x, int y)	{
		.show;
		.move(x,y);
	}
	napispod(string s)	{	.napisshow(<s>.getcx-.getw/2, <s>.getey+5); }
	timplay(string stimer, int delay, string sfunc)	{ <GAME> (stimer, delay, sfunc ) { (string stimer, int delay, string sfunc)
		.timer = (stimer, delay, sfunc );
		<stimer>.play;
	}; }
	/***********************************************************/
	advclick()	{
		if( igmdebug && (igmstate==0 || igmstate==5) )	{
			this.cactsndstop(true);
		}
	}
	key_down	{
		if( igmdebug && keyboard.iskeydown("lctrl") && keyboard.iskey("r") )	.crestart;
	}
	askfor(@s)	{ if( igmstate!=111) {sAskerGame=s; claskexit.askexittomenu; }	}
	public askrestart	{	claskexit.askrestart;	}
	/***********************************************************/
	onmusicfin      {	mus.play;	}
	exit	{
		bsms.setstd;
		.game_exit;
		if( igmsubtitle )	{
			subtitle.reset;
		}
	}
	/*********************** hidden ************************************/
	mhobutmask	{ ._mhobut(0); }
	mhobut	{ ._mhobut(1); }
	_mhobut(bool bvis)	{
		if( bvis )
			.Button_isinalpha;
		else	.Button_isinvisalpha;
		.addmethod("butmoveon", func { ; } );
		.addmethod("butmoveoff", func { ; } );
		.addmethod("butclick", func {
			if( igmstate==1 || sgmstate=="hoout" ) {
				.mho_click;
				.<.actionname + "_click">;
				but1.onmousemove;
			}
			} );
		but1.add(this);
	}
	mhobjmask	{	._mhobj(0);	}
	mhobj	{	._mhobj(1);	}
	_mhobj(bool bvis)	{
		if( bvis )
			.Button_isinalpha;
		else	.Button_isinvisalpha;
		.addmethod("butmoveon", func { advmouse.setact; } );
		.addmethod("butmoveoff", func { advmouse.setstd; } );
		.addmethod("butclick", func {
			if( igmstate!=1 ) return;
			.<this + "_click">;
			} );
		but1.add(this);
	}
	mstdenter	{
		/*if( igmipad )	{
			igmstate=1;
		} else {
			ccs.enter( func { igmstate=1; } );
		}*/
		ccs.enter( func { igmstate=1; } );
	}
	mprzejdzclick(string s)	{	if( igmstate!=2 ) .mprzejdz(s);	}
	mprzejdz(string s)	{
		igmstate=2;
		sNextGame = s;
		mus.fadeout(1000);
		ccs.close( func {
			if( .hasvar("clsave") )	{
				clsave.set("last_scene", GAME);
				clsave.stdsave;
			}
			gameapi.play(sNextGame);
			} );
	}
	mouse_lclick	{
		if( bmatch3mode )	{
			.m3_lclick;
		} else {
			.tit_lclick;
		}
	}
	mprogress	{
		.newtext("txtprg", "Work in progress", .stdfont(48), .white);
		txtprg.txtcenterscreen;
	}
	stdgo	{	igmstate=1;	}
	loadsnddb	{
		if( .hasvar("dbsnd") ) return;
		if( engine.fileexist(.lang_path("snd_")+".db") )	{
			.lang_db("dbsnd", "snd_");
		} else {
			new db dbsnd;
		}
		new tcramka tcr;
		new db dbts;
		dbts.load(LANGDIR + "Common_snd_"+LANG+".db");
		dbsnd.dbaddrowfromto("dbts", 0, dbts.getrowsno);
		dbts.free;
		.snd=("lektordoors", "lektordoors", "stdret" );
		.snd=("lektorhodone", "lektorhodone", "stdret" );
		.snd=("lektorclicks", "lektorclicks", func {
			tcr.ahide;
			pogadal=true;
			if( !timhokara.isplaying ) igmstate=1;
			} );
		if( AdventureMode )	{
			lektorclicks.var2("pogadal", clsave.bis("ho_ukarany") );
		}
	}
	stdret	{	tcr.ahide; igmstate=1; }
	titsounds={
		.loadsnddb;
		.sounds = ();
	}
	txtsayl(string s)	{ ._txtplay(s,"sayl");	}
	txtsayr(string s)	{ ._txtplay(s,"sayr");	}
	txtthinkl(string s)	{ ._txtplay(s,"thinkl");	}
	txtthinkr(string s)	{ ._txtplay(s,"thinkr");	}
	txtplay(string s)	{ ._txtplay(s, null);	}
	_txtplay(string s, string styp)	{ <GAME> (s, styp){ (string s, string styp)
		
		if( igmstate==1 ) igmstate=0;	// 12.06.02
		
		dbts.free;
		@id = dbsnd.findbyrow(s);
		if( id>=0 )	{
			for( int i=3; i<dbsnd.getcolsno(id); i++)	{
				@row = dbts.addrow-1;
				dbts.add(row, dbsnd.get(id,i));
			}
			if( dbsnd.get(id,1)->in(A, "sayl", "sayr", "thinkl", "thinkr") )
				styp = dbsnd.get(id,1);
			int limit = dbconf.dbget("dialog_chars:");
			if( styp==null )	{
				/*new TextDb tdsnd(null, 16, "$var:dbts", .grey(20),
					dbsnd.get(id,1)->to_r*iResX,dbsnd.get(id,2)->to_r*iResY, 5,750, "left");*/
				new TextDb tdsnd(null, TextDialogSize, "$var:dbts", .grey(20),
					dbsnd.get(id,1)->to_r*iResX,dbsnd.get(id,2)->to_r*iResY, 5,750, "limit_"+limit);
				tcr.view("tdsnd");
			} else {
				/*new TextDb tdsnd(null, 16, "$var:dbts", .grey(20),
					0,0, 5,750, "left");*/
				new TextDb tdsnd(null, 16, "$var:dbts", .grey(20),
					0,0, 5,750, "limit_"+limit);
				tcr.speaker = (s);
				tcr.<styp>("tdsnd");
			}
			
			.deletegmobj("tdsnd");
			tcr.ashow;
		}
		.cbplay(s);
	}; }
	snd=(string sname, string sfile, string sfun)	{ <GAME> (sname, sfile, sfun) {
		(string sname, string sfile, string sfun)
		
		if( igmsoundson )	{
			.newsndfree(sname, sfile + ".wav");
			<sname>.addmethod("onfinish", sfun);
		} else {
			@id = dbsnd.findbyrow(sname);
			if( id>=0 )	{
				@stxt = "";
				for( int i=3; i<dbsnd.getcolsno(id); i++)	{
					stxt+=dbsnd.get(id,i);
				}
				.newtimer( sname, stxt.length*_itimersnddelay, 1);
				<sname>.addmethod("onstart", "_sndtimerstart");
				<sname>.addmethod("setstartstopflag", func { (bool b1, bool b2) ; });
				<sname>.addmethod("onfinish", sfun);
			}
		}
	}; }
	/****************** duch album ***********************/
	foto_album	{ <GAME> {
		@sp = .getgraphpath;
		.path = ("album");
		.imgs = (A, "al.pyz 700", "fotos.pyzGH 710");
		.sfx = ("albumP");
		//anal.ancenterscreen;
		int ileduchow = anfotos.nofactions;
		new int _idfoto;
		for( int i=1; i<=ileduchow; i++)	{
			@s = grfotos.get(i-1);
			//<s>.setpos( anal.getposx, anal.getposy );
			if( clsave.bis("duch"+i+"_found") )	{
				<s>.setframe(-1,1);
				<s>.show;
			}
		}
		new itemadder clduch;
		
		.setgraphpath(sp);
	}; }
	foto_albumout	{ <GAME> {
		delete fxalbum;
		clduch.free;
		delete clduch;
		delete _idfoto;
		grfotos.deleteloaded;
		delete grfotos;
		delete anal;
	}; }
	foto_show(int idduch)	{
		clsave.bset("duch"+idduch+"_found");
		@s = grfotos.get(idduch-1);
		<s>.setz(<s>.getz+1);
		clduch.showitem(s, "foto_shown");
	}
	foto_to_album(int idduch)	{
		_idfoto=idduch;
		clduch.gotonextfr(grfotos.get(idduch-1), 15, func {
			@sduch = grfotos.get(_idfoto-1);
			<sduch>.setframe(-1,1);
			<sduch>.setpos(0,0);
			.foto_in_album;
			} );
	}
	/*************** klucz ********************/
	klucz_show(int idklucz)	{ <GAME> (idklucz) { (int idklucz)
		new itemadder clklucz;
		clsave.bset("ma_klucz"+idklucz);
		new int _idklucz;
		if( !.hasvar("fxfoundkey") )
			.sfx = ("foundkey 80");
		fxfoundkey.play;
		clklucz.showitem(grklucze.get(idklucz), "klucz"+idklucz+"_shown");
	}; }
	klucz_to_kolo(int idklucz)	{ <GAME> (idklucz) { (int idklucz)
		_idklucz = idklucz;
		if( !.hasvar("fxtolist0") )	{
			.sfx = ("tolist0");
		}
		fxtolist0.play;
		clklucz.gotonextfr(grklucze.get(idklucz), 15, func {
			@sduch = grklucze.get(_idklucz);
			<sduch>.setframe(-1,1);
			<sduch>.setpos(0,0);
			.<"klucz"+_idklucz+"_in_kolo">;
			} );
	}; }
	/****************** duch ***********************/
	gogo_duch	{
		<GAME>.cycle = ("_duch_poser", func {
			anduch.setpos( and2.getpx, and2.getpy ); 
			and2.ansetnextfr;
			.play;
			} );
		_duch_poser.play;
	}
	stop_duch	{	_duch_poser.stop(false);	}
	load_duch(string s)	{
		grels.hide;
		
		.newanima("anduch", s+".pyz", 320);
		.newanima("anwybuch", "$scripts/common/wybuch.pyz", 330);
		anwybuch.hide;
		
		.copyanima("anduch", "and2");
		and2.hide;
		and2.setframe(1,0);
		
		anduch.play(0);
		
		anwybuch.addmethod("onendframe", func {
			if( .framename=="bum" )	{
				grels.show;
				timduchwybuch.play;
			}
			});
		
		new int iduchstep = 10;
		
		anduch {
			.Button_stdalpha;
			.addmethod("butclick", func {
				if( igmstate==iduchstate )	{
					_duch_poser.stop(false);
					.anhide;
					and2.stop(false);
					anwybuch.setpos( .getcx, .getcy );
					anwybuch.play(0);
					
					grels.eval( func {
						.vars2(A, "stepx", (anwybuch.getcx - .getpx)/iduchstep,
							"stepy", (anwybuch.getcy - .getpy)/iduchstep );
						.move( iduchstep*stepx, iduchstep*stepy );
						} );
				}
				} );
			but1.add(this);
		};
		.cycle = ("timduchwybuch", func {
			grels.eval( func { .move(-stepx, -stepy); } );
			iduchstep--;
			if( iduchstep<=0 )
				.duch_wybuchl;
			else .play;
			} );
	}
	remove_duch	{ <GAME> {
		but1.removebut("anduch");
		delete and2;
		.deletegmobj("anduch");
	}; }
	/****************** items ***********************/
	addnewitem(string s)	{
		clsave.bset("item_"+s);
		clsave.additem(s);
	}
	itemclick_szyfr	{
		if( igmstate==101 )	{
			/*itszyf.hideitem(this, func {
				anitemszyfr {
					itszyf.freeitem;
					.itemonpos;
				};
				igmstate = 1; 
				} ); */
			itszyf.freeitem;
			.itemonpos;
			@x = .getpx; @y = .getpy; @h=.geth;
			
			.setframe(1,0); .setpos(0,0);
			itszyf.gotodest(this, h, x, y, 15, func {
				anitemszyfr {
					itszyf.freeitem;
					.itemonpos;
				};
				igmstate = 1; 
				} );
		} else if( igmstate==1 ) {
			igmstate = 100;
			.setframe(1,0);
			.setpos(0,0);
			itszyf.showitem(this, func { igmstate=101; } );
		}
	}
	itemclick_haslo		{	.itemclick_mapa;	}
	itemclick_batyskaf	{	.itemclick_mapa;	}
	itemclick_mapafull	{	.itemclick_mapa;	}
	itemclick_mapa	{
		if( igmstate==101 )	{
			.itemonpos;
			igmstate = 1; 
		} else if( igmstate==1 ) {
			igmstate = 100;
			.setframe(1,0);
			.setpos(0,0);
			igmstate = 101;
		}
	}
	mouse_move	{
		GameController::mouse_move;
	}
}

class Kajuta1 : StdGame	{
	init(string s)	{
		StdGame::init(s);
		
		.loadsnddb;
		
		.cycle = ("timendmatch3", func { <GAME> {
			/*if( m3ttc.itime > 0 )	{
				.match3finish;
			} else {*/
				@ipoints = im3points;
				@ilimit = im3pointlimit;
				if( ipoints<ilimit && m3ttc.itime > 0  ) .match3finish;
				else {
					.match3finish;
					if( ipoints >= ilimit ) .match3_won;
					else .match3_lost;
				}
			//}
			}; } );
	}
	mtimhelper	{
		if( igmipad )	{
			@s = .getgraphpath;
			.path = ("common");
			//.newgrimg("grshowhint", "showhintb", 800);
			new gmimgvec grshowhint;
			string san = grshowhintb.srcanima;
			_ = .newanactionsgr(san, san+"c", "grshowhint");
			grshowhint.setz(800);
			new gmimgvec grhintpad;
			grhintpad.var2("idhint", 0);
			.setgraphpath(s);
			new gmimgvec grhintpad2;
			.timer = ("timhelper", 4000, func {
				if( igmstate==1 )	{
					grhintpad.free;
					grhintpad.addgr("grhintpad2");
					//grhintpad.addgr("grhint");
					if( <GAME>.hasvar("grext") )	{
						for( int i=0; i<grext.size; i++)	{
							if( <grext.get(i)>.bshow )
								grhintpad.add( grext.get(i) );
						}
						if( <GAME>.hasvar("grhint") )	{
							for( i=0; i<grhint.size; i++)	{
								grhintpad.addonce( grhint.get(i) );
							}
						}
					}
					if( grhintpad.size > 0 )	{
						@s = grhintpad.get( grhintpad.idhint % grhintpad.size );
						grhintpad.idhint = (( grhintpad.idhint + 1 )% grhintpad.size );
						grshowhint.setpos( <s>.getcx, <s>.getcy );
						grshowhint.nplay(-1);
					}
					/*for( int i=0; i<grhint.size; i++)	{
						@s = grhint.get(i);
						if( <s>.
					}*/
				}
				.play;
				} );
			timhelper.play;
		}
	}
	mskipminigame	{
		.img = ("$scripts/common/skip_minigame.pyz 660");
		anskip_minigame	{
			.Button_isinalpha;
			.addmethod("butmoveon", func {
				if( igmstate==1 ) advmouse.setbut;
				} );
			.Button_moveoffms;
			.addmethod("butclick", func { if( AdventureMode && igmstate==1 ) .skip_minigame; } );
			but1.add(this);
		};
	}
	addhintpad(string s)	{	if( igmipad ) grhintpad2.add(s);	}
	removehintpad(string s)	{	if( igmipad ) grhintpad2.remove(s);	}
	virtual match3_won	{}
	virtual match3_lost	{}
	tohint	{	.withlist("antohint"); 	}
	loadhint {	<GAME> {
		if( !.hasvar("anshowhint") )	{
			//.img = ("$scripts/common/showhint.pyzH 800");
			new anima anshowhint;
			anshowhint.load("scripts/common/gwiazdkif.pyz");
			anshowhint.hide; anshowhint.setz(800);
			anshowhint.var2("splaynext", null);
			anshowhint.addmethod("onfinish", func {
				if( splaynext!=null )	{
					@s = splaynext;
					splaynext=null;
					.playhint(s);
					igmstate=1;
				}
				} );
		}
	}; }
	antohint(string s)	{
		.loadhint;
		if( s=="grext" )	{
			for( int i=0; i<grext.size; i++)	{
				s = grext.get(i);
				if( <s>.bshow )
					grhint.add(s);
			}
		} else if( <s>.gettype=="gmimgvec" ) grhint.addgr(s);
		else grhint.add(s);
	}
	hoverobject	{
		if( igmstate==1 && ( !grshowhintb.isplaying || grshowhintb.lastplayed!=this ) )	{
			grshowhintb.setpos(.getcx, .getcy );
			grshowhintb.lastplayed = (this);
			grshowhintb.nplay(-1);
		}
	}
	hovergold	{
		if( igmstate==1 && ( !grshowhintgold.isplaying || grshowhintgold.lastplayed!=this ) )	{
			grshowhintgold.setpos(.getcx, .getcy );
			grshowhintgold.lastplayed = (this);
			grshowhintgold.nplay(-1);
		}
	}
	hoverhint(string san)	{
		<san>.addmethod("butmoveon", func {
			advmouse.setbut;
			.hoverobject;
			} );
	}
	grextohint	{	.antohint("grext");	}
	extohint(string s)	{ .antohint( grext.getsac("do_" + s) );  }
	playhint(string s)	{
		.loadhint;
		if( s!=null )	{
			anshowhint.setpos( <s>.getcx, <s>.getcy );
			anshowhint.play(0);
		}
	}
	playhints(string s1, string s2)	{
		igmstate=0;
		.loadhint;
		anshowhint.splaynext = (s2);
		.playhint(s1);
	}
	playhint2(string s)	{ <GAME> (s) { (@s)
		if( !.hasvar("anshowhint2") )	{
			.loadhint;
			.copyanima("anshowhint", "anshowhint2");
			anshowhint2.anhide;
		}
		if( s!=null )	{
			anshowhint2.setpos( <s>.getcx, <s>.getcy );
			anshowhint2.play(0);
		}
	}; }
	playexhint(string s)	{ .playhint( grext.getsac("do_"+s) ); }
	playexhint2(string s)	{ .playhint2( grext.getsac("do_"+s) ); }
	mpanel	{
		new gmimgvec grpan;
		new gmimgvec grklucze;
		@s=.getgraphpath;
		.path = ("common");
		"grpan" .* "panel.pyz";
		"grklucze" .* "klucze.pyz";
		.img = ("gwiazdkif.pyzH 600");
		.setgraphpath(s);
		grpan.each( func { (@id)
			.setz(500 + id * 5);
			} );
		.copyanima(grpan.getsac("prawy"), "anhint");
		new gmimgvec grhint;
		
		.sfx = ("showhint");
		anhint {
			.setframe(-1,1);
			 .addmethod("isbutin", func { (int x, int y)
				.isin(x,y,1,1) && .withincut(x,y);
				} );
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				if( !timhint.isplaying )	{
					timhint.xend = ( .getpx );
					.clip( .getpx, 0, .getpx, iResY );
					timhint.play;
					.HO_hint_click;
					.kajuta_hint_click;
				}
				} );
			.timer = ("timhint", dbconf.confmode("hint_time"), func {
				xend++;
				anhint.clip( anhint.getpx, 0, xend, iResY );
				if( xend < anhint.getex )	{
					.play;
				}
				} );
			timhint.vars2(A, "xend", 0);
			but1.add(this);
		};
		grklucze.each( func { (@id)
			.setz(550);
			if( .actionname=="kolko" )	{
				.show;
			} else  {
				if( AdventureMode )	{
					if( !clsave.bis("ma_klucz"+id) )
						.hide;
					else .setframe(-1,1);
				} else .hide;
			}
			} );
		.mshowalbum;
		if( AdventureMode && clsave.bis("ma_medalion") )	{
			.mshowmedalion;
		}
	}
	hidepanel	{
		grpan.hide;
		anhint.hide;
	}
	showpanel	{
		grpan.show;
		anhint.show;
	}
	virtual HO_hint_click		{}
	virtual kajuta_hint_click	{}
	mshowmedalion	{ <GAME> {
		//.img = ("$scripts/common/medalion.pyz 507");
		.img = ("$scripts/common/medalion.pyzG 507");
		.sfx = ("wisioropen 50");
		//anmedalion0.mhobj;
		anmedalion0 {
			.Button_isinalpha;
			//.addmethod("butmoveon", func { advmouse.setact; } );
			//.addmethod("butmoveoff", func { advmouse.setstd; } );
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				.<this + "_click">;
				} );
			but1.add(this);
		};
		.medalion_close;
	}; }
	rosie_go	{	<GAME> {
		if( !.hasvar("anmedblysk") )	{
			.img = ("$scripts/common/medblysk.pyz "+anmedalion0.getz);
			anmedblysk {
				.Button_stdms;
				.addmethod("butclick", func {
					if( igmstate==226 )	{
						if( anmedalion.framenr!=1 )
							.medalion_open;
						igmstate=0;
						.anhide;
						but1.onmousemove;
						.rosie_help;
					}
					} );
				but1.add(this);
			};
		}
		anmedblysk.play(0);
		igmstate=226;
	}; }
	mshowalbum	{
		if( AdventureMode && clsave.bis("ma_album") )	{
			.img = ("$scripts/album/album.pyz 527");
			analbum {
				.setframe(0,1);
				.setz( <grpan.getsac("plecak")>.getz+1 );
				.addmethod("isbutin", func { (@x, @y)
					.isin(x,y,1,1) || ( <GAME>.hasvar("anal") && anal.isin(x,y,1,1) );
					} );
				.Button_moveonms;
				.Button_moveoffms;
				.addmethod("butclick", func {
					if( igmstate==1 )	{
						igmstate = 121;
						.foto_album;
					} else if (igmstate==121)	{
						.foto_albumout;
						igmstate=1;
						.album_hidden;
					}
					} );
				but1.add(this);
			};
			
		}
	}
	medalion_open	{
		anmedalion0.setframe(-1,1);
		fxwisioropen.play;
		if( clsave.bis("ma_medalion1") )
			anmedalion1.show;
		if( clsave.bis("ma_medalion2") )
			anmedalion2.show;
	}
	medalion_close	{
		anmedalion0.setframe(-1,0);
		anmedalion1.hide;
		anmedalion2.hide;
	}
	anmedalion0_click	{
		if( igmstate!=1 ) return;
		if( .framenr==0 )	{
			.medalion_open;
		} else {
			.medalion_close;
		}
	}
	mbutnext	{
		.img = ("$scripts/common/butnext.pyz");
		anbutnext {
			.setz(700);
			.Button_stdalpha;
			.addmethod("butclick", func {
				if( igmstate==1 )
					.<this + "_click">;
				} );
			but1.add(this);
		};
	}
	match3but	{
		if( Trudnosc>=2 ) return;
		.img = ("$scripts/common/match3but.pyz");
		anmatch3but	{
			.setz(710);
			.Button_stdalpha;
			.addmethod("butclick", func {
				if( bmatch3mode )	{
					if( igmstate!=1000 || im3state!=0 ) return;
					//.match3finish;
					m3ttc.stop;
					.m3finish;
				} else {
					if( igmstate!=1 ) return;
					.match3start;
				}
				} );
			but1.add(this);
		};
	}
	match3start	{
		bmatch3mode = true;
		igmstate = 1000;
		anmatch3but.setframe("match3off",0);
		<GAME>.m3init;
	}
	match3finish	{
		igmstate = 1;
		bmatch3mode = false;
		anmatch3but.setframe("match3mode",0);
		<GAME>.m3exit;
	}
	blockexit(string s)	{	grext.mhide("do_"+s);	}
	disablexit(string s)	{	grext.mdisable("do_"+s);	}
	diblockexit(string s)	{	.blockexit(s); .disablexit(s);	}
	titblock	{	.withlist( "blockexit" );	}
	dititblock	{	.withlist( "diblockexit" );	}
	hodone(string s)	{	<grext.getsac("do_"+s)>.bhog = (true);		}
	msethover(string s, bool b)	{ <grext.getsac("do_"+s)>.bstars = (b);	}
	nohover(string s)	{	.msethover(s,0);	}
	mgoldhover(string s)	{	<.mgetext(s)>.bgoldhint = (1);	}
	mgetext(string s)	{	grext.getsac("do_"+s);	}
	mexits	{
		.newgrimg("grext", "exit", 0);
		grext.hide;
		if( igmdebug )	{
			new string sexitfont = .stdfont(20);
		}
		grext.eval( func {
			/*if( igmdebug )	{
				.newtext("txtlok", .actionname->strsubbs("do_"), sexitfont, .grey(255) );
				txtlok.setpos(.getcx - txtlok.getw/2, .getcy - txtlok.geth/2 );
				if( txtlok.getpx < 0 )	txtlok.move( -txtlok.getpx, 0);
				if( txtlok.getpy < 0 )	txtlok.move( 0, -txtlok.getpy);
				if( txtlok.getex > iResX )	txtlok.move( iResX-txtlok.getex, 0);
				if( txtlok.getey > iResY )	txtlok.move( 0, iResY-txtlok.getey);
				txtlok.setz(700);
				txtlok.txtshadow(2, sexitfont);
			}*/
			.vars2(A, "bshow", 1, "benable", 1, "bhog", 0, "bstars", 1, "bgoldhint", 0,
				"sexit", .actionname->strsubbs("do_") );
			.addmethod("isbutin", func { (int x, int y) 
				/*bshow && */.isin(x,y,0,1);
				} );
			.addmethod("butmoveon", func {
				if( bshow ) {
					advmouse.setbut;
					if( bgoldhint )		.hovergold;
					else if( bstars )	.hoverobject;
				}
				} );
			.addmethod("butmoveoff", func {
				if( bshow )
					advmouse.setstd;
				} );
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				if( bshow  )	{
					.<"click_"+sexit>; 
				} else if ( benable )	{
					igmstate=0;
					.txtplay("lektordoors");
				} else if ( bhog )	{
					igmstate=0;
					.txtplay("lektorhodone");
				}
				} );
			but1.add(this);
			} );
		grext.addmethod("mshow", func { (string s)
			<.getsac(s)>.bshow = (true);
			} );
		grext.addmethod("mhide", func { (string s)
			<.getsac(s)>.bshow = (false);
			} );
		grext.addmethod("mdisable", func { (string s)
			<.getsac(s)>.benable = (false);
			} );
	}
	mbatyskaf	{
		.img = ("$scripts/common/batyskaf.png 480");
	}
}

class Kajuta : Kajuta1	{
	init(string s)	{
		Kajuta1::init(s);
		.mpanel;
		
		@s2 = grpan.getsac("belka");
		<s2>.hide;
		.path = ("common");
		.newgrimg("grpan2", "panelc", <s2>.getz);
		<grpan2.last>.hide;
		.path = (s);
		
		if( AdventureMode )	{
			clsave.builditems;
			.mtimhelper;
		}
	}
	showpan2	{	<grpan2.get(2)>.show;	}
	hidepan2	{	<grpan2.get(2)>.hide;	}
	virtual kajuta_hint_click	{
		if( igmstate==1 )
			.hint_click;
		if( igmstate==1 )	{
			.playhint( grhint.rand );
		}
	}
}

new string HiddenPath = null;
new string HiddenExclude = null;
new string HiddenEls = null;
new real HiddenReduce = 0.0;
class Hidden : Kajuta1	{
	init(string s)	{
		Kajuta1::init(s);
		
		if( HiddenPath!=null )	{
			.path = (HiddenPath);
			HiddenPath = null;
		}
		
		new int ihoclickdelay = dbconf.dbget("hoclick_delay:");
		new int ihoclicktimes = dbconf.dbget("hoclick_times:");
		new int ihoclickkara = dbconf.dbget("hoclick_kara:");
		
		new int ihoclicker = 0;
		.timer = ("timhoclicker", ihoclickdelay, func {
				ihoclicker=0;
			} );
		.timer = ("timhokara", ihoclickkara, func {
			imgkara.hide;
			if( lektorclicks.pogadal )
				igmstate = 1;
			} );
		new img imgkara;
		imgkara.create(iResX, iResY, .black, 128);
		imgkara.setz(2222);
		imgkara.hide;
// 		.debug = (1);
		
		.sfxs = (A, "tolist0 70", "tolist1 70", "tolist2 50");
		
		.newgrimg("grels", "els", 10);
		new gmimgvec grelscopy;
		grelscopy.copy("grels");
		
		if( HiddenExclude!=null )	{
			new gmimgvec grexclude;
			.lang_db("dbexc", HiddenExclude);
			for( int i=0; i< dbexc.getrowsno; i++)	{
				@s = grels.getsac( dbexc.get(i,0) );
				<s>.hide;
				grels.remove(s);
				grexclude.add(s);
			}
			HiddenExclude = null;
		}
		if( HiddenReduce > 0.0 )	{
		
			grels.sortimgsfun( func { (string s0, string s1)
				<s0>.getw*<s0>.geth < <s1>.getw * <s1>.geth;
				} );
			//grels.hash;
			int ile = HiddenReduce*grels.size+0.5;
			for( int i=0; i<ile; i++)	{
				<grels.first>.hide;
				grels.removefirst;
			}
			grels.sortimgs;
			HiddenReduce = 0.0;
		}
		.mpanel;
		
		//.newgrimg("grtxt", "txts", 506);
		new string sclickedho = null;
		if( HiddenEls!=null )	{
			.lang_db("dbtxts", HiddenEls);
			HiddenEls=null;
		} else {
			.lang_db("dbtxts", "els_");
		}
		new gmimgvec grtxt;
		new vector vtexts; vtexts.type("string");
		new gmimgvec grtxtgrey;
		
		int i[4], string s[4];
		new int itxtheight = 16;
		.newfont("fnttxts", "configs/fonts/timesit.ttf", itxtheight);
		
		for( int i=0; i<dbtxts.getrowsno; i++)	{
			if( dbtxts.getcolsno(i)>1 )	{
				s0 = dbtxts.get(i,0);
				i0 = grels.findsac(s0);
				if( i0>=0 )	{
					s2 = grels.getsac(s0);
					s1 = dbtxts.get(i,1);
					i0 = vtexts.find(s1);
					if( i0>=0 )	{
						for( i1=0; i1 < grtxt.size; i1++)	{
							s3 = grtxt.get(i1);
							if( <s3>.idvtext==i0 )	{
								<s2>.var2("stxtview", s3);
								<s3>.mupdatetxt(1);
							}
						}
					} else {
						vtexts.add(s1);
						
						s0 = "txtel_" + s0;
						.newtext(s0, s1, "fnttxts", .grey(10) );
						<s0>.hide;
						<s0>.setz(507);
						<s0>.vars2(A, "stekst", s1, "icnt", 1, "idvtext", vtexts.size-1);
						<s0>.addmethod("mupdatetxt", func { (int ile)
							icnt += ile;
							if( icnt>1 )	{
								.txtset( stekst + " x " + icnt );
							} else if (icnt == 1)	{
								.txtset( stekst );
							}
							} );
						grtxt.add(s0);
						
						<s2>.var2("stxtview", s0);
					}
				}
			}
		}
		grtxt.vars2(A, "irows", 3, "icols", 3 );
		grtxt.addmethod("lastid", func {
			int id = 0;
			while( id<.size && <.get(id)>.isvisible )	{
				id++;
			}
			id;
			} );
		grtxt.addmethod("shownext", func {
			int id = .lastid;
			if( id==.size ) return;
			
			if( id < irows*icols )	{
				@s = .get(id);
				int row = id/icols;
				int col = id%icols;
				<s>.setpos( iResX/2 - (icols.to_r/2.0 - col.to_r - 0.5)*120 - <s>.getw/2,
					<grpan.first>.getpy + 62 + row * ( itxtheight + 2) );
				
				<s>.show;
			}
			} );
		new int iilegrtxt = grtxt.irows * grtxt.icols;
		for( i=0; i<iilegrtxt; i++)
			grtxt.shownext;
		
		new int ilehonaraz = 35;
		new classancounter ctcen;
		ctcen.set("timcenter",ilehonaraz);
		new int idtimcenter = 0;
		new real rcykcenter = 16.0;
		new string shidenmov = null;
		for (int i=0; i<ilehonaraz; i++)	{
			/*new vector <"vhox"+i>; <"vhox"+i>.type("real"); <"vhox"+i>.resize(rcykcenter+1, 0.0);
			new vector <"vhoy"+i>; <"vhoy"+i>.type("real"); <"vhoy"+i>.resize(rcykcenter+1, 0.0);*/
			@dt = 3;
			
			.cycle= ("timcenter"+i, func {
				icyk++;
				
				rdx += rpx;
				rdy += rpy;
				if( ietap==2 )	{
					<shidenmov>.ansetbpos(vhox.get(icyk), vhoy.get(icyk));
					grgwiazdki1.setpos( vhox.get(icyk), vhoy.get(icyk) );
				} else {
					<shidenmov>.move(rdx, rdy);
				}
				rdx -= rdx->to_i;
				rdy -= rdy->to_i;
				
				@sdym = ctdym.get;
				<sdym>.setpos( <shidenmov>.getcx, <shidenmov>.getcy );
				<sdym>.setz( <shidenmov>.getz-1 );
				
				if( icyk>=rcykcenter )	{
					if( ietap==1 )	{
						idestx = idestx2;
						idesty = idesty2;
						ietap = 2;
						
						grgwiazdki1.setpos( <shidenmov>.getcx, <shidenmov>.getcy );
						grgwiazdki1.setz( <shidenmov>.getz-1 );
						grgwiazdki1.nplay(-1);
						
						anbable2.setpos( <shidenmov>.getcx, <shidenmov>.getcy );
						anbable2.setz( <shidenmov>.getz-1 );
						anbable2.play(0);
						
						fxtolist2.playif;
						
						.mstart;
						<"timcenterb"+myid>.play;
					} else {
						ctcen.retf(this);
						if( ctcen.allfree )	{
							sgmstate="init";
							igmstate = 1;
						}
						<shidenmov>.hide;
						grels.remove( shidenmov );
						
						@ile = grtxt.irows * grtxt.icols;
						
						@s2 = <shidenmov>.actionname;
						if( <sclickedho>.icnt > 1 )	{
							<sclickedho>.mupdatetxt(-1);
						/*} else if( grtxt.size > ile )	{
							grtxtgrey.add( sclickedho );
							@id = grtxt.find( sclickedho );
							@s = grtxt.last;
							grtxt.remove(s);
							grtxt.set(id, s);
							grtxt.shownext;
							<sclickedho>.hide;*/
						} else {
							grtxt.remove( sclickedho );
							grtxtgrey.add( sclickedho );
							<sclickedho>.createtxt( .grey(128) );
							if( grtxtgrey.size == ile && grtxt.size>0 )	{
								grtxtgrey.hide;
								grtxtgrey.free;
								int i = 0;
								while( i<ile && grtxt.size>0 )	{
									grtxt.shownext;
									i++;
								}
							}
						}
						<sdym>.setpos( <sclickedho>.getpx + <sclickedho>.getw/2,
							<sclickedho>.getpy + <sclickedho>.geth/2 );
						<sdym>.play("end");
						.<s2 + "_put">;
						.hiddenobj_put;
					}
				} else {
					/*if( (ietap==1 && icyk%2) || ietap==2 )
						<sdym>.play("go");*/
					if( ietap==1 || ietap==2 )	{
						<sdym>.play("go");
					}
					.play;
				}
				} );
			<"timcenter"+i>.addmethod("mstart", func {
				@x = <shidenmov>.getcx;
				@y = <shidenmov>.getcy;
				rpx = (idestx - x)->to_r/rcykcenter;
				rpy = (idesty - y)->to_r/rcykcenter;
				rdx = 0.0;
				rdy = 0.0;
				icyk = 0;
				if( ietap==2 )	{
					
					vhox.set(0, x - (x-<shidenmov>.getpx));
					vhoy.set(0, y - (y-<shidenmov>.getpy));
					
					if( rpx<0 )	{
						for( int i=1; i<=rcykcenter; i++)	{
							vhox.set( i, rpx + vhox.get(i-1) - (i-rcykcenter.to_i/2)*5 );
							vhoy.set( i, rpy + vhoy.get(i-1) - (i-rcykcenter.to_i/2)*5 );
						}
					} else {
						for( int i=1; i<=rcykcenter; i++)	{
							vhox.set( i, rpx + vhox.get(i-1) + (i-rcykcenter.to_i/2)*5 );
							vhoy.set( i, rpy + vhoy.get(i-1) - (i-rcykcenter.to_i/2)*5 );
						}
					}
					
					real r[4];
					r0 = idesty - y;
					r1 = vhoy.get( rcykcenter-1 )  - vhoy.get( 0 );
					r2 = r0/r1;
					for( i=1; i<=rcykcenter; i++)
						vhoy.set( i, vhoy.get(i)*r2 );
					
				}
				} );
			<"timcenter"+i> (i) { (@id)
				new vector vhox; vhox.type("real"); vhox.resize(rcykcenter+1, 0.0);
				new vector vhoy; vhoy.type("real"); vhoy.resize(rcykcenter+1, 0.0);
				.vars(A, "rdx", "rdy", "rpx", "rpy", "icyk", "idestx", "idesty", "idestx2", "idesty2",
				"ietap", "shidenmov", "myid", "sclickedho");
				myid = id;
				shidenmov=null;
				sclickedho=null;
			};
			.timer = ("timcenterb"+i, 500, func {
				<"timcenter"+myid>.mstart;
				fxtolist1.playif;
				<"timcenter"+myid>.play;
				} );
			<"timcenterb"+i>.vars2(A, "myid", i);
		}
		
		@s = .getgraphpath;
		.path = ("common");
		@iledymu = 60;
		.newanima("anhodym", "dymki.pyz", 600);
		anhodym.hide;
		new gmimgvec grdym;
		grdym.ancopies("anhodym", iledymu);
		new classancounter ctdym;
		ctdym.set("anhodym_",iledymu);
		.imgs = (A, /*"gwiazdkif.pyzH",*/ "gwiazdki1.pyzGH", "bable.pyzH");
		.copyanima("anbable", "anbable2");
		
		.setgraphpath(s);
		
		new int izels = 10;
		grelscopy.each( func { (@id)
			.setz(izels + id*5);
			} );
		grels.each( func { (@id)
			//.setz(izels + id*5);
			.setframe(-1,1);
			.mhobut;
			} );
		/*grtxt.eval( func {
			if( .nofframes(-1) < 2 )
				.hide;
			} );*/
		if( igmdebug )	{
			new string smovedfont = .stdfont(14);
			.newtext("txtmovedho", "", smovedfont, .grey(240) );
			txtmovedho.setz(1500);
			.newtext("txtmovedho2", "", smovedfont, .grey(2) );
			txtmovedho2.setz(1499);
		}
	}
	/************ hidden ******************/
	mmasks	{
		if( engine.fileexist(.getgraphpath + "masks.pyz") )	{
			.newgrimg("grmasks", "masks", 0);
			grmasks.eval( func {
				.mmask( .actionname );
				if( .nofframes(-1)>1 )
					.play(-1);
				} );
		} else {
			new gmimgvec grmasks;
		}
	}
	mmask(string s)	{
		if( s.getb(0,5)=="_prev" )	{
			@id = grmasks.find(this);
			if( id>0 )
				.setz( <grmasks.get( id-1 )>.getz );
			else .setz( 2 );
		} else {
			string sob;
			//@id = grels.findsac(s);
			@id = grelscopy.findsac(s);
			if( id<0 )	{
				sob = grexclude.getsac(s);
			} else	{
				//sob = grels.get(id);
				sob = grelscopy.get(id);
			}
			.setz( <sob>.getz + 2 );
		}
	}
	mhider(string s)	{
		@sob = grels.getsac(s);
		.setz( <sob>.getz - 2 );
		<sob>.hide;
		.var2("maskedobj", sob);
		.addmethod("hidemask", func {
			if( grels.contains(maskedobj) )
				<maskedobj>.hide;
			} );
		.addmethod("showmask", func {
			if( grels.contains(maskedobj) )
				<maskedobj>.show;
			} );
	}
	mhiderclick	{
		if( .actionnr(-1)==0 )	{
			.setframe(1,0);
			.showmask;
		} else {
			.setframe(0,0);
			.hidemask;
		}
	}
	mho_click	{
		//@id = grtxt.findsac(.actionname);
		/*@s = .actionname;
		sclickedho = null;
		for( int i=0; i<grtxt.size; i++)	{
			if( grtxt.get(i)->strsubbs("txtel_")==s && <grtxt.get(i)>.isvisible )
				sclickedho = grtxt.get(i);
		}*/
		
		if( .hasvar("stxtview") && <stxtview>.isvisible )
			sclickedho = stxtview;
		else sclickedho = null;
		
		//if( id>=0 )	{
		if( sclickedho!=null && (igmstate==1 || sgmstate=="hoout") )	{
			@s = ctcen.getf;
			if( s!=null )	{
				ihoclicker = 0;
				but1.removebut(this);
				angwiazdkif.anhide;
				
				shidenmov = this;
				<s>.shidenmov = (this);
				.setframe(-1,0);
				.setz(600);
				igmstate = 2;
				
				if( <GAME>.hasmet( .actionname+"_put" ) )
					sgmstate="init";
				else sgmstate="hoout";
				<s>.idestx = ( iResX/2 );
				<s>.idesty = ( iResY/2 );
				<s>.idestx2 = ( <sclickedho>.getpx + <sclickedho>.getw/2 );
				<s>.idesty2 = ( <sclickedho>.getpy + <sclickedho>.geth/2 );
				<s>.ietap = (1);
				<s>.sclickedho = (sclickedho);
				<s>.mstart;
				
				@sdym = ctdym.get;
				<sdym>.setpos( <shidenmov>.getcx, <shidenmov>.getcy );
				<sdym>.play("start");
				
				/*angwiazdkif.setpos( <shidenmov>.getcx, <shidenmov>.getcy );
				angwiazdkif.setz( <shidenmov>.getz-1 );
				angwiazdkif.play(0);*/
				/*anbable.setpos( <shidenmov>.getcx, <shidenmov>.getcy );
				anbable.setz( <shidenmov>.getz-1 );
				anbable.play(0);*/
				
				fxtolist0.playif;
				<s>.play;
			} else sclickedho=null;
		}
	}
	but1_lclick	{
		if( igmstate==1 && !grtxt.empty )	{
			if( timhoclicker.isplaying ) {
				ihoclicker++;
			}
			if( ihoclicker==ihoclicktimes )	{
				ihoclicker=0;
				timhoclicker.stop(false);
				sobject = null;
				igmstate = 12345;
				imgkara.show;
				timhokara.play;
				if( !clsave.bis("ho_ukarany") )	{
					clsave.bset("ho_ukarany");
					.txtplay("lektorclicks");
				}
			} else {
				timhoclicker.play;
			}
		} else ihoclicker=0;
	}
	HO_hint_click	{
		fxshowhint.playif;
		new gmobjvec _grtmp;
		string s;
		for( int i=0; i<grels.size; i++)	{
			s = grels.get(i);
			if( <s>.hasvar("stxtview") && < <s>.stxtview >.isvisible )
				_grtmp.add(s);
		}
		s = _grtmp.rand;
		if( s!=null )	{
			angwiazdkif.setpos( <s>.getcx, <s>.getcy );
			angwiazdkif.setz( 600 );
			angwiazdkif.play(0);
		}
		delete _grtmp;
	}
	mgetel(string s)	{
		@id = grels.findsac(s);
		if( id>=0 ) grels.get(id);
		else null;
	}
	mouse_move	{
		StdGame::mouse_move;
		if( igmdebug )	{
			if( igmstate==1 )	{
				if( grels.isin(mouse.getpos,1,1) )	{
					@s = <grels.getsfound>.actionname;
					if( txtmovedho.get != s )	{
						txtmovedho.txtset(s);
						txtmovedho2.txtset(s);
					}
					txtmovedho.setpos( mouse.getpx, mouse.getpy - txtmovedho.geth - 1 );
					txtmovedho2.setpos( mouse.getpx + 1, mouse.getpy - txtmovedho.geth );
					txtmovedho.show;
					txtmovedho2.show;
				} else {
					txtmovedho.hide;
					txtmovedho2.hide;
				}
			} else {
				txtmovedho.hide;
				txtmovedho2.hide;
			}
		}
	}
}

new classgamepause clpause;
new classgamemusic clmusic;
clmusic.sndbgrpath("sounds/bgr/");
clmusic.musicpath("sounds/music/");
clmusic.load("sounds/music.db");

new snd sndakskermovon;
sndakskermovon.load("sounds/sfx/butmovon.wav");
sndakskermovon.setvol(50);

class classasker2 : classasker	{
	init()	{
		classasker::init();
		
		new snd sndaskexit;		sndaskexit.setstartstopflag(false,true);
		new snd sndaskexitgame;	sndaskexitgame.setstartstopflag(false,true);
		new snd sndyes;			sndyes.setstartstopflag(false,true);
		new snd sndno;			sndno.setstartstopflag(false,true);
		new snd sndaskrestart;	sndaskrestart.setstartstopflag(false,true);
		new snd sndaskrestart2;	sndaskrestart2.setstartstopflag(false,true);

		.reload;
		this.load( classgame::getlangfile("scripts/common/asker.pyz"), 12000 );
		this.fxonmovon("sndakskermovon");
	}
	reload	{
		this.setwavpath(SNDPATH);
		@s = .getsndpath;
		sndaskexit.load( s + "narexit.wav");
		sndaskexitgame.load( s + "narexitgame.wav");
		sndyes.load( s + "naryes.wav");
		sndno.load( s + "narno.wav");
		sndaskrestart.load( s + "narrestart.wav");
		sndaskrestart2.load( s + "narrestart.wav");
	}
	askexittomenu()	{
		this.ask( "sndaskexit", "sndyes", "sndno", "myestomenu", "mnotomenu");
	}
	askexitgame	{	.ask( "sndaskexitgame", "sndyes", "sndno", "myestomenu", "mnotomenu");	}
	askrestart()	{
		this.ask( "sndaskrestart", "sndyes", "sndno", "myesrestart", "mnorestart");
	}
	askrestart2()	{
		this.ask( "sndaskrestart2", "sndyes", "sndno", "myesrestart", "mnorestart");
	}
	mnotomenu()	{}
	myestomenu()	{
		if( <GAME>.hasvar("clsave") )
			clsave.free;
		match( gameapi.getgamename() )	{
			"MainMenu" => "exit";
			? => "MainMenu";
		}
		gameapi.play;
	}
	mnorestart()	{
		match(gameapi.getgamename)	{
			"SubMenu" => "MenuGry";
			? => "MainMenu";
		}
		gameapi.play;
	}
	myesrestart()	{	this.crestart();	}
	/*****************************************************************/
	ask( string sask, string syes, string sno, string sf1, string sf2 )	{
		if( !ccs.isplaying )	classasker::ask( sask, syes, sno, sf1, sf2 );
	}
}

new classasker2 claskexit;

public LANG=(@s)	{
	LANG = s;
	SNDPATH = "sounds/";
	if( LANG=="pl" ) LANG="";
	if( LANG.length > 0 ) SNDPATH += LANG + "/";
	
	claskexit.reload;
}

module clbuts	{
	init()	{}
	load()	{
		new classbutton buts;
		buts.build("scripts/common/buttons.pyz", 4000, "imglobcurs");
		buts.transclickfunc( engine.actclassname(), "butclick");
		buts.transmovonfunc( engine.actclassname(), "butmovon");
		buts.transmovofffunc( engine.actclassname(), "butmovoff");
		buts.disableall();
		new db dbb;
		dbb.load("scripts/common/buts.db");
		new snd sndfxglobon;
		sndfxglobon.load("sounds/sfx/globbutmovon.wav");
		sndfxglobon.setvol(50);
		new @bvisible = true;
	}
	reset()	{
		buts.disableall();	
		@sgame = gameapi.getgamename;
		int pos = dbb.findbyrow( sgame );
		if( pos>=0 )	{
			int ile = dbb.getcolsno( pos );
			for( int i=1; i<ile; i++)	{
				buts.enable( dbb.get( pos, i ) );
			}
		}
	}
	setcursorpos(int x, int y)	{	buts.setcursorpos(x,y);	}
	enable(string sbu)	{
		buts.enable( sbu );
	}
	/*****************************************/
	butmovon(string sc)	{
		sndfxglobon.play();
		bvisible = mouse.isvisible;
		mouse.show;
		.<this + "_" + sc + "_butmoveon">;
	}
	butmovoff(string sc)	{
		if( !bvisible ) mouse.hide;
		.<this + "_" + sc + "_butmoveoff">;
	}
	butclick(string sc)	{
		if( sc=="pause" )	{
			clpause.pause();
		} else if( sc=="menu" )	{
			match( gameapi.getgamename )	{
				"MainMenu" => claskexit.askexitgame;
				? => {
					claskexit.askexittomenu();
				}
			}
		} else if (sc=="restart")	{
			claskexit.askrestart();
		}
		.<this + "_" + sc + "_butclick">;
	}
}

class classplacepointer2 : classplacepointer    {
	init()  {
		classplacepointer::init();
		this.load("scripts/common/strzalka.pyz");
	}
}

/***************************************************/
// new classnextgame clnextgm;
igmstate = 0;
|igmeasy, igmdemo, igmbegin| = false, false, true;

bsms.setstd;

//clnextgm.load("scripts/common/games.db");
clbuts.load;
if( !igmdebug && igmipad )	advmouse.load("scripts/common/kursorypad.pyz");
else advmouse.load("scripts/common/cursors.pyz");

new int Trudnosc = dbconf.dbget("trudnosc:");	// 0 - easy, 1 -normal, 2 - expert

new bool bFullScreen;

gameapi.play("MainLoader");
game MainLoader : StdGame	{
	init	{
		StdGame::init("mainloader");
		
		/*new classfullsave clsmen("global.sav");
		clsmen.stdload;*/
		if( clsmen.has("fullscreen") )	{
			bFullScreen = clsmen.get("fullscreen");
			engine.setfullscreen(bFullScreen);
		} else {
			bFullScreen = 1;
			clsmen.set("fullscreen", 1);
			clsmen.stdsave;
			engine.setfullscreen(bFullScreen);
		}
		
		igmdebug = dbconf.dbget("debug_mode:");
		AdventureMode = dbconf.dbget("adventure_mode:");
		ibigfish = dbconf.dbget("bigfish:");
		igamehouse = dbconf.dbget("gamehouse:");
		
		new db dbsnd;
		dbsnd.load("scripts/common/sounds.db");
		if( igmdebug )	{
			dbsnd.save( "exports/snd.dlg" );
		}
		
		new db dbl;
		dbl.loadbeh( .getpath("init.beh") );
		gameapi.play( dbl.dbgets("startgame:", 1) );
	}
}
/***************************************************/


/*game Platforma : Kajuta1	{
	init	{
		Kajuta1::init("02platforma");
		.setsndbase("platforma");
		
		.imgsgr = (A, "hotel.jpg 10", "hotel2.jpgH 5",
			"grall");
		
		.loadsnddb;
		.sounds=(A, ":lektor4", "Przy udziale ogromnych rodkw firm prywatnych zbudowano najnowoczeniejsz platform hotelow na wiecie. Jest w stanie wytrzyma najwiksze sztormy wystpujce na tych wodach", func { tcr.ahide; tim3.play; }
			);
		
		
		new classfadeinout clfio;
		
		.cycle = ("timpos", func {
			@dx = -5;
			imghotel.move(dx, 0);
			if( imghotel.getex < iResX )	{
				imghotel.move( iResX-imghotel.getex, 0 );
				timhotel.play;
			} else
				.play;
			} );
		.timer = ("timhotel", 500, func {
				imghotel2.show;
				clfio.imgtransparency(1, -3, "imghotel", func {
					imghotel.hide;
					tim2.play;
				} );
			} );
		.timer = ("tim2", 1000, func {
				igmstate++;
				.tcheckend;
			} );
		.timer = ("tim3", 2000, func {
				igmstate++;
				.tcheckend;
			} );
		ccs.enter( func {
			//timhotel.play;
			timpos.play;
			.timplay("tim4", 1500, func { .txtplay("lektor4"); } );
			} );
	}
	tcheckend	{
		if( igmstate==2 )	{
			.mprzejdz("Winda");
		}
	}
	tit_lclick	{
		if( igmdebug ) .cactsndstop(true);
	}
}*/

game Platforma : Kajuta1	{
	init	{
		Kajuta1::init("02platforma");
		.setsndbase("platforma");
		
		.imgsgr = (A, "hotel.jpg", "hel1.pyzP 5", /*"maska.pyz 15",*/ "hel2.pyzH 20",
			"grall");
		
		.sfxs = (A, "bgrmorze2N 40");
		.timplay("timhel", 4000, func { mus.playstr("helikopter.ogg"); } );
		
		.loadsnddb;
		.sounds=(A, ":lektor4", "Przy udziale ogromnych rodkw firm prywatnych zbudowano najnowoczeniejsz platform hotelow na wiecie. Jest w stanie wytrzyma najwiksze sztormy wystpujce na tych wodach", func { tcr.ahide;  }
			);
		
		.copyanima("anhel2", "anhel");
		
		anhel.setframe(2,0);
		anhel2.setpos( iResX - anhel2.lodx, 0.01*iResY );
		anhel.hide;
		new int idestx = anhel.getpx;
		new int idesty = anhel.getpy;
		new real rdesth = anhel.geth;
		new real rstepx = -6.0;
		new real rstepy = 1.8;
		new real rodleg = rstepy.length(anhel2.getpx - idestx, anhel2.getpy - idesty);
		new real rgox = 0.0;
		new real rgoy = 0.0;
		new real istartx = anhel2.getpx - 5.0;
		new real istarty = anhel2.getpy - 3.0;
		
		new filter fthel;
		
		.timer = ("tim3", 14000, func {
			fthel.link("anhel2");
			fthel.setpivottype(1);
			anhel2.play(0);
			tim5.play; 
			} );
		.cycle = ("tim5", func {
			.modleg;
			if( anhel2.isplaying(-1)==false )
				anhel2.play(0);
			if( anhel2.getposx-50 > idestx )	{
				//("" + istartx + " "+anhel2.getposx)->print;
				.play;
			} else {
				if( !.hasvar("playend") )	{
					.var("playend");
					.mend;
				}
				.play;
			}
			} );
		//tim5.setcycle(2);
		
		ccs.enter( func {
			.timplay("tim4", 1500, func { .txtplay("lektor4"); } );
			tim3.play;
			} );
	}
	modleg	{
		/*real rx = istartx - idestx;
		real ry = istarty - idesty;
		real rd = rx.length(rx,ry) / rodleg;*/
		real rx = anhel2.getposx - idestx;
		real ry = anhel2.getposy - idesty;
		real rd = rx.length(rx,ry) / rodleg;
		
		@r1 = 0.05;
		@r2 = 1.2;
		
		if( rd<=0 )
			rd=0.1;
		real rzoom = r1 + r2*rd;
		if( rzoom>0.1 )
			fthel.setzoom( rzoom );
		
		/*istartx -= 5;
		istarty += 1;
		anhel2.setpos( istartx, istarty );*/
		
		rgox += rstepx * rd;
		rgoy += rstepy * rd;
		int x = rgox;
		int y = rgoy;
		if( x || y )	{
			rgox -= x;
			rgoy -= y;
			anhel2.move(x,y);
			istartx+=x;
			istarty+=y;
		}
	}
	mend	{
		.mprzejdz("Winda");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	mouse_rclick	{
		if( igmdebug ) .mend;
	}
}

game Winda : Kajuta1	{
	init	{
		Kajuta1::init("03winda");
		.setsndbase("winda");
		
		.imgs = (A, "03winda.jpg", "windaa.jpg", "bat.pyz 5", "winda.pyzG 10", "metry.pyz 11", "bable.pyzP 7");
		
		new img imgwinda;
		imgwinda.create( iResX, 800, 1,6,12,255 );
		imgwinda.setpos( 0, imgwindaa.getey );
		img03winda.setpos( 0, imgwinda.getey );
		anbat.setpos( 0, imgwinda.getey );
		
		new gmimgvec grall;
		grall.addlist(A, "img03winda", "imgwindaa", "imgwinda", "anbat");
		
		/*@dy = iResY - anwinda.getey;
		anwinda.move(0, dy);
		anbable.move(0, dy);*/
		
		anbat.move(0, -300);
		
		.loadsnddb;
		.sounds = (A, ":lektor5", "Jednak szczytem myli technicznej jest podwodne muzeum. Zastosowano tu najnowoczeniejsze materiay aby konstrukcja moga wytrzyma napr ogromnego cinienia.",
			func { tcr.ahide; }
			);
		
		mus.playstr("ambient_podwodny.ogg -v 60");
		
		.cycle = ("tim2", func {
			grall.move(0, -5);
			if( img03winda.getey < 1.35*iResY && !.hasvar("gobat") )	{
				new int gobat;
				anbat.play(0);
			}
			/*if( img03winda.getey < 1.05*iResY && !.hasvar("finitobandito") )	{
				new int finitobandito;
				.mend;
			}*/
			if( img03winda.getey < iResY )	{
				.timplay("tim3", 500, "mend" );
			} else .play;
			} );
		
		ccs.enter( func {
			.timplay("tim1", 1000, func { tim2.play; .txtplay("lektor5"); } ); 
			} );
	}
	mend	{	.mprzejdz("Podwodnemuzeum"); }
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	mouse_rclick	{
		if( igmdebug ) .mend;
	}
}

game Podwodnemuzeum : Kajuta	{
	init	{
		Kajuta::init("04podwodnemuzeum");
		.setsndbase("podwodnemuzeum");
		
		//.imgs = (A, "podwodnemuzeum.jpg");
		.imgs = (A, "woda.jpg", /*"wiel1.pyzP 5", "wiel2.pyzP 7", */ "maska1.pyz 10",
			/*"delf1.pyzP 12",*/ "lawica1.pyzP 15"/*, "lawica2.pyzP 20"*/, "bkg.png 25");
		
		.loadsnddb;
		.sounds = (A, ":lektor6", "Twrcy muzeum zdecydowali si na zbudowanie repliki wraku, gwnie z powodw technicznych. Prawdziwy wrak jest w bardzo zym stanie i wszelka zmiana rodowiska mogaby zniszczy go do koca.", 
			func { .txtplay("lilian1"); },
			":lilian1", "Jaki oszaamiajcy widok! Musz zobaczy cae muzeum od rodka. O... tam widz jake tablice informacyjne", 
			func { tcr.ahide; igmstate=1;
				.showpanel; 
				<grpan.getsac("belka")>.hide;
			},
			":lilian2", "Tam w oddali widz wiata biurowcw, pewnie tam musz pj.", "stdret"
			);
		
		mus.playstr("kopula.ogg -l -v 60");
		
		.mexits;
		
		if( clsave.is("epizod", "e1_muzeum") && !clsave.bis("e1_podwodnemuzeum_enter") )
			.hidepanel;
		
		if( clsave.is("epizod", "e1_muzeum") )	{
			if( clsave.bis("e1_hotablicepamiatki") )
				.blockexit("41dok");
			else
				.titblock(A, "07trap", "41dok");
		}
		
		//anwiel2.move( iResX - anwiel2.getpx, 0 );
		//anwiel1.move( iResX, 0 );
		.cycle = ("timryby", func {
			/*anwiel1.move(-3, 0);
			anwiel2.move(-4, 0);
			if( anwiel2.getpx < -3*iResX )
				anwiel2.move( iResX - anwiel2.getpx, 0 );
			if( anwiel1.getpx < -2*iResX )
				anwiel1.move( iResX - anwiel1.getpx, 0 );*/
			/*andelf1.move(2, 0);
			if( andelf1.getpx > iResX )
				andelf1.setpos( -400 - andelf1.lodx, 0 );*/
			anlawica1.move(-1, 0);
			if( anlawica1.getpx < iResX/2 )
				anlawica1.move( iResX - anlawica1.getpx , 0 );
			.play;
			} );
		timryby.play;
		
		ccs.enter( func {
			if( clsave.is("epizod", "e1_muzeum") )	{
				.grextohint;
				if( clsave.bis("e1_podwodnemuzeum_enter") )	{
					igmstate=1;
				} else {
					clsave.bset("e1_podwodnemuzeum_enter");
					.txtplay("lektor6");
				}
			} else if ( clsave.is("epizod", "e3_powrot") )	{
				.extohint("41dok");
				if( clsave.bgo("e3_podwodnemuzeumenter") ) .txtplay("lilian2");
				else igmstate=1;
			}
			} );
	}
	click_07trap	{
		.mprzejdz("Trap");
	}
	click_05tablice	{
		.mprzejdz("Tablice");
	}
	click_41dok	{
		.mprzejdz("Dok");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Tablice : Kajuta	{
	init	{
		Kajuta::init("05tablice");
		.setsndbase("tablice");
		
		.imgs = (A, "05tablice.jpg", "swiece.pyzG 5");
		grswiece.eval( func {
			//.setdelay(4);
			.play(-1);
			.setframe(-1, .nofframes(-1)->rand);
			} );
		
		.loadsnddb;
		.sounds = (A, ":kasjer1", "Tutaj widz pastwo list wszystkich ofiar katastrofy; Te wiece przynieli krewni i znajomi ofiar; Na ekranie obok mog pastwo zobaczy przedmioty znalezione na wraku; Zachcamy pastwa do przejrzenia by moe znajdziecie co co naleao do waszych krewnych", func { .txtplay("lilian1"); },
			":lilian1", "To nazwiska ludzi ktrzy zginli. Bardzo duga lista. To straszna tragedia.",
				func { .txtplay("lilian2"); },
			":lilian2", "Na ekranie dotykowym mona zobaczy przedmioty tych ludzi.", "stdret",
			":lilian3", "Poszukam wejscia do wntrza muzuem.", "stdret",
			":lilian4", "Tam lezy jakas podarta fotografia.", "stdret"
			);
		
		.snd=("lektor15", "lektor15", "stdret" );	// nie ma tutaj nic do zrobienia
		
		mus.playstr("tablice.ogg -l");
		
		.mexits;
		
		if( clsave.is("epizod", "e1_muzeum") )	{
			if( !clsave.bis("e1_hotablicepamiatki") )	{
				.titblock(A, "07trap");
				.extohint("06ho_tablicepamiatki");
			} else	{
				//.grextohint;
				.extohint("07trap");
			}
		} else if (clsave.is("epizod", "e4_end") )	{
			.dititblock(A, "04podwodnemuzeum", "07trap", "06ho_tablicepamiatki");
			.img=("zdjecie.pyz 10");
			new itemadder clz;
			anzdjecie {
				.Button_stdalpha;
				.addmethod("butclick", func {
					if( igmstate!=1) return;
					.setframe(1,0);
					but1.removebut(this);
					clz.showitem( this, func {
						.timplay("tim1", 1500, func { clz.hideitem("anzdjecie", func {
							anzdjecie.hide;
							.mprzejdz("Zdjecie");
							} ); } );
						} );
					} );
				but1.add(this);
			};
			.hoverhint("anzdjecie");
		}
		
		ccs.enter( func {
			if( clsave.is("epizod", "e1_muzeum") )	{
				if( clsave.bis("e1_tablice_enter") )	{
					if( clsave.last == "Tablicepamiatki" )	{
						.txtplay("lilian3");
					} else
						igmstate=1;
				} else {
					clsave.bset("e1_tablice_enter");
					.txtplay("kasjer1");
				}
			} else if ( clsave.is("epizod", "e3_powrot") )	{
				igmstate=1;
				.extohint("04podwodnemuzeum");
			} else if ( clsave.is("epizod", "e4_end") )	{
				igmstate=1;
			}
			} );
	}
	hint_click	{ 
		if( clsave.is("epizod", "e4_end") ) {
			igmstate=0;
			.playhint("anzdjecie");
			.txtplay("lilian4"); 
		}
	}
	click_07trap	{
		.mprzejdz("Trap");
	}
	click_06ho_tablicepamiatki	{
		if( clsave.bis("e1_hotablicepamiatki") )	{
			igmstate=0;
			.txtplay("lektor15");
		} else {
			clsave.bset("e1_hotablicepamiatki");
			.mprzejdz("Tablicepamiatki");
		}
	}
	click_04podwodnemuzeum	{
		.mprzejdz("Podwodnemuzeum");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
		/*if( igmstate==5 )	{
			clsave.free;
			.mprzejdz("MainMenu");
		}*/
	}
}

game Trap : Kajuta	{
	init	{
		Kajuta::init("07trap");
		
		.imgs = (A, "07trap.jpg", "wiatrak.pyzG 5");
		grwiatrak.nplay(-1);
		.setsndbase("trap");
		
		mus.playstr("kopula.ogg -l -v 50");
		
		.loadsnddb;
		.sounds = (A, ":kasjer1", "Zapraszamy pastwa do zwiedzania wraku. Jego replika jest cakowicie bezpieczna. Na ekranach dotykowych moecie pastwo zobaczy materiay historyczne zwizane z budow i eksploatacj Titanica." , func {
				tcr.ahide;
				.mprzejdz("HOTrap");
			}
			);
		
		.mexits;
		ccs.enter( func {
			if( clsave.is("epizod", "e1_muzeum") )	{
				//.grextohint;
				if( !clsave.bis("e1_traphistorial") )
					.extohint("historial");
				else if( !clsave.bis("e1_traphistoriar") )
					.extohint("historiar");
				else .extohint("08kasy");
				
				if( clsave.bis("e1_trap_enter") )	{
					igmstate=1;
				} else {
					clsave.bset("e1_trap_enter");
					.txtplay("kasjer1");
				}
			} else if ( clsave.is("epizod", "e3_powrot") )	{
				igmstate=1;
				.extohint("04podwodnemuzeum");
			}
			} );
	}
	click_08kasy	{
		.mprzejdz("Kasy");
	}
	click_historial	{
		clsave.bset("e1_traphistorial");
		.mprzejdz("InfoTrapL");
	}
	click_historiar	{
		clsave.bset("e1_traphistoriar");
		.mprzejdz("InfoTrapR");
	}
	click_04podwodnemuzeum	{
		.mprzejdz("Podwodnemuzeum");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Kasy : Kajuta	{
	init	{
		Kajuta::init("08kasy");
		.setsndbase("kasy");
		
		.imgs = (A, "08kasy.jpg");
		
		.loadsnddb;
		.sounds = (A, ":kasjer1", "Na tych ekranach dotykowych mog pastwo zapozna si faktami i materiaami zebranymi na temat samej katastrofy.", "stdret",
			":lilian1","Musz wyj na zewntrz statku i tam znajd droge do dokw z batyskafami.", "stdret",
			":lilian2", "I better head into the replica.", "stdret"
			);
		
		mus.playstr("kopula.ogg -l -v 50");
		
		.mexits;
		
		if( clsave.bis("e1_hotitanic") )	{
			.diblockexit("08ho_titanic");
			.hodone("08ho_titanic");
		} else .titblock(A, "07trap", "09korytarzmuzeum");
		
		ccs.enter( func {
			if( clsave.is("epizod", "e1_muzeum") )	{
				//.grextohint;
				if( clsave.bis("e1_kasy_enter") )	{
					igmstate=1;
				} else {
					clsave.bset("e1_kasy_enter");
					.txtplay("kasjer1");
					.extohint("08ho_titanic");
				}
			} else if ( clsave.is("epizod", "e3_powrot") )	{
				if( clsave.bgo("e3_kasyenter") ) .txtplay("lilian1");
				else igmstate=1;
				.extohint("07trap");
			}
			} );
	}
	hint_click	{
		if( clsave.is("epizod", "e1_muzeum") && clsave.bis("e1_hotitanic") )	{
			igmstate=0;
			.txtplay("lilian2");
		}
	}
	click_historia	{ .mprzejdz("InfoKasyL"); }
	click_08ho_titanic	{
		clsave.bset("e1_hotitanic");
		.mprzejdz("HOTytan");
	}
	click_07trap	{
		.mprzejdz("Trap");
	}
	click_09korytarzmuzeum	{
		.mprzejdz("Korytarzmuzeum");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Korytarzmuzeum : Kajuta	{
	init	{
		Kajuta::init("09korytarzmuzeum");
		.setsndbase("korytarzmuzeum");
		
		.imgs = (A, "09korytarzmuzeum.jpg", "drzwi.pyz 5");
		
		mus.playstr("kopula.ogg -l -v 40");
		
		.loadsnddb;
		.sounds = (A, ":kasjer1", "Zachcamy pastwa do zwiedzania rnych pomieszcze; Prosz si nie krpowa my czuwamy nad waszym bezpieczestwem i nic pastwu nie grozi; Zachcamy do zgbiania tajemnic wraku i jego tragicznego rejsu", "stdret",
			":lilian15", "Syszaam e na pokadzie statku byo morderstwo; Czy wie pan co wicej na ten temat",
				func { .txtplay("kasjer2"); },
			":kasjer2", "Niestety nie za wiele; Wiemy tylko tyle ile wiadkowie mogli przekaza jednak z trzeciej klasy niewielu ludzi ocalao; Bya zamknita krata i ci biedacy zostali tam na wieki; Kajuty trzeciej klasy mona zobaczy na prawdziwym wraku wykupujc dodatkow wycieczk batyskafem z przewodnikiem",
				func { .txtplay("lilian16"); },
			":lilian16", "Gdzie mog wykupi tak wycieczk?",
				func { .txtplay("kasjer3"); },
			":kasjer3", "Na drugim kocu muzeum s budynki administracyjne National Geographic; Prosz si tam uda i tam wszystko bdzie mona zaatwi", "stdret",
			":lilian17", "Ciekawe co jest za tymi drzwiami?", func { .mprzejdz("HOKajutamuzeum"); }
			);
		
		.sfxs = (A, "opendoor");
		
		.mexits;
		
		ccs.enter( func {
			if( clsave.is("epizod", "e1_muzeum") )	{
				if( clsave.bis("e1_korytarzmuzeum_enter") )	{
					igmstate=1;
				} else {
					clsave.bset("e1_korytarzmuzeum_enter");
					.txtplay("kasjer1");
				}
				if( !clsave.bis("e1_hokajutamuzeum") )	.extohint("10kajutamuzeum");
				else .grextohint;
			} else if ( clsave.is("epizod", "e3_powrot") )	{
				if( !clsave.bis("e3_przewodnik") )	{
					clsave.bset("e3_przewodnik");
					.txtplay("lilian15");
				} else igmstate=1;
				.extohint("08kasy");
				.nohover("10kajutamuzeum");
			}
			} );
	}
	click_08kasy	{
		.mprzejdz("Kasy");
	}
	click_10kajutamuzeum	{
		andrzwi.play(1);
		fxopendoor.play;
		if( !clsave.bis("e1_hokajutamuzeum") )	{
			clsave.bset("e1_hokajutamuzeum");
			igmstate=0;
			.txtplay("lilian17");
		} else
			.mprzejdz("Kajutamuzeum");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Kajutamuzeum : Kajuta	{
	init	{
		Kajuta::init("10kajutamuzeum");
		.setsndbase("kajutamuzeum");
		
		.imgs = (A, "kajutamuzeum.jpg", "lustromask.pyzH");
		//anlustromask.mhobjmask;
		
		mus.playstr("kopula.ogg -l -v 40");
		
		.loadsnddb;
		.sounds = (A, ":lilian3", "Kim jeste? aaaaaaaaaaaa", func { .txtplay("prab1"); },
			":prab1", "Dugo czekaam  na ciebie; Wiele dusz wspierao dziaania ludzi aby moga tu dotrze",
				func { .txtplay("lilian4"); },
			":lilian4","Czuje jakbym ci znaa; Bya tutaj w dniu katastrofy?", func { .txtplay("prab2"); },
			":prab2","Znasz mnie z opowieci; Widz e dostaa jedyn pamitk po mnie; W dniu katastrofy wrzuciam medalion do jednej z odzi ratunkowych; Niestety medalion nie jest kompletny zgubiam na pokadzie kilka jego elementw", 
				func { .txtplay("lilian5"); },
			":lilian5","Prababcia?! Jak to moliwe e z tob rozmawiam? Czemu musiaa tu zgin? Mam tyle pyta do ciebie; Mama mwia e pracowaa tutaj jako pielgniarka na grnych pokadach; Czy ju zostaniesz z nami ?",
				func { .txtplay("prab3"); },
			":prab3","Niestety mj wiat jest ju gdzie indziej ale czekalimy na ciebie i musisz nam pomc aby podobne rzeczy nie wydarzyy si w przyszoci",
				func { .txtplay("lilian6"); },
			":prab4","W dniu katastrofy na dolnych pokadach zostali zamknici ludzie biedota ktra emigrowaa do Ameryki; Chciaam im pomc ale niestety nie mogam otworzy kraty ktra oddzielaa ich poziom od wolnoci; Pom nam moemy jeszcze to zmieni",
				func { .txtplay("lilian6"); },
			":lilian6","Ale jak? aaaaaaaaaaa",
				func { .txtplay("prab5"); },
			":prab5","To lustro przeniesie ci do 1912 roku do dnia kiedy wydarzya si katastrofa; Odszukaj prosz wszystkie klucze do kraty a take wszystkie brakujce czci medalionu; Bd ci wspiera; Nie bj si",
				func { .txtplay("lilian9"); },
			":lilian9", "What can I do to save them?", func { .txtplay("prab6"); },
			":prab6","Jeszcze jedno; Widz e masz ju album na zdjcia ktry pomoe wielu duszom na spokojne odejcie; Spotkasz na swojej drodze duchy; Nie bj si ich i zaopiekuj si nimi; One pomog tobie a ty bardzo pomoesz im",
				func { .txtplay("prab7"); },
			":prab7","One more thing, I see that you have a picture album containing photos of passengers who died during the tragic wreck. Throughout your journey, you will meet with spirits from the Titanic, but don't be afraid of them. Help them out, and they will help you in return! Farewell, Lilian, and good luck!", func { tcr.ahide; ccs.playfin( func {
					anbabki.hide;
				}, func { 
					.txtplay("lilian7");
				} ); },
			":lilian7", "Wow! Ja chyba ni! Najpierw duch przy schodach teraz moja prababcia i na dodatek to magiczne lustro przenoszce do innego wymiaru; Co niedobrego dzieje si z moj gow; ale jednak sprawdz czy prababcia mwia prawd", "stdret",
			":lilian8", "Moe w biurze muzeum bd wiedzieli czy jest jakas moliwo dostania si na prawdziwy wrak. Zapytam kogo z obsugi.", "stdret",
			":prab19","Dzikuj ci Lilian; Mam ju wszystkie klucze dziki ktrym uratuje bardzo wielu ludzi",
				func {
					tcr.ahide;
					clkey.hideitem( "ankluczes", func {
						clkey.freeitem;
						ankluczes.hide;
						.txtplay("lilian24"); 
						} );
				},
			":lilian24","Tak si ciesz e mogam ci zobaczy; Czy spotkamy si jeszcze?", func { .txtplay("prab20"); },
			":prab20","egnaj Lilian", func { tcr.ahide; .mprzejdz("Tablice"); }
			);
		
		.mexits;
		
		if (clsave.is("epizod", "e3_powrot") )	{
			.diblockexit("11kajutalustro");
			.extohint("09korytarzmuzeum");
		} else if (clsave.is("epizod", "e4_end") )	{
			.titblock(A, "09korytarzmuzeum", "11kajutalustro" );
			.img=("babki.pyz 10");
			.newanima("ankluczes", "klucze.pyz", 100);
			ankluczes.hide;
			new itemadder clkey;
		} else .extohint("11kajutalustro");
		
		ccs.enter( func {
			if( clsave.is("epizod", "e1_muzeum") )	{
				if( clsave.bis("e1_kajutamuzeum_enter") )	{
					igmstate=1;
				} else {
					clsave.bset("e1_kajutamuzeum_enter");
					.img = ("babcia.pyzH 10");
					anbabcia.addmethod("onfinish", func {
						if( .actionnr(-1)==0 )	{
							ccs.playfin( func { anbabcia.play(1); }, 
								func {
									.timplay("timbabka2", 500, func {
										ccs.playfin( func { delete anbabcia;
												.img=("babki.pyz 10"); },
											func { .txtplay("lilian3"); } ); 
										} );
								} );
						}
						} );
					.timplay("timbabka", 1000, func { anbabcia.play(0); fxshowhint.play; });
				}
			} else if (clsave.is("epizod", "e3_powrot") )	{
				if( clsave.bgo("e3_kajutamuzeumenter") )	.txtplay("lilian8");
				else igmstate=1;
			} else if ( clsave.is("epizod", "e4_end") )	{
				grklucze.hide;
				clsave.set("ma_klucz1",0);
				clsave.set("ma_klucz2",0);
				clsave.set("ma_klucz3",0);
				clsave.set("ma_klucz4",0);
				clsave.set("ma_klucz5",0);
				clsave.set("ma_klucz6",0);
				clkey.showitem("ankluczes", func { clkey.freeitem; .txtplay("prab19"); });
			}
			} );
	}
	click_09korytarzmuzeum	{
		if( clsave.is("epizod", "e3_powrot") && !clsave.bis("e3_hokorytarzmuzeum") )	{
			clsave.bset("e3_hokorytarzmuzeum");
			.mprzejdz("HOKorytarzmuzeum");
		} else
			.mprzejdz("Korytarzmuzeum");
	}
	click_11kajutalustro	{
		clsave.set("epizod", "e2_1912");
		.mprzejdz("Kajutalustro");
	}
	/*anlustromask_click	{
		if( anbabki.isvisible )
			.mprzejdz("Kajutalustro");
	}*/
	tit_lclick	{
		//.cactsndstop(true);
	}
}

game Kajutalustro : Kajuta	{
	init	{
		Kajuta::init("11kajutalustro");
		.setsndbase("kajutalustro");
		
		.imgsgr = (A, "kajutalustro.png",
			"grall");
		
		.loadsnddb;
		.sounds = (A, ":lilian6", "Jednak to prawda!", func { .txtplay("prab7"); },
			":prab7","Pom mi Lilian; Znajd klucze!", "stdret",
			":prab18","Zosta teraz ostatni klucz; Niestety znajdziesz go w swoich czasach na prawdziwym wraku; Powodzenia Lilian", "stdret",
			":prab19","Dzikuj ci Lilian; Mam ju wszystkie klucze dziki ktrym uratuje bardzo wielu ludzi",
				func {
					tcr.ahide;
					clkey.hideitem( "ankluczes", func {
						clkey.freeitem;
						ankluczes.hide;
						.txtplay("lilian24"); 
						} );
				},
			":lilian24","Tak si ciesz e mogam ci zobaczy; Czy spotkamy si jeszcze?", func { .txtplay("prab20"); },
			":prab20","egnaj Lilian", func { tcr.ahide; .mprzejdz("Tablice"); },
			":lilian25","Przeszukam to pomieszcznie zanim przenios si do moich czasw.", func {
				tcr.ahide;
				.timplay("timbum2", 300, func {
					fxstatekbum.play;
					timbum.setcycle(2);
					timbum.var2("idbum", 20);
					timbum.play;
					} );
				},
			":lilian26", "We've hit the iceberg! I need to hurry and find this ring!", "stdret"
			);
		
		//mus.playstr("titanic3.ogg -l -v 60");
		.mexits;
		
		.sfxs = (A, "bgrsala2N");
		
		if( clsave.is("epizod", "e2_1912") )	{
			if( clsave.bis("e2_kajutalustrofinito") )	{
				.dititblock(A, "11ho_kajutalustro", "12schody");
				.hodone("11ho_kajutalustro");
			} else if( clsave.bis("e2_morderstworozwiazane") )	{
				.dititblock(A, "10kajutamuzeum", "12schody");
				.sfx = ("statekbum");
				.cycle = ("timbum", func {
					if( idbum%2 ) grall.move(-1,0);
					else grall.move(1,0);
					idbum--;
					if( idbum>0 ) .play;
					else .txtplay("lilian26");
					} );
			} else {
				.titblock(A, "10kajutamuzeum", "11ho_kajutalustro");
			}
		} else if (clsave.is("epizod", "e4_end") )	{
			.titblock(A, "11ho_kajutalustro", "12schody", "10kajutamuzeum" );
			.imgs=(A, "$scripts/10kajutamuzeum/babki.pyz 10");
			.newanima("ankluczes", "klucze.pyz", 100);
			ankluczes.hide;
			new itemadder clkey;
		}
		.grextohint;
		ccs.enter( func {
			if( clsave.is("epizod", "e2_1912") )	{
				if( clsave.bis("e2_kajutalustrofinito") )	{
					//.txtplay("prab18");
					.rosie_go;
				} else if( clsave.bis("e2_morderstworozwiazane") )	{
					.txtplay("lilian25");
				} else if( clsave.bis("e2_kajutalustro_enter") )	{
					igmstate=1;
				} else {
					clsave.bset("e2_kajutalustro_enter");
					.txtplay("lilian6");
				}
			} else if ( clsave.is("epizod", "e4_end") )	{
				grklucze.hide;
				clsave.set("ma_klucz1",0);
				clsave.set("ma_klucz2",0);
				clsave.set("ma_klucz3",0);
				clsave.set("ma_klucz4",0);
				clsave.set("ma_klucz5",0);
				clsave.set("ma_klucz6",0);
				clkey.showitem("ankluczes", func { clkey.freeitem; .txtplay("prab19"); });
			}
			} );
	}
	rosie_help	{	.txtplay("prab18");	}
	click_12schody	{
		.mprzejdz("Schody");
	}
	click_10kajutamuzeum	{
		clsave.set("epizod", "e3_powrot");
		.mprzejdz("Kajutamuzeum");
	}
	click_11ho_kajutalustro	{
		clsave.bset("e2_kajutalustrofinito");
		.mprzejdz("HOKajutalustro");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Schody : Kajuta	{
	init	{
		Kajuta::init("12schody");
		.setsndbase("schody");
		
		.imgs = (A, "12schody.jpg", "skrytka.pyz 10");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Jestem niewidzialna; Mog wej wszdzie i nikt mnie nie zobaczy", "stdret",
			":lilian2", "Zepsuty zegar Co mi podpowiada e to nie jedyna jego funkcja",
				func { tcr.ahide; .mprzejdz("Zegar"); },
			":lilian3", "Mam pierwszy z szeciu zaginionych kluczy! Musz przeszuka pokad Tytanika w poszukiwaniu pozostaych oraz drugiej czci medalionu prababci.", "stdret",
			":lilian4", "Poszukam sali o ktrej mwia prababcia.", "stdret",
			":lilian5", "Wydje mi si, e wejscie do sali tureckiej byo blisko kanapy.", "stdret"
			);
		
		.sfxs = (A, "bgrsala2N");
		.mexits;
		
		.mgoldhover("14korytarz3odnogi");
		.nohover("11kajutalustro");
		
		if( clsave.bis("e2_schody_otwarta_skrytka") )	{
			anskrytka.setframe("open", 0);
			.diblockexit("13ho_skrytkaschody");
			.hodone("13ho_skrytkaschody");
		}
		if( clsave.is("epizod", "e2_1912") )	{
			if( clsave.bis("e2_recepcjalustro") )	{
				//.img = ("e2ludzie2.pyzG 20");
				.titblock(A, "38salaturecka", "36salabalowarecepcja", "11kajutalustro" );
				.extohint("14korytarz3odnogi");
			} else if( clsave.bis("e2_wnioskitajemnica") )	{
				//mus.playstr("gwarludzi.ogg -l -v 50");
				.sfx=("gwarludziN 50");
				.img = ("e2ludzie2.pyzG 20");
				if( clsave.bis("e2_recepcjaszafa") && !clsave.bis("e2_hosalaturecka") ) {
					.titblock(A, "14korytarz3odnogi", "11kajutalustro");
					.extohint("38salaturecka");
				} else {
					.titblock(A, "38salaturecka", "14korytarz3odnogi", "11kajutalustro");
					.grextohint;
				}
			} else {
				.img = ("e2ludzie.pyzG 20");
				//mus.playstr("gwarludzi.ogg -l -v 50");
				.sfx=("gwarludziN 50");
				if( !clsave.bis("e2_schody_otwarta_skrytka") )	{
					.titblock(A, "38salaturecka", "14korytarz3odnogi", "36salabalowarecepcja");
					.extohint("13ho_skrytkaschody");
				} else {
					.titblock(A, "38salaturecka", "36salabalowarecepcja");
					.extohint("14korytarz3odnogi");
				}
			}
		}
		
		ccs.enter( func {
			if( clsave.is("epizod", "e2_1912") )	{
				if( clsave.bis("e2_schody_enter") )	{
					if( clsave.bis("e2_schody_otwarta_skrytka") && !clsave.bis("e2_schodykoment1") )	{
						clsave.bset("e2_schodykoment1");
						.txtplay("lilian3");
					} else if (clsave.bis("e2_wnioskitajemnica") && clsave.bgo("e2_schodykomentsalabalowa") )	{
						.txtplay("lilian4");
					} else {
						igmstate=1;
					}
				} else {
					clsave.bset("e2_schody_enter");
					.txtplay("lilian1");
				}
			}
			} );
	}
	hint_click	{
		if( clsave.bis("e2_recepcjaszafa") && !clsave.bis("e2_hosalaturecka") ) {
			igmstate=0;
			.playexhint("38salaturecka");
			.txtplay("lilian5");
		}
	}
	click_38salaturecka	{
		.mprzejdz("Salaturecka");
	}
	click_14korytarz3odnogi	{
		if( !clsave.bis("e2_hokorytarz3odnogi") )	{
			clsave.bset("e2_hokorytarz3odnogi");
			.mprzejdz("HOKorytarz3odnogi");
		} else
			.mprzejdz("Korytarz3odnogi");
	}
	click_36salabalowarecepcja	{
		.mprzejdz("Salabalowarecepcja");
	}
	click_13ho_skrytkaschody	{
		clsave.bset("e2_schody_otwarta_skrytka");
		igmstate = 0;
		.txtplay("lilian2");
	}
	click_11kajutalustro	{
		.mprzejdz("Kajutalustro");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Korytarz3odnogi : Kajuta	{
	init	{
		Kajuta::init("14korytarz3odnogi");
		.setsndbase("korytarz3odnogi");
		
		.imgs = (A, "14korytarz3odnogi.jpg");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Pjd prosto korytarzem.", "stdret",
			":lilian2", "Moe teraz pjd w inna stron?", "stdret",
			":lilian3", "Teraz zostaa mi tylko jedna droga.", "stdret"
			);
		
		//mus.playstr("titanic2.ogg -l -v 60");
		.sfxs = (A, "bgrsala2N");
		.mexits;
		
		if( clsave.is("epizod", "e2_1912") )	{
			if( clsave.bis("e2_hokuchnia") )	{
				.titblock(A, "15korytarzambulatorium", "20korytarzkrata");
				.extohint("18kajutabos");	// potem z kajutybos od razu do kajutylustro
				.nohover("12schody");
			} else if( clsave.bis("e2_recepcjalustro") )	{
				.titblock(A, "15korytarzambulatorium", "18kajutabos");
				.extohint("20korytarzkrata");
				.nohover("12schody");
			} else {
				if( clsave.bis("ma_klucz3") )	{
				} else if( clsave.bis("ma_klucz2") )	{
					.blockexit("20korytarzkrata");
				} else {
					.titblock(A, "20korytarzkrata", "18kajutabos");
				}
			}
		}
		//.tohint(A, "grext");
		new int ipodpokor = 0;
		ccs.enter( func {
			if( clsave.bis("e2_hoskrzyniaplay") && !clsave.bis("e2_ko3ostatniadroga") )	{
				.txtplay("lilian3");
				ipodpokor = 3;
			} else if( clsave.bis("e2_hoambulatorium") && !clsave.bis("e2_kor3koment2") )	{
				.txtplay("lilian2");
				ipodpokor = 2;
			} else if( !clsave.bis("e2_hokorytarz3odnogidone") )	{
				//clsave.bset("e2_hokorytarz3odnogidone");
				.txtplay("lilian1");
				ipodpokor = 1;
			} else igmstate=1;
			} );
	}
	hint_click	{
		match(ipodpokor)	{
			1 => { igmstate=0; .txtplay("lilian1"); .playexhint("15korytarzambulatorium"); }
			2 => { igmstate=0; .txtplay("lilian2"); .playexhint("18kajutabos"); }
			3 => { igmstate=0; .txtplay("lilian3"); .playexhint("20korytarzkrata"); }
			? => ;
		}
	}
	click_15korytarzambulatorium	{
		clsave.bset("e2_hokorytarz3odnogidone");
		.mprzejdz("Korytarzambulatorium");
	}
	click_20korytarzkrata	{
		clsave.bset("e2_ko3ostatniadroga");
		.mprzejdz("Korytarzkrata");
	}
	click_18kajutabos	{
		clsave.bset("e2_kor3koment2");
		.mprzejdz("Kajutabos");
	}
	click_12schody	{
		.mprzejdz("Schody");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Korytarzambulatorium : Kajuta	{
	init	{
		Kajuta::init("15korytarzambulatorium");
		.setsndbase("korytarzambulatorium");
		
		.loadsnddb;
		.sounds = (A, ":lilian7", "To pewnie gabinet prababci", func { .mprzejdz("HOAmbulatorium2"); },
			":lilian1", "Sprawdz czy drzwi s otwarte. By moe znajd tam co ciekawego.", "stdret"
			);
		
		.sfxs = (A, "opendoor", "bgrsala2N", "foto2 30" );
		
		/*if( clsave.is("epizod", "e2_1912") )
			.img = ("15korytarzambulatorium2.jpg");
		else .img = ("15korytarzambulatorium.jpg");*/
		.img = ("15korytarzambulatorium.jpg");
		
		.imgs = (A, /*"animy1.pyzG",*/ "zegar.pyzP 5", "zegarmask.pyz 10", "doors.pyz 5");
		//granimy1.nplay(-1);
		
		//mus.playstr("titanic2.ogg -l -v 60");
		
		.mexits;
		
		if( clsave.bis("e2_hoambulatorium") ) .extohint("14korytarz3odnogi");
		else .extohint("16ambulatorium");
		
		ccs.enter( func {
			if( !clsave.bis("e2_weszlakorambulatorium") )	{
				clsave.bset("e2_weszlakorambulatorium");
				.txtplay("lilian1");
			} else igmstate=1;
			} );
	}
	click_16ambulatorium	{
		andoors.setframe(0,1);
		fxopendoor.play;
		if( !clsave.bis("e2_korytarzambulatorium_enter") )	{
			clsave.bset("e2_korytarzambulatorium_enter");
			igmstate=0;
			.txtplay("lilian7");
		} else 	{
			.mprzejdz("Ambulatorium");
		}
	}
	click_14korytarz3odnogi	{
		.mprzejdz("Korytarz3odnogi");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Ambulatorium : Kajuta	{
	init	{
		Kajuta::init("16ambulatorium");
		.setsndbase("ambulatorium");
		
		.titsounds = (A, ":lilian1", "Rosemary must have been in a hurry, she left many items in disarray! What a caring woman, risking her own life to try to save those trapped passengers.", "stdret",
			":lilian2","Moe apteczka skrywa co w swoim wntrzu?", func { .mprzejdz("HOAmbulatorium"); },
			":lilian3", "Nie ma tu ju nic do zrobienia. Id szuka kluczy w innych miejscach.", "stdret"
			);
		
		.imgs = (A, /*"16ambulatorium.jpg"*/ "bkg.pyz", "firany.pyzG 5", "polka.pyz 10");
		grfirany.nplay(-1);
		
		.sfxs = (A, "przeciagN");
		//mus.playstr("titanic2.ogg -l -v 60");
		
		.mexits;
		
		if( clsave.bis("e2_hoambulatorium") )	{
			anpolka.setframe(2,0);
			.diblockexit("17ho_ambulatorium");
			.hodone("17ho_ambulatorium");
			.extohint("15korytarzambulatorium");
		} else .extohint("17ho_ambulatorium");
		
		ccs.enter( func {
			if( clsave.last == "HOAmbulatorium" )	{
				.txtplay("lilian3");
			} else if( clsave.bgo("e2_weszlaambulatorium") )	{
				.txtplay("lilian1");
			} else igmstate=1;
			} );
	}
	click_17ho_ambulatorium	{
		anpolka.play(1);
		clsave.bset("e2_hoambulatorium");
		igmstate=0;
		.txtplay("lilian2");
	}
	click_15korytarzambulatorium	{
		.mprzejdz("Korytarzambulatorium");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Kajutabos : Kajuta	{
	init	{
		Kajuta::init("18kajutabos");
		.setsndbase("kajutabos");
		
		.imgs = (A, "kajutabos.png 5", "morze.pyzP", "dymek.pyzP 10", "skrzynia.pyz 20");
		
		.sfxs = (A, "bgrmorzeN 70", "skrzyniaopen 30");
		
		.loadsnddb;
		.sounds = (A, ":prab14","Rozwizaa zagadk mierci dziewczyny; Nieszczliwa mio a po grb",
				func { .txtplay("lilian17"); },
			":lilian17", "It was the officer! He killed the woman because she didn't return his love!", 
				func { .txtplay("prab15"); },
			":prab15","Za chwil dojdzie do katastrofy; Musisz wrci do swojego czasu aby zdoby ostatni klucz",
				func { .txtplay("lilian14"); },
			":lilian14","Nie zd uratowa tych nieszcznikw!", func { .txtplay("prab16"); },
			":prab16", "Dasz rad;  ja ci w tym bardzo pomog; Teraz jednak musisz wrci do mojego pokoju i odnale tam piercionek jaki znalazam przy tej zabitej dziewczynie; Ostatni klucz ma przy sobie oficer ktry jest gdzie we wraku Titanica; Musisz wrci do swoich czasw i tam go odszuka", func { .txtplay("prab17"); },
			":prab17","Popiesz si Lilian", func { .mprzejdz("Kajutalustro"); },
			":lilian15", "To chyba kajuta jakiego oficera, rozejrz si.", "stdret",
			":lilian16", "Maybe I overlooked something in the trunk last time I searched through it.", "stdret"
			);
		
		.mexits;
		grext.mhide("do_19skrzynia");
		
		if( !clsave.bis("ma_klucz3") || (clsave.bis("e2_hokuchnia") && !clsave.bis("e2_hoskrzyniaagain")) )	{
			.antohint("anskrzynia");
		} else .extohint("14korytarz3odnogi");
		
		anskrzynia.mhobj;
		.hoverhint("anskrzynia");
		if( clsave.bis("18kajutabos_skrzynia_open") )
			anskrzynia.setframe("open", 0);
		//.tohint(A, "grext", "anskrzynia");
		if( clsave.bis("e2_hoskrzyniaagain") && !clsave.bis("e2_morderstworozwiazane") )	{
			clsave.bset("e2_morderstworozwiazane");
			//.txtplay("prab14");
			.rosie_go;
		} else {
			//.mstdenter;
			ccs.enter( func {
				if( clsave.bgo("e2_kajutaoficerenter") )	{
					.txtplay("lilian15");
				} else igmstate=1;
				} );
		}
	}
	rosie_help	{
		.txtplay("prab14");
	}
	//click_19skrzynia	{}
	click_14korytarz3odnogi	{
		.mprzejdz("Korytarz3odnogi");
	}
	anskrzynia_click	{
		if( anskrzynia.actionname=="close" )	{
			clsave.bset("18kajutabos_skrzynia_open");
			anskrzynia.setframe("open", 0);
			fxskrzyniaopen.play;
		} else {
			if( clsave.is("epizod", "e2_1912") )	{
				if( clsave.bis("e2_hokuchnia") && !clsave.bis("e2_hoskrzyniaagain") )	{
					clsave.bset("e2_hoskrzyniaagain");
					HiddenExclude = "els_";
					HiddenEls = "els2_";
					.mprzejdz("Skrzynia");
				} else if( !clsave.bis("ma_klucz3") )
					.mprzejdz("Skrzynia");
			}
		}
	}
	hint_click	{
		if( clsave.bis("e2_hokuchnia") && !clsave.bis("e2_hoskrzyniaagain") )	{
			igmstate=0;
			.txtplay("lilian16");
		}
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Korytarzkrata : Kajuta	{
	init	{
		Kajuta::init("20korytarzkrata");
		.setsndbase("korytarzkrata");
		
		.imgs = (A, "20korytarzkrata.jpg", "krata.pyz 10", "kufer.pyz 10"/*, "maska.pyz 5", "morze.pyzP 1"*/);
		
		.titsounds = (A, ":lilian1", "Krata blokuje przejcie. Sprbuj j otworzy.", "stdret",
			":lilian2", "Super! Udao mi si! Schody prowadz na gr.", "stdret"
			);
		
		//mus.playstr("titanic2.ogg -l -v 60");
		
		.sfxs = (A, "skrzyniaopen 30", "bgrsala2N");
		.mexits;
		
		if( clsave.bis("e2_otworzyl_krate") )	{
			ankrata.setframe(1,0);
			.diblockexit("klodki");
			.extohint("21korytarznamostek");
		} else {
			.blockexit("21korytarznamostek");
			<.mgetext("21korytarznamostek")>.move(0,-1000);
		}
		
		if( clsave.bis("e2_kuferkorytarznamostek") )	{
			.blockexit("20ho_korytarzkrata");
			.disablexit("20ho_korytarzkrata");
			.hodone("20ho_korytarzkrata");
			if( !clsave.bis("e2_otworzyl_krate") )
				.extohint("klodki");
			else <.mgetext("klodki")>.move(0,-1000);
			.nohover("14korytarz3odnogi");
		} else {
			.blockexit("klodki");
			.extohint("20ho_korytarzkrata");
		}
		//.tohint(A, "grext");
		ccs.enter( func {
			if( clsave.last=="Klodki")
				.txtplay("lilian2");
			else if( clsave.bgo("e2_korytarzkrataenter") )
				.txtplay("lilian1");
			else igmstate=1;
			} );
	}
	click_20ho_korytarzkrata	{
		// if otwarte
		clsave.bset("e2_kuferkorytarznamostek");
		clsave.bset("item_szyfr");
		igmstate = 2;
		ankufer.setframe(1,0);
		fxskrzyniaopen.play;
		.timplay("tim1", 1000, func { .mprzejdz("HOKorytarzkrata"); } );
	}
	click_21korytarznamostek	{
		if( !clsave.bis("e2_hokorytarznamostek") )	{
			clsave.bset("e2_hokorytarznamostek");
			.mprzejdz("HOKorytarznamostek");
		} else
			.mprzejdz("Korytarznamostek");
	}
	click_klodki	{
		// game klodki
		clsave.bset("e2_otworzyl_krate");
		.mprzejdz("Klodki");
	}
	click_14korytarz3odnogi	{
		.mprzejdz("Korytarz3odnogi");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Korytarznamostek : Kajuta	{
	init	{
		Kajuta::init("21korytarznamostek");
		
		//.imgs = (A, /*"21korytarznamostek.jpg"*/ "niebo.pyzP", "bkg.pyz 5", "lampy.pyzG 10");
		.imgs = (A, "21korytarznamostek.jpg", "lampy.pyzG 10");
		grlampy.nplay(-1);
		.sfxs = (A, "bgrsala2N");
		//mus.playstr("titanic2.ogg -l -v 60");
		.mexits;
		//.tohint(A, "grext");
		.extohint("22mostek");
		.mgoldhover("22mostek");
		.mstdenter;
	}
	click_20korytarzkrata	{
		.mprzejdz("Korytarzkrata");
	}
	click_22mostek	{
		.mprzejdz("Mostek");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Mostek : Kajuta	{
	init	{
		Kajuta::init("22mostek");
		.setsndbase("mostek");
		
		.imgs = (A, "22mostek.jpg", "22mostek2.jpg", "maska.pyz 5", "morze.pyzP 2");
		
		.loadsnddb;
		.sounds = (A, ":oficer1","Panie kapitanie! Mam z wiadomo; Dokonano ohydnego morderstwa w kajucie klasy trzeciej",
				func { .txtplay("kapitan1"); },
			":kapitan1","No jeszcze tego nam brakowao; Co dokadnie si stao?",
				func { .txtplay("oficer2"); },
			":oficer2","Dzisiaj rano niejaki Brandon, znalaz ciao swojej przyszej narzeczonej i od razu zawiadomi obsug statku; Lekarz stwierdzi zgon w wyniku gbokiej rany zadanej noem",
				func { .txtplay("kapitan2"); },
			":kapitan2","Powinna si tym zaj policja; Prosz zaplombowa jej kajut i niczego nie rusza",
				func { .txtplay("oficer3"); },
			":oficer3","Z caym szacunkiem ale kiedy dopyniemy do portu morderca moe uciec; Zaplombowanie samej kajuty nic nie da; Kazaem zamkn krat wejciowa na trzeci pokad",
				func { .txtplay("kapitan3"); },
			":kapitan3","Wie pan czym to grozi? Co bdzie w przypadku jakiej nie daj Boe katastrofy?",
				func { .txtplay("oficer4"); },
			":oficer4","Klucz mam przy sobie wiec w razie nagego wypadku szybko otworz krat; Prosz si nie obawia przecie ten statek jest niezatapialny",
				func { .txtplay("kapitan4"); },
			":kapitan4","Dobrze; Ma pan racje; Zostawmy zamknite przedziay trzeciej klasy; Klucz prosz mie przy sobie",
				func { tcr.ahide; ccs.playfin( func { img22mostek.hide; img22mostek2.show; ancaptain.hide; },
					func { .txtplay("lilian8"); } ); },
			":lilian8","O czym oni mwi? Jakie morderstwo? Moe to jest wanie ta mroczna tajemnica o ktrej mwia Prababcia ?", "stdret",
			":lilian9","Przeszukam to pomieszczenie moe znajd jakies wskazwki ", "stdret",
			":lilian10","Plan statku z zaznaczonymi miejscami? Pewnie to s miejsca skrytek gdzie oficer schowa klucze; Ciekawe dlaczego to zrobi? Mwi e klucze trzyma przy sobie", func {
				clmap.hideitem("anmapka2", null);
				.txtplay("lilian11");
				},
			":lilian11","Musz dalej szuka kluczy; Obiecaam e pomog uwolni tych nieszcznikw", "stdret",
			":lilian12", "Te belki pod sufitem s do due. Przyjrz si im bliej.", "stdret"
			);
		
		//mus.playstr("titanic2.ogg -l -v 60");
		.sfxs = (A, "bgrszumoceanuN 60", "mapafound");
		
		.mexits;
		
		.diblockexit("21korytarznamostek");
		.extohint("23korytarzdolnypoklad");
		
		if( clsave.bis("e2_pogadal_kapitan") )	{
			img22mostek.hide;
		} else {
			img22mostek2.hide;
			new itemadder clmap;
			.imgs = (A, "mapka.pyz 10", "mapka2.pyzH 100", "captain.pyz 10");
			.nohover("23korytarzdolnypoklad");
			anmapka	{
				.Button_stdalpha;
				.addhintpad("anmapka");
				.hoverhint(this);
				.addmethod("butclick", func {
					if( igmstate!=1 ) return;
					igmstate = 2;
					.hide;
					fxmapafound.play;
					anmapka2.ancenterscreen;
					clsave.bset("e2_ma_mapke");
					clmap.showitem("anmapka2", func { .txtplay("lilian10"); } );
					grhint.remove("anmapka");
					.removehintpad("anmapka");
					.hoverhint(.mgetext("23korytarzdolnypoklad") );
					} );
				but1.add(this);
			};
		}
		
		ccs.enter( func {
			if( clsave.bis("e2_pogadal_kapitan") )
				igmstate=1;
			else {
				clsave.bset("e2_pogadal_kapitan");
				.txtplay("oficer1");
			}
			} );
	}
	click_21korytarznamostek	{
		if( clsave.bis("e2_ma_mapke") )
			.mprzejdz("Korytarznamostek");
		else {
			igmstate=0;
			.txtplay("lilian9");
		}
	}
	click_23korytarzdolnypoklad	{
		if( clsave.bis("e2_ma_mapke") )	{
			if( !clsave.bis("e2_hokorytarzdolnypoklad") )	{
				clsave.bset("e2_hokorytarzdolnypoklad");
				.mprzejdz("HOKorytarzdolnypoklad");
			} else
				.mprzejdz("Korytarzdolnypoklad");
		} else {
			igmstate=0;
			.txtplay("lilian9");
		}
	}
	tit_lclick	{
		//if( igmstate==0 ) .cactsndstop(true);
	}
	hint_click	{
		if( !clsave.bis("e2_ma_mapke") )	{
			igmstate = 0;
			.txtplay("lilian12");
			.playhint("anmapka");
		}
	}
}


game Pokojlilian : Hidden	{
	init	{
		Hidden::init("01pokojlilian");
		.setsndbase("pokojlilian");
		
		.imgs = (A, "pokojlilian.png", "lampa.pyzH 5", "lampamask.pyzH", // els
			"szuflada.pyz", "maskamedalion.pyz", "maskaparasol.pyz"
			//, "lilian.pyz 50"
			);
		
		.sfxs = (A, "szufladaopen", "szufladaclose", "lampka 80");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Zabior kilka drobiazgw i wyjedam jeszcze dzisiaj", //func { tcr.ahide; igmstate=5; },
			func { .txtplay("lektor1"); },
			":lilian2", "My great-great-grandmother Rosemarys medallion the only belonging of hers that survived from the catastrophe! After news of the ship's sinking, the medallion was returned to Rosemarys daughter, my great-grandmother, and it has been passed down through the family ever since. Unfortunately, it was damaged during that chaotic night on the ship. Its entire interior was left on the Titanic, broken in pieces.", func { tcr.ahide; igmstate=1; .hiddenobj_put;  },
			":lilian3", "A zabrae medalion? Potem znowu bdziesz pisa, e si gra wywala!", "stdret"
			);
		/*":lektor1", "Zbierz wszystkie przedmioty wyszczeglnione na licie", func { tcr.ahide; igmstate=1; },*/
		/*":lektor3", "W tym pomieszczeniu zostay wykonane wszystkie zadania", func { igmstate=15; }*/
		.snd=("lektor1", "lektor1", func { tcr.ahide; igmstate=1; } );
		.snd=("lektor3", "lektor3", func { igmstate=15; } );
		/*anlilian	{
			.Button_stdalpha;
			.addmethod("butclick", func {
				if( igmstate==5 )	{
					igmstate = 6;
					ccs.playfin( func { anlilian.hide; },
						func { .txtplay("lektor1"); } );
				}
				} );
			but1.add(this);
		};*/
		
		anszuflada.mhider("titanic");
		anszuflada.mhobj;
		.hoverhint("anszuflada");
		
		anlampamask.mhobjmask;
		.hoverhint("anlampamask");
		
		anmaskaparasol.mmask("parasol");
		
		anmaskamedalion.mmask("medalion");
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		//.mstdenter;
		/*if( igmipad )	{
			igmstate=5;
		} else {
			ccs.enter( func { igmstate=5; } );
		}*/
		
		clsave.set("epizod", "e1_muzeum");
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	anlampamask_click	{
		fxlampka.play;
		if( anlampa.isvisible )	{
			anlampa.hide;
		} else anlampa.show;
	}
	anszuflada_click	{
		.mhiderclick;
		if( anszuflada.actionnr(-1)!=0 )
			fxszufladaopen.play;
		else fxszufladaclose.play;
	}
	medalion_put	{
		clsave.bset("ma_medalion");
		.mshowmedalion;
		igmstate=10;
		.txtplay("lilian2");
	}
	hiddenobj_put	{
		if( grtxt.empty && igmstate!=10 )	{
			.txtplay("lektor3");
		}
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
		if( igmstate==15 )
			.mprzejdz("Platforma");
	}
	anbutnext_click	{
		if( igmstate!=1 ) return;
		if( clsave.bis("ma_medalion") )	{
			grtxt.free;
			.hiddenobj_put;
		} else .txtplay("lilian3");
	}
}

game Tablicepamiatki : Hidden	{
	init	{
		Hidden::init("06ho_tablicepamiatki");
		.setsndbase("tablicepamiatki");
		
		.imgs = (A, "06ho_tablicepamiatki.png");
		
		.loadsnddb;
		
		.sounds = (A, ":lilian1", "Fragmen medalionu prababci. To niesamowite, e udao mi si go znale.",
			func { tcr.ahide; .mprzejdz("Tablice"); },
			":lilian2", "Ten album emanuje dziwn energi. Zabior go.", "stdret"
			);
		/*lektor1|0.3|0.3|Zbierz wszystkie przedmioty wyszczeglnione na licie.
		lektor3|0.3|0.3|W tym pomieszczeniu zostay wykonane wszystkie zadania.
		lektor8|0.3|0.3|Fragment medalionu prababci.
		lektor9|0.3|0.3|Album na zdjcia.*/
		.snd=("lektor1", "lektor1", func { tcr.ahide; igmstate=1; } );
		.snd=("lektor3", "lektor3", func { igmstate=15; } );
		.snd=("lektor8", "lektor8", func { .txtplay("lilian1"); } );
		.snd=("lektor9", "lektor9", func { igmstate=15; } );
		
		.mmasks;
		
		mus.playstr("tablice.ogg -l");
		
		if( igmdebug )	.mbutnext;
		
		ccs.enter( func {
			.txtplay("lektor1");
			} );
	}
	hiddenobj_put	{ <GAME> {
		if( grtxt.empty && igmstate!=10 )	{
			new itemadder clb1;
			igmstate=2;
			.img = ("$scripts/items/brylant1get.pyz 750");
			clb1.showitem("anbrylant1get", func { .timplay("timbryl1",1000, func {
				.medalion_open;
				clb1.gotodestan("anbrylant1get", "anmedalion1", 15, func {
					anbrylant1get.hide;
					clsave.bset("ma_medalion1");
					.medalion_open;
					angwiazdkif.setpos( anmedalion1.getcx, anmedalion1.getcy );
					angwiazdkif.setz( anmedalion1.getz+1);
					angwiazdkif.play(0);
					.timplay("timbryl2", 1000, func {
						//.mprzejdz("Tablice"); 
						.txtplay("lilian1");
						} );
					} );
				} );
				} );
		}
	}; }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	ho_album_put	{ <GAME> {
		clsave.bset("ma_album");
		.mshowalbum;
		igmstate=2; .txtplay("lilian2");
		/*
		igmstate=10;
		analbum.setframe(0,0);
		analbum.hide;
		new itemadder clalbum;
		.timplay("timal2", 1000, func {
			clalbum.showitem("analbum", func { .timplay("timal",1000, func {
				clalbum.gotonextfr( "analbum", 15, func {
					igmstate = 1;
					clalbum.freeitem;
					analbum.setframe(0,1);
					analbum.show;
					.hiddenobj_put;
					} );
				} ); } );
			} );*/
	}; }
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game HOTytan : Hidden	{
	init	{
		Hidden::init("08ho_tytan");
		.setsndbase("hotytan");
		
		.imgs = (A, "hotytan.jpg");
		
		.loadsnddb;
		.sounds = (A, ":lektor1", "Zobacz przedmioty wydobyte z wraku Titanica.", "stdret");
		
		.mmasks;
		
		mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		//.mstdenter;
		ccs.enter( func { .txtplay("lektor1"); } );
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			.mprzejdz("Kasy");
		}
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		
	}
}

game HOKajutalustro : Hidden	{
	init	{
		Hidden::init("11ho_kajutalustro");
		.setsndbase("hokajutalustro");
		
		.titsounds=(A, "lilian1", "Jaki pikny pierscionek zarczynowy. Musia kosztowac fortun.", "mend"
			);
		
		.imgs = (A, "hokajutalustro.jpg", "$scripts/items/ringget.pyzH 700");
		
		.mmasks;
		
		mus.playstr("mystery_war.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		.mstdenter;
	}
	mend	{	.mprzejdz("Kajutalustro");	}
	hiddenobj_put	{ <GAME> {
		if( grtxt.empty )	{
			new itemadder clb1;
			clsave.bset("item_ring");
			clb1.showitem("anringget", func { .timplay("timring",1000, func {
				clb1.hideitem("anringget", func {
					anringget.hide;
					.txtplay("lilian1");
					} );
				} );
				} );
		}
	}; }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		
	}
	mouse_rclick	{
		return;
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
}

game Skrytkaschody : Hidden	{
	init	{
		Hidden::init("13ho_skrytkaschody");
		.setsndbase("hoskrytkaschody");
		
		.imgs = (A, "skrytkaschody.png");
		
		.loadsnddb;
		.sounds = (A, ":lilian1","Znalazam pierwszy klucz!", func { tcr.ahide; .klucz_to_kolo(1); },
			":lilian2", "Wiedziaam, e ten zegar co kryje! Musz zebra wszystkie przedmioty ze skrytki.", "stdret"
			);
		
		.mmasks;
		
		mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		ccs.enter( func { .txtplay("lilian2"); } );
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			.klucz_show(1);
		}
	}
	klucz1_shown	{ .txtplay("lilian1");	}
	klucz1_in_kolo	{ .mprzejdz("Schody");	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game HOAmbulatorium : Hidden	{
	init	{
		Hidden::init("17ho_ambulatorium");
		.setsndbase("hoambulatorium");
		
		.imgs = (A, "17ho_ambulatorium.jpg");
		
		.titsounds = (A, ":lilian1", "I've found the second key!", func {
				tcr.ahide;
				.mprzejdz("Ambulatorium");
				}
			);
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		.mstdenter;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			//.mprzejdz("Ambulatorium");
			.klucz_show(2);
		}
	}
	klucz2_shown	{ .timplay("timkey", 2000, func { .klucz_to_kolo(2); });	}
	klucz2_in_kolo	{ .txtplay("lilian1");	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	mouse_rclick	{
		return;
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
}

game Skrzynia : Hidden	{
	init	{
		Hidden::init("19skrzynia");
		.setsndbase("skrzynia");
		
		.imgs = (A, "skrzynia.png");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "I cannot stop thinking about you. Please come to me, to my room. I love you more than anything and I can't stand the thought that you have a fiance now. If you don't come with me, I feel like I am going to do something that I will regret for the rest of my life.", func { .txtplay("lilian4"); },
			":lilian4", "My dear! You will always be in my heart as someone very close to me. However, I love my fiance and I will spend the rest of my life with him. Please forgive me. Yours, Margaret."
				, func { .mprzejdz("Kajutabos"); },
			":lilian2", "To chyba nie pierwszy statek na ktrym ten oficer suy. Sporo rzeczy nazbiera podczas swoich rejsw.",
				"stdret",
			":lilian3", "I've found the third key!", func { .mprzejdz("Kajutabos"); }
			);

		
		//.newanima("anskiplist", "$scripts/common/skip.pyz", 755);
		new img anskiplist {
			.copy("anskip");
			.setz(755);
			.hide;
			.Button_stdms;
			.addmethod("butclick", func { .mprzejdzclick("Kajutabos"); } );
			but1.add(this);
		};
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		ccs.enter( func {
			if( clsave.bgo("e2_hoskrzyniaplay") )	{
				.txtplay("lilian2");
			} else igmstate=1;
			} );
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			//.mprzejdz("Kajutabos");
			if( clsave.bis("e2_hoskrzyniaagain") )	{
				igmstate=23;
				// list
				.timplay("timend", 200, func { <GAME> {
					.img = ("$scripts/common/kartka2.png 500");
					imgkartka2.setpos( iResX/2 - imgkartka2.getw/2, iResY/2 - 0.7*imgkartka2.geth );
					new TextDb tdlist( sgmfontitalic, 14, "$lang:list_", 50,20,195,
						imgkartka2.getpx+0.07*imgkartka2.getw,
							imgkartka2.getpy+0.15*imgkartka2.geth, 10,750, "center");
					new TextDb tdlist2( sgmfontitalic, 14, "$lang:list2_", 120,10,15,
						tdlist.getpx, tdlist.getey+30 , 8,750, "center");
					new img imlist;
					imlist.create( tdlist2.getw + 10, tdlist2.geth + 10, .transparent );
					imlist.setpos( tdlist2.getpx - 5, tdlist2.getpy - 5 );
					tdlist2.blitto("imlist");
					tdlist2.hide;
					new filter ftlist;
					ftlist.link("imlist");
					ftlist.setrotate(7);
					imlist.setz(750);
					//.txtplay("lilian1");
					anskiplist.ansetbpos( imlist.getcx, imlist.getey );
					anskiplist.show;
				}; } );
			} else
				.klucz_show(3);
		}
	}
	klucz3_shown	{ .timplay("timkey", 2000, func { .klucz_to_kolo(3); });	}
	klucz3_in_kolo	{ .txtplay("lilian3");	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
		if( igmstate==23 )	{
			//.cactsndstop(true);
		}
	}
	mouse_rclick	{
		return;
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
}

game HOKorytarzkrata : Hidden	{
	init	{
		Hidden::init("21ho_korytarzkrata");
		.setsndbase("hokorytarzkrata");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Kartka z dziwnymi napisami. Przeczytam j pniej, jak skocz przeszukiwa t skrzyni.",
			func {
				if( grtxt.empty ) .mend;
				else .stdret;
			});
		
		.imgs = (A, "hokorytarzkrata.jpg", "$scripts/items/szyfr.pyzH 500");
		
		.mmasks;
		
		mus.playstr("mystery_war.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		new itemadder clsrub;
		
		.mstdenter;
	}
	hiddenobj_put	{
		if( igmstate!=20 && grtxt.empty )	{
			.mend;
		}
	}
	szyfr_shown	{
		.timplay("timkey", 2000, func {
			clsrub.hideitem("anszyfr", func {
				//igmstate=1;
				anszyfr.hide;
				.hiddenobj_put;
				.txtplay("lilian1");
				} );
			} );
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	HO_szyfr_put	{
		anszyfr.setframe(1,0);
		igmstate = 20;
		clsrub.showitem("anszyfr", "szyfr_shown");
	}
	mouse_rclick	{
		return;
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
	mend	{	.mprzejdz("Korytarzkrata");	}
}


game HOKotlownia : Hidden	{
	init	{
		Hidden::init("27ho_kotlownia");
		
		.imgs = (A, "27ho_kotlownia.jpg");
		
		.mmasks;
		
		mus.playstr("mystery_war.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		.mstdenter;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			.klucz_show(4);
		}
	}
	klucz4_shown	{ .timplay("timkey", 2000, func { .klucz_to_kolo(4); });	}
	klucz4_in_kolo	{
		clsave.set("item_klocek", 0);
		clsave.bset("ma_klucz4");
		clsave.bset("otwarte_drzwikotlownia");
		.mprzejdz("Kotlownia");
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	mouse_rclick	{
		return;
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
}

game HOKuchnia : Hidden	{
	init	{
		Hidden::init("30ho_kuchnia");
		.setsndbase("hokuchnia");
		
		.imgs = (A, "30ho_kuchnia.jpg");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Tajemnica tragicznej  mioci zamknita jest w skrzyni oficera", func { .txtplay("lilian13"); },
			":lilian13","Skrzynia w  kajucie oficera; Moe znajd tam rozwizanie zagadki mierci tej biednej dziewczyny",
				func { .mprzejdz("Kuchnia"); }
			);
		
		.mmasks;
		
		//.newanima("anskiplist", "$scripts/common/skip.pyz", 755);
		new img anskiplist {
			.copy("anskip");
			.setz(755);
			.hide;
			.Button_stdms;
			.addmethod("butclick", func { .mprzejdzclick("Kuchnia"); } );
			but1.add(this);
		};
		
		mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		.mstdenter;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 3;
			.klucz_show(5);
		}
	}
	klucz5_shown	{ .timplay("timkey", 2000, func { .klucz_to_kolo(5); });	}
	klucz5_in_kolo	{ <GAME> {
		.img = ("$scripts/common/kartka.png 500");
		imgkartka.setpos( iResX/2 - imgkartka.getw/2, iResY/2 - imgkartka.geth/2 );
		new TextDb tdlist( sgmfontitalic, 18, "$lang:list_", 50,20,195,
			imgkartka.getpx+0.15*imgkartka.getw, imgkartka.getpy+0.15*imgkartka.geth, 5,750, "center");
		//.txtplay("lilian1");
		anskiplist.setpos( imgkartka.getcx - anskiplist.getw/2, imgkartka.getey );
		anskiplist.show;
	}; }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game HOZejscie : Hidden	{
	init	{
		Hidden::init("24ho_zejscie");
		
		.imgs = (A, "24ho_zejscie.jpg", "$scripts/items/kolo.pyzH 507");
		ankolo.setframe(1,0);
		
		.sounds = (A, ":lilian1","Look at this wheel I found! I should hold on to this, maybe I can use it later.", 
			func { tcr.ahide; clb1.hideitem("ankolo", func {
					ankolo.hide;
					clsave.bset("item_kolo");
					.mend;
					} );
				}
			);
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		.mstdenter;
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	mend	{
		.mprzejdz("Zejsciedomaszynowni");
	}
	hiddenobj_put	{ <GAME> {
		if( grtxt.empty )	{
			new itemadder clb1;
			igmstate=0;
			clb1.showitem("ankolo", func { .timplay("timkolo",100, func {
					.txtplay("lilian1");
					} );
				} );
		}
	}; }
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game HOPokojadministracyjny : Hidden	{
	init	{
		Hidden::init("35ho_pokojadm");
		
		.imgs = (A, "35ho_pokojadm.jpg", "$scripts/items/batyskaf.pyzH 507"/*, "$scripts/items/haslo.pyzH 507"*/);
		anbatyskaf.setframe(1,0);
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		new itemadder cldiam;
		
		.mstdenter;
	}
	hiddenobj_put	{
		if( igmstate!=20 && grtxt.empty )	{
			.mprzejdz("Pokojadministracyjny");
		}
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	bat_shown	{
		.timplay("timbat", 2000, func {
			clsave.bset("item_batyskaf");
			cldiam.hideitem("anbatyskaf", func {
				igmstate=1;
				anbatyskaf.hide;
				.hiddenobj_put;
				} );
			} );
	}
	HO_batyskaf_put	{
		igmstate = 20;
		cldiam.showitem("anbatyskaf", "bat_shown");
	}
	/*haslo_shown	{
		.timplay("timhaslo", 2000, func {
			clsave.bset("item_haslo");
			cldiam.hideitem("anhaslo", func {
				igmstate=1;
				anhaslo.hide;
				.hiddenobj_put;
				} );
			} );
	}
	ho_gniot_put	{
		igmstate = 20;
		cldiam.showitem("anhaslo", "haslo_shown");
	}*/
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game HODok : Hidden	{
	init	{
		Hidden::init("41ho_dok");
		
		.imgs = (A, "41ho_dok.jpg", "$scripts/41dok/haslofragment.pyzH 507", "$scripts/items/mapa.pyzH 507",
			"$scripts/items/mapafull.pyzH 507");
		anmapa.setframe(1,0);
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		.mstdenter;
	}
	/*hiddenobj_put	{
		if( grtxt.empty )	{
			.mprzejdz("Salabalowarecepcja");
		}
	}*/
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	hiddenobj_put	{ <GAME> {
		if( grtxt.empty )	{
			new itemadder clb1;
			new itemadder clmap;
			new int ilefragmov = 50;
			anhaslofragment.move(ilefragmov,ilefragmov);
			clb1.showitem("anhaslofragment", func { .timplay("timbryl1",1000, func {
				clmap.showitem("anmapa", func {
					.cycle=("timfrag", func {
						@dt = -2;
						anhaslofragment.move(dt,dt);
						ilefragmov+=dt;
						if( ilefragmov<=0 )	{
							anhaslofragment.hide;
							anmapa.hide;
							anmapafull.show;
							anmapafull.setframe(1,0);
							.timplay("timdok1", 2000, func { 
								clb1.hideitem("anmapafull", func {
									anmapafull.hide;
									clsave.set("item_mapa", 0);
									clsave.bset("item_mapafull");
									.mprzejdz("Dok");
									} );
								} );
						} else .play;
						} );
					timfrag.play;
					} );
				} );
			} );
		}
	}; }
	mouse_rclick	{
		return;
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
}

game HOSalabalowa : Hidden	{
	init	{
		Hidden::init("37ho_salabalowa");
		.setsndbase("hosalabalowa");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Podarta fotografia. Zo j po przeszukaniu szafy.", "stdret");
		
		.imgs = (A, "37ho_salabalowa.jpg", "krysztal15.pyzH 507", "zdjecie.pyzH 507");
		
		.mmasks;
		
		mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		new itemadder cldiam;
		
		.mstdenter;
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	hiddenobj_put	{
		if( igmstate!=20 && grtxt.empty )	{
			.mprzejdz("Zdjecie");
		}
	}
	diament_shown	{
		.timplay("timdiam15", 2000, func {
			clsave.bset("item_krysztal15");
			cldiam.hideitem("ankrysztal15", func {
				igmstate=1;
				ankrysztal15.hide;
				.hiddenobj_put;
				} );
			} );
	}
	HO_diament_put	{
		igmstate = 20;
		cldiam.showitem("ankrysztal15", "diament_shown");
	}
	zdjecie_shown	{
		.timplay("timzdjecie", 2000, func {
			cldiam.hideitem("anzdjecie", func {
				//igmstate=1;
				anzdjecie.hide;
				.hiddenobj_put;
				.txtplay("lilian1");
				} );
			} );
	}
	HO_zdjecia_put	{
		igmstate = 20;
		cldiam.showitem("anzdjecie", "zdjecie_shown");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game HOSalaturecka : Hidden	{
	init	{
		Hidden::init("39ho_salaturecka");
		
		.imgs = (A, "39ho_salaturecka.jpg", "diament14.pyzH 507");
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		new itemadder cldiam;
		
		.mstdenter;
	}
	hiddenobj_put	{
		if( igmstate!=20 && grtxt.empty )	{
			.mprzejdz("Salaturecka");
		}
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	diament_shown	{
		.timplay("timdiam14", 2000, func {
			clsave.bset("item_krysztal14");
			cldiam.hideitem("andiament14", func {
				igmstate=1;
				andiament14.hide;
				.hiddenobj_put;
				} );
			} );
	}
	HO_diament14_put	{
		igmstate = 20;
		cldiam.showitem("andiament14", "diament_shown");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	mouse_rclick	{
		return;
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
}

game HOSkrytkalustro : Hidden	{
	init	{
		Hidden::init("40ho_skrytkalustro");
		.setsndbase("hoskrytkalustro");
		
		.imgs = (A, "40ho_skrytkalustro.jpg", "klocek.pyzH 507", "klocekb.pyzH 507");
		
		.titsounds = (A, ":lilian1", "Znalazam brakujce fragmenty herbu. Wracam do kotowni", "mend");
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		.mstdenter;
	}
	/*hiddenobj_put	{
		if( grtxt.empty )	{
			.mprzejdz("Salabalowarecepcja");
		}
	}*/
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	mend	{ .mprzejdz("Salabalowarecepcja"); }
	hiddenobj_put	{ <GAME> {
		if( grtxt.empty )	{
			new itemadder clb1;
			new itemadder clb2;
			clsave.bset("item_klocek");
			clsave.bset("item_klocekb");
			clb1.showitem("anklocek", func { .timplay("timbryl1",1000, func {
				clb1.hideitem("anklocek", func {
					anklocek.hide;
					clb2.showitem("anklocekb", func { .timplay("timbryl2",1000, func {
						clb2.hideitem("anklocekb", func {
							anklocekb.hide;
							.txtplay("lilian1");
							} );
							} );
						} );
					} );
				} );
			} );
		}
	}; }
}

game HOWrak : Hidden	{
	init	{
		Hidden::init("46ho_wrak");
		.setsndbase("howrak");
		
		.titsounds=(A, ":lilian1", "Pewnie w tej stercie przedmitw ukryty jest ostatni klucz.", "stdret"
			);
		
		.imgs = (A, "howrak.jpg", "box.pyzH 507");
		
		.mmasks;
		
		mus.playstr("wizards.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	hiddenobj_put	{ <GAME> {
		if( grtxt.empty )	{
			new itemadder clb1;
			clb1.showitem("anbox", func { .timplay("timbryl1",1000, func {
				clb1.hideitem("anbox", func {
					anbox.hide;
					clsave.set("item_mapafull",0);
					.mprzejdz("BoxA");
					} );
				} );
				} );
		}
	}; }
}


/*game HOTrap : Hidden	{
	init	{
		HiddenPath = ("07trap");
		Hidden::init("hotrap");
		
		new int trapduch = 1;
		
		.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; .gogo_duch; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii jakie pozostawi duch.",
				func { .remove_duch; .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide; .foto_to_album(trapduch); }
			);
		
		.imgs = (A, "07trap.jpg");
		
		.load_duch("duch");
		
		.mmasks;
		
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
		ccs.enter( func {
			.txtplay("lektor11");
			} );
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	duch_wybuchl	{ .txtplay("lektor12"); }
	foto_shown	{ .txtplay("lilian2"); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Trap"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		
	}
	mouse_rclick	{
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}
}*/

class Hiddenp : Hidden	{
	init(string s)	{
		real rile = ( gameapi.getgamename == "HOTrap" ? 27 : 14 );
		match( Trudnosc )	{
			0 => 7;
			1 => 9;
			2 => 12;
			? => ;
		}
		real r = _;
		HiddenReduce = (rile-r)/rile;
		
		Hidden::init(s);
		
		.img = ("$scripts/common/skip_collection.pyz 800");
		anskip_collection	{
			.Button_isinalpha;
			.addmethod("butmoveon", func {
				if( igmstate==1 ) advmouse.setbut;
				} );
			.Button_moveoffms;
			.addmethod("butclick", "collect_all");
			but1.add(this);
		};
	}
	collect_all	{
		if( igmstate!=1 ) return;
		for( int i=0; i<grels.size; i++)	{
			<grels.get(i)>.butclick;
		}
	}
}

game HOTrap : Hiddenp	{
	init	{
		HiddenPath = ("07trap");
		Hiddenp::init("hotrap");
		
		new int trapduch = 1;
		
		new classplacepointer2 clp;
		
		.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii.",
				func { .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide; .foto_to_album(trapduch); },
			":lilian3", "What just happened? Did I see that or am I hallucinating? I feel like I have memories from this place, but I've never been here before!",
				func { .txtplay("lilian4"); },
			":lilian4", "Le jakie fragmety fotografi. Pozbieram je.",  func { grtxt.show;
				@s= grels.first;
				.txtplay("lektor1"); clp.showob( s, "rd" );
				angwiazdkif.ansetcpos( <s>.getcx, <s>.getcy );
				angwiazdkif.play(0);
				},
			":lilian5", "Rozejrz si po tym pomieszczneniu, moe odkryj jeszcze co ciekawego.",
				func { .mprzejdz("Trap"); },
			":lektor1", "Click on the fragment!", func { anskip_collection.show;
				clp.showob("anskip_collection", "lu"); .txtplay("lektor2"); },
			":lektor2", "You can also choose to skip the collection at any time!", func { clp.stoph; .stdret; }
			);
		
		.imgs = (A, "07trap.jpg", "wiatrak.pyzG 5");
		grwiatrak.nplay(-1);
		
		.mmasks;
		mus.playstr("kopula.ogg -l -v 50");
		.sfxs = (A, "aparat");
		
		grtxt.hide;
		anskip_collection.hide;
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 6, 9);
			anzd.hide;
			anzd.setz(10);
			
			ccs.enter( func {
				.timplay("tim1", 2000, func { anzd.play; });
			} );
		} else {
			ccs.enter( func {
				.timplay("tim1", 2000, func { .txtplay("lektor12"); });
			} );
		}
		
		
		
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		

	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		.txtplay("lilian3");
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	duch_wybuchl	{ .txtplay("lektor12"); }
	foto_shown	{ .txtplay("lilian2"); }
	foto_in_album	{ .timplay("timduchend", 1000, func { .txtplay("lilian5"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{
		
	}
	/*mouse_rclick	{
		if( igmdebug )	{
			grtxt.free;
			.hiddenobj_put;
		}
	}*/
}

game HOKajutamuzeum : Hiddenp	{
	init	{
		HiddenPath = ("10kajutamuzeum");
		Hiddenp::init("hokajutamuzeum");
		
		new int trapduch = 6;
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "To jedna z kajut. Niesamowite jak te wszystkie meble porosy glonami. Ciekawe czemu to lustro jest takie czyste?", func { tcr.ahide; anzd.play; },
			":lilian2", "Znowu te wspomnienia! Co niezwykle tajmniczego mnie spotyka.", func { .txtplay("lilian3"); },
			":lilian3", "Znowu fragmenty fotografi. Pozbieram je.", func { grtxt.show; .stdret; }
			);
		
		.imgs = (A, "kajutamuzeum.jpg");
		
		.mmasks;
		
		.sfxs = (A, "aparat");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 2, 9);
			anzd.hide;
			grtxt.hide; 
			ccs.enter( func { .txtplay("lilian1"); } );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		mus.playstr("kopula.ogg -l -v 40");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		.txtplay("lilian2");
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Kajutamuzeum"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}



game HOSchody : Hiddenp	{
	init	{
		HiddenPath = ("12schody");
		Hiddenp::init("hoschody");
		
		new int trapduch = 3;
		
		/*.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; .gogo_duch; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii.",
				func { .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide;  }
			);*/
		
		.imgs = (A, "12schody.jpg");
		
		.mmasks;
		
		.sfxs = (A, "aparat", "bgrsalaN");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			grtxt.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.hide;
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		grtxt.show;
		igmstate = 1;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Schody"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}

game HOKorytarz3odnogi : Hiddenp	{
	init	{
		HiddenPath = ("14korytarz3odnogi");
		Hiddenp::init("hokorytarz3odnogi");
		
		new int trapduch = 4;
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Teraz ju wiem, e to informacja od zagubionych dusz. Pozbieram wszystkie fragmenty fotografi. Pomoge im.", func { .stdret; grtxt.show; }
			);
		
		.imgs = (A, "14korytarz3odnogi.jpg");
		
		.mmasks;
		
		.sfxs = (A, "aparat", "bgrsalaN");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			grtxt.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.hide;
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		.txtplay("lilian1");
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Korytarz3odnogi"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}

game HOAmbulatorium2 : Hiddenp	{
	init	{
		HiddenPath = ("16ambulatorium");
		Hiddenp::init("hoambulatoriumb");
		
		new int trapduch = 5;
		
		.loadsnddb;
		.sounds = (A, ":lilian1","Zdjcia tych ludzi s bardzo podobne do siebie. Zupenie jakby fotograf sta w jednym miejscu statku. Niezapomniana pamitka z rejsu i jedyna pamitka po tych ludziach.", 
			func { tcr.ahide; .foto_to_album(trapduch); }
			);
		
		.imgs = (A, /*"16ambulatorium.jpg"*/ "bkg.pyz", "firany.pyzG 5", "polka.pyz 10");
		grfirany.nplay(-1);
		
		.sfxs = (A, "przeciagN", "aparat");
		
		.mmasks;
		
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.setz(20);
			anzd.hide;
			grtxt.hide;
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		grtxt.show;
		igmstate=1;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .txtplay("lilian1"); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Ambulatorium"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}

game HOKorytarzdolnypoklad : Hiddenp	{
	init	{
		HiddenPath = ("23korytarzdolnypoklad");
		Hiddenp::init("hokorytarzdolnypoklad");
		
		new int trapduch = 7;
		
		/*.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; .gogo_duch; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii.",
				func { .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide;  }
			);*/
		
		.imgs = (A, "bkg.pyz", "tla.pyzG 5");
		grtla.nplay(-1);
		mus.playstr("przeciag2.ogg -l");
		
		.mmasks;
		
		.sfxs = (A, "aparat");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.setz(20);
			anzd.hide;
			grtxt.hide;
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grtxt.show;
		grels.show;
		igmstate=1;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Korytarzdolnypoklad"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}

game HOSzczelina : Hiddenp	{
	init	{
		HiddenPath = ("43szczelina");
		Hiddenp::init("hoszczelina");
		
		new int trapduch = 2;
		
		/*.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; .gogo_duch; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii.",
				func { .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide;  }
			);*/
		
		.imgs = (A, "43szczelina.jpg");
		
		.mmasks;
		
		mus.playstr("mapa2.ogg -l -v 60");
		.sfxs = (A, "aparat");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			grtxt.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.hide;
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		grtxt.show;
		igmstate=1;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Szczelina"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}

game HOKorytarzmuzeum : Hiddenp	{
	init	{
		HiddenPath = ("09korytarzmuzeum");
		Hiddenp::init("hokorytarzmuzeum");
		
		new int trapduch = 8;
		
		/*.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; .gogo_duch; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii.",
				func { .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide;  }
			);*/
		
		.imgs = (A, "09korytarzmuzeum.jpg", "drzwi.pyz 5");
		
		.mmasks;
		
		.sfxs = (A, "aparat", "bgrsalaN");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			grtxt.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.hide;
			anzd.setz(20);
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		grtxt.show;
		igmstate=1;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Korytarzmuzeum"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}

game HOKorytarznamostek : Hiddenp	{
	init	{
		HiddenPath = ("21korytarznamostek");
		Hiddenp::init("hokorytarznamostek");
		
		new int trapduch = 9;
		
		/*.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; .gogo_duch; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii.",
				func { .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide;  }
			);*/
		
		//.imgs = (A, "niebo.pyzP", "bkg.pyz 5", "lampy.pyzG 10");
		.imgs = (A, "21korytarznamostek.jpg", "lampy.pyzG 10");
		grlampy.nplay(-1);
		
		.mmasks;
		
		.sfxs = (A, "aparat", "bgrsalaN");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			grtxt.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.hide;
			anzd.setz(20);
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		grtxt.show;
		igmstate=1;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
			//.mprzejdz("Trap");
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Korytarznamostek"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}

game HOKuchnia2 : Hiddenp	{
	init	{
		HiddenPath = ("29kuchnia");
		Hiddenp::init("hokuchniab");
		
		new int trapduch = 10;
		
		/*.loadsnddb;
		.sounds = (A, ":lektor11", "Eteryczna posta. Kliknij na niej aby rozwiza tajemnic jej wielowymiarowego pochodzenia.",
			func { tcr.ahide; igmstate = iduchstate; .gogo_duch; },
			":lektor12", "Zbierz z lokacji fragmenty fotografii.",
				func { .stdret; },
			":lilian2", "To jest zdjcie pasaera statku! Co si dzieje? Dlaczego widz takie rzeczy? Czyby czekay mnie wiksze tajemnice?", func { tcr.ahide;  }
			);*/
		
		.imgs = (A, "29kuchnia.jpg");
		
		.mmasks;
		
		.sfxs = (A, "aparat", "bgrsalaN");
		
		new int isduch = 1;
		if( isduch )	{
			grels.hide;
			grtxt.hide;
			
			new imganima anzd;
			anzd.load("fl", "jpg", 0, 3, 9);
			anzd.hide;
			
			ccs.enter( func {
				anzd.play;
				} );
		} else {
			ccs.enter( func {
				igmstate = 1;
				} );
		}
	
		//mus.playstr("waltzing_ghosts.ogg -l -v 60");
		
		if( igmdebug )	.mbutnext;
		
	}
	anzd_endframe	{	fxaparat.play;	}
	anzd_finish	{
		.hide;
		grels.show;
		grtxt.show;
		igmstate=1;
	}
	hiddenobj_put	{
		if( grtxt.empty )	{
			igmstate = 20;
			ccs.playfin( func { .foto_album; }, func { .foto_show(trapduch); } );
		}
	}
	foto_shown	{ .timplay("tim2", 2000, func { .foto_to_album(trapduch); } ); }
	foto_in_album	{ .timplay("timduchend", 2000, func { .mprzejdz("Kuchnia"); } ); }
	anbutnext_click	{
		grtxt.free;
		.hiddenobj_put;
	}
	tit_lclick	{}
}



new int SuwakiRow = 16;
game Drzwikotlownia : Kajuta	{
	init	{
		Kajuta::init("drzwikotlownia");
		
		int irow = SuwakiRow;
		
		.titsounds = (A, "lektor1", "U herb firmy White Star, przesuwajc jego fragmenty.|Jak chcesz przesun jeden z fragmentw, kliknij na niego.", "stdret"
			);
		
		.sfxs = (A, "nasadza 60", "blokmove 50", "wcisnij 70");
		
		.imgs = (A, "bkg.pyz", "zasuwy.pyz 10", "zamek.pyz 15", "drzwi.pyz 20", "maska.pyz 50");
		
		new int Rows;
		new int Cols;
		match(SuwakiRow)	{
			9 => { |Rows, Cols| = 3,3; }
			12 => { |Rows, Cols| = 3,4; }
			16 => { |Rows, Cols| = 4,4; }
			24 => { |Rows, Cols| = 4,6; }
			35 => { |Rows, Cols| = 5,7; }
			40 => { |Rows, Cols| = 5,8; }
			? => ;
		}
		
		.newgrimg("grels", "p"+irow, 25);
		
		new vector vx1;
		new vector vy1;
		grels.each( func { (@id)
			.var2("myid", id);
			vx1.add( .getpx );
			vy1.add( .getpy );
			} );
		vx1.add( <grels.last>.getex );
		vy1.add( <grels.last>.getpy );
		
		new vector vsuw;
		vsuw.vecnewint(grels.size);
		vsuw.add(-1);
		
		vsuw.set(11,-1);
		<grels.get(11)>.hide;
		
		vsuw.hash;
		.mrestore;
		
		//.mpanel;
		
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		
		.match3but;
		if( Trudnosc<2) anmatch3but.move(0, -10);
		
		ccs.enter( func {
			.txtplay("lektor1");
			} );
	}
	/************** wyjscia *****************/
	anbutnext_click	{
		.mend;
	}
	mend	{
		if( AdventureMode )	{
			clsave.bset("ukonczone_drzwikotlownia");
			.mprzejdz("DrzwikotlowniaB");
		} else {
			.mprzejdz("MainMenu");
		}
	}
	match3_won	{ .mend; }
	skip_minigame	{	.mend;	}
	/*******************************/
	mgo	{	igmstate = 1;	}
	int mget(int r, int c)	{
		if( r>=0 && r<Rows && c>=0 && c<Cols ) vsuw.get(r*Cols + c);
		else -2;
	}
	bool mcheck(string s, int id, int r, int c)	{
		if( .mget(r,c)==-1 )	{
			@id2 = r*Cols + c;
			vsuw.swap(id, id2);
			.mrestore;
			.mcheckwin;
			fxblokmove.play;
			true;
		} else false;
	}
	mcheckwin	{
		bool b = true;
		for( int i=0; i<grels.size; i++)	{
			if( <grels.get(i)>.myid != i )
				b = false;
		}
		if( b )	{
			.mend;
			igmstate = 2;
		}
	}
	mrestore	{
		for( int i=0; i<Rows; i++)	{
			for( int j=0; j<Cols; j++)	{
				@id = i*Cols + j;
				@id2 = vsuw.get(id);
				if( id2>=0 )	{
					@s = grels.get( id2 );
					<s>.msetpos(id);
				}
			}
		}
	}
	msetpos(int id)	{
		.ansetbpos( vx1.get(id), vy1.get(id) );
		.myid = (id);
	}
	tit_lclick	{
		if( igmstate==0)	.cactsndstop(true);
		if( igmstate==1 )	{
			if( grels.isin(mouse.getpos, 1,1) )	{
				@s = grels.getsfound;
				@id = <s>.myid;
				@row = id/Cols;
				@col = id%Cols;
				
				@mx = <s>.getcx;
				@my = <s>.getcy;
				@x = mouse.getpx;
				@y = mouse.getpy;
				if( x >= mx && y <= my )	{
					if( .mcheck(s, id, row-1, col) ) {
					} else if( .mcheck(s, id, row, col+1) ) {
					} else if( .mcheck(s, id, row+1, col) ) {
					} else if( .mcheck(s, id, row, col-1) ) {
					}
				} else if ( x >= mx && y >= my )	{
					if( .mcheck(s, id, row+1, col) ) {
					} else if( .mcheck(s, id, row, col+1) ) {
					} else if( .mcheck(s, id, row, col-1) ) {
					} else if( .mcheck(s, id, row-1, col) ) {
					}
				} else if ( x <= mx && y >= my )	{
					if( .mcheck(s, id, row+1, col) ) {
					} else if( .mcheck(s, id, row, col-1) ) {
					} else if( .mcheck(s, id, row, col+1) ) {
					} else if( .mcheck(s, id, row-1, col) ) {
					}
				} else if ( x <= mx && y <= my )	{
					if( .mcheck(s, id, row-1, col) ) {
					} else if( .mcheck(s, id, row, col-1) ) {
					} else if( .mcheck(s, id, row, col+1) ) {
					} else if( .mcheck(s, id, row+1, col) ) {
					}
				} else {
					if( .mcheck(s, id, row, col-1) ) {
					} else if( .mcheck(s, id, row-1, col) ) {
					} else if( .mcheck(s, id, row, col+1) ) {
					} else if( .mcheck(s, id, row+1, col) ) {
					}
				}
				if( <s>.actionnr(-1)==<s>.myid )
						fxwcisnij.play;
			}
		}
	}
	mouse_rclick	{
		//if( igmdebug ) grels.free;
	}
}


game DrzwikotlowniaB : Kajuta	{
	init	{
		Kajuta::init("drzwikotlowniab");
		.path = ("drzwikotlownia");
		
		.imgs = (A, "bkg.pyz", "zasuwy.pyz 10", "zamek.pyz 15", "drzwi.pyz 20", "maska.pyz 50",
			"klocek.pyzH 625", "klocekb.pyzH 625");
		.newgrimg("grels", "p16", 25);
		<grels.get(11)>.hide;
		
		.sfxs = (A, "putklocek", "putdiament");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Brakuje dwoch elementow", func {
			tcr.ahide;
			if( clsave.bis("item_klocek") )	{
				igmstate=1; 
			} else {
				.timplay("tim2", 1000, func { .mprzejdz("Kotlownia"); } );
			}
			});
		
		new DelayMover cmov;
		cmov.unlock;
		
		ccs.enter( func {
			if( clsave.bis("item_klocek") )	igmstate=1;
			else .timplay("tim1",1000, func { .txtplay("lilian1"); }); 
			} );
	}
	mend	{
		.mprzejdz("HOKotlownia");
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( anitemklocek.isin(mouse.getpos,1,1) )	{
			anklocek.ansetcpos(anitemklocek.getcx, anitemklocek.getcy);
			anklocek.show;
			.mssetobj("anklocek");
			anitemklocek.hide;
			igmstate=2;
		} else if( anitemklocekb.isin(mouse.getpos,1,1) )	{
			anklocekb.ansetcpos(anitemklocekb.getcx, anitemklocekb.getcy);
			anklocekb.show;
			.mssetobj("anklocekb");
			anitemklocekb.hide;
			igmstate=2;
		}
	}
	cmov_PUT	{
		@s = .getfree;
		
		if( <s>.aninlod(25) )	{
			clsave.set("item_" + s.strsubbs("an"), 0);
			<s>.setpos(0,0);
			<s>.setz(30);
			fxputdiament.play;
			if( clsave.is("item_klocek",0) && clsave.is("item_klocekb", 0) )	{
				fxputklocek.play;
				anzasuwy.hide;
				.timplay("tim3", 500, func {
					grels.hide;
					anklocek.hide;
					anklocekb.hide;
					andrzwi.setframe(1,0);
					.timplay("tim4", 1000, "mend");
					} );
			} else igmstate = 1;
		} else {
			<s>.hide;
			<s>.setpos(0,0);
			if( s.gete(0,1)=="b" )	anitemklocekb.show;
			else anitemklocek.show;
			igmstate=1;
		}
	}
	hint_click	{
		if( clsave.bis("item_klocek") )	{
			.playhints("anitemklocek", "anklocek");
		} else if ( clsave.bis("item_klocekb") )	{
			.playhints("anitemklocekb", "anklocekb");
		}
	}
}



game Zegar : Kajuta	{
	init	{
		Kajuta::init("zegar");
		
		.imgs = (A, "zegar.png", "els1.pyzG 10", "els2.pyzGH 15", "wskazowki.pyz 120", "szyba.pyz 125", "podpo.pyz 20",
			"$scripts/common/bable.pyzH 5");
		
		grels1.sortz(10);
		
		new classplacepointer2 clp;
		
		.loadsnddb;
		.sounds = (A, ":lilian1","Uszkodzny zegar. Wszystkie cyfry pospaday ze swoich miejsc. Uo je.",
				func { if( Trudnosc<2 )	{
					clp.showob( "anmatch3but", "uu" );
					.txtplay("lektor1");
					} else .stdret;
					},
			"lektor1", "If you want to skip this Mini Game, you can play Match 3 instead.", func { clp.stoph; .stdret; }
			);
		
		//.mpanel;
		
		.sfxs = (A, "cyfra", "wcisnij");
		
		new Rect rec2(anszyba.getpx,anszyba.getpy,anszyba.getw,anszyba.geth);
		
		new DelayMover cmov;
		cmov.unlock;
		
		grels2.eval( func {
			//.Button_isinvis;
			.addmethod("isbutin", func { (@x, @y)
				if( cmov.moving && .actionnr(-1) == <cmov.getmover>.actionnr(-1) )
					.mcheckpos(x,y);
				else 0;
				} );
			.addmethod("butmoveon", func {
				if( .isvisible==false && cmov.moving )	{
					advmouse.setbut;
					yesitsme=1;
				}
				} );
			.addmethod("butmoveoff", func {
				yesitsme=0;
				advmouse.setstd;
				} );
			.var2("yesitsme",0);
			but1.add(this);
			} );
		
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		.match3but;
		
		mus.playstr("mystery_war.ogg -l -v 50");
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( anszyba.framenr==0 )	{
			if( anszyba.isin(mouse.getpos,1,0) )	{
				anszyba.setframe(0,1);
				fxwcisnij.play;
			}
		} else {
			if( grels1.isin(mouse.getpos,1,0) )	{
				@s = grels1.getsfound;
				.mssetobj(s);
				<s>.setz(130);
				grels1.remove(s);
				fxwcisnij.play;
			}
		}
	}
	mcheckpos(int x, int y)	{	0->length(x-.getcx, y-.getcy) < 40;	}
	cmov_PUT	{
		@s = .getfree;
		//if( grels2.isin(mouse.getpos,0,0) )	{
		@s2 = grels2.get( grels2.findac( <s>.anactnr ) );
		if( <s2>.yesitsme )	{
			//if( <s>.actionnr(-1)==<s2>.actionnr(-1) )	{
				<s>.hide;
				<s2>.show;
				fxcyfra.play;
				anbable.setpos( <s2>.getcx, <s2>.getcy );
				anbable.play(0);
				grels2.remove(s2);
				if( grels2.empty )	{
					igmstate = 2;
					.mend;
				}
			//} else .melret(s);
		} else {
			.melret(s);
			fxwcisnij.play;
		}
	}
	melret(string s)	{
		grels1.add(s);
		grels1.sortz(10);
		rec2.fit(s);
	}
	hint_click	{
		if( anszyba.framenr==0 )	{
		
		} else if( grels1.size )	{
			@s = grels1.rand;
			@s2 = grels2.get( grels2.findac( <s>.anactnr ) );
			.playhints(s, s2);
		}
	}
	/************** wyjscia *****************/
	anbutnext_click	{
		.mend;
	}
	mend	{
		.mprzejdz("Skrytkaschody");
	}
	match3_won	{ .mend; }
	skip_minigame	{	.mend;	}
}

game BoxA : Kajuta	{
	init	{
		Kajuta::init("boxa");
		.path = ("box");
		
		.titsounds=(A, ":lilian1", "Nareszcie!! Udao si!! mam ostatni klucz. Zabior go i szybko przekae wszystkie klucze prababci.", func { .mprzejdz("Kajutamuzeum"); }
			);
		
		.imgs = (A, "bga.jpg", "boxa.pyz 5", "txta.pyzH 10", "keya.pyzH 20");
		
		.sfxs = (A, "skrzyniaopen2 70");
		mus.playstr("tytan_wnetrze.ogg -l -v 30");
		
		if( clsave.bis("e3_ulozylabox") )	{
			antxta.show;
			anboxa {
				.Button_stdalpha;
				.addmethod("butclick", func {
					if( igmstate!=1 ) return;
					but1.removebut(this);
					.setframe(1,0);
					fxskrzyniaopen2.play;
					antxta.hide;
					ankeya.show;
					} );
				but1.add(this);
			};
			ankeya {
				.Button_stdalpha;
				.addmethod("butclick", func {
					if( igmstate!=1 ) return;
					igmstate=0;
					<GAME>.klucz_show(6);
					.hide;
					} );
				but1.add(this);
			};
		} else {
			anboxa {
				.Button_stdalpha;
				.addmethod("butclick", func {
					if( igmstate!=1 ) return;
					igmstate=0;
					clsave.bset("e3_ulozylabox");
					.mprzejdz("BoxB");
					} );
				but1.add(this);
				.hoverhint(this);
			};
		}
		ccs.enter( func { igmstate=1; } );
	}
	klucz6_shown	{ .timplay("timkey", 2000, func { .klucz_to_kolo(6); });	}
	klucz6_in_kolo	{
		clsave.set("epizod", "e4_end");
		.txtplay("lilian1");
	}
}

game BoxB : Kajuta	{
	init	{
		Kajuta::init("boxa");
		.path = ("box");
		
		.titsounds = (A, ":lilian1", "Miedziane litery odpady z pudeka. Uoe je na swoich miejscach.", "stdret"
			);
		
		.imgs = (A, "bgb.jpg", "elsb.pyzG 10", "$scripts/common/bable.pyzH 3");
		
		.sfxs = (A, "litera");
		
		mus.playstr("tytan_wnetrze.ogg -l -v 30");
		
		grelsb.eval( func { .setframe(-1,1); } );
		.copyanima(grelsb.first, "anpoka");
		anpoka.hide;
		
		new DelayMover cmov;
		cmov.unlock;
		
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		.match3but;
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( grelsb.isin(mouse.getpos,1,1) )	{
			@s = grelsb.getsfound;
			@x = <s>.getpx;
			@y = <s>.getpy;
			<s>.setframe(-1,0);
			<s>.ansetbpos(x,y);
			.mssetobj(s);
			<s>.setz(130);
			grelsb.remove(s);
		}
	}
	cmov_PUT	{
		@s = .getfree;
		if( <s>.aninlod(50) )	{
			<s>.setpos(0,0);
			<s>.setz(5);
			anbable.setpos(<s>.getcx, <s>.getcy);
			anbable.play(0);
			fxlitera.play;
			if( grelsb.empty )
				.mend;
			else igmstate = 1;
		} else {
			<s>.setz(10);
			<s>.setframe(-1,1);
			<s>.setpos(0,0);
			grelsb.add(s);
		}
	}
	/************** wyjscia *****************/
	anbutnext_click	{
		.mend;
	}
	mend	{
		if( AdventureMode )
			.mprzejdz("BoxA");
		else .mprzejdz("MainMenu");
	}
	match3_won	{ .mend;	}
	skip_minigame	{	.mend;	}
	hint_click	{
		if( grelsb.size )	{
			@s = grelsb.rand;
			anpoka.setframe( <s>.actionnr(-1), 0 );
			anpoka.setpos(0,0);
			.playhints(s, "anpoka");
		}
	}
}



game Korytarzdolnypoklad : Kajuta	{
	init	{
		Kajuta::init("23korytarzdolnypoklad");
		.setsndbase("korytarzdolnypoklad");
		
		.imgs = (A, /*"23korytarzdolnypoklad.jpg",*/"bkg.pyz", "tla.pyzG 5");
		grtla.nplay(-1);
		
		//mus.playstr("titanic2.ogg -l -v 60");
		
		.loadsnddb;
		.sounds = (A, ":lilian9", "Plan oficera pokazywa e jedna ze skrytek jest w maszynowni", "stdret",
			":lilian12", "Mamy niewiele czasu a brakuje mi jeszcze dwch kluczy; Pom mi", func { .txtplay("prab12"); },
			":prab12", "W kuchni znajdziesz pity klucz; Szukaj dobrze by moe wiele tajemnic odnajdzie swj fina", "stdret",
			":lilian13", "W maszynowni zawsze jest ciemno i gono, moe tam prowadzi ten ciemny korytarz.", "stdret",
			":lilian14", "Sprbuj pj w prawo.", "stdret",
			":lilian5", "Musz szybko odnale kajut oficera.", "stdret"
			);
		
		.sfxs = (A, "przeciag2N");
		
		.mexits;
		
		new int iwprawohint = 0;
		if( clsave.is("epizod", "e2_1912") )	{
			if( clsave.bis("e2_hokuchnia") )	{
				.titblock(A, "29kuchnia", "24zejsciedomaszynowni");
				.extohint("12schody");
				ccs.enter( func { .txtplay("lilian5"); } );
			} else if( clsave.bis("otwarte_drzwikotlownia") )	{
				.blockexit("12schody");
				.extohint("29kuchnia");
				ccs.enter( func {
					if( !clsave.bis("e2_zostaly2klucze") )	{
						clsave.bset("e2_zostaly2klucze") ;
						.rosie_go;
						//.txtplay("lilian12");
					} else igmstate=1;
					} );
			} else if( clsave.bis("e2_wnioskitajemnica") )	{
				.blockexit("29kuchnia");
				if( clsave.bis("item_klocek") )	{
					.extohint("24zejsciedomaszynowni");
					.nohover("12schody");
				} else	{
					.extohint("12schody");
				}
				.mstdenter;
			} else {
				.titblock(A, "29kuchnia", "12schody");
				.extohint("24zejsciedomaszynowni");
				if( !clsave.bis("e2_kordolnypoklad_comment") )	{
					clsave.bset("e2_kordolnypoklad_comment");
					.txtplay("lilian9");
				} else .mstdenter;
			}
		}
		//.tohint(A, "grext");
	}
	rosie_help	{	.txtplay("lilian12");	}
	click_24zejsciedomaszynowni	{
		clsave.bset("e2_zeszladomaszynowni");
		.mprzejdz("Zejsciedomaszynowni");
	}
	hint_click	{
		if( !clsave.bis("e2_zeszladomaszynowni") )	{
			igmstate = 0;
			.txtplay("lilian13");
			.playexhint("24zejsciedomaszynowni");
		} else if( clsave.bis("e2_wnioskitajemnica") && !clsave.bis("e2_salabalowaenter") )	{
			igmstate = 0;
			.txtplay("lilian14");
			.playexhint("12schody");
		}
	}
	click_29kuchnia	{
		if( !clsave.bis("e2_hokuchnia2") )	{
			clsave.bset("e2_hokuchnia2");
			.mprzejdz("HOKuchnia2");
		} else
			.mprzejdz("Kuchnia");
	}
	click_12schody	{
		.mprzejdz("Schody");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Zejsciedomaszynowni : Kajuta	{
	init	{
		Kajuta::init("24zejsciedomaszynowni");
		.setsndbase("zejsciedomaszynowni");
		
		.loadsnddb;
		.sounds = (A, ":prab9", "Witaj Lilian! Dzielnie si spisaa; Masz ju skompletowany cay medalion; Moesz mnie teraz wezwa kiedy zechcesz", func { .txtplay("lilian10"); },
			":lilian10", "Poznaam mrocz tajemnic o ktrej mwia; Chodzi o morderstwo w trzeciej klasie",
				func { .txtplay("prab10"); },
			":prab10", "Tak; Nigdy nie odnaleziono sprawcy; Nieszczsna dziewczyna", func { .txtplay("lilian11"); },
			":lilian11", "Nie mogam otworzy skrytki w kotowni; Brakuje jednego elementu", func { .txtplay("prab11"); },
			":prab11", "Sprbuj moe w recepcji to dua sala gdzie gocie oczekiwali na zaatwienie wszelkich formalnoci; Ci sami ludzie ktrzy budowali skrytk w kotowni wykaczali take boilery w kotowni", func { tcr.ahide; igmstate=1; },
			":lilian12", "Zamknite drzwi, adnej klamki. Moe znajd co w tej stercie narzdzi", "stdret",
			":lilian13", "To koo powinno rozwiza problem zamknitych drzwi.", "stdret",
			":lilian14", "Tutaj nie mam ju nic do zrobienia.", "stdret",
			":lilian15", "It's closed!", "stdret",
			":lilian16","I need to return to the Engine Room to open the hatch!", "stdret"
			);
		
		.sfxs = (A, "iskry 70");
		.imgs = (A, "bg.pyz", "doors.pyz 5", "prund.pyzH 10", "rura.pyz 20");
		.timplay("timprund", 5000, func { anprund.play(0); fxiskry.play; .play; } );
		
		mus.playstr("maszynownia.ogg -l -v 40");
		.mexits;
		
		andoors.addmethod("onfinish", func {
			clsave.bset("e2_odkrecilmaszynownia");
			grext.mshow("do_25kotlypalacz");
			igmstate=1;
			} );
		if( clsave.bis("e2_hozejsciedomaszynowni") )	{
			.diblockexit("24ho_zejscie");
			.hodone("24ho_zejscie");
		} else .extohint("24ho_zejscie");
		
		if( !clsave.bis("e2_odkrecilmaszynownia") )	{
			//.diblockexit("25kotlypalacz");
			if( clsave.bis("item_kolo") )	{
				new DelayMover cmov;
				cmov.unlock;
				.sfx = ("metaldoors");
				//.antohint("anitemkolo");
			}
		} else andoors.setframe(2,0);
		
		ccs.enter( func {
			if( clsave.is("epizod", "e2_1912") )	{
				if( clsave.bis("ma_medalion2") && !clsave.bis("e2_wnioskitajemnica") )	{
					clsave.bset("e2_wnioskitajemnica");
					//.txtplay("prab9");
					.rosie_go;
					.nohover("25kotlypalacz");
				} else if ( clsave.bgo("e2_zejsciestertaklamka") )	{
					.txtplay("lilian12");
				} else if ( clsave.last == "HOZejscie" )	{
					.txtplay("lilian13");
				} else {
					if( clsave.bis("item_klocek") )
						.nohover("23korytarzdolnypoklad");
					igmstate=1;
				}
			}
			} );
	}
	rosie_help	{	.txtplay("prab9");	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( anitemkolo.isin(mouse.getpos,1,1) )	{
			.mssetobj("anitemkolo");
			igmstate=2;
		}
	}
	cmov_PUT	{
		.retobj;
		if( andoors.isin(mouse.getpos,1,1) )	{
			anitemkolo.hide;
			clsave.set("item_kolo",0);
			andoors.play(1);
			fxmetaldoors.play;
		} else igmstate=1;
	}
	click_24ho_zejscie	{
		clsave.bset("e2_hozejsciedomaszynowni");
		.mprzejdz("HOZejscie");
	}
	click_25kotlypalacz	{
		if( !clsave.bis("e2_odkrecilmaszynownia") )	{
			igmstate=0;
			.txtplay("lilian15");
		} else .mprzejdz("Kotlypalacz");
	}
	click_23korytarzdolnypoklad	{
		.mprzejdz("Korytarzdolnypoklad");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
	hint_click	{
		if( !clsave.bis("e2_odkrecilmaszynownia") && clsave.bis("item_kolo") )	{
			//.playexhint("25kotlypalacz");
			.playhints("anitemkolo", grext.getsac("do_25kotlypalacz"));
		} else if( clsave.bis("e2_hozejsciedomaszynowni") && clsave.bis("e2_odkrecilmaszynownia") )	{
			if( clsave.bis("item_klocek") || !clsave.bis("ukonczone_drzwikotlownia") )	{
				.playexhint("25kotlypalacz");
				if( clsave.bis("item_klocek") )	{
					igmstate = 0;
					.txtplay("lilian16");
				}
			} else {
				.playexhint("23korytarzdolnypoklad");
				igmstate = 0;
				.txtplay("lilian14");
			}
		}
	}
}

game Kotlypalacz : Kajuta	{
	init	{
		Kajuta::init("25kotlypalacz");
		.setsndbase("kotlypalacz");
		
		.loadsnddb;
		.sounds = (A, ":palacz1","Co jest! Do stu tysicy diabw morskich! Karty same si uoyy!! Duchy, czy moe za duo rumu? Wezm si lepiej za robot", func { tcr.ahide; 
			clsave.bset("e2_do100tys");
			.timplay("timp1",2000, func { .txtplay("palacz2"); }); 
			},
			":palacz2","Duchu moe masz ochot zagra w kko i krzyyk? No chod nie daj si prosi",
				func {
					clsave.bset("e2_wygralakolkokrzyz");
					tcr.ahide;
					.timplay("timp2", 1000, func { .mprzejdz("Kolkokrzyz"); }); 
				},
			":palacz3","Duchu! Nie wiem gdzie jeste bo ci nie widz ale za to e wygrae masz tak ma byskotk ktr znalazem na stercie wgla", func { <GAME> {
				tcr.ahide;
				new itemadder clb2;
				.imgs = (A, "$scripts/items/brylant2get.pyz 750");
				new anima angwiazdkif2;
				angwiazdkif2.load("scripts/common/gwiazdkif.pyz");
				angwiazdkif2.hide;
				
				clb2.showitem("anbrylant2get", func { .timplay("timbryl1",1000, func {
				.medalion_open;
				clb2.gotodestan("anbrylant2get", "anmedalion2", 15, func {
					anbrylant2get.hide;
					clsave.bset("ma_medalion2");
					.medalion_open;
					angwiazdkif2.setpos( anmedalion2.getcx, anmedalion2.getcy );
					angwiazdkif2.setz( anmedalion2.getz+1);
					angwiazdkif2.play(0);
					.timplay("timbryl2", 1000, func { .txtplay("lilian2"); } );
					} );
				} );
				} );
				}; },
			":lilian1", "W kotach napalone i chwila przerwy na may pasjans?|Przyacze si do gry. Ciekawe jak bdzie mia min palacz... Jestem w kocu niewidzialna.", "stdret",
			":lilian2", "Mam ju drugi fragment medalionu prababci! Niesamowite, e udao mi si skompletowac cao. Pjd dalej w gb kotowni, moe znajd tam co ciekawego.", "stdret"
			);
		
		.imgs = (A, "25kotlypalacz.jpg", "palacz.pyz 3", "deska.pyz 1", "memo.pyz 2");
		
		mus.playstr("maszynownia.ogg -l -v 50");
		.mexits;
		
		if( clsave.is("epizod", "e2_1912") )	{
			if( !clsave.bis("e2_wygralamemo") )	{
				.titblock(A, "26kotlownia", "24zejsciedomaszynowni");
				anmemo {
					.Button_std;
					.addmethod("butclick", func {
						if( igmstate!=1 ) return;
						clsave.bset("e2_wygralamemo");
						.mprzejdz("Memo");
						} );
					but1.add(this);
				};
				.antohint("anmemo");
				.hoverhint("anmemo");
			} else {
				anpalacz.setframe(1,0);
				if( !clsave.bis("ukonczone_drzwikotlownia") )	{
					.blockexit("24zejsciedomaszynowni");
					.extohint("26kotlownia");
				} else if( clsave.bis("item_klocek") )	{
					.extohint("26kotlownia");
					.nohover("24zejsciedomaszynowni");
				} else .extohint("24zejsciedomaszynowni");
			}
		}
		
		ccs.enter( func {
			if( clsave.is("epizod", "e2_1912") )	{
				if( clsave.bis("e2_wygralamemo") )	{
					if( !clsave.bis("e2_do100tys") )	{
						.txtplay("palacz1");
					} else if (!clsave.bis("e2_wygralakolkokrzyz") )	{
						.txtplay("palacz2");
					} else if (!clsave.bis("ma_medalion2") )	{
						.txtplay("palacz3");
					} else igmstate=1;
				} else if ( clsave.bgo("e2_enterpalaczkotlownia") )	{
					.txtplay("lilian1");
				} else igmstate=1;
			}
			} );
	}
	click_26kotlownia	{
		.mprzejdz("Kotlownia");
	}
	click_24zejsciedomaszynowni	{
		.mprzejdz("Zejsciedomaszynowni");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}


game Kotlownia : Kajuta	{
	init	{
		Kajuta::init("26kotlownia");
		.setsndbase("kotlownia");
		
		.imgs = (A, "26kotlownia.jpg", "drzwi.pyz 10");
		
		.titsounds = (A, ":lilian1", "Jakie te koty ogromne. Pi kotw w jednym rzdzie. eby Titanic mg pyn potrzebna bya ogromna ilo pary.", "stdret",
			":lilian2", "O.. jaki dziwny waz na jednym z kotw. Sprawdz to.", "stdret",
			":lilian3", "Musz znale brakujce elementy w innych pomieszczeniach.", "stdret",
			":lilian4", "Wracam na grne pokady, tu ju nie mam nic do zrobienia.", "stdret"
			);
		
		mus.playstr("maszynownia.ogg -l");
		.mexits;
		
		if( clsave.bis("otwarte_drzwikotlownia") )	{
			.diblockexit("27ho_kotlownia");
			.hodone("27ho_kotlownia");
			andrzwi.setframe("open",0);
			.extohint("25kotlypalacz");
		} else if( clsave.bis("item_klocek") || !clsave.bis("ukonczone_drzwikotlownia") ) .extohint("27ho_kotlownia");
		else .extohint("25kotlypalacz");
		
		ccs.enter( func {
			if( clsave.bgo("e2_kotlowniaenter") )	.txtplay("lilian1");
			else if ( clsave.bis("ukonczone_drzwikotlownia") && clsave.bgo("e2_ukonczonedrzwikotkoment") )
				.txtplay("lilian3");
			else if ( clsave.last == "HOKotlownia" )
				.txtplay("lilian4");
			else igmstate=1;
			} );
	}
	hint_click	{
		if( !clsave.bis("ukonczone_drzwikotlownia") )	{
			igmstate=0;
			.txtplay("lilian2");
		}
	}
	click_27ho_kotlownia	{
		if( clsave.bis("ukonczone_drzwikotlownia") )
			.mprzejdz("DrzwikotlowniaB");
		else .mprzejdz("Drzwikotlownia");
	}
	click_25kotlypalacz	{
		.mprzejdz("Kotlypalacz");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Kuchnia : Kajuta	{
	init	{
		Kajuta::init("29kuchnia");
		.setsndbase("kuchnia");
		
		.titsounds=(A, ":lilian1", "Przeszukam to pomieszczenie. Prababcia mwia, e znajd tutaj klucz.", "stdret"
			);
		
		.imgs = (A, "29kuchnia.jpg");
		
		//mus.playstr("titanic2.ogg -l -v 60");
		.sfxs = (A, "bgrsala2N");
		.mexits;
		
		if( clsave.bis("e2_hokuchnia") )	{
			.diblockexit("30ho_kuchnia");
			.hodone("30ho_kuchnia");
			.extohint("23korytarzdolnypoklad");
		} else {
			.extohint("30ho_kuchnia");
			.nohover("23korytarzdolnypoklad");
		}
		
		ccs.enter( func {
			if( clsave.bgo("e2_kuchniaenter") )	{
				igmstate=0;
				.txtplay("lilian1");
			} else igmstate=1;
			} );
	}
	click_30ho_kuchnia	{
		clsave.bset("e2_hokuchnia");
		.mprzejdz("HOKuchnia");
	}
	click_23korytarzdolnypoklad	{
		.mprzejdz("Korytarzdolnypoklad");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Salabalowarecepcja : Kajuta	{
	init	{
		Kajuta::init("36salabalowarecepcja");
		.setsndbase("salabalowarecepcja");
		
		.imgs = (A, "36salabalowarecepcja.jpg", "lustro.pyz 5", "szafa.pyz 5"/*, "maska.pyz 3", "morze.pyzP 1"*/);
		
		.titsounds = (A, ":lilian1", "Jakie piekne miejsce i tylu wytwornych pasaerw. Rozejrz si u poszukam miejsca gdzie mog by brakujce fragmenty herbu.", "stdret",
			":lilian2", "W rogu stoi szafa, moe tam co znajd.", "stdret",
			":lilian3", "Poszukam sali ze zdjecia.", "stdret"
			);
		
		//mus.playstr("gwarludzi.ogg -l -v 60");
		.sfx=("gwarludziN 60");
		.mexits;
		
		if( clsave.is("epizod", "e2_1912") )	{
			.img = ("ludzie.pyzG 10");
		}
		if( clsave.bis("e2_recepcjalustro") )	{
			anlustro.setframe(1,0);
			.diblockexit("40ho_skrytkalustro");
			.hodone("40ho_skrytkalustro");
			.extohint("12schody");
		} else if( clsave.bis("item_krysztal14") && clsave.bis("item_krysztal15") ) .antohint("anlustro");
		else .extohint("12schody");
		if( clsave.bis("e2_recepcjaszafa") )	{
			anszafa.setframe(1,0);
			.diblockexit("37ho_salabalowa");
			.hodone("37ho_salabalowa");
		} else .antohint("anszafa");
		
		ccs.enter( func {
			if( clsave.bgo("e2_salabalowaenter") )	{
				.txtplay("lilian1");
			} else if ( clsave.last == "Zdjecie" )	{
				.txtplay("lilian3");
			} else igmstate=1;
			} );
	}
	click_37ho_salabalowa	{
		//.mprzejdz("HOSalabalowa");
		clsave.bset("e2_recepcjaszafa");
		.mprzejdz("Szafa");
	}
	click_40ho_skrytkalustro	{
		//.mprzejdz("HOSkrytkalustro");
		.mprzejdz("KrysztalyA");
	}
	click_12schody	{
		if( clsave.bis("e2_recepcjalustro") && !clsave.bis("e2_hoschody") )	{
			clsave.bset("e2_hoschody");
			.mprzejdz("HOSchody");
		} else
			.mprzejdz("Schody");
	}
	hint_click	{
		if( !clsave.bis("e2_recepcjaszafa") )	{
			igmstate=0;
			.txtplay("lilian2");
			.playhint("anszafa");
		}
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Salaturecka : Kajuta	{
	init	{
		Kajuta::init("38salaturecka");
		.setsndbase("salaturecka");
		
		.imgs = (A, "38salaturecka.jpg");
		
		.titsounds = (A, ":lilian1", "To chyba aznia turecka. Budowniczowie Titanica zadbali o wszelkie wygody dla pasaerw.",
			"stdret",
			":lilian2", "Te szufladki na cianie mog kry jak zagadk.", "stdret",
			":lilian3", "Wrc do sali z szaf. Moe tam dowiem si co mog zrobi z krysztaami." , "stdret"
			);
		
		//mus.playstr("titanic2.ogg -l -v 60");
		.mexits;
		.sfxs = (A, "bgrsala2N");
		if( clsave.bis("e2_hosalaturecka") )	{
			.diblockexit("39ho_salaturecka");
			.hodone("39ho_salaturecka");
			.extohint("12schody");
		}
		
		ccs.enter( func {
			if( clsave.last == "HOSalaturecka" )	{
				.txtplay("lilian3");
			} else if( clsave.bgo("e2_salatureckaenter") )
				.txtplay("lilian1");
			else igmstate=1;
			} );
	}
	hint_click	{
		if( !clsave.bis("e2_hosalaturecka") )	{
			igmstate=0;
			.txtplay("lilian2");
			.playexhint("39ho_salaturecka");
		}
	}
	click_39ho_salaturecka	{
		clsave.bset("e2_hosalaturecka");
		.mprzejdz("Szuflady");
	}
	click_12schody	{
		.mprzejdz("Schody");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}


game MainMenu : StdGame	{
	init	{
		AdventureMode = 0;
		
		StdGame::init("menu");
		
		.sfxs = (A, "click 80");
		
		clsmen.saveonset = (true);
		if( clsmen.has("currentprofile") )	{
			iProfilId = clsmen.get("currentprofile");
			Trudnosc = clsmen.get("difficulty_"+iProfilId);
		} else {
			iProfilId = 0;
			Trudnosc = 1;
			clsmen.set("currentprofile",iProfilId);
			.setstdprofile;
		}
		
		if( igmipad )	{
			.imgs = (A, "bg.jpg", "panelpod.pyzG 9", "menunakipad.pyz 15", "stdbutsipad.pyzG 10",
				"$scripts/introg2/fala.pyzP 5", "$scripts/introg2/dym.pyzG 6");
			anmenunakipad.addtogamevars("anmenunak");
			grstdbutsipad.addtogamevars("grstdbuts");
			/*.imgs = (A, "bg.jpg", "panelpod.pyzG 9", "menunak.pyz 15", "stdbuts.pyzG 10",
				"$scripts/introg2/fala.pyzP 5", "$scripts/introg2/dym.pyzG 6");
			<grstdbuts.getsac("_quit")>.hide;*/
		} else {
			.imgs = (A, "bg.jpg", "panelpod.pyzG 9", "menunak.pyz 15", "stdbuts.pyzG 10",
				"$scripts/introg2/fala.pyzP 5", "$scripts/introg2/dym.pyzG 6");
		}
		
		if( LANG=="pol" )	{
			.img = ("linkwww.pyzH");
			anlinkwww {
				.Button_isinvis;
				.addmethod("butmoveon", func {
					if( sgmstate!="game" ) return;
					advmouse.setact;
					} );
				.addmethod("butmoveoff", func {
					if( sgmstate!="game" ) return;
					advmouse.setstd;
					} );
				.addmethod("butclick", func {
					if( sgmstate!="game" ) return;
					engine.linkwww("http://playway.com/");
					} );
				but1.add(this);
			};
		}
		
		.lang_db("dbtxt", "teksty_");
		
		grdym.nplay(-1);
		.imgsgr = (A, "savebut.pyzH 50", "okienko.pyzH 20", "ok.pyzH 35", "exit.pyzGH 40",
			"credits.pyzH 25",
			"extras.pyzH 25", "explansze.pyzGH 25", "exmin.pyzGH 30",  "exsnd.pyzGH 30", "exlearn.pyzGH 30",
			"options.pyzH 25", "optplansze.pyzGH 25", "optsound.pyzGH 25", "opsuwmuz.pyzH 30", "opsuwfx.pyzH 30",
			"optmode.pyzHG 30", "optmodes.pyzH 25",
			"optfullscreen.pyzH 30", "optfson.pyzH 25",
			/*"profiles.pyzH 25", "prlist.pyzGH 25", "prnapisy.pyzH 25",*/
			"prwindow.pyzH 20", "profiles.pyzH 25", "prwnd.pyzH 25", "prdel.pyzHG 30",
			"welcome.pyz 15",
			"grmen"
			);
		
		if( dbconf.dbget("logo_ng:")->to_i )
			.img = ("logong.pyz 10");
		
		grmen.remove("anwelcome");
		new string sactmenu = null;
		//init(string sfont, int isize, string sdbfile, int r, int g, int b, 
			//int x, int y, int dy, int z, string sdir)	{
		new int icredx1 = anokienko.getpx+70;
		new int icredy1 = ancredits.getey+10;
		new int icredy2 = anokienko.getey-20;
		
		@isize = 16;
		.newfont("fntcred_italic", "configs/fonts/FreeSerifItalic.ttf", isize);
		.newfont("fntcred_bold_italic", "configs/fonts/FreeSerifBoldItalic.ttf", isize);
		new TextDb tdcred("fntcred_italic$fntcred_bold_italic", isize, "$lang:credits_", .grey(20),
			icredx1, icredy1, 5,25, "left");
		tdcred.clip( 0, icredy1, iResX, icredy2 );
		tdcred.hide;
		.cycle = ("timcred", func {
			tdcred.move(0, -1);
			if( tdcred.getey < icredy1 - 50 )	.mcredgo;
			.play;
			} );
		
		anextras.butmen;
		new int idextras = 1;
		new int idexsnd = 0;
		grexsnd.eval( func {
			@s = .actionname;
			if( s.contains("play") )	{
				.Button_stdmsisin;
				.addmethod("butclick", func {
					if( sgmstate!="submenu" ) return;
					idexsnd = .actionname->gete(0,1);
					.putexsnd;
					} );
				but1.add(this);
			}
			} );
		grexplansze.eval( func {
			.Button_stdmsisin;
			.addmethod("butclick", func {
				if( sgmstate!="submenu" ) return;
				idextras = .actionnr(-1);
				<GAME>.putextras;
				} );
			but1.add(this);
			} );
		grexmin.eval( func {
			.Button_stdmsisin;
			.addmethod("butclick", func {
				if( sgmstate!="submenu" ) return;
				AdventureMode = 0;
				match(.actionname)	{
					"1_memo" => "Memo"; 
					"2_pietnacha" => "Drzwikotlownia";
					"3_lustro" => "Krysztaly";
					"4_sejf" => "Roznice";
					"5_panel" => "Puzzle";
					"6_box" => "BoxB";
					? => ;
				}
				.mprzejdz;
				} );
			but1.add(this);
			} );
		grexlearn.eval( func {
			.Button_stdmsisin;
			.addmethod("butclick", func {
				if( sgmstate!="submenu" ) return;
				AdventureMode = 0;
				match(.actionname)	{
					"budowa" => "InfoTrapR"; 
					"przekroj" => "InfoTrapL";
					"lost" => "InfoKasyL";
					? => ;
				}
				.mprzejdz;
				} );
			but1.add(this);
			} );
		
		ancredits.butmen;
		
		/*grprlist.eval( func {
			.addmethod("isbutin", func { (@x, @y)
				anprofiles.isvisible && .isin(x,y,0,0);
				} );
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				<grprlist.get(iProfilId-1)>.hide;
				iProfilId = .actionnr(-1) + 1;
				clsmen.set("currentprofile",iProfilId);
				.show;
				} );
			but1.add(this);
			} );*/
		//anprofiles.butmen;
		anprofiles.move(0,-25);
		new int iileprofili = 5;
		new int itmprofil = iProfilId;
		new gmimgvec grprof;
		// okno, hak, ramka, ok, rename, delete
		.newfont("fntprit", sgmfontitalic, 14);
		
		.newtext( "txtenter", dbtxt.dbget("entername"), "fntprit", .menucol );
		txtenter.hide;
		txtenter.setz(35);
		.newtext( "txtexists", dbtxt.dbget("exists"), "fntprit", .menucol );
		txtexists.hide;
		txtexists.setz(35);
		
		.newfont("fntprnom", sgmfontfile, 20);
		
		.newtext( "txtwelcome", "", "fntprnom", .menucol );
		txtwelcome.setz(18);
		.mwelcome;
		
		@ilimit = 12;
		new ConTextTyper ttp("fntprnom", 20, .menucol, "at0 ", ilimit);
		ttp.Sdir = ("left");
		ttp.onenter(GAME, "mendtype" );
		ttp.disable;
		ttp.setz(35);
		ttp.hide;
		new string stypemode;
		
		for( int i=1; i<=iileprofili; i++)	{
			@sgr = "grt"+i;
			new gmimgvec <sgr>;
			
			@s = .mwnd(i);
			.copyanima("anprwnd", s);
			
			@s2 = s + "txt1";
			.newtext( s2, dbtxt.dbget("newprofile"), "fntprit", .menucol );
			<s2>.setz( <s>.getz + 1 );
			@s3 = s + "txt2";
			.newtext( s3, "", "fntprnom", .black );
			<s3>.setz( <s>.getz + 1 );
			if( .hasprofile(i) )	{
				<s3>.txtset( clsmen.get("profilename_"+i) );
			}
			<s2>.hide; <s3>.hide;
			<s2>.mcenterpos(s);
			<s3>.mcenterpos(s);
			<sgr>.add(s2); <sgr>.add(s3);
			
			<s> (i) { (int id)
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate!="submenu" ) return;
					itmprofil=myid;
					.msetactprofile;
					@s = .mwnd(myid);
					if( !.hasprofile(myid) )	{
						<s+"txt1">.hide;
						txtenter.mcenterpos(s);
						txtenter.show;
						
						stypemode = "newprofile";
						.mstarttype;
					} else {
						//ttp.updatetxt("profilename_"+myid);
					}
					} );
				but1.add(this);
				.addmethod("mshowtxt", func {
					if( .hasprofile(myid) ) {
						<this+"txt2">.show;
						<this+"txt1">.hide;
					} else {
						<this+"txt2">.hide;
						<this+"txt1">.show;
					}
					} );
				.buildprofile(id);
			};
			
			/*s = .mwnd(i)+"hak";
			.copyanima("anprwnd", s);
			<s>.setframe("hak", 0);
			<s>.buildprofile(i);
			<s>.hide;
			
			s = .mwnd(i)+"ramka";
			.copyanima("anprwnd", s);
			<s>.setframe("ramka", 0);
			<s>.buildprofile(i);
			<s>.hide;*/
			
			s = .mwnd(i)+"ok";
			.copyanima("anprwnd", s);
			<s>.setframe("ok", 0);
			<s>.buildprofile(i);
			<s> {
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate!="submenu" || .framenr==0 ) return;
					iProfilId = itmprofil;
					clsmen.set("currentprofile", itmprofil);
					Trudnosc = clsmen.get("difficulty_"+iProfilId);
					.setgamevolume;
					.wczytajglosnosc;
					sgmstate="game";
					<GAME>.hideactmen;
					.mwelcome;
					.mcheckplay;
					} );
				but1.add(this);
			};
			
			s = .mwnd(i)+"rename";
			.copyanima("anprwnd", s);
			<s>.setframe("rename", 0);
			<s>.buildprofile(i);
			<s> {
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate!="submenu" || .framenr==0 ) return;
					ttp.txtset( clsmen.get("profilename_"+itmprofil)  );
					.mcheckname;
					<.mactwnd+"txt2">.hide;
					
					stypemode="renameprofile";
					.mstarttype;
					} );
				but1.add(this);
			};
			
			s = .mwnd(i)+"delete";
			.copyanima("anprwnd", s);
			<s>.setframe("delete", 0);
			<s>.buildprofile(i);
			<s> {
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate!="submenu" || .framenr==0 ) return;
					sgmstate = "delprofil";
					grprdel.show;
					} );
				but1.add(this);
			};
			
			<grprdel.get(1)> {
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate!="delprofil") return;
					clsmen.remove("profilename_"+itmprofil);
					clsmen.remove("difficulty_"+itmprofil);
					clsmen.remove("sfx_volume"+itmprofil);
					clsmen.remove("music_volume"+itmprofil);
					clsmen.set("profil_"+itmprofil+"_started",0);
					itmprofil = .mfirstprofile;
					<GAME>.putprofiles;
					} );
				but1.add(this);
			};
			<grprdel.get(2)> {
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate!="delprofil") return;
					<GAME>.putprofiles;
					} );
				but1.add(this);
			};
			
			s = .mwnd(i)+"ok2";
			.copyanima("anprwnd", s);
			<s>.setframe("ok2",0);
			<s>.buildprofile(i);
			<s>.msetok2;
			<s> {
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate=="typeprofile" && .framenr==1 ) {
						<GAME>.mendtype;
					} else if (sgmstate=="profileexist")	{
						sgmstate="submenu";
						.putprofiles;
					}
					} );
				but1.add(this);
			};
			
			s = .mwnd(i)+"cancel";
			.copyanima("anprwnd", s);
			<s>.setframe("cancel", 0);
			<s>.buildprofile(i);
			<s> {
				.Button_stdms;
				.addmethod("butclick", func {
					if( sgmstate=="typeprofile" ) {
						if( !.hasprofile(myid) )	{
							//itmprofil=.mfirstprofile;
							itmprofil=0;
						}
						<GAME>.putprofiles;
					} else if (sgmstate=="profileexist")	{
						sgmstate="submenu";
						.putprofiles;
					}
					} );
				but1.add(this);
			};
			
			<sgr>.move( -40, (i-1)*(2.3*<s>.geth) );
		}
		
		anoptions.butmen;
		new int idoptplansze = 0;
		groptplansze.eval( func {
			.Button_stdmsisin;
			.addmethod("butclick", func {
				idoptplansze = .actionnr(-1);
				<GAME>.putoptions;
				} );
			but1.add(this);
			} );
		groptmode.eval( func {
			.addmethod("isbutin", func { (@x, @y)
				anoptions.isvisible && idoptplansze==0 && .isin(x,y,0,0);
				} );
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				<groptmode.get(Trudnosc)>.hide;
				Trudnosc = .actionnr(-1);
				clsmen.set("difficulty_"+iProfilId,Trudnosc);
				.show;
				} );
			but1.add(this);
			} );
		anopsuwmuz.createsuwak(2);
		anopsuwfx.createsuwak(3);
		anoptfson {
			.addmethod("isbutin", func { (@x, @y)
				anoptions.isvisible && idoptplansze==2 && .isin(x,y,0,0);
				} );
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				bFullScreen = !bFullScreen;
				if( bFullScreen ) .show;
				else .hide;
// 				|int x, int y| = mouse.getpos;
				engine.setfullscreen(bFullScreen);
				//mouse.setpos(x,y);
				mouse.setpos( .getcx, .getcy );
				clsmen.set("fullscreen", bFullScreen);
				} );
			but1.add(this);
		};
		
		ccs.enter( func {
			mus.playstr("wizards.ogg -l -v 60");
			sgmstate = "game";
			} );
		
		<grexit.get(1)> {
			.Button_stdms;
			.addmethod("butclick", func {
				sgmstate = "exit";
				.mprzejdz("exit");
				} );
			but1.add(this);
		};
		<grexit.get(2)> {
			.Button_stdms;
			.addmethod("butclick", func {
				sgmstate = "game";
				grexit.hide;
				but1.onmousemove;
				} );
			but1.add(this);
		};
		
		new int isubstate = 10;
		
		//engine.printtypes;
		
		grstdbuts.eval( func {
			.Button_isin;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( sgmstate!="game" ) return;
				match( .actionname )	{
					"_profiles" => {<GAME>.putprofiles; }
					"_quit" => {
						grexit.show;
						sgmstate="askexit";
					}
					"_extras" => { 
						<GAME>.putextras; 
						}
					"_options" => { <GAME>.putoptions; }
					"_play" => {
						AdventureMode = 1;
						.mprzejdz("IntroG1");
					}
					"_continue" => {
						if( .framenr==1 )	{
							if( iProfilId==0 )	{
								<GAME>.putprofiles;
							} else {
								AdventureMode = 1;
								clsmen.set("profil_"+iProfilId+"_started",1);
								.mprzejdz("IntroG1");
							}
						} else {
							AdventureMode = 2;
							.loadsaver;
							clsave.stdload;
							if( clsave.bis("currentgame") )
								.mprzejdz( clsave.get("currentgame") );
							else 
								.mprzejdz( "IntroG1" );
						}
					}
					"_credits" => { <GAME>.putcredits; }
					? => ;
				}
				} );
			but1.add(this);
			} );
		
		anok {
			.Button_stdms;
			.addmethod("butclick", func {
				if( sgmstate!="submenu" ) return;
				<GAME>.hideactmen;
				but1.onmousemove;
				sgmstate="game";
				//<GAME>.<this + "_exit">;
				} );
			but1.add(this);
		};
		
		.mcheckplay;
	}
	wczytajglosnosc	{
		@vol = .loadsndvolume;
		anopsuwfx.suwakpos(vol.to_r/100.0);
		engine.setsndvol(vol);
		vol = .loadmusicvolume;
		anopsuwmuz.suwakpos(vol.to_r/100.0);
		gameapi.setmusicvol(vol);
	}
	setstdprofile	{
		clsmen.set("difficulty_"+iProfilId,1);
		clsmen.set("music_volume"+iProfilId, .stdmusicvol);
		clsmen.set("sfx_volume"+iProfilId, .stdsndvol);
	}
	mcheckplay	{
		@s = grstdbuts.getsac("_continue");
		if( iProfilId==0 || !clsmen.is("profil_"+iProfilId+"_started",1) )
			<s>.setframe(-1,1);
		else <s>.setframe(-1,0);
	}
	mwelcome	{
		if( iProfilId>0 )	{
			txtwelcome.txtset( dbtxt.dbget("welcome") + " " + clsmen.get("profilename_"+iProfilId) );
			txtwelcome.show;
			anwelcome.show;
		} else {
			//txtwelcome.txtset( dbtxt.dbget("welcome") );
			txtwelcome.hide;
			anwelcome.hide;
		}
		txtwelcome.mcenterpos("anwelcome");
	}
	mfirstprofile	{
		for( int i=1; i<=iileprofili; i++ )	{
			if( .hasprofile(i) )
				return i;
		}
		0;
	}
	mendtype	{
		keyboard.hide;
	
		txtenter.hide;
		@s = .mactwnd;
		@stp = ttp.get;
		stp.clear;
		ttp.txtset("");
		ttp.disable;
		bool b = 1;
		if( stp.length )	{
			for( int i=1; i<=iileprofili; i++ )	{
				if( i!=itmprofil )	{
					if( stp == clsmen.get("profilename_"+i) )	{
						txtexists.mcenterpos(s);
						txtexists.show;
						b=0;
					}
				}
			}
			if( b )	{
				clsmen.set("profilename_"+itmprofil, stp);
				@s2 = s+"txt2";
				<s2>.txtset(stp);
				<s2>.mcenterpos(s);
				<s2>.show;
			} else if( !.hasprofile(itmprofil) )	{
				//itmprofil=.mfirstprofile;
				itmprofil=0;
			}
		} else {
			<s+"txt1">.show;
		}
		ttp.hide;
		
		if( b ) {
			sgmstate="submenu";
			if( stypemode=="newprofile" )	{
				iProfilId = itmprofil;
				.setstdprofile;
				.setgamevolume;
				.wczytajglosnosc;
			}
			.putprofiles;
		} else {
			sgmstate="profileexist";
		}
		
	}
	mstarttype	{
		@s = .mactwnd;
		
		<s+"ok">.hide;
		<s+"rename">.hide;
		<s+"delete">.hide;
		<s+"ok2">.show;
		<s+"cancel">.show;
		txtexists.hide;
		
		ttp.setpos( <s>.getpx + 100, <s>.getcy - ttp.geth/2 );
		//ttp.mcenterpos(s);
		ttp.show;
		ttp.enable;
		sgmstate = "typeprofile";
		but1.onmousemove;
		
		keyboard.show;
	}
	ttp_ontype	{	txtenter.hide;	}
	ttp_ontyped	{	.mcheckname;	}
	mcheckname	{
		@s = ttp.get;
		s.clear;
		<.mactwnd+"ok2">.setframe(-1, (s.length>0 ? 1 : 0) );
	}
	mcenterpos(string sbg)	{
		.setpos( <sbg>.getcx - .getw/2, <sbg>.getcy - .geth/2 );
	}
	menucol	{	.grey(32);	}
	mwnd(int id)	{ "anpr_"+id; }
	mactwnd	{	.mwnd(itmprofil);	}
	buildprofile(int id)	{
		<"grt"+id>.add(this);
		.vars2(A, "myid", id);
		grprof.add(this);
	}
	hasprofile(int id)	{	clsmen.has("profilename_"+id); }
	putextras	{
		sgmstate="submenu";
		if( sactmenu=="anextras" )	{
			grmen.hide;
		} else {
			.hideactmen;
			mus.fadeout(500);
		}
		sactmenu = "anextras";
		anokienko.show;
		anextras.show;
		anok.show;
		grexplansze.eval( func {
			if( .actionnr(-1)==idextras )
				.setframe(-1,1);
			else .setframe(-1,0); 
			.show;
			} );
		if( idextras==0 )	{
			grexsnd.show;
			idexsnd = 0;
			.putexsnd;
		} else if (idextras==1 )	{
			grexmin.show;
		} else if (idextras==2 )	{
			grexlearn.show;
		}
	}
	putexsnd	{
		for( int i=1; i<=3; i++ )	{
			if( i==idexsnd )	{
				@id1 = <grexsnd.getsac("wiol"+i)>.framenr;
				if( id1==1 )	{
					idexsnd=0;
					mus.fadeout(500);
					.putexsnd;
					return;
				} else {
					<grexsnd.getsac("wiol"+i)>.setframe(-1,1);
					<grexsnd.getsac("play"+i)>.setframe(-1,1);
					match(idexsnd)	{
						1 => "mystery_war.ogg";
						2 => "waltzing_ghosts.ogg";
						3 => "wizards.ogg";
						? => ;
					}
					mus.playstr;
				}
			} else {
				<grexsnd.getsac("wiol"+i)>.setframe(-1,0);
				<grexsnd.getsac("play"+i)>.setframe(-1,0);
			}
		}
	}
	createsuwak(int idpos)	{
		@s = groptsound.get(idpos);
		@dx = 50;
		@x = <s>.getpx + dx;
		@ex = <s>.getex - dx;
		.vars2(A, "ypos", <s>.getcy, "xpos", x, "expos", ex);
		.Button_stdms;
		.addmethod("butmoving", func {
			@x = mouse.getpx;
			if( x <= xpos )	.ansetcpos(xpos, ypos);
			else if (x>=expos) .ansetcpos( expos, ypos);
			else .ansetcpos( x, ypos );
			real r[2];
			r0 = expos - .getcx;
			r1 = expos - xpos;
			int vol = (1.0-(r0/r1))*100.0;
			if( this->gete(0,2)=="fx" )	{
				engine.setsndvol(vol);
				clsmen.set("sfx_volume"+iProfilId, vol);
			} else {
				gameapi.setmusicvol(vol);
				clsmen.set("music_volume"+iProfilId, vol);
			}
			} );
		if( this->gete(0,2)=="fx" )	{
			.suwakpos(.loadsndvolume->to_r/100.0);
		} else {
			.suwakpos(.loadmusicvolume->to_r/100.0);
		}
		but1.add(this);
	}
	suwakpos(real r)	{	.ansetcpos(xpos + r*(expos-xpos), ypos);	}
	mnofullscreen	{	igmipad || igmmac;	}
	putoptions	{
		sgmstate="submenu";
		// "optsound.pyzGH 25", "opsuwmuz.pyzH 30", "opsuwfx.pyzH 30",
		.hideactmen;
		sactmenu = "anoptions";
		anokienko.show;
		anoptions.show;
		anok.show;
		groptplansze.show;
		if( .mnofullscreen )	{
			<groptplansze.get(2)>.hide;	// schowaj fullscreen
		}
		groptplansze.eval( func {
			if( .actionnr(-1)==idoptplansze )
				.setframe(-1,1);
			else .setframe(-1,0); 
			} );
		if( idoptplansze==0 )	{
			<groptmode.get(Trudnosc)>.show;
			anoptmodes.show;
		} else if (idoptplansze==1 )	{
			//"optsound.pyzGH 25", "opsuwmuz.pyzH 30", "opsuwfx.pyzH 30",
			groptsound.show;
			anopsuwmuz.show;
			anopsuwfx.show;
		} else if (idoptplansze==2)	{
			if( .mnofullscreen )	{
				anoptfullscreen.hide;
				anoptfson.hide;
			} else {
				anoptfullscreen.show;
				if( bFullScreen ) anoptfson.show;
			}
		}
	}
	putprofiles	{
		sgmstate="submenu";
		.hideactmen;
		sactmenu = "anprofiles";
		ttp.txtset("");
		ttp.disable;
		ttp.hide;
		txtenter.hide;
		/*anokienko.show;
		anprnapisy.show;
		anprofiles.show;
		<grprlist.get(iProfilId-1)>.show;*/
		anprofiles.show;
		anprwindow.show;
		.msetactprofile;
	}
	misactprofil	{	.hasprofile(itmprofil);	}
	msetok2	{
		if( .hasprofile(myid) ) .setframe("ok2",1);
		else .setframe("ok2",0);
	}
	msetactprofile	{
		grprof.eval( func {
			.show;
			if( itmprofil==myid )	{
				match(.actionname)	{
					"okno" => { .mshowtxt; .setframe(-1,1); }
					"rename", "ok", "delete" => if( .hasprofile(myid) ) .setframe(-1,1);
					"ok2", "cancel" => .hide;
					? => ;
				}
			} else {
				match(.actionname)	{
					"okno" => { .mshowtxt; .setframe(-1,0); }
					//"hak" => .hide;
					"rename", "ok", "delete" => .setframe(-1,0);
					"ok2" => { .hide; .msetok2; }
					"cancel" => .hide;
					? => ;
				}
			}
		} );
	}
	anprofiles_exit	{
		grprof.hide;
		for( int i=1; i<=iileprofili; i++)	{
			<"grt"+i>.hide;
		}
		txtexists.hide;
	}
	mcredgo	{	tdcred.setpos( icredx1, icredy2 ); tdcred.show;	}
	putcredits	{
		sgmstate="submenu";
		.hideactmen;
		sactmenu = "ancredits";
		anokienko.show;
		ancredits.show;
		anok.show;
		.mcredgo;
		timcred.play;
	}
	ancredits_exit	{
		timcred.stop(false);
		tdcred.hide;
	}
	butmen	{
		return;
		.Button_stdms;
		.addmethod("butclick", func {
			if( sgmstate!="submenu" ) return;
			<GAME>.hideactmen;
			but1.onmousemove;
			sgmstate="game";
			<GAME>.<this + "_exit">;
			} );
		but1.add(this);
	}
	
	anextras_exit	{	mus.playstr("wizards.ogg -l -v 60"); }
	hideactmen	{
		if( sactmenu!=null )	{
			.<sactmenu + "_exit">;
			sactmenu=null;
		}
		grmen.hide;
	}
	but1_lclick	{
		if( sobject!=null ) fxclick.play;
	}
}



class TPuzzle	{
	init	{}
	tinit(string sbkg, string sels, int row, int col, int dx, int dy)	{
		new int iCols = col;
		new int iRows = row;
		.newimg("imgbkg", sbkg, 0);
		
		new gmimgvec grel;
		new gmimgvec grend;
		"grel" ..< sels;
		grel.hash;
		grel.each( func { (@id) .setz(10+id); } );
		
		new int ibadajl = 25;
		new string sactpuz;
		new int iblitopacity = 192;
		new int PuzzleState = 0;
		
		new DelayMover cmov;
		new SimpleCounter cnt(200);
		
		new int iX = dx;
		new int iY = dy;
		grel.move( iX, iY );
	}
	setpuzstate(int istate)	{
		PuzzleState=istate;
		if( PuzzleState==1)	{
			new gmimgvec grblit;
			@s = _;
			"grblit" ..< s;
			grblit.hide;
		}
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( grel.isincut( mouse.getpos, true, true ) )	{
			string s = grel.getsfound;
			<s>.setz(900);
			.mssetobj( s );
			.tpuzzle_get;
		}
	}
	bool cwithin(string s)	{
		int i;
		if( .gettype!="anima" )	{
			for( i=0; i < .size; i++)	{if( <.get(i)>.cwithin( s ) )	return true;}
			return false;
		} else {
			if( <s>.gettype=="anima" )	{
				int id = .framenr;
				int im = id%iCols;
				A;
				if( im>0 )			id-1;
				if( im<iCols-1 )	id+1;
				im = id/iCols;
				if( im>0 )			id-iCols;
				if( im<iRows-1)	id+iCols;
				return <s>.framenr->in;
			} else {
				for( i=0; i< <s>.size; i++)		{if( .cwithin( <s>.get(i) ) )	return true;}
				return false;
			}
		}
	}
	cblit(string s)	{
		if( <s>.gettype=="anima" )	{
			if( PuzzleState==1 )	{
				<s>.setpos(iX, iY);
				<s>.hide;
				s = grblit.get(<s>.framenr);
			}
			<s> {
				.setz(1);
				.show;
				
				.setpos(iX,iY);
				int x = .getpx;
				int y = .getpy;
				.anaddfilter;
				.setopacity(iblitopacity);
				.setpos(x,y);
				imgbkg.blit( this );
				.unlink;
				.setpos(iX,iY);
				.hide;
			};
		} else	for( int i=0; i< <s>.size; i++ )		.cblit( <s>.get(i) );
	}
	cmov_PUT	{	<GAME>.cput;	}
	cput	{
		.tpuzzle_put;
		string s = cmov.getmover;
		<s>.setz(100+cnt.next);
		cmov.free;
		grel {
			.sortimgs;
			.each( func { (int i) .setz(10+i); } );
		};
		string s1 = s, string s2;
		sactpuz = s;
		while(<s>.gettype != "anima")	s=<s>.get(0);
		if( ibadajl.length( <s>.lodx+iX-<s>.getpx, <s>.lody+iY-<s>.getpy ) < ibadajl )	{
			sactpuz = null;
			.cblit(s1);
			grel.remove(s1);
			grend.add(s1);
			.tpuzzle_blit;
			if( grel.empty )	{
				grend.show;
				.tpuzzle_end;
			}
		} else {
			grel.remove(s1);
			for( int i=0; i<grel.size; i++)	{
				s = grel.get(i);
				if( cllen.iposlen(s,s1)<0 && <s1>.cwithin(s) )	{	// nie laczyc
				//if( cllen.iposlen(s,s1)<ibadajl && <s1>.cwithin(s) )	{
					|int x, int y| = <s>.getpos;
					if( <s>.gettype=="anima")	{
						.mwyjmij(s);
						if( <s1>.gettype=="anima" )	{
							s2 = "gr" + s;
							new gmimgvec <s2>;
							<s2>.add(s);
							<s2>.add(s1);
						} else {
							<s1>.add(s);
							s2 = s1;
						}
						grel.remove(s);
						grel.add(s2);
					} else {
						if( <s1>.gettype=="anima" )	{
							<s>.add(s1);
						} else {
							<s>.addgr(s1);
						}
						s2 = s;
					}
					<s2>.setpos(x,y);
					<s2>.setz( <s1>.getz );
					grel.sortimgs;
					sactpuz = s2;
					return;
				}
			}
			grel.add(s1);
		}
	}
	virtual tpuzzle_end {}
	virtual tpuzzle_get {}
	virtual tpuzzle_blit {}
	virtual tpuzzle_put {}
}

game Puzzle : Kajuta, TPuzzle	{
	init	{
		Kajuta::init("puzzle");
		
		.titsounds = (A, "lektor1", "Na grze ekranu s fragmenty poczne. Ukadaj je w odpiednich miejscach tak aby electricity, oxygen, fuel poaczyy si odpowiednimi zegarami po przeciwnej stronie ekranu.", func { .unlockall; .stdret; }
			);
		
		.sfxs = (A, "getpuz 60", "putpuz 60", "ok 60", "puzzleok 50", "putpuz2 60");
		
		new int iPuzRow = 4;
		new int iPuzCol = 5;
		new bool bPlayMusic = true;
		.tinit("bgpuzzle.png", "puz4_5.pyz", iPuzRow, iPuzCol, 0, 0);
		
		.imgs = (A, "left.pyz 200", "right.pyz 200", "maski.pyzG 199", "finisz.pyzH 20");
		
		anleft.Button_std;
		anright.Button_std;
		but1.add("anleft");
		but1.add("anright");
		new int strzalkax = 5;
		
		new int rewindspeed = 10;
		.cycle = ("timleft", func {
			if( igmstate==1 && grpes.size )	{
				grpes.move( rewindspeed, 0 );
				@s = grpes.first;
				if( <s>.getpx > anleft.getex + strzalkax )
					grpes.move( (anleft.getex+strzalkax)-<s>.getpx, 0 );
				.play;
			}
			} );
		.cycle = ("timright", func {
			if( igmstate==1 && grpes.size )	{
				grpes.move( -rewindspeed, 0 );
				@s = grpes.last;
				if( <s>.getex < anright.getpx - strzalkax )
					grpes.move( (anright.getpx-strzalkax)-<s>.getex, 0 );
				.play;
			}
			} );
		
		new Rect rec2(6,54,1012,690);
		new gmimgvec grpes;
		for( int i=0; i<grel.size; i++ )
			.mwstaw(grel.get(i));
		
		/*.cbutexit;
		anbutexit.move(-15,-15);*/
		
		.timer = ("timwatch", 2000, "mend" );
		
		//.cbutmusic;
		
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		.match3but;
		if( Trudnosc<2) anmatch3but.move(0, iResY - anmatch3but.getey - 120 );
		
		if( bPlayMusic )	{
			//mus.playstr("wizards.ogg -v 50 -l");
		}
		ccs.enter( func {
			.txtplay("lektor1");
			} );
	}
	mend	{
		if( AdventureMode )
			.mprzejdz("HasloA");
		else .mprzejdz("MainMenu");
	}
	match3_won	{ .mend;	}
	skip_minigame	{	.mend;	}
	play_music	{	mus.playstr("wizards.ogg -v 50 -l");	}
	stop_music	{	mus.fadeout(1000);	}
	mwstaw(string s)	{
		int dy = 5;
		int xpos;
		if( grpes.size )	{
			xpos = <grpes.last>.getex;
		} else {
			xpos = anleft.getex;
		}
		<s>.ansetbpos( xpos + strzalkax, <grmaski.first>.getpy + 10 );
		<s>.clip( anleft.getex + strzalkax, 0, anright.getpx-strzalkax, iResY );
		grpes.add(s);
	}
	mwyjmij(string s)	{
		int id = grpes.find(s);
		if( id<0 ) return;
		<s>.clip(0,0,iResX,iResY);
		grpes.remove(s);
		for( int i=id; i < grpes.size; i++ )	{
			<grpes.get(i)>.move( -<s>.getw-strzalkax, 0 );
		}
	}
	clbuts_help_butmoveon	{
		//if( igmstate!=2)
			//anpodpo.show;
	}
	clbuts_help_butmoveoff	{
		//if( igmstate!=2)
			//anpodpo.hide;
	}
	tpuzzle_get	{
		fxgetpuz.play;
		.mwyjmij(grel.getsfound);
	}
	tpuzzle_put	{	fxputpuz.play;	}
	tpuzzle_blit	{	fxputpuz2.play;	}
	tpuzzle_end	{
		fxok.play;
		grend.hide;
		igmstate=2;
		
		anfinisz.play(0);
		timwatch.play;
		fxpuzzleok.play;
	}
	anbutnext_click	{
		.tpuzzle_end;
	}
	cmov_PUT	{
		<GAME>.cput;
		if( sactpuz!=null )	{
			if( <sactpuz>.gettype=="anima" && <sactpuz>.getpy < anleft.getcy )	{
				.mwstaw(sactpuz);
			} else {
				rec2.fit(sactpuz);
			}
		}
		
	}
	tit_lclick	{
		|int x, int y| = mouse.getpos;
		if( igmstate==1 )	{
			if( anleft.isin(x,y,1,1) ) timleft.play;
			else if (anright.isin(x,y,1,1) ) timright.play;
		}
	}
	mouse_lrel	{
		if( igmstate==1 )	{
			if( timleft.isplaying ) timleft.stop(false);
			if( timright.isplaying ) timright.stop(false);
		}
	}
	mouse_rclick	{
		//if( igmdebug ) .tpuzzle_end;
		if( igmdebug ) grpes.print;
	}
}



class GraczeMemo	{
	init(int imode)	{
		new int idrugi = 1;
		if( imode==1 )	idrugi=2;	// 1 - p vs comp, 2 - p vs p
		new anima angracz1;
		angracz1.load("scripts/memo/gracze.pyz");
		.copyanima("angracz1", "angracz2");
		angracz1.addtogamevars("angracz1");
		angracz2.addtogamevars("angracz2");
		.var("aktualny");
		.set(1);
	}
	set(int id)	{
		aktualny = id;
		if( id==1 )	{
			angracz1.setframe(0,1);
			angracz2.setframe(1,0);
		} else {
			angracz1.setframe(0,0);
			angracz2.setframe(1,1);
		}
	}
	next	{
		if(aktualny==1) .set(2);
		else .set(1);
	}
}

iMemoW = 6;
iMemoH = 5;
iMemoTryb = 1;

game Memo : Kajuta, TMemo {
	init()	{
		Kajuta::init("memo");
		
		.tinit("$scripts/25kotlypalacz/25kotlypalacz.jpg", "tmale.pyz", "tafmaly.pyz", 2);
		
		.path = ("25kotlypalacz");
		.imgs = (A, "palacz.pyz 3", "deska.pyz 1", "memo.pyz 2");
		.path = ("memo");
		
		.tfitinsurf( 720, 510 );
		@dy = -15;
		grnak.move( 0, dy );
		grtaf.move( 0, dy );
		
		.sfxs = (A, "memo1", "memo2", "brawo", "buu");
		
		new GraczeMemo gracze( iMemoTryb );
		new Cypher ct1(null,40, .white, angracz1.getcx-10, angracz1.getey+3, 500);
		new Cypher ct2(null,40, .white, angracz2.getcx-10, angracz2.getey+3, 500);
		//gracz2.setpos( iResX-gracz2.getw, 0 );
		
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		.match3but;
		
		ccs.enter( "tm_start" );
	}
	tm_start	{
		igmstate = 1;
		TMemo::tm_start;
	}
	tnextplayer	{
		TMemo::tnextplayer;
		gracze.set( iplayer );
	}
	askrestart2()	{
		if( iMemoTryb==1 )		claskexit.askrestart;
		else	claskexit.askrestart2;
	}
	tfinish()	{
		<"ct" + iplayer>.++;
		int c1 = ct1.get;
		int c2 = ct2.get;
		if( c1==c2 )	{ .memrestart;}
		else if (c1>c2)	{ .mend; }
		else { .memrestart; }
	}
	mend	{
		if( AdventureMode )
			.mprzejdz("Kotlypalacz");
		else .mprzejdz("MainMenu");
	}
	match3_won	{	.mend;	}
	skip_minigame	{	.mend;	}
	memrestart	{	.mprzejdz("Memo");	}
	tpoint()	{
		if( iMemoTryb>0 )	{
			<"ct" + iplayer>.++;
		}
		fxmemo2.play;
	}
	tchoose	{	fxmemo1.play;	}
	terror	{	}
	tit_lclick()	{
		.tm_mouselclick;
	}
	anbutnext_click	{
		.mend;
	}
}

game Kolkokrzyz : Kajuta {
	init	{
		Kajuta::init("kolkokrzyz");
		.imgs = (A, "bg.jpg", "pola.pyzGH", "ramka.pyz 5", "kolo.pyzGH 10", "krzyz.pyzGH 10", "kreski.pyzH 20");
		
		new GraczeMemo gracze( 1 );
		gracze.set( 2->rand+1 );
		
		.sfxs = (A, "kreska", "putznak");
		mus.playstr("maszynownia.ogg -l -v 30");
		
		new vector vgracz1;
		new vector vgracz2;
		
		grpola.each( func { (@id) .var2("myid",id); } );
		
		.timer = ("timpalacz", 1000, func {
			@id = grpola.size->rand;
			@pos = <grpola.get( id )>.myid;
			grpola.removeat(id);
			vgracz2.add(pos);
			<grkrzyz.get(pos)>.show;
			fxputznak.play;
			if( .mwin("vgracz2") || grpola.empty )	{
				timrepeat.play;
			} else {
				igmstate=1;
				gracze.next;
			}
			} );
		.timer = ("timrepeat", 1000, func { .mprzejdz("Kolkokrzyz"); });
		.timer = ("timwin", 1000, func { .mprzejdz("Kotlypalacz"); });
		
		if( gracze.aktualny == 2 )
			.mpalacz;
		else igmstate = 1;
	}
	mpalacz	{ igmstate=0; timpalacz.play; }
	tit_lclick	{
		if( igmstate==1 && grpola.isin(mouse.getpos,0,1) )	{
			igmstate=0;
			@id = grpola.getfound;
			@pos = <grpola.get(id)>.myid;
			grpola.removeat(id);
			vgracz1.add(pos);
			<grkolo.get(pos)>.show;
			fxputznak.play;
			if( .mwin("vgracz1") )	{
				timwin.play;
			} else if ( grpola.empty )	{
				timrepeat.play;
			} else {
				gracze.next;
				timpalacz.play;
			}
		}
	}
	mwin(string s)	{
		if( <s>.size>=3 )	{
			for(int i=0; i<ankreski.nofactions; i++)	{
				ankreski.setframe(i,0);
				fxkreska.play;
				string sac = ankreski.actionname;
				if( <s>.contains( sac.getb(0,1) ) && <s>.contains( sac.getb(1,1) )
					&& <s>.contains( sac.getb(2,1) ) )	{
					ankreski.show;
					return 1;
				}
			}
		}
		0;
	}
}


game Intro : StdGame	{
	init	{
		StdGame::init("intro");
		
		.sfxs = (A, "logo 60", "logong 70", "ruchwody 70");
		
		new img imgpw3;
		imgpw3.create( iResX, iResY, .white, 255 );
		imgpw3.setz(4);
		imgpw3.hide;
		
		new classfadeinout clfio;
		
		if( .mnofish )	{
			.imgs = (A, "ng.png" , "pw.pngH 5");
			fxlogong.play;
		} else {
			if( igamehouse )	.newimg("imbfg", "gh1024x768_white.jpg", 0);
			else if (ibigfish)	.newimg("imbfg", "splash_1024x768.jpg", 0);
			
			fxlogong.play;
			.timer = ("timbfg", 2000, func {
				ccs.playfin( func { delete imbfg; .imgs = (A, "ng.png" , "pw.pngH 5"); fxlogong.play; },
					func { tim1a.play; } );
				} );
		}
		
		.timer = ("tim1a", 500, func {
			imgpw3.transparency(0);
			imgpw3.show;
			clfio.imgtransparency(1, 5, "imgpw3", func { <GAME> {
				imgng.clone( "imgpw3" );
				imgng.show;
				imgpw3.load( .getgraphpath + "pw3.jpg" );
				imgpw3.hide;
				//.img = ("pw.pngH 5");
				tim1.play;
				}; } );
			} );
		
		.timer = ("tim1", 500, func {
			imgpw.transparency(0);
			imgpw.show;
			fxlogong.play;
			clfio.imgtransparency(1, 5, "imgpw", func {
				imgng.load( .getgraphpath + "pw2.jpg" );
				tim2.play;
				} );
			} );
		.timer = ("tim2", 500, func {
			clfio.imgtransparency(1, -5, "imgpw", func {
				imgpw.hide;
				tim3.play;
				} );
			} );
		.timer = ("tim3", 500, func { <GAME> {
			delete imgpw;
			new img imwater;
			imwater.create( iResX, iResY, 3,14,33, 255 );
			.imgs = (A, "wrak.pyz 10", "fale.pyz 10", "water.pyz 5");
			anwrak.setpos( 0, iResY );
			anfale.move( 0, iResY - anfale.getpy );
			anfale.play(0);
			anwater.setpos(0, anfale.getpy + 30);
			imwater.setpos(0, iResY );
			
			imgpw3.show;
			imgpw3.clip( 0, anwater.getpy, iResX, iResY );
			imgpw3.setz( imgng.getz + 1 );
			fxruchwody.play;
			tim4a.play;
			}; } );
		
		new int wodaspeed = -10;
		
		.cycle = ("tim4a", func {
			anfale.move( 0, wodaspeed );
			
			if( anwater.getpy < 0 )	{
				anwater.setpos(0, 0);
				imgng.hide;
				imgpw3.clip( 0, anwater.getpy, iResX, iResY );
			} else	{
				anwater.move( 0, wodaspeed );
				imgpw3.clip( 0, anwater.getpy+30, iResX, iResY );
			}
			if( anfale.getey < 0 )	{
				anfale.anhide;
				tim4.play;
			} else .play;
			} );
		.cycle = ("tim4", func {
			anwater.move( 0, wodaspeed );
			imwater.move( 0, wodaspeed );
			imgng.move( 0, wodaspeed );
			imgpw3.move( 0, wodaspeed );
			if( imwater.getpy <= 0 )	{
				imwater.setpos(0,0);
				anwater.anhide;
				imgng.create( iResX, iResY, 0,8,4, 255 );
				imgng.setpos(0,0);
				imgng.setz( imwater.getz - 1 );
				imgng.show;
				clfio.imgtransparency(1, -5, "imwater", func {
					imwater.hide;
					tim5.play;
					} );
			} else
				.play;
			} );
		.cycle = ("tim5", func {
			anwrak.move( 0, wodaspeed );
			if( anwrak.getey < iResY )	{
				anwrak.move( 0, iResY - anwrak.getey );
				imwater.load( .getgraphpath + "t1.jpg" );
				imwater.setz( anwrak.getz + 1 );
				imwater.hide;
				imwater.transparency(0);
				
				tim6.play;
			} else .play;
			} );
		.timer = ("tim6", 1000, func {
			imwater.show;
			clfio.imgtransparency(1, 5, "imwater", func {
				tim7.play;
				anwrak.hide;
				imgng.load( .getgraphpath + "t2.jpg" );
				} );
			} );
		.timer = ("tim7", 200, func {
			clfio.imgtransparency(1, -5, "imwater", func { <GAME>.mtytul; } );
			} );
		.timer = ("tim9", 2000, "mstart");
		
		mus.playstr("intro.ogg -v 80");
		
		ccs.enter( func {
			if( .mnofish )	{
				tim1a.setdelay(1000);
				tim1a.play; 
			} else {
				timbfg.play;
			}
			} );
		//tim1a.play;
		//.mtytul;
	}
	mnofish	{	igmipad || (ibigfish == 0 && igamehouse==0 );	}
	mtytul	{
		.img = ("tytul.pyz 10");
		new filter ftyt;
		ftyt.link("antytul");
		new real rstartzooom = 1.7;
		ftyt.setzoom(rstartzooom);
		new real iletyt = 30.0;
		new real ityty = iResY - antytul.getpy;
		new real isteptyt = ityty/iletyt;
		new real rstep = 0.0;
		antytul.move(0, ityty);
		.cycle = ("tim8", func {
			rstep += isteptyt;
			int dt = rstep;
			if( dt )	{
				rstep -= dt;
				antytul.move(0, -dt);
			}
			real r = 1.0 + (rstartzooom-1.0)*(ile/iletyt);
			ftyt.setzoom(r);
			ile--;
			if( ile<0 )	{
				ftyt.unlink;
				//antytul.setpos(0,0);
				tim9.play;
			} else .play;
			} );
		tim8.var2("ile", iletyt);
		tim8.play;
		.timplay("timlogo", 900, func { fxlogo.play; } );
	}
	mtogame	{ gameapi.play("MainMenu"); }
	mstart	{
		if( igmstate==0 )	{
			igmstate = 1;
			/*if( ccs.isplaying ) .mtogame;
			else {
				mus.fadeout(900);
				ccs.close( "mtogame" );
			}*/
			.mtogame;
		}
	}
	mouse_lclick	{
		.mstart;
	}
}


game IntroG1 : StdGame	{
	init	{
		StdGame::init("introg");
		
		.imgsgr = (A, "bg.jpg", "fala.pyzP 5", "dym.pyzG 10",
			"grall");
		grdym.nplay(-1);
		
		.img = ("skipintro.pyz 100");
		@size = 14;
		if( LANG == "eng" ) size=24;
		.newfont("fnt1", "configs/fonts/timesbd.ttf", size);
		.newtext("txtskip", dblangcom.dbget("skipintro"), "fnt1", .black);
		txtskip.setpos(anskipintro.getcx - txtskip.getw/2, anskipintro.getcy-txtskip.geth/2 );
		txtskip.setz(anskipintro.getz);
		anskipintro {
			.Button_stdms;
			.addmethod("butclick", func { gameapi.play("Cs1Pad"); } );
			but1.add(this);
		};
		
		.sfxs = (A, "statekN 50", "statekbum", "fx3 50");
		
		.sounds = (A, "snd1", "eRMS Titanic; Wspaniay wytwr ludzkiej myli technicznej pocztku 20 wieku Dla jednych luksusowy rodek transportu, dla innych wehiku do nowego wiata dajcy nadziej na lepsz przyszo",
			func { tim2.play; tcr.ahide; },
			"snd2", "W czasie swego dziewiczego rejsu by wiadkiem wielu wydarze i ludzkich historii ktrych by moe nigdy ju nie poznamy; Wszystkie zostay bolenie przerwane tragicznej nocy z 14 na 15 kwietnia 1912 roku",
			func { angora.play(0); tcr.ahide; }
			);
		
		.timer = ("tim1", 500, func { .cbplay("snd1"); } );
		.timer = ("tim2", 500, func {
			//.mprzejdz("IntroG2"); 
			ccs.close( "initG2" );
			} );
		
		//init(string sfont, int isize, string sdbfile, int r, int g, int b, int x, int y, int dy, int z, string sdir)	{
		new TextDb tdtxt(null, 16, "$lang:txt1_", .grey(20),
			0.56*iResX,0.26*iResY, 5,250, "left");
		
		new tcramka tcr;
		tcr.view("tdtxt");
		tcr.hide;
		
		ccs.enter( func {
			tim1.play;
			tcr.ashow;
			mus.playstr("mystery_war.ogg -l -v 60");
			} );
	}
	initG2	{
		grall.deleteinit;
		delete grall;
		
		.path = ("introg2");
		
		.imgsgr = (A, "bg2.jpg", "tafla.pyzP 5", "odbicie.pyzP 10", "statek.pyzP 15",
			"fala.pyzP 20", "gora.pyzH 25", "kra1.pyz 30", "kra2.pyz 35", "dym.pyzG 40",
			"grall");
		grdym.nplay(-1);
		
		ankra1.move( -ankra1.getex, 70 );
		ankra2.move( -ankra2.getex-200, 170 );
		new AnMover cskra1("ankra1", 2.2, -0.24);
		new AnMover cskra2("ankra2", 3, -0.3);
		cskra1.play;
		cskra2.play;
		grall.add("cskra1");
		grall.add("cskra2");
		
		angora.addmethod("onendframe", func {
			if( .framename=="bum" )	{
				anstatek.play(1);
				anfala.anhide;
				fxstatekbum.play;
			}
			} );
		anstatek.addmethod("onfinish", func {
			if( .actionnr(-1) == 1 )
				timend.play;
			} );
		
		/*.cycle = ("timgora", func {
			if( ankra2.getpx > 0.65*iResX )
				angora.play(0);
			else .play;
			} );
		timgora.play;*/
		
		new TextDb tdtxt2(null, 16, "$lang:txt2_", .grey(20),
			0.56*iResX,0.26*iResY, 5,250, "left");
		
		//new tcramka tcr("tdtxt");
		tcr.view("tdtxt2");
		tcr.hide;
		
		.timer = ("timend", 2000, func {
			ccs.close( "initG3" );
			} );
		
		ccs.enter( func { tcr.ashow; .cbplay("snd2"); } );
	}
	initG3 {
		fxstatek.stop(false);
		fxstatekbum.stop(false);
		
		grall.deleteinit;
		delete grall;
		
		.path = ("introg3");
		
		.imgsgr = (A, "bg3.jpg", "woda.pyzH 10", "woda2.pyzH 15", "woda3.pyzH 20",
			"grall");
			
		.copyanima("anwoda", "anwodab");
		grall.add("anwodab");
		new filter ftw;
		ftw.link("anwoda");
		ftw.setopacity(128);
		
		new filter ftw2;
		ftw2.link("anwodab");
		anwodab.hide;
		anwodab.setz(9);
		
		.sfxs = (A, "zalanakotlowniaP 70");
		
		anwoda.addmethod("onsetframe", func {
			if( .framenr==1 ) anwodab.play(4);
			match( .framenr%3 )	{
				0 => ftw.setopacity(92);
				1 => ftw.setopacity(164);
				2 => ftw.setopacity(255);
				? => ;
			}
			} );
		anwodab.addmethod("onsetframe", func {
			match( .framenr%3 )	{
				0 => ftw2.setopacity(92);
				1 => ftw2.setopacity(164);
				2 => ftw2.setopacity(255);
				? => ;
			}
			} );
		anwoda.play(4);
		ftw.setopacity(92);
		anwodab.addmethod("onfinish", func {
			anwoda.hide;
			.hide;
			anwoda2.show;
			tim11.play;
			} );
		
		.timer = ("tim11", 500, func {
			anwoda2.hide;
			anwoda3.show;
			tim12.play;
			} );
		.timer = ("tim12", 500, func {
			anwoda3.hide;
			imgbg3.load(.getgraphpath+"bg3b.jpg");
			tim13.play;
			} );
		.timer = ("tim13", 1500, func {
			ccs.close( "initG4" );
			} );
	}
	initG4	{
		fxzalanakotlownia.stop(false);
		delete fxstatek;
		delete fxstatekbum;
		
		ftw.unlink;
		ftw2.unlink;
		delete ftw;
		delete ftw2;
		grall.deleteinit;
		delete grall;
		delete tim1;
		delete tim2;
		
		.path = ("introg4");
		.imgsgr = (A, "b40.jpg 5", "b41.jpg",
			"grall");
		
		.sfxs = (A, "tlumwodaP");
		
		new classfadeinout clfio;
		new int ifio = 15;
		
		.timer = ("tim1", 500, func {
			clfio.imgtransparency(1, -ifio, "imgb40", func {
				imgb40.setz(0);
				imgb40.load( .getgraphpath + "b42.jpg" );
				imgb41.setz(5);
				tim2.play;
				} );
			} );
		.timer = ("tim2", 500, func {
			clfio.imgtransparency(1, -ifio, "imgb41", func {
				imgb41.setz(0);
				imgb41.load( .getgraphpath + "b43.jpg" );
				imgb40.setz(5);
				tim3.play;
				} );
			} );
		.timer = ("tim3", 500, func {
			clfio.imgtransparency(1, -ifio, "imgb40", func {
				imgb40.setz(0);
				imgb40.load( .getgraphpath + "b44.jpg" );
				imgb41.setz(5);
				tim4.play;
				} );
			} );
		.timer = ("tim4", 500, func {
			clfio.imgtransparency(1, -ifio, "imgb41", func {
				imgb41.setz(0);
				imgb41.load( .getgraphpath + "b45.jpg" );
				imgb40.setz(5);
				tim5.play;
				} );
			} );
		.timer = ("tim5", 500, func {
			clfio.imgtransparency(1, -ifio, "imgb40", func {
				imgb40.setz(0);
				//imgb40.load( .getgraphpath + "b44.jpg" );
				imgb41.setz(5);
				tim6.play;
				} );
			} );
		.timer = ("tim6", 500, func {
			ccs.close("initG5");
			} );
		ccs.enter( func { tim1.play; } );
	}
	initG5	{
		fxtlumwoda.stop(false);
		delete fxzalanakotlownia;
		
		grall.deleteinit;
		delete grall;
		
		.path = ("introg5");
		.imgsgr = (A, "bg5.jpg", "swiatlo.pyz 10", "batyskaf.pyz 15",
			"grall");
		
		new AnMover csbat("anbatyskaf", -10, 0);
		new int idx = iResX-anbatyskaf.getpx;
		new int idx1 = 0.5*idx;
		new int idx2 = 0.4*idx;
		new int idx3 = 0.25*idx;
		new int idx4 = 0.12*idx;
		anbatyskaf.move(idx, 0);
		
		new bool bx1;
		new bool bx2;
		new bool bx3;
		new bool bx4;
		new real slower = 0.75;
		
		new filter fts;
		fts.link("answiatlo");
		fts.setopacity(0);
		
		.cycle = ("timbat", func {
			csbat.move;
			@x = anbatyskaf.getpx;
			
			@x2 = iResX/15;
			real dx = iResX - x2 - x;
			if( dx>0 && x > anbatyskaf.lodx )	{
				real r = (dx/(iResX - x2 - anbatyskaf.lodx)->to_r)*255.0;
				fts.setopacity ( r*r*r/(255.0*255.0) );
			}
			
			if( x <= anbatyskaf.lodx )	{
				fts.setopacity(255);
				timend2.play;
				return;
			} else if( x < idx4 )	{
				if( !bx4 )	{
					csbat.rdx = ( slower*csbat.rdx );
					//fts.setopacity(152);
					bx4=1;
				}
			} else if( x < idx3 )	{
				if( !bx3 )	{
					csbat.rdx = ( slower*csbat.rdx );
					//fts.setopacity(88);
					bx3=1;
				}
			} else if( x < idx2 )	{
				if( !bx2 )	{
					csbat.rdx = ( slower*csbat.rdx );
					//fts.setopacity(42);
					bx2=1;
				}
			} else if( x < idx1 )	{
				if( !bx1 )	{
					csbat.rdx = ( slower*csbat.rdx );
					//fts.setopacity(24);
					bx1=1;
				}
			}
			timbat.play;
			} );
		
		.timer = ("timend2", 2000, func {
			mus.fadeout(1000);
			.mprzejdz("Cs1Pad");
			} );
		fxfx3.play;
		ccs.enter( func { timbat.play; } );
	}
}

game Outro : StdGame	{
	init	{
		StdGame::init("outro");
		
		mus.playstr("outroludzie.ogg -l -v 50");
		
		.loadsnddb;
		.sounds = (A, ":dziadzio1", "We are forever grateful for your help. We wouldn't be here without You. But how did You do this? It was impossible to find all the keys!", func { tcr.ahide; /*anusta1.anhide;*/ .timplay("tim5", 1000, func { <GAME> {
			//delete anusta1;
			delete imgdziad1;
			.imgs = (A, "prab1.jpg", "usta2.pyzH 10");
			.timplay("tim6", 1000, func { .txtplay("rosie1"); /*anusta2.play(0);*/ });
			}; } ); },
			":rosie1", "You would never believe me if I told You. I think it has something to do with... my grand granddaughter...",
			func { tcr.ahide; anusta2.play(1); .timplay("tim7", 3000, func { <GAME> {
				delete imgprab1;
				delete anusta2;
				.imgs = (A, "siedza.jpg", "babcia2.pyz 5", "lilian.pyz 10");
				new filter ftil;
				ftil.link("anlilian");
				ftil.setopacity(0);
				clfio.setopacity(2, 10, "ftil", func { .timplay("tim8", 2000, "mend"); });
				}; } ); }
			);
		
		.mput(1);
		.imgs = (A, "list.pyzH 20");
		.copyanima("anlist", "anlist2");
		anlist.addmethod("onfinish", func {
			if( .actionnr(-1)==0 )	{
				anlist2.play(1);
			} else if (.actionnr(-1)==2)	{
				.timplay("tim2", 200, func { <GAME> {
					delete anlist2;
					delete anlist;
					.imgs = (A, "siedza.jpg 20");
					imgsiedza.transparency(0);
					clfio.imgtransparency(1, 5, "imgsiedza", func { <GAME> {
						.mdel;
						.img = ("babcia1.pyzH 30");
						.timer = ("tim3", 3000, func { <GAME>.mscena2; });
						anbabcia1.addmethod("onfinish", func {
							if( .actionnr(-1)==0 )	tim3.play;
							.play(1);
							} );
						anbabcia1.play(0);
						}; } );
					}; } );
			}
			} );
		anlist2.addmethod("onfinish", func {
			.hide;
			anlist.play(2);
			} );
		new classfadeinout clfio;
		
		ccs.enter( func { .timplay("tim1", 3000, func { anlist.play(0); } ); } );
	}
	mput(int id)	{ <GAME> (id) { (@id)
		.mdel;
		.newgrimg("grels", "outro"+id, 10);
		grels.eval( func { .play(-1); } );
	}; }
	mdel	{ <GAME> {
		if( .hasvar("grels") )	{
			grels.deleteloaded;
			delete grels;
		}
	}; }
	mscena2	{
		delete anbabcia1;
		delete imgsiedza;
		.imgs = (A, "dziad1.jpg"/*, "usta1.pyzH 10"*/);
		.timplay("tim4", 1000, func { .txtplay("dziadzio1"); /*anusta1.play(0);*/ });
	}
	/*********** finitos **********/
	mend	{
		clsmen.set("profil_"+clsmen.get("currentprofile")+"_started",0);
		.mprzejdzclick("MainMenu");
	}
	//mouse_lclick	{	.mend;	}
}


game Klodki : Kajuta	{
	init	{
		Kajuta::init("klody");
		.imgs = (A, "bgklody.jpg", "klody.pyzG 5", "kloda1.pyzH 10",
			"szyfr1.pyzGH 15", "kloda2.pyzH 10", "szyfr2.pyzGH 15");
		
		new itemadder clk1;
		new itemadder clk2;
		
		.titsounds = (A, ":lilian1", "I must use a specific combination of digits and letters to unlock the padlocks.", "stdret",
			":lilian2", "Maybe the secret document I found could help me figure out these codes.", "stdret");
		
		.sfxs = (A, "cyk", "klodkago", "wcisnij");
		
		grklody.eval( func {
			.Button_isinalpha;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				igmstate = 31;
				
				@id = .actionnr(-1) + 1;
				<"clk"+id>.freeitem;
				.setframe(-1,0);
				.setpos(0,0);
				<"ankloda"+id>.setpos(0,0);
				<"clk"+id>.showitem( "ankloda"+id, "kloda"+id+"_shown");
				
				but1.removebut(this);
				} );
			but1.add(this);
			} );
		grszyfr1.eval( func {
			.addmethod("isbutin", func { (@x, @y) igmstate==40 && .isin(x,y,0,1); } );
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=40 ) return;
				if( .isvisible ) {
					.hide;
				} else {
					.show;
				}
				fxwcisnij.play;
				if( .mvis(1) && .mvis(2) && .mvis(3) && .mvis(7) && !.mvis(0) && !.mvis(4)
					&& !.mvis(5) && !.mvis(6) && !.mvis(8) && !.mvis(9) )	{
					ankloda1.setframe(1,0);
					<grklody.get(0)>.setframe(-1,1);
					fxcyk.play;
					grszyfr1.hide;
					igmstate = 5;
					.timplay("timkloda1", 1000, func { 
						grszyfr1.eval( func { but1.removebut(this); .hide; } );
						fxklodkago.play;
						clk1.gotodestan("ankloda1", grklody.get(0), 15, "kloda1_ok");
						} );
				}
				} );
			but1.add(this);
			} );
		grszyfr2.eval( func {
			.Button_isinalpha;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=30 ) return;
				.ansetnextfr;
				if( .mfr(0)==0 && .mfr(1)==5 && .mfr(2)==0 && .mfr(3)==3 )	{
					ankloda2.setframe(1,0);
					<grklody.get(1)>.setframe(-1,1);
					fxcyk.play;
					grszyfr2.hide;
					igmstate = 5;
					.timplay("timkloda2", 1000, func { 
						grszyfr2.hide;
						fxklodkago.play;
						clk2.gotodestan("ankloda2", grklody.get(1), 15, "kloda2_ok");
						} );
				}
				} );
			but1.add(this);
			} );
		
		.match3but;
		.mskipminigame;
		.img = ("$scripts/common/showhint.pyz 800");
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	kloda1_shown	{
		grszyfr1.show;
		ankloda1.setframe(-1,1);
		igmstate=40;
	}
	kloda2_shown	{
		grszyfr2.show;
		igmstate=30;
	}
	kloda1_ok	{
		ankloda1.hide;
		.mcheck;
	}
	kloda2_ok	{
		ankloda2.hide;
		.mcheck;
	}
	mcheck	{
		if( <grklody.get(0)>.framenr==1 && <grklody.get(1)>.framenr==1 )	{
			igmstate = 3;
			//clsave.set("item_szyfr",0);
			anitemszyfr.showszyfr;
			//.timplay("timend", 1000, func { .mprzejdz("Korytarzkrata"); } );
		} else igmstate=1;
	}
	showszyfr	{
		.setframe(1,0);
		.setpos(0,0);
		itszyf.showitem(this, func { .timplay("timszyf", 1000, func { anitemszyfr.hideszyfr; } ); } );
	}
	hideszyfr	{
		itszyf.hideitem(this, func {
			anitemszyfr {
				itszyf.freeitem;
				.hide;
			};
			.timplay("timend", 1000, "mend" );
			} );
	}
	mend	{
		clsave.set("item_szyfr",0);
		.mprzejdz("Korytarzkrata");
	}
	match3_won	{	.mend;	}
	skip_minigame	{	.mend;	}
	mvis(int id)	{ !<grszyfr1.get(id)>.isvisible; }
	mfr(int id)	{ <grszyfr2.get(id)>.framenr;	}
	mret	{ igmstate=1;	}
	tit_lclick	{
		if( igmstate==40 && !ankloda1.isin(mouse.getpos,1,1) )	{
			igmstate=5;
			grszyfr1.hide;
			clk1.gotodestan("ankloda1", grklody.get(0), 15, func { igmstate=1; ankloda1.hide; but1.add(grklody.get(0)); } );
		} else if( igmstate==30 && !ankloda2.isin(mouse.getpos,1,1) )	{
			igmstate=5;
			grszyfr2.hide;
			clk2.gotodestan("ankloda2", grklody.get(1), 15, func { igmstate=1; ankloda2.hide; but1.add(grklody.get(1));});
		}
	}
	kajuta_hint_click	{
		/*anshowhint.setpos( anitemszyfr.getcx, anitemszyfr.getpy-5 );
		anshowhint.play(0);*/
		igmstate=12;
		.txtplay("lilian2");
	}
}



game Cs1Pad : StdGame	{
	init	{
		StdGame::init("cs1_pad");
		
		.imgs = (A, "bg.jpg", "pad.pyz 10", "foto.pyz 20");
		
		//.lang_db("dbm", "mail_");
		
		//init(string sfont, int isize, string sdbfile, int r, int g, int b, int x, int y, int dy, int z, string sdir)	{
		new TextDb tdmail(null, 12, "$lang:mail_", .grey(20),
			anpad.getpx + 0.18*anpad.getw, anpad.getpy + 0.3*anpad.geth, 5,250, "left");
		anfoto.move(80, -60);
		
		//new tcramka tcr("tdmail");
		
		.lang_db("dbp", "zatwierdz_");
		new font fnbold;
		fnbold.load(sgmfontbold, 14);
		.newtext("txtpot", dbp.get(0,0), "fnbold" /*.stdfont(14)*/, .blue);
		txtpot {
			.setpos( tdmail.getpx - 5, tdmail.getpy + tdmail.geth + 20 );
			.setz(10);
			.Button_isin;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				.mprzejdzclick("Pokojlilian");
				} );
			but1.add(this);
		};
		
		mus.playstr("tablice.ogg -l -v 60");
		
		ccs.enter( func { ; } );
	}
}

game Cs2Batyskaf : StdGame	{
	init	{
		StdGame::init("cs2_batyskaf");
		
		.imgs = (A, "bkg.jpg", "battyl.pyz 5", "szyby.pyz 10", "dzwig.pyz 15", "batprzod.pyz 20", "swiatla1.pyzH 25",
			"swiatla2.pyzH 25", "drzwi.pyz 30", "maskaprzed.pyz 35", "panel.pyz 40", "czapka.pyz 45");
		
		mus.playstr("bgrdok.ogg -l -v 60");
		.sfxs = (A, "mechanizm", "zanurzanie 50");
		
		andrzwi.addmethod("onfinish", func {
			if( .actionnr(-1)==0 )	{
				ccs.playfin( null, func { andrzwi.play(1); } );
			} else {
				answiatla1.play(0);
				answiatla2.play(0);
				.timplay("tim2", 2000, func {
					fxmechanizm.play;
					fxzanurzanie.play;
					andzwig.play(0);
					});
			}
			} );
		
		new gmimgvec grbat;
		grbat.addlist(A, "anbatprzod", "answiatla1", "answiatla2", "andrzwi");
		
		.copyanima("andzwig", "andz2");
		andz2.hide;
		andzwig.addmethod("onendframe", func {
			@y = .getpy - andz2.getpy;
			andz2.setframe(-1, .framenr);
			grbat.move(0, y);
			} );
		andzwig.addmethod("onfinish", func {
			answiatla2.anhide;
			grbat.hide;
			.timplay("tim3", 3000, func { anbattyl.play(0); });
			} );
		
		anbattyl.addmethod("onfinish", "mend" );
		
		ccs.enter( func { .timplay("tim1", 2000, func {
				andrzwi.play(0);
				} );
			} );
	}
	mend	{
		.mprzejdz("Dziob");
	}
}


game HasloA : Kajuta	{
	init	{
		Kajuta::init("hasloa");
		.path = ("haslo");
		
		.imgs = (A, "bga.jpg", "aon.pyz 5", "apswd.pyzH 5", "apanelon.pyzH 10",
			"aswiatla.pyzGH 15", "aekranon.pyzH 20", "aczapka.pyz 25");
		
		if( clsave.bis("haslo_wpisane") )	{
			anaon.hide;
			anapanelon.show;
			graswiatla.nplay(-1);
			anaekranon.show;
		}
		
		.sfxs = (A, "dokpanelN 80");
		
		ccs.enter( func {
			if( clsave.bis("haslo_wpisane") )	tim1.play;
			else igmstate = 1;
			} );
		.timer = ("tim1", 3000, func { .mprzejdz("Dok"); } );
		
		anaon {
			.Button_isin;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				if( .actionnr(-1)==0 )	{
					.play(1);
					tim2.play;
				}
				} );
			but1.add(this);
		};
		
		.timer = ("tim2", 500, func {
			anaon.anhide;
			anapswd.show;
			anapanelon.show;
			graswiatla.nplay(-1);
			} );
		
		anapswd {
			.Button_isin;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				.mprzejdz("HasloB");
				} );
			but1.add(this);
		};
	}
}

game HasloB : Kajuta	{
	init	{
		Kajuta::init("haslob");
		.path = ("haslo");
		
		.imgs = (A, "bkg.pyz", "klawiatura.pyz 5", "bkeys.pyzGH 10", "btxt.pyz 15", "bstar.pyzGH 20", "cload.pyzGH 25");
		
		.sfxs = (A, "dokpanelN 80");
		
		new vector vps; vps.type("string");
		vps.resize( grbstar.size, null );
		new int idps = -1;
		
		@isndon = igmsoundson;
		igmsoundson = 1;
		.sounds = (A, "sndpswd", "Please enter password", func {
				grbkeys.show;
				grbstar.show;
				igmstate = 1;
				},
			"sndwrong", "Wrong password", func {  anbtxt.setframe("enter",0); igmstate=1; },
			"sndok", "Passowrd correct", func { tim1.play; },
			":lilian1", "Hmm. Maybe the map I found can help me determine the correct password.", "stdret"
			);
		igmsoundson = isndon;
		grbkeys.eval( func {
			.Button_isin;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				
				@s = .actionname;
				match( s )	{
					"_enter_" => {
						string s2 = "";
						for( int i=0; i<=idps; i++)	{
							s2+=vps.get(i);
						}
						if( s2=="15_space_april_space_1912" )	{
							igmstate=5;
							.cbplay("sndok");
							grbstar.hide;
							anbtxt.setframe("ok",0);
						} else {
							igmstate=5;
							.mreset;
							anbtxt.setframe("wrong",0);
							.cbplay("sndwrong");
						}
					}
					"_del_" => {
						if( idps>=0 )	{
							<grbstar.get(idps)>.setframe(-1,0);
							vps.set( idps, null );
							idps--;
						}
					}
					? => {
						if( idps < grbstar.size-1 )
							idps++;
						<grbstar.get(idps)>.setframe(-1,1);
						vps.set( idps, s );
					}
				}
				} );
			but1.add(this);
			} );
		
		.timer = ("tim1", 1000, func {
			anklawiatura.hide;
			grbkeys.hide;
			anbtxt.hide;
			grbstar.hide;
			grcload.nplay(-1);
			tim2.play;
			} );
		.timer = ("tim2", 1500, "mend" );
		
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		
		.match3but;
		if( Trudnosc<2) anmatch3but.move(0,-10);
		
		//.tohint(A, "anitemmapafull");
		
		.game_mute;
		ccs.enter( func { .cbplay("sndpswd"); } );
	}
	game_mute	{
		int vol = (iGameMute ? 0 : 100);
		sndok.setvol(vol);
		sndpswd.setvol(vol);
		sndwrong.setvol(vol);
	}
	hint_click	{
		if( igmstate==1 )	{
			igmstate=0;
			.txtplay("lilian1");
		}
	}
	mreset	{
		idps = -1;
		grbstar.setframe(-1,0);
	}
	anbutnext_click	{
		tim2.play;
	}
	mend	{
		clsave.bset("haslo_wpisane");
		.mprzejdz("Puzzle");
	}
	match3_won	{ .mend;	}
	skip_minigame	{	.mend;	}
}




game KrysztalyA : Kajuta	{
	init	{
		Kajuta::init("krysztalya");
		.path = ("krysztaly");
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Czego tu brakuje", func { tcr.ahide; .timplay("timend", 1000, func {
			.mprzejdz("Salabalowarecepcja"); } ); }
			);
		
		.sfxs = (A, "putdiament");
		//mus.playstr("gwarludzi.ogg -l -v 40");
		.sfx=("gwarludziN 40");
		
		.imgs = (A, "bg.pyz", "lustro.pyz 5", "sciana.pyz 10", "krys1.pyz 20", "m14.pyzH",
			"m15.pyzH", "od14.pyz 20", "od15.pyz 20");
		if( !clsave.bis("e2_wlozylkrys14") )
			anod14.hide;
		if( !clsave.bis("e2_wlozylkrys15") )
			anod15.hide;
		
		new DelayMover cmov;
		cmov.unlock;
		
		ccs.enter( func {
			if( !clsave.bis("item_krysztal14") || !clsave.bis("item_krysztal15") )
				.txtplay("lilian1");
			else igmstate = 1;
			} );
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( anitemkrysztal14.isin(mouse.getpos,1,1) )	{
			.mssetobj("anitemkrysztal14");
			igmstate=2;
		} else if( anitemkrysztal15.isin(mouse.getpos,1,1) )	{
			.mssetobj("anitemkrysztal15");
			igmstate=2;
		}
	}
	hint_click	{
		if( clsave.bis("item_krysztal14") )	{
			.playhints("anitemkrysztal14", "anm14");
		} else if ( clsave.bis("item_krysztal15") )	{
			.playhints("anitemkrysztal15", "anm15");
		}
	}
	cmov_PUT	{
		.mcheck(.getfree);
	}
	mcheck(string s)	{
		@s2 = s.gete(0,2);
		if( <"anm"+s2>.isin(mouse.getpos,0,0) )	{
			fxputdiament.play;
			<s>.hide;
			<"anod"+s2>.show;
			clsave.set("item_krysztal"+s2, 0);
			if( anod14.isvisible && anod15.isvisible )	{
				.timplay("timend", 1000, func { .mprzejdz("Krysztaly"); } );
			} else igmstate=1;
		} else {
			<s>.itemonpos;
			igmstate=1;
		}
	}
}

game Krysztaly : Kajuta	{
	init	{
		Kajuta::init("krysztaly");
		
		.titsounds=(A, "lektor1", "Kady kryszta rzuca odpowiedni blask ktry jest fragmentem obrazu. Zamieniaj miejscami krysztay a w lustrze pokae si obraz przedstawiajcy flag White Star.", "stdret");
		
		.imgsgr = (A, "bg.pyz", "lustro.pyz 5", "sciana.pyz 10", "kr.pyzG 20", "$scripts/common/obw.pyzH 25", "nahint.pyzH 30",
			"animlustro.pyzH 35",
			"grall");
		.copyanima("anobw", "anobw2");
		grall.add("anobw2");
		
		new gmimgvec grall2;
		
		//mus.playstr("gwarludzi.ogg -l -v 40");
		.sfx=("gwarludziN 40");
		
		.sfxs = (A, "lustroopen", "diamenty 50");
		
		new vector vkr;
		new string set1 = null;
		new string set2 = null;
		grkr.eval( func {
			.vars2(A, "myid", .actionnr(-1), "mypos", .actionnr(-1) );
			vkr.add(myid);
			.addmethod("isbutin", func { (@x,@y)
				.setframe(-1,1);
				0->length( x-.getcx, y-.getcy ) < 20;
				.setframe(-1,0);
				} );
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				if( set1==null )	{
					set1 = this;
					.tsetset("anobw");
				} else {
					set2 = this;
					.tsetset("anobw2");
					igmstate = 5;
					tim1.play;
				}
				} );
			but1.add(this);
			} );
		vkr.hash;
		for( int i=0; i<vkr.size; i++)	{
			.zmien( <grkr.get(i)>.myid, vkr.get(i) );
		}
		
		.timer = ("tim1", 500, func {
			anobw.anhide;
			anobw2.anhide;
			.zmien( <set1>.myid, <set2>.myid );
			but1.onmousemove;
			set1 = null;
			set2 = null;
			bool b = true;
			for( int i=0; i<grkr.size; i++)
				if( <grkr.get(i)>.myid != <grkr.get(i)>.mypos )
					b=false;
			if( b )	{
				.mend;
			} else {
				igmstate=1;
			}
			} );
		.timer = ("tim2", 1009, func {
			anobw.anhide;
			anobw2.anhide;
			igmstate=1;
			} );
		.cycle = ("tim3", func {
			anlustro.move(3,0);
			if( anlustro.getpx > anbg.getex )	{
				if( AdventureMode )	{
					clsave.bset("e2_recepcjalustro");
					.mprzejdz("HOSkrytkalustro");
				} else .mprzejdz("MainMenu");
			} else .play;
			} );
		
		if( AdventureMode ) {	// usuniecie gry z przygody 23.07.2012
			igmstate=5;
			grkr.hide;
			ananimlustro.show;
			
			ccs.enter(func { fxlustroopen.play;
			tim3.play; });
		} else {
			if( igmdebug )	.mbutnext;
			.match3but;
			
			ccs.enter( func { .txtplay("lektor1"); } );
		}
	}
	m3init	{
		Kajuta::m3init;
		new img imgbg2;
		imgbg2.create(iResX, iResY, .transparent);
		grall.sortimgs;
		for( int i=0; i<grall.size; i++)	{
			@s = grall.get(i);
			if( <s>.gettype=="gmimgvec" )	{
				for( int j=0; j< <s>.size; j++)	{
					< <s>.get(j)>.m3bgblit;
				}
			} else <s>.m3bgblit;
		}
	}
	m3bgblit	{
		if( .isvisible )	{
			grall2.add(this);
			imgbg2.blit(this);
			.hide;
		}
	}
	m3exit	{
		Kajuta::m3exit;
		grall2.show;
		grall2.free;
		delete imgbg2;
	}
	mend	{
		igmstate=5;
		grkr.hide;
		ananimlustro.show;
		fxlustroopen.play;
		tim3.play;
	}
	match3_won	{	.mend;	}
	skip_minigame	{	.mend;	}
	tsetset(string s)	{
		.setframe(-1,1);
		<s>.setpos( .getpx, .getpy );
		.setframe(-1,0);
		<s>.play(1);
	}
	zmien(int id1, int id2)	{
		@s1 = grkr.get(id1);
		@s2 = grkr.get(id2);
		<s1>.setframe(id1, 1);
		<s2>.setframe(id2, 1);
		@dx = <s2>.getpx - <s1>.getpx;
		@dy = <s2>.getpy - <s1>.getpy;
		<s1>.setframe(id1, 0);
		<s2>.setframe(id2, 0);
		<s1>.move( dx, dy );
		<s2>.move( -dx, -dy );
		@pos1 = <s1>.mypos;
		<s1>.mypos = (<s2>.mypos);
		<s2>.mypos = (pos1);
		fxdiamenty.play;
	}
	kajuta_hint_click	{
		if( igmstate==1 )	{
			annahint.play(0);
			igmstate=5;
			string s;
			for( int i=0; i<grkr.size; i++)	{
				s = grkr.get(i);
				if( <s>.myid != <s>.mypos )	{
					i=grkr.size;
				}
			}
			<s>.tsetset("anobw");
			for( i=0; i<grkr.size; i++)
				if( <grkr.get(i)>.mypos == <s>.myid )
					<grkr.get(i)>.tsetset("anobw2");
			tim2.play;
		}
	}
	anbutnext_click	{
		.mend;
	}
}

game Szafa : Kajuta	{
	init	{
		Kajuta::init("szafagra");
		
		.imgs = (A, "bg.jpg", "sruba1.pyz 25", "sruba2.pyz 25", "klodka.pyz 3", "srubo.pyz 30", "zoom.pyzH 20");
		
		.titsounds = (A, ":lilian1", "Jasny gwint! Drzwi zamknite na kdk.", "stdret",
			":lilian2", "Zamek solidnie przykrcony rubkami.", "stdret"
			);
		
		new DelayMover cmov;
		cmov.unlock;
		new string ssruba;
		new bool bsruba1 = 0;
		new bool bsruba2 = 0;
		
		.sfxs = (A, "srubka", "srubaout");
		//mus.playstr("gwarludzi.ogg -l -v 40");
		.sfx=("gwarludziN 40");
		
		ansrubo.addmethod("onendframe", func {
			if( .framename=="go" )	{
				<ssruba>.hide;
				fxsrubka.play;
			}
			} );
		ansrubo.addmethod("onfinish", func {
			.mretzoom;
			if( bsruba1 && bsruba2 )	{
				anzoom.hide;
				ansruba1.setframe(0,0);
				ansruba2.setframe(0,0);
				ansruba1.show;
				ansruba2.show;
				timsrub.play;
			} else {
				igmstate = 1;
			}
			} );
		
		.timer = ("timsrub", 1500, func {
			ansruba1.anplayfin(0, func {
				.hide;
				ansruba2.anplayfin(0, func {
					anklodka.anplayfin(0, func {
						.mprzejdz("HOSalabalowa");
						} );
					} );
				} );
			} );
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	hint_click	{
		igmstate=0;
		.txtplay("lilian2");
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( ansrubo.isin(mouse.getpos,1,1) )	{
			ansrubo.setframe(1,0);
			.setcobj("ansrubo");
			.msmove;
			anzoom.show;
			if( !bsruba1 )
				ansruba1.setframe(1,0);
			if( !bsruba2 )
				ansruba2.setframe(1,0);
			igmstate=2;
		}
	}
	cmov_PUT	{
		.free;
		
		|int x, int y| = classansearcher::_findnotr("ansrubo",ansrubo.getpx, ansrubo.getpy, 0, 1);
		
		if( !bsruba1 && ansruba1.isin(x,y,0,0) )	{
			.mwypad(x,y,1);
		} else if( !bsruba2 && ansruba2.isin(x,y,0,0) )	{
			.mwypad(x,y,2);
		} else {
			.mretzoom;
			igmstate=1;
			//.msruby;
		}
	}
	msruby	{
		if( bsruba1 )
			ansruba1.setframe(0,0);
		if( bsruba2 )
			ansruba2.setframe(0,0);
	}
	mwypad(int x, int y, string s)	{
		<"bsruba"+s>.set(1);
		ssruba="ansruba"+s;
		ansrubo.move( <ssruba>.getcx-x, <ssruba>.getcy-y );
		ansrubo.play(1);
	}
	mretzoom	{
		//anzoom.hide;
		ansrubo.setframe(0,0);
		ansrubo.setpos(0,0);
	}
}

game Roznice : Kajuta	{
	init	{
		Kajuta::init("roznice");
		
		.sounds = (A, ":lilian1", "This scene looks similar to the photo I just found. But something is off...", "stdret");
		
		.imgs = (A, "bkg.pyz", "open.pyzH 10", "op.pyzG 20", "roz.pyzG 30", "$scripts/common/obw.pyzH 35");
		new int idopas = 0;
		grroz.eval( func {
			.Button_isin;
			.Button_moveonms;
			.Button_moveoffms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				fxrozniceklik.play;
				.hide;
				grroz.remove(this);
				but1.onmousemove;
				<grop.get(idopas)>.hide;
				idopas++;
				if( grroz.empty )	{
					igmstate=5;
					anopen.show;
					tim1.play;
				}
				} );
			but1.add(this);
			} );
		.timer = ("tim1", 1500, "mend" );
		
		.sfxs = (A, "rozniceklik");
		
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		.match3but;
		
		if( AdventureMode==0 )	{
			.img = ("$scripts/items/batyskaf.pyz 600");
			anbatyskaf {
				.Button_stdms;
				.addmethod("butclick", func {
					if( igmstate==1 )	{
						.setframe(1,0);
						.setpos(0,0);
						igmstate=101;
					} else if (igmstate==101)	{
						.setframe(0,0);
						.setbatpos;
						igmstate=1;
					}
					} );
				but1.add(this);
				.setbatpos;
			};
		}
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	setbatpos	{
		@s = grpan2.get(3);
		anbatyskaf.setpos( <s>.getcx, <s>.getcy );
	}
	kajuta_hint_click	{
		if( igmstate==1 )	{
			@s = grroz.first;
			anobw.setpos( <s>.getcx, <s>.getcy );
			anobw.play(0);
		}
	}
	anbutnext_click	{
		tim1.play;
	}
	mend	{
		if( AdventureMode )	{
			clsave.set("item_batyskaf", 0);
			.mprzejdz("Pokojadministracyjny");
		} else .mprzejdz("MainMenu");
	}
	match3_won	{	.mend;	}
	skip_minigame	{	.mend;	}
}

game Zdjecie : Kajuta	{
	init	{
		Kajuta::init("zdjecie");
		.sfxs = (A, "foto1", "foto2", "cyfra", "wcisnij");
		
		new int iidfoto = 1;
		if( clsave.is("epizod", "e4_end") )	{
			iidfoto = 2;
			.imgs = (A,"$scripts/05tablice/05tablice2.jpg", "ramka2.pyz", "$scripts/common/bable.pyzH 105");
			new img imblak;
			imblak.create( iResX, iResY, .black, 128);
			img05tablice2.blit("imblak");
			img05tablice2.blit("anramka2");
			delete anramka2;
			delete imblak;
			.imgs = (A, "tablica.pyzH 20", "nazwiska.pyzGH 25");
			.timer = ("timnaz", 400, func {
				<grnazwiska.get(idnaz)>.hide;
				idnaz++;
				if( idnaz>=grnazwiska.size )
					.mprzejdz("Outro");
				else .play;
				} );
			timnaz.var2("idnaz",0);
			.newgrimg("grels", "els2", 0);
			mus.playstr("tablice.ogg -l -v 40");
			
			.mskipminigame;
		} else {
			.imgs = (A, "bg.jpg", "els.pyzG", "ramka.pyz 5", "$scripts/common/bable.pyzH 105");
			//mus.playstr("gwarludzi.ogg -l -v 40");
			.sfx=("gwarludziN 40");
		}
		grels.sortz(10);
		
		.loadsnddb;
		.sounds = (A, ":lilian1", "Podarte zdjcie; Zo je", "stdret",
			":lilian2", "Znam to miejsce; Jest niedaleko std", func { .mprzejdz("Salabalowarecepcja"); },
			":lilian25","To jednak ciebie te uratowaam; Tak si ciesz e mogymy si spotka",
				func {
					tcr.ahide;
					clsave.set("epizod", "e5_outro");
					grels.hide;
					antablica.show;
					grnazwiska.show;
					timnaz.play;
				}
			);
		
		new Rect rec2(0.1*iResX,0.1*iResY,0.9*iResX, <grpan.first>.getpy);
		rec2.fitgrouprand("grels");
		
		if( igmdebug )	.mbutnext;
		
		new DelayMover cmov;
		cmov.unlock;
		
		ccs.enter( func {
			if( clsave.is("epizod", "e4_end") )
				igmstate=1;
			else .txtplay("lilian1"); 
			} );
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( grels.isin(mouse.getpos,1,0) )	{
			@s = grels.getsfound;
			.mssetobj(s);
			<s>.setz(130);
			grels.remove(s);
		}
	}
	cmov_PUT	{
		@s = .getfree;
		<"fxfoto"+iidfoto>.play;
		if( <s>.aninlod(25) )	{
			<s>.setpos(0,0);
			<s>.setz(1);
			anbable.ansetcpos(mouse.getpos);
			anbable.play(0);
			fxcyfra.play;
			if( grels.empty )	{
				.mkoniec;
			} else igmstate = 1;
		} else {
			grels.add(s);
			grels.sortz(10);
			igmstate = 1;
		}
	}
	mkoniec	{
		igmstate = 2;
		.timplay("timend", 1000, "mend" );
	}
	mend	{
		if( clsave.is("epizod", "e4_end") ) .txtplay("lilian25");
		else .txtplay("lilian2"); 
	}
	anbutnext_click	{
		.mend;
	}
	skip_minigame	{
		grels.eval( func { .setpos(0,0); .setz(1); } );
		grels.free;
		.mkoniec;
	}
}

game Szuflady : Kajuta	{
	init	{
		Kajuta::init("szuflady");
		
		.imgs = (A, "bg.jpg", "maski.pyzH 20", "els.pyzG 10");
		.copyanima("anmaski", "anmaski2");
		
		.titsounds = (A, "lektor1", "Kada szuflada pasuje tylko do jednego miejsca. Zamieniaj szuflady miejscami tak aby uoyc kad na swoim miejscu.", "stdret",
			"lektor2","Try to align the patterns in the wood so that the markings run consistently across each row of drawers.", "stdret"
			);
		
		.sfxs = (A, "szufladaput 70", "szufladaklik", "szufzmiana 50");
		
		new vector vels; vels.vecnewint(12);
		vels.hash;
		new int iframe1;
		new int iframe2;
		
		grels.each( func { (@id)
			.setframe(-1, vels.get(id) );
			.Button_stdms;
			.addmethod("butclick", func {
				if( igmstate!=1 ) return;
				fxszufladaklik.play;
				if( anmaski.isvisible )	{
					anmaski2.setframe( .actionnr(-1), 0 );
					iframe2 = .framenr;
					anmaski2.show;
					igmstate = 2;
					tim1.play;
				} else {
					anmaski.setframe( .actionnr(-1), 0 );
					iframe1 = .framenr;
					anmaski.show;
				}
				} );
			but1.add(this);
			} );
			
		.timer = ("tim1", 500, func {
			@id1 = anmaski.actionnr(-1);
			@id2 = anmaski2.actionnr(-1);
			<grels.get(id1)>.setframe(-1, iframe2);
			<grels.get(id2)>.setframe(-1, iframe1);
			fxszufzmiana.play;
			if( <grels.get(id1)>.framename->contains("ok") || <grels.get(id2)>.framename->contains("ok") )
				fxszufladaput.play;
			tim2.play;
			} );
		.timer = ("tim2", 500, func {
			anmaski.hide;
			anmaski2.hide;
			bool b = true;
			@s = "";
			for( int i=0; i< grels.size; i++)	{
				if( !<grels.get(i)>.framename->contains("ok") )	{
					s += " " + i;
					b=false;
				}
			}
			if( b ) {
				.timplay("timend", 1000, "mend" );
			} else igmstate = 1;
			} );
		
		.match3but;
		if( Trudnosc<2) anmatch3but.move(0, -10);
		if( igmdebug )	.mbutnext;
		.mskipminigame;
		
		ccs.enter( func { .txtplay("lektor1"); } );
	}
	mend	{
		.mprzejdz("HOSalaturecka"); 
	}
	match3_won	{ .mend;	}
	skip_minigame	{	.mend;	}
	anbutnext_click	{
		.mend;
	}
	hint_click	{
		igmstate=0;
		.txtplay("lektor2");
	}
}


game Dok : Kajuta	{
	init	{
		Kajuta::init("41dok");
		.setsndbase("dok");
		
		.titsounds = (A, "lilian1", "Maj batyskafy. By moe uda si wypoyczy jeden.", "stdret",
			":lilian2","Panel sterujacy uruchamiany jest na haso. Rozjerz si w pobliu moe znajde jak wskazk dotyczc hasa.", "stdret",
			":lilian3", "Chyba ju mam wskazwk i mog sprbowa uruchomi panel sterujacy batyskafem.","stdret",
			":lilian4", "Panel uruchomiony teraz mog otworzy drzwi i mog pyn.", "stdret"
			);
		
		.imgs = (A, "41dok.jpg");
		
		mus.playstr("bgrdok.ogg -l -v 60");
		.mexits;
		
		if (clsave.is("epizod", "e3_powrot") )	{
			if( clsave.bis("haslo_wpisane") )	{
				.dititblock(A, "42dokpanel", "41ho_dok");
				.hodone("42dokpanel");
				.hodone("41ho_dok");
				.extohint("45dziob");
			} else if( clsave.bis("e3_wzielamape") )	{
				if( clsave.bis("e3_mafragmenthasla") )	{
					.titblock(A, "45dziob", "41ho_dok");
					.disablexit("41ho_dok");
					.hodone("41ho_dok");
					.nohover("34pokojadministracyjny");
					.nohover("04podwodnemuzeum");
					.extohint("42dokpanel");
				} else {
					.titblock(A, "45dziob", "42dokpanel");
					.nohover("34pokojadministracyjny");
					.nohover("04podwodnemuzeum");
					.extohint("41ho_dok");
				}
			} else {
				.titblock(A, "42dokpanel", "45dziob", "41ho_dok");
				.extohint("34pokojadministracyjny");
			}
		}
		
		ccs.enter( func {
			if (clsave.is("epizod", "e3_powrot") )	{
				if( clsave.bgo("e3_dokenter") ) .txtplay("lilian1");
				else if (clsave.bis("e3_wzielamape") && clsave.bgo("e3_dokszukahaslo") ) .txtplay("lilian2");
				else if (clsave.last=="HODok")	.txtplay("lilian3");
				else if (clsave.last=="HasloA") .txtplay("lilian4");
				else igmstate=1;
			}
			} );
	}
	click_41ho_dok	{
		clsave.bset("e3_mafragmenthasla");
		.mprzejdz("HODok");
	}
	click_42dokpanel	{
		.mprzejdz("HasloA");
	}
	click_45dziob	{
		//.mprzejdz("Dziob");
		.mprzejdz("Cs2Batyskaf");
	}
	click_34pokojadministracyjny	{
		.mprzejdz("Pokojadministracyjny");
	}
	click_04podwodnemuzeum	{
		.mprzejdz("Podwodnemuzeum");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Dokpanel : Kajuta	{
	init	{
		Kajuta::init("42dokpanel");
		
		.imgs = (A, "42dokpanel.jpg");
		
		//mus.playstr("titanic2.ogg -l -v 60");
		.mexits;
		.tohint(A, "grext");
		.mstdenter;
	}
	click_41dok	{
		.mprzejdz("Dok");
	}
	click_puzzle	{
		.mprzejdz("Puzzle");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Szczelina : Kajuta1	{
	init	{
		Kajuta1::init("43szczelina");
		.setsndbase("szczelina");
		
		.titsounds=(A, ":lilian1", "Mam ju wszystkie zdjcia. Magiczny fotograf uwieczni na kliszy ludzi i dzieki temu pozwoli im odej w spokoju. Magicznym miejscem jest Titanic.", "stdret",
			":lilian2", "Wpywam do rodka wraku.", "mend"
			);
		
		.imgs = (A, "43szczelina.jpg");
		
		mus.playstr("mapa2.ogg -l -v 60");
		.mexits;
		//.tohint(A, "grext");
		
		.mbatyskaf;
		
		.mtimhelper;
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	mend	{	.mprzejdz("Wnetrze");	}
	click_44wnetrze	{
		igmstate=0;
		.txtplay("lilian2");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Wnetrze : Kajuta	{
	init	{
		Kajuta::init("44wnetrze");
		.setsndbase("wnetrze");
		
		.loadsnddb;
		.sounds = (A, ":duchoficera5","Witaj Lilian; Odkrya moj tajemnic; Nawet nie wiesz jak bardzo czekaem na ciebie; Zrobiem straszn rzecz ktra pocigna za sob tak wiele mierci; Kiedy zorientowaem si; e przez moje zalepienie zgino tak wielu ludzi rozpacz wypala moj dusz; Nie pomogem wtedy i dugo czekaem na kogo takiego jak ty aby pomc im teraz",
				func { .txtplay("lilian22"); },
			":lilian22","Mam dla ciebie piercionek Margaret", "stdret",
				/*func {
					anitemring.setpos( iResX/2, 0.35*iResY );
					tcr.ahide;
					clsave.set("item_ring",0);
					.timplay("tim3", 2000, func { clduch.hideitem( "anitemring", func {
						anitemring.hide;
						.txtplay("duchoficera6");
						} );
						} );
				},*/
			":duchoficera6","Boe! To jest piercionek zarczynowy ktry daem Margaret; Zrobiem straszn rzecz; Jak mogem by tak zalepiony; Ja j kochaem",
				func { .txtplay("lilian23"); },
			":lilian23","Daj mi prosz ostatni klucz, naprawi cz twojego bdu z przeszoci",
				func { .txtplay("duchoficera7"); },
			":duchoficera7","Prosz oto skrzynka w ktrej jest klucz; Dzikuj ci za pomoc; Ja zostan tu na wieki i bd si opiekowa duszami ludzi ktre tak jak ja zostay tutaj",
				func { <GAME> {
					anduch7.play(0);
					clduch.showitem("anduch7", func {
						clduch.freeitem;
						.txtplay("margaret1"); } );
				}; },
			":margaret1","John! Wybaczam ci; Wiem e zrobie to z wielkiej mioci; Chod ze mn; Wybaczanie to wielka sia ktra moe uleczy kad dusze",
				func { .txtplay("duchoficera8"); },
			":duchoficera8","Margaret! Ja nie zasuguje na wybaczenie; Zrobiem wiele zego",
				func { .txtplay("margaret2"); },
			":margaret2","Chod ze mn John",
				func { <GAME> {tcr.ahide;
					clduch.hideitem("anduch7", func { <GAME> {
						anduch7.anhide;
						clduch.hideitem("anduch", func {
							clduch.freeitem;
							anduch.anhide;
							.timplay("tim2", 1000, func { .mprzejdz("HOWrak"); });
							} );
						}; }); 
				}; }
			);

		new imganima anwnetrze;
		anwnetrze.load("bg", "jpg", 0, 5, 7);
		anwnetrze.play;
		
		mus.playstr("tytan_wnetrze.ogg -l -v 60");
		//.mexits;
		
		.imgs = (A, "duch.pyzH 10", "duch7.pyzH 10");
		anduch.setpos( 0.2*iResX, 0.1*iResY );
		anduch7.setpos( 0.6*iResX, 0.1*iResY );
		
		new itemadder clduch;
		
		.mbatyskaf;
		
		if( clsave.bis("item_ring") )	{
			new DelayMover cmov;
			cmov.unlock;
			.sfxs = (A, "lampka");
			//.antohint("anitemring");
		}
		
		ccs.enter( func { 
			.timplay("tim1", 1000, func { anduch.play(0); clduch.showitem("anduch",
				func { clduch.freeitem; .txtplay("duchoficera5"); }); 
				} );
			} );
	}
	cmov_GET	{
		if( igmstate!=1 ) return;
		if( anitemring.isin(mouse.getpos,1,1) )	{
			.mssetobj("anitemring");
			anitemring.setz(1000);
			fxlampka.play;
			igmstate=2;
		}
	}
	cmov_PUT	{
		if( anduch.isin(mouse.getpos,1,1) )	{
			.free;
			clsave.set("item_ring",0);
			.timplay("timring", 1000, func {
				clduch.hideitem( "anitemring", func { anitemring.hide; .txtplay("duchoficera6"); } );
				} );
			fxshowhint.play;
		} else {
			igmstate=1;
			.retobj;
		}
	}
	hint_click	{
		if( clsave.bis("item_ring") )	{
			.playhints("anitemring", "anduch");
		}
	}
	anwnetrze_finish	{	.play;	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}

game Dziob : Kajuta1	{
	init	{
		Kajuta1::init("45dziob");
		.setsndbase("dziob");
		
		.titsounds=(A, ":lilian1", "Niesamowity widok. Tyle lat pod wod a cigle robi wraenie. Musz poszuka jakiej szczeliny w kadubie aby dostac si do rodka.", "stdret"
			);
		
		.imgs = (A, "45dziob.jpg");
		
		mus.playstr("mapa2.ogg -l -v 60");
		
		.mexits;
		//.tohint(A, "grext");
		//.hoverhint( .mgetext("43szczelina") );
		.mbatyskaf;
		
		.mtimhelper;
		
		//.msethover("43szczelina",1);
		
		ccs.enter( func { .txtplay("lilian1"); } );
	}
	click_43szczelina	{
		.mprzejdz("HOSzczelina");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
		/*if( igmstate==1 )	{
			igmstate=8;
		} else if (igmstate==8 )	{
			igmstate=0;
			.mprzejdz("HOSzczelina");
		}*/
	}
}

game Pokojadministracyjny : Kajuta	{
	init	{
		Kajuta::init("34pokojadministracyjny");
		.setsndbase("pokojadministracyjny");
		
		.imgs = (A, "34pokojadministracyjny.jpg", "obraz.pyz 10", "rama.pyz 5", "bable.pyzP 2");
		
		.loadsnddb;
		.sounds = (A, ":lilian17","Witaj Robercie! Co za zbieg okolicznoci!", func { .txtplay("robert1"); },
			":robert1","Lilian? Co ty tutaj robisz? No tak; zapomniaem e w tym feralnym rejsie pyna twoja prababcia",
				func {.txtplay("lilian18"); },
			":lilian18","Tak si ciesz e ciebie wanie tu spotkaam; Chciaabym zwiedzi wrak; Czy moesz mi udostpni batyskaf?", func { .txtplay("robert2"); },
			":robert2","Z wielk radoci; Popyn z tob", func { .txtplay("lilian19"); },
			":lilian19","Wolaabym sama tam popyn", func { .txtplay("robert3"); },
			":robert3","Wiele razem pywalimy w takich batyskafach ale nie mog ci puci samej; Wyjd przygotowa batyskaf a ty we prosz ze skrytki za obrazem mapy wraku; Szyfr do skrytki jest prost amigwk ktr kiedy sama zaprojektowaa; Informacje znajdziesz na biurku; Dasz sobie rad", func {.txtplay("lilian20"); },
			":lilian20","Poradz sobie; Jak wezm mapy to przyjd do doku", func { tcr.ahide; 
				ccs.playfin( func { grludzie1.hide; }, func { igmstate=1; });
				},
			":lilian21", "Przeszukam biurko, moe tam znajd jak wsakzwk.", "stdret",
			":lilian22","Mam fotografi to teraz moge sprbowa otworzy skrytk.", "stdret",
			":lilian23", "Udao si otworzyc skrytk. Teraz zbieram map i ide do doku.", "stdret",
			":lilian24", "I think I see the map in that secret opening.","stdret"
			);
		
		//mus.playstr("titanic2.ogg -l -v 60");
		.mexits;
		
		if (clsave.is("epizod", "e3_powrot") )	{
			if( !clsave.bis("e3_weszlapokojadmi") )	{
				.img = ("ludzie1.pyzG 20");
			}
			if( clsave.bis("e3_hopokojadmi") )	{
				.diblockexit("35ho_pokojadministracyjny");
				.hodone("35ho_pokojadministracyjny");
			} else {
				.diblockexit("roznice");
			}
			if( clsave.bis("e3_otwartyobraz") )	{
				.diblockexit("roznice");
				anobraz.setframe(1,0);
				if( !clsave.bis("e3_wzielamape") )	{
					new itemadder clmap;
					.imgs = (A, "mapa.pyz 15");
					.nohover("41dok");
					anmapa	{
						.Button_stdalpha;
						.addmethod("butclick", func {
							if( igmstate!=1 ) return;
							igmstate = 2;
							.hide;
							clsave.bset("e3_wzielamape");
							<GAME>.addnewitem("mapa");
							anitemmapa.setframe(1,0);
							anitemmapa.setpos(0,0);
							grhint.remove("anmapa");
							.extohint("41dok");
							.timplay("tim1", 1500, func {
								anitemmapa.itemonpos;
								@x = anitemmapa.getpx;
								@y = anitemmapa.getpy;
								@h = anitemmapa.geth;
								anitemmapa.setframe(1,0);
								anitemmapa.setpos(0,0);
								clmap.gotodest("anitemmapa", h, x, y, 15, func {
									anitemmapa.itemonpos;
									igmstate = 1; 
									.msethover("41dok",1);
									} );
								} );
							} );
						but1.add(this);
					};
					.antohint("anmapa");
					.hoverhint("anmapa");
				} else {
					.hodone("roznice");
					.extohint("41dok");
				}
			}
		}
		
		ccs.enter( func {
			if( !clsave.bis("e3_weszlapokojadmi") )	{
				clsave.bset("e3_weszlapokojadmi");
				.txtplay("lilian17");
			} else if( clsave.last=="Roznice" )	{
				.txtplay("lilian23");
			} else igmstate=1;
			} );
	}
	hint_click	{
		if( !clsave.bis("e3_hopokojadmi") ) {
			igmstate=0; 
			.txtplay("lilian21");
			.playexhint("35ho_pokojadministracyjny");
		} else if( !clsave.bis("e3_wzielamape") )	{
			igmstate=0;
			if( clsave.bis("e3_otwartyobraz") )
				.txtplay("lilian24");
			else .txtplay("lilian22");
			.playexhint("roznice");
		}
	}
	click_roznice	{
		clsave.bset("e3_otwartyobraz");
		.mprzejdz("Roznice");
	}
	click_35ho_pokojadministracyjny	{
		clsave.bset("e3_hopokojadmi");
		.mprzejdz("HOPokojadministracyjny");
	}
	click_41dok	{
		.mprzejdz("Dok");
	}
	tit_lclick	{
		//if( igmdebug ) .cactsndstop(true);
	}
}


class InfoTit : Kajuta1	{
	init(string s, string sret)	{
		Kajuta1::init(s);
		.path = ("info");
		
		new string sretgame = sret;
		
		.img = ("powrot.pyz 100");
		anpowrot {
			.Button_stdms;
			.addmethod("butclick", func {
				if( AdventureMode )
					.mprzejdz(sretgame);
				else .mprzejdz("MainMenu");
				} );
			but1.add(this);
		};
	}
}

//game InfoTrapL : InfoTit	{
game InfoKasyL : InfoTit	{
	init	{
		//InfoTit::init("infotrapl", "Trap");
		InfoTit::init("infotrapr", "Kasy");
		
		new img imbg;
		new int idimbg = 0;
		.reloadbg;
		igmstate = 1;
		
		.img = ("strzalki.pyz 10");
		anstrzalki {
			.move(0,20);
			.Button_stdms;
			.addmethod("butclick", func {
				if( igmstate==1 ) <GAME>.reloadbg;
				} );
			but1.add(this);
		};
		
		anpowrot.move(0, iResY-anpowrot.geth - 5);
		
		.mstdenter;
	}
	reloadbg	{
		match(idimbg)	{
			0 => "lost.jpg";
			1 => "saved.jpg";
			2 => "historia.png";
			? => ;
		}
		string s = _;
		imbg.load( .getgraphpath + s );
		idimbg = (idimbg+1)%3;
	}
}

game InfoTrapL : InfoTit	{
	init	{
		InfoTit::init("infotrapl", "Trap");
		
		new img imbg;
		new int idimbg = 0;
		.reloadbg;
		
		if( imbg.geth < iResY )	{
			int r[3];
			|r0,r1,r2| = imbg.getrgb(5,imbg.getey-5);
			new img imbg2;
			imbg2.create(iResX, iResY-imbg.geth, r0,r1,r2,255);
			imbg2.setpos(0, imbg.geth);
		}
		
		igmstate = 1;
		
		.img = ("strzalki.pyz 10");
		anstrzalki {
			.move(0,20);
			.Button_stdms;
			.addmethod("butclick", func {
				if( igmstate==1 ) <GAME>.reloadbg;
				} );
			but1.add(this);
		};
		
		anpowrot.move(0, iResY-anpowrot.geth - 5);
		
		.mstdenter;
	}
	reloadbg	{
		match(idimbg)	{
			0 => "przekroj1.png";
			1 => "przekroj2.png";
			2 => "przekroj3.png";
			? => ;
		}
		string s = _;
		imbg.load( .getgraphpath + s );
		idimbg = (idimbg+1)%3;
	}
}

/*game InfoTrapL : InfoTit	{
	init	{
		InfoTit::init("infotrapl", "Trap");
		
		new img imbg;
		new int idprzek = 1;
		
		.newanima("anprawo", "strzalki.pyz", 10);
		.copyanima("anprawo", "anlewo");
		anprawo.mstrzalka;
		anlewo.mstrzalka;
		anlewo.setframe(1,0);
		
		.mloadprzek(0);
		.mstdenter;
	}
	mstrzalka	{
		.Button_stdms;
		.addmethod("butclick", func {
			if( this=="anprawo" ) .mloadprzek(1);
			else .mloadprzek(-1);
			} );
		but1.add(this);
	}
	mloadprzek(int id)	{
		idprzek+=id;
		if( idprzek<1 ) idprzek=1;
		else if (idprzek>3) idprzek=3;
		imbg.load( .getgraphpath + "przekroj" + idprzek + ".png" );
		if( idprzek==1 ) anlewo.hide;
		else anlewo.show;
		if( idprzek==3 ) anprawo.hide;
		else anprawo.show;
	}
}*/

game InfoTrapR : InfoTit	{
	init	{
		InfoTit::init("infotrapr", "Trap");
		
		.img = ("budowa.jpg");
		anpowrot.ansetbpos( iResX-anpowrot.getw-10, iResY-anpowrot.geth-10 );
		.mstdenter;
	}
}

/*game InfoKasyL : InfoTit	{
	init	{
		InfoTit::init("infotrapr", "Kasy");
		
		.imgs = (A, "bgkatastrofa.pyz", "butskat.pyzG 10");
		grbutskat.eval( func {
			.Button_stdms;
			.addmethod("butclick", func {
				grbutskat.setz(10);
				.setz(20);
				} );
			but1.add(this);
			} );
		.mstdenter;
	}
}*/

